#NGINX can run multiple worker processes, each capable of processing a large number of simultaneous connections

#worker_processes – The number of NGINX worker processes (the default is 1). In most cases, running one worker 
#process per CPU core works well, and we recommend setting this directive to auto to achieve that. There are times 
#when you may want to increase this number, such as when the worker processes have to do a lot of disk I/O.

#worker_connections – The maximum number of connections that each worker process can handle simultaneously. 
#The default is 512, but most systems have enough resources to support a larger number. The appropriate setting 
#depends on the size of the server and the nature of the traffic, and can be discovered through testing.
worker_processes 1;
daemon off;

error_log <%= ENV["APP_ROOT"] %>/nginx/logs/error.log;
events { worker_connections 1024; }

http {
  charset utf-8;
  log_format cloudfoundry '$http_x_forwarded_for - $http_referer - [$time_local] "$request" $status $body_bytes_sent';
  access_log <%= ENV["APP_ROOT"] %>/nginx/logs/access.log cloudfoundry;
  default_type application/octet-stream;
  include mime.types;
  sendfile on;

  #The ngx_http_gzip_module module is a filter that compresses responses using the “gzip” method. This often helps to reduce 
  #the size of transmitted data by half or even more.
  gzip on;
  gzip_disable "msie6";
  gzip_comp_level 6;
  gzip_min_length 1100;
  gzip_buffers 16 8k;
  gzip_proxied any;
  gunzip on;
  gzip_static always;
  gzip_types text/plain text/css text/js text/xml text/javascript application/javascript application/x-javascript application/json application/xml application/xml+rss;
  gzip_vary on;

  #tcp_nopush is opposite to tcp_nodelay. Instead of pushing packages as fast as possible, it aims to optimise the amount of data sent simultaneously.
  #It will force the package to wait until it gets its maximum size (MSS) before sending it to the client. This directive only works, when sendfile is on. 
  tcp_nopush on;
  keepalive_timeout 30;
  port_in_redirect off; # Ensure that redirects don't include the internal container PORT - <%= ENV["PORT"] %>
  server_tokens off;

  # Use real IP module instead of AWS ELB proxy ip
  real_ip_header X-Forwarded-For;
  real_ip_recursive on;
  set_real_ip_from 0.0.0.0/0;

  ######### STAGING #########

  ## APP ##
  server {
    listen <%= ENV["PORT"] %>;
    server_name app.staging.e-potek.ch;

    <% if ENV["FORCE_HTTPS"] %>
     if ($http_x_forwarded_proto != "https") {
       return 301 https://$host$request_uri;
     }
    <% end %>

    <% if ENV["MAINTENANCE_STAGING_APP"] %>
      location / {
        proxy_pass  http://e-potek-maintenance.s3-website.eu-central-1.amazonaws.com/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
      }
    <% else %>
      location / {
      allow 213.3.47.70;
      allow 185.19.31.79
      allow 2a02:121f::/32;
      deny all;
      proxy_pass  https://e-potek-app-staging.scapp.io/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      }
    <% end %>
  }

  ## ADMIN ##
  server {
    listen <%= ENV["PORT"] %>;
    server_name admin.staging.e-potek.ch;

    <% if ENV["FORCE_HTTPS"] %>
     if ($http_x_forwarded_proto != "https") {
       return 301 https://$host$request_uri;
     }
    <% end %>

     <% if ENV["MAINTENANCE_STAGING_ADMIN"] %>
      location / {
        proxy_pass  http://e-potek-maintenance.s3-website.eu-central-1.amazonaws.com/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
      }
    <% else %>
      location / {
      allow 213.3.47.70;
      allow 185.19.31.79
      allow 2a02:121f::/32;
      deny all;
      proxy_pass  https://e-potek-admin-staging.scapp.io/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      }
    <% end %> 

  }

  ## WWW ##
  server {
    listen <%= ENV["PORT"] %>;
    server_name www.staging.e-potek.ch;

    <% if ENV["FORCE_HTTPS"] %>
     if ($http_x_forwarded_proto != "https") {
       return 301 https://$host$request_uri;
     }
    <% end %>

     <% if ENV["MAINTENANCE_STAGING_WWW"] %>
      location / {
        proxy_pass  http://e-potek-maintenance.s3-website.eu-central-1.amazonaws.com/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
      }
    <% else %>
      location / {
      allow 213.3.47.70;
      allow 185.19.31.79
      allow 2a02:121f::/32;
      deny all;
      proxy_pass  https://e-potek-www-staging.scapp.io/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      }
    <% end %> 
  }

  ## PRO ##
  server {
    listen <%= ENV["PORT"] %>;
    server_name pro.staging.e-potek.ch;

    <% if ENV["FORCE_HTTPS"] %>
     if ($http_x_forwarded_proto != "https") {
       return 301 https://$host$request_uri;
     }
    <% end %>

    <% if ENV["MAINTENANCE_STAGING_PRO"] %>
      location / {
        proxy_pass  http://e-potek-maintenance.s3-website.eu-central-1.amazonaws.com/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
      }
    <% else %>
      location / {
      allow 213.3.47.70;
      allow 185.19.31.79
      allow 2a02:121f::/32;
      deny all;
      proxy_pass  https://e-potek-pro-staging.scapp.io/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      }
    <% end %>
  }

  ######### PRODUCTION #########

  ## APP ##
  server {
    listen <%= ENV["PORT"] %>;
    server_name app.e-potek.ch;

    <% if ENV["FORCE_HTTPS"] %>
     if ($http_x_forwarded_proto != "https") {
       return 301 https://$host$request_uri;
     }
    <% end %>

     <% if ENV["MAINTENANCE_PRODUCTION_APP"] %>
      location / {
        proxy_pass  http://e-potek-maintenance.s3-website.eu-central-1.amazonaws.com/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
      }
    <% else %>
      location / {
      proxy_pass  https://e-potek-app-production.scapp.io/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      }
    <% end %>
  }

  ## ADMIN ##
  server {
    listen <%= ENV["PORT"] %>;
    server_name admin.e-potek.ch;

    <% if ENV["FORCE_HTTPS"] %>
     if ($http_x_forwarded_proto != "https") {
       return 301 https://$host$request_uri;
     }
    <% end %>

    <% if ENV["MAINTENANCE_PRODUCTION_ADMIN"] %>
      location / {
        proxy_pass  http://e-potek-maintenance.s3-website.eu-central-1.amazonaws.com/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
      }
    <% else %>
      location / {
      allow 213.3.47.70;
      allow 185.19.31.79
      allow 2a02:121f::/32;
      deny all;
      proxy_pass  https://e-potek-admin-production.scapp.io/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      }
    <% end %>  
  }

  ## WWW ##
  server {
    listen <%= ENV["PORT"] %>;
    server_name www.e-potek.ch;

    <% if ENV["FORCE_HTTPS"] %>
     if ($http_x_forwarded_proto != "https") {
       return 301 https://$host$request_uri;
     }
    <% end %>

    <% if ENV["MAINTENANCE_PRODUCTION_WWW"] %>
      location / {
        proxy_pass  http://e-potek-maintenance.s3-website.eu-central-1.amazonaws.com/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
      }
    <% else %>
      location / {
      proxy_pass  https://e-potek-www-production.scapp.io/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      }
    <% end %> 
  }

  ## PRO ##
  server {
      listen <%= ENV["PORT"] %>;
      server_name pro.e-potek.ch;

      <% if ENV["FORCE_HTTPS"] %>
      if ($http_x_forwarded_proto != "https") {
        return 301 https://$host$request_uri;
      }
      <% end %>

      <% if ENV["MAINTENANCE_PRODUCTION_PRO"] %>
        location / {
          proxy_pass  http://e-potek-maintenance.s3-website.eu-central-1.amazonaws.com/;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
        }
      <% else %>
        location / {
        proxy_pass  https://e-potek-pro-production.scapp.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        }
      <% end %>
    }

  ######## KADIRA #########

  server {
    listen <%= ENV["PORT"] %>;
    server_name kadira.e-potek.ch;

    <% if ENV["FORCE_HTTPS"] %>
     if ($http_x_forwarded_proto != "https") {
       return 301 https://$host$request_uri;
     }
    <% end %>

     location / {
       allow 213.3.47.70;
       allow 185.19.31.79
       allow 2a02:121f::/32;
       deny all;
       proxy_pass http://159.100.240.117:4000;
     }
  }

  ######## DEFAULT REDIRECT ######
  server {
      listen <%= ENV["PORT"] %> default_server;
      return 301 https://www.e-potek.ch/;      
    }
}


{"version":3,"sources":["meteor://ðŸ’»app/packages/cultofcoders:redis-oplog/redis-oplog.client.js","meteor://ðŸ’»app/packages/cultofcoders:redis-oplog/lib/constants.js","meteor://ðŸ’»app/packages/cultofcoders:redis-oplog/lib/vent/VentClient.js"],"names":["module","export","Vent","VentClient","link","v","Events","Strategy","RedisPipe","VentConstants","EVENT","DOC","FIELDS","MODIFIER","DOCUMENT_ID","SYNTHETIC","UID","MODIFIED_TOP_LEVEL_FIELDS","exportDefault","INSERT","UPDATE","REMOVE","DEFAULT","DEDICATED_CHANNELS","LIMIT_SORT","ID","EVENT_VARIABLE","PREFIX","getPrefix","id","name","Random","DDPCommon","store","listen","Meteor","connection","subscribe","subscription","VentClientSubscription","add","args","ddpConnection","_stream","on","raw_msg","search","substr","length","msg","parseDDP","handle","remove","client","_name","_id","self","handler","oldStop","stop","Object","assign","eventHandler","_","isFunction","Error","_eventHandler","call","event"],"mappings":"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","file":"/packages/cultofcoders_redis-oplog.js","sourcesContent":["import VentClient from './lib/vent/VentClient';\n\nconst Vent = new VentClient();\n\nexport { Vent };\n","const RedisPipe = {\n    EVENT: 'e',\n    DOC: 'd',\n    FIELDS: 'f',\n    MODIFIER: 'm',\n    DOCUMENT_ID: 'id',\n    SYNTHETIC: 's',\n    UID: 'u', // this is the unique identity of a change request\n    MODIFIED_TOP_LEVEL_FIELDS: 'mt'\n};\n\nexport default RedisPipe;\n\nconst Events = {\n    INSERT: 'i',\n    UPDATE: 'u',\n    REMOVE: 'r'\n};\n\nconst Strategy = {\n    DEFAULT: 'D',\n    DEDICATED_CHANNELS: 'DC',\n    LIMIT_SORT: 'LS'\n};\n\nconst VentConstants = {\n    ID: 'i',\n    EVENT_VARIABLE: 'e',\n    PREFIX: '__vent',\n    getPrefix(id, name) {\n        return `${id}.${name}`;\n    }\n};\n\nexport {\n    Events,\n    Strategy,\n    RedisPipe,\n    VentConstants\n};\n","import {VentConstants} from '../constants';\nimport {Random} from 'meteor/random';\nimport {DDPCommon} from 'meteor/ddp-common';\n\n/**\n * Handles vents inside Meteor\n */\nexport default class VentClient {\n    constructor() {\n        this.store = {};\n        this.listen(Meteor.connection);\n    }\n\n    subscribe(name, ...args) {\n        const subscription = new VentClientSubscription(this, name);\n        this.add(subscription);\n\n        return subscription.subscribe(...args);\n    }\n\n    listen(ddpConnection) {\n        ddpConnection._stream.on('message', (raw_msg) => {\n            // avoid parsing unnecessary ddp events\n            const search = `{\"msg\":\"changed\",\"${VentConstants.PREFIX}\":\"1`;\n            if (raw_msg.substr(0, search.length) !== search) {\n                return;\n            }\n\n            const msg = DDPCommon.parseDDP(raw_msg);\n            const subscription = this.store[msg.id];\n            if (subscription) {\n                subscription.handle(msg[VentConstants.EVENT_VARIABLE]);\n            }\n        });\n    }\n\n    /**\n     * {VentClientSubscription}\n     * @param subscription\n     */\n    add(subscription) {\n        this.store[subscription.id] = subscription;\n    }\n\n    /**\n     * @param {VentClientSubscription} subscription\n     */\n    remove(subscription) {\n        delete this.store[subscription.id];\n    }\n}\n\n/**\n * Handles Vent subscription\n */\nclass VentClientSubscription {\n    constructor(client, name) {\n        this.client = client;\n        this._name = name;\n        this._id = Random.id();\n    }\n\n    get id() {\n        return VentConstants.getPrefix(this._id, this._name);\n    }\n\n    /**\n     * Subscribes to Meteor\n     *\n     * @param args\n     * @returns {*}\n     */\n    subscribe(...args) {\n        const self = this;\n\n        const handler = Meteor.subscribe(this._name, this._id, ...args);\n\n        const oldStop = handler.stop;\n        Object.assign(handler, {\n            listen(eventHandler) {\n                if (!_.isFunction(eventHandler)) {\n                    throw new Meteor.Error('invalid-argument', 'You should pass a function to listen()');\n                }\n\n                self._eventHandler = eventHandler;\n            },\n            stop() {\n                self.client.remove(self);\n\n                return oldStop.call(handler);\n            }\n        });\n\n        return handler;\n    }\n\n    /**\n     * Watches the incomming events\n     */\n    handle(event) {\n        if (this._eventHandler) {\n            this._eventHandler(event);\n        } else {\n\n        }\n    }\n}"]}
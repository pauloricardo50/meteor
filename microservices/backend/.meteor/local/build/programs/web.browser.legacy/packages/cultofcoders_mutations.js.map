{"version":3,"sources":["meteor://ðŸ’»app/packages/cultofcoders:mutations/main.js","meteor://ðŸ’»app/packages/cultofcoders:mutations/lib/aop.js","meteor://ðŸ’»app/packages/cultofcoders:mutations/lib/debug.js","meteor://ðŸ’»app/packages/cultofcoders:mutations/lib/mutation.class.js","meteor://ðŸ’»app/packages/cultofcoders:mutations/lib/wrap.js"],"names":["module","export","Mutation","wrap","link","v","AOP","befores","afters","addBefore","fn","check","Function","push","addAfter","executeBefores","args","forEach","call","executeAfters","exportDefault","Object","assign","isDebugEnabled","Meteor","isDevelopment","process","env","MUTATION_DEBUG_ENABLED","addBeforeCall","config","params","context","console","log","name","addAfterCall","result","error","time","Date","addBeforeExecution","JSON","stringify","Match","checkDefaultConfig","callAOP","executionAOP","addAfterExecution","Error","run","callParams","options","aopData","Promise","resolve","reject","apply","setHandler","self","methods","e"],"mappings":"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","file":"/packages/cultofcoders_mutations.js","sourcesContent":["import wrap from './lib/wrap';\nimport Mutation from './lib/mutation.class';\nimport './lib/debug';\n\nexport { Mutation, wrap };\n","class AOP {\n    befores = [];\n    afters = [];\n\n    addBefore(fn) {\n        check(fn, Function);\n\n        this.befores.push(fn);\n    }\n\n    addAfter(fn) {\n        check(fn, Function);\n\n        this.afters.push(fn);\n    }\n\n    executeBefores(...args) {\n        this.befores.forEach(fn => fn.call(null, ...args));\n    }\n\n    executeAfters(...args) {\n        this.afters.forEach(fn => fn.call(null, ...args));\n    }\n}\n\nexport default AOP;\n","import Mutation from './mutation.class';\n\nObject.assign(Mutation, {\n    isDebugEnabled: Meteor.isDevelopment || process.env.MUTATION_DEBUG_ENABLED,\n});\n\nMutation.addBeforeCall(({ config, params, context }) => {\n    if (Mutation.isDebugEnabled) {\n        console.log(`[mutations][${config.name}] Calling with params:`, params);\n    }\n});\n\nMutation.addAfterCall(({ config, params, context, result, error }) => {\n    if (Mutation.isDebugEnabled) {\n        const time = new Date();\n\n        if (!error) {\n            console.log(`[mutations][${config.name}] Received result:`, result);\n        } else {\n            console.error(`[mutations][${config.name}] Received error:`, error);\n        }\n    }\n});\n\nMutation.addBeforeExecution(({ config, params, context }) => {\n    if (Mutation.isDebugEnabled) {\n        const time = new Date();\n        console.log(\n            `[mutations][${\n                config.name\n            }] Received call with params: ${JSON.stringify(params)}`\n        );\n    }\n});\n","import { Meteor } from 'meteor/meteor';\nimport AOP from './aop';\nimport { check, Match } from 'meteor/check';\n\nexport default class Mutation {\n    static callAOP = new AOP();\n    static executionAOP = new AOP();\n\n    constructor(config) {\n        Mutation.checkDefaultConfig(config);\n\n        this.config = config;\n        this.callAOP = new AOP();\n        this.executionAOP = new AOP();\n    }\n\n    /**\n     * @param {Function} fn\n     */\n    static addBeforeCall(fn) {\n        this.callAOP.addBefore(fn);\n    }\n\n    /**\n     * @param {Function} fn\n     */\n    static addAfterCall(fn) {\n        this.callAOP.addAfter(fn);\n    }\n\n    /**\n     * @param {Function} fn\n     */\n    static addBeforeExecution(fn) {\n        this.executionAOP.addBefore(fn);\n    }\n\n    /**\n     * @param {Function} fn\n     */\n    static addAfterExecution(fn) {\n        this.executionAOP.addAfter(fn);\n    }\n\n    /**\n     * @param {Object} config\n     */\n    static checkDefaultConfig(config) {\n        check(config, Object);\n        if (typeof config.name !== 'string') {\n            throw new Meteor.Error(\n                'invalid-config',\n                'You must provide a \"name\" property to your mutation config.'\n            );\n        }\n    }\n\n    /**\n     * @param {Function} fn\n     */\n    addBeforeCall(fn) {\n        this.callAOP.addBefore(fn);\n    }\n\n    /**\n     * @param {Function} fn\n     */\n    addAfterCall(fn) {\n        this.callAOP.addAfter(fn);\n    }\n\n    /**\n     * @param {Function} fn\n     */\n    addBeforeExecution(fn) {\n        this.executionAOP.addBefore(fn);\n    }\n\n    /**\n     * @param {Function} fn\n     */\n    addAfterExecution(fn) {\n        this.executionAOP.addAfter(fn);\n    }\n\n    /**\n     * Runs the mutation inside a promise\n     * @param {Object} callParams\n     * @param {Object} options Meteor options https://docs.meteor.com/api/methods.html#Meteor-apply\n     * @returns {Promise}\n     */\n    run(callParams, options = {}) {\n        const config = this.config;\n\n        const aopData = { config, params: callParams };\n        Mutation.callAOP.executeBefores(aopData);\n        this.callAOP.executeBefores(aopData);\n\n        const { name, params } = config;\n\n        return new Promise((resolve, reject) => {\n            Meteor.apply(name, [callParams], options, (error, result) => {\n                const aopData = {\n                    config,\n                    params: callParams,\n                    result,\n                    error,\n                };\n\n                Mutation.callAOP.executeAfters(aopData);\n                this.callAOP.executeAfters(aopData);\n\n                if (error) {\n                    reject(error);\n                } else {\n                    resolve(result);\n                }\n            });\n        });\n    }\n\n    /**\n     * Creates the Meteor Method and the handler for it\n     * @param {Function} fn\n     */\n    setHandler(fn) {\n        const config = this.config;\n        const { name, params } = config;\n        const self = this;\n\n        Meteor.methods({\n            [name](params = {}) {\n                if (config.params) {\n                    check(params, config.params);\n                }\n\n                let aopData = {\n                    context: this,\n                    config,\n                    params,\n                };\n\n                Mutation.executionAOP.executeBefores(aopData);\n                self.executionAOP.executeBefores(aopData);\n\n                let error, result;\n                try {\n                    result = fn.call(null, this, params);\n                } catch (e) {\n                    error = e;\n                }\n\n                aopData = {\n                    context: this,\n                    config,\n                    params,\n                    result,\n                    error,\n                };\n\n                Mutation.executionAOP.executeAfters(aopData);\n                self.executionAOP.executeAfters(aopData);\n\n                if (error) {\n                    throw error;\n                }\n\n                return result;\n            },\n        });\n    }\n}\n","import Mutation from './mutation.class';\n\nexport default function wrap(config) {\n    return new Mutation(config);\n}\n"]}
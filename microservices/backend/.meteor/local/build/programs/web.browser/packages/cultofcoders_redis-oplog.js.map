{"version":3,"sources":["meteor://ðŸ’»app/packages/cultofcoders:redis-oplog/redis-oplog.client.js","meteor://ðŸ’»app/packages/cultofcoders:redis-oplog/lib/constants.js","meteor://ðŸ’»app/packages/cultofcoders:redis-oplog/lib/vent/VentClient.js"],"names":["module","export","Vent","VentClient","link","default","v","Events","Strategy","RedisPipe","VentConstants","EVENT","DOC","FIELDS","MODIFIER","DOCUMENT_ID","SYNTHETIC","UID","MODIFIED_TOP_LEVEL_FIELDS","exportDefault","INSERT","UPDATE","REMOVE","DEFAULT","DEDICATED_CHANNELS","LIMIT_SORT","ID","EVENT_VARIABLE","PREFIX","getPrefix","id","name","Random","DDPCommon","constructor","store","listen","Meteor","connection","subscribe","subscription","VentClientSubscription","add","args","ddpConnection","_stream","on","raw_msg","search","substr","length","msg","parseDDP","handle","remove","client","_name","_id","self","handler","oldStop","stop","Object","assign","eventHandler","_","isFunction","Error","_eventHandler","call","event"],"mappings":"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","file":"/packages/cultofcoders_redis-oplog.js","sourcesContent":["import VentClient from './lib/vent/VentClient';\n\nconst Vent = new VentClient();\n\nexport { Vent };\n","const RedisPipe = {\n    EVENT: 'e',\n    DOC: 'd',\n    FIELDS: 'f',\n    MODIFIER: 'm',\n    DOCUMENT_ID: 'id',\n    SYNTHETIC: 's',\n    UID: 'u', // this is the unique identity of a change request\n    MODIFIED_TOP_LEVEL_FIELDS: 'mt'\n};\n\nexport default RedisPipe;\n\nconst Events = {\n    INSERT: 'i',\n    UPDATE: 'u',\n    REMOVE: 'r'\n};\n\nconst Strategy = {\n    DEFAULT: 'D',\n    DEDICATED_CHANNELS: 'DC',\n    LIMIT_SORT: 'LS'\n};\n\nconst VentConstants = {\n    ID: 'i',\n    EVENT_VARIABLE: 'e',\n    PREFIX: '__vent',\n    getPrefix(id, name) {\n        return `${id}.${name}`;\n    }\n};\n\nexport {\n    Events,\n    Strategy,\n    RedisPipe,\n    VentConstants\n};\n","import {VentConstants} from '../constants';\nimport {Random} from 'meteor/random';\nimport {DDPCommon} from 'meteor/ddp-common';\n\n/**\n * Handles vents inside Meteor\n */\nexport default class VentClient {\n    constructor() {\n        this.store = {};\n        this.listen(Meteor.connection);\n    }\n\n    subscribe(name, ...args) {\n        const subscription = new VentClientSubscription(this, name);\n        this.add(subscription);\n\n        return subscription.subscribe(...args);\n    }\n\n    listen(ddpConnection) {\n        ddpConnection._stream.on('message', (raw_msg) => {\n            // avoid parsing unnecessary ddp events\n            const search = `{\"msg\":\"changed\",\"${VentConstants.PREFIX}\":\"1`;\n            if (raw_msg.substr(0, search.length) !== search) {\n                return;\n            }\n\n            const msg = DDPCommon.parseDDP(raw_msg);\n            const subscription = this.store[msg.id];\n            if (subscription) {\n                subscription.handle(msg[VentConstants.EVENT_VARIABLE]);\n            }\n        });\n    }\n\n    /**\n     * {VentClientSubscription}\n     * @param subscription\n     */\n    add(subscription) {\n        this.store[subscription.id] = subscription;\n    }\n\n    /**\n     * @param {VentClientSubscription} subscription\n     */\n    remove(subscription) {\n        delete this.store[subscription.id];\n    }\n}\n\n/**\n * Handles Vent subscription\n */\nclass VentClientSubscription {\n    constructor(client, name) {\n        this.client = client;\n        this._name = name;\n        this._id = Random.id();\n    }\n\n    get id() {\n        return VentConstants.getPrefix(this._id, this._name);\n    }\n\n    /**\n     * Subscribes to Meteor\n     *\n     * @param args\n     * @returns {*}\n     */\n    subscribe(...args) {\n        const self = this;\n\n        const handler = Meteor.subscribe(this._name, this._id, ...args);\n\n        const oldStop = handler.stop;\n        Object.assign(handler, {\n            listen(eventHandler) {\n                if (!_.isFunction(eventHandler)) {\n                    throw new Meteor.Error('invalid-argument', 'You should pass a function to listen()');\n                }\n\n                self._eventHandler = eventHandler;\n            },\n            stop() {\n                self.client.remove(self);\n\n                return oldStop.call(handler);\n            }\n        });\n\n        return handler;\n    }\n\n    /**\n     * Watches the incomming events\n     */\n    handle(event) {\n        if (this._eventHandler) {\n            this._eventHandler(event);\n        } else {\n\n        }\n    }\n}"]}
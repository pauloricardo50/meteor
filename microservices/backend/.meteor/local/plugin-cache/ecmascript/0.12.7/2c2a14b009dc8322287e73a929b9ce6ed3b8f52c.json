{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/packages/cultofcoders:redis-oplog/lib/redis/RedisSubscriber.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/cultofcoders:redis-oplog/lib/redis/RedisSubscriber.js","filename":"/Users/Florian/dev/epotek/microservices/backend/packages/cultofcoders:redis-oplog/lib/redis/RedisSubscriber.js","passPerPreset":false,"envName":"production","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/packages/cultofcoders:redis-oplog/lib/redis/RedisSubscriber.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/cultofcoders:redis-oplog/lib/redis/RedisSubscriber.js"}},"code":"module.export({\n  default: () => RedisSubscriber\n});\nlet Strategy;\nmodule.link(\"../constants\", {\n  Strategy(v) {\n    Strategy = v;\n  }\n\n}, 0);\nlet getProcessor;\nmodule.link(\"../processors\", {\n  getProcessor(v) {\n    getProcessor = v;\n  }\n\n}, 1);\n\nlet _;\n\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n\n}, 2);\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 3);\nlet extractIdsFromSelector;\nmodule.link(\"../utils/extractIdsFromSelector\", {\n  default(v) {\n    extractIdsFromSelector = v;\n  }\n\n}, 4);\nlet RedisSubscriptionManager;\nmodule.link(\"./RedisSubscriptionManager\", {\n  default(v) {\n    RedisSubscriptionManager = v;\n  }\n\n}, 5);\nlet syntheticProcessor;\nmodule.link(\"../processors/synthetic\", {\n  default(v) {\n    syntheticProcessor = v;\n  }\n\n}, 6);\nlet getDedicatedChannel;\nmodule.link(\"../utils/getDedicatedChannel\", {\n  default(v) {\n    getDedicatedChannel = v;\n  }\n\n}, 7);\n\nclass RedisSubscriber {\n  /**\n   * @param publicationEntry\n   * @param strategy\n   */\n  constructor(publicationEntry, strategy) {\n    this.publicationEntry = publicationEntry;\n    this.observableCollection = publicationEntry.observableCollection;\n    this.strategy = strategy;\n    this.processor = getProcessor(strategy); // We do this because we override the behavior of dedicated \"_id\" channels\n\n    this.channels = this.getChannels(this.observableCollection.channels);\n    RedisSubscriptionManager.attach(this);\n  }\n  /**\n   * @param channels\n   * @returns {*}\n   */\n\n\n  getChannels(channels) {\n    const collectionName = this.observableCollection.collectionName;\n\n    switch (this.strategy) {\n      case Strategy.DEFAULT:\n      case Strategy.LIMIT_SORT:\n        return channels;\n\n      case Strategy.DEDICATED_CHANNELS:\n        const ids = extractIdsFromSelector(this.observableCollection.selector);\n        return ids.map(id => getDedicatedChannel(collectionName, id));\n\n      default:\n        throw new Meteor.Error(`Strategy could not be found: ${this.strategy}`);\n    }\n  }\n  /**\n   * @param args\n   */\n\n\n  process(...args) {\n    this.processor.call(null, this.observableCollection, ...args);\n  }\n  /**\n   * @param event\n   * @param doc\n   * @param modifier\n   * @param modifiedTopLevelFields\n   */\n\n\n  processSynthetic(event, doc, modifier, modifiedTopLevelFields) {\n    syntheticProcessor(this.observableCollection, event, doc, modifier, modifiedTopLevelFields);\n  }\n  /**\n   * Detaches from RedisSubscriptionManager\n   */\n\n\n  stop() {\n    try {\n      RedisSubscriptionManager.detach(this);\n    } catch (e) {\n      console.warn(`[RedisSubscriber] Weird! There was an error while stopping the publication: `, e);\n    }\n  }\n  /**\n   * Retrieves the fields that are used for matching the validity of the document\n   *\n   * @returns {array}\n   */\n\n\n  getFieldsOfInterest() {\n    return this.observableCollection.fieldsOfInterest;\n  }\n\n}","map":{"version":3,"sources":["packages/cultofcoders:redis-oplog/lib/redis/RedisSubscriber.js"],"names":["module","export","default","RedisSubscriber","Strategy","link","v","getProcessor","_","Meteor","extractIdsFromSelector","RedisSubscriptionManager","syntheticProcessor","getDedicatedChannel","constructor","publicationEntry","strategy","observableCollection","processor","channels","getChannels","attach","collectionName","DEFAULT","LIMIT_SORT","DEDICATED_CHANNELS","ids","selector","map","id","Error","process","args","call","processSynthetic","event","doc","modifier","modifiedTopLevelFields","stop","detach","e","console","warn","getFieldsOfInterest","fieldsOfInterest"],"mappings":"AAAAA,MAAM,CAACC,MAAP,CAAc;AAACC,EAAAA,OAAO,EAAC,MAAIC;AAAb,CAAd;AAA6C,IAAIC,QAAJ;AAAaJ,MAAM,CAACK,IAAP,CAAY,cAAZ,EAA2B;AAACD,EAAAA,QAAQ,CAACE,CAAD,EAAG;AAACF,IAAAA,QAAQ,GAACE,CAAT;AAAW;;AAAxB,CAA3B,EAAqD,CAArD;AAAwD,IAAIC,YAAJ;AAAiBP,MAAM,CAACK,IAAP,CAAY,eAAZ,EAA4B;AAACE,EAAAA,YAAY,CAACD,CAAD,EAAG;AAACC,IAAAA,YAAY,GAACD,CAAb;AAAe;;AAAhC,CAA5B,EAA8D,CAA9D;;AAAiE,IAAIE,CAAJ;;AAAMR,MAAM,CAACK,IAAP,CAAY,mBAAZ,EAAgC;AAACG,EAAAA,CAAC,CAACF,CAAD,EAAG;AAACE,IAAAA,CAAC,GAACF,CAAF;AAAI;;AAAV,CAAhC,EAA4C,CAA5C;AAA+C,IAAIG,MAAJ;AAAWT,MAAM,CAACK,IAAP,CAAY,eAAZ,EAA4B;AAACI,EAAAA,MAAM,CAACH,CAAD,EAAG;AAACG,IAAAA,MAAM,GAACH,CAAP;AAAS;;AAApB,CAA5B,EAAkD,CAAlD;AAAqD,IAAII,sBAAJ;AAA2BV,MAAM,CAACK,IAAP,CAAY,iCAAZ,EAA8C;AAACH,EAAAA,OAAO,CAACI,CAAD,EAAG;AAACI,IAAAA,sBAAsB,GAACJ,CAAvB;AAAyB;;AAArC,CAA9C,EAAqF,CAArF;AAAwF,IAAIK,wBAAJ;AAA6BX,MAAM,CAACK,IAAP,CAAY,4BAAZ,EAAyC;AAACH,EAAAA,OAAO,CAACI,CAAD,EAAG;AAACK,IAAAA,wBAAwB,GAACL,CAAzB;AAA2B;;AAAvC,CAAzC,EAAkF,CAAlF;AAAqF,IAAIM,kBAAJ;AAAuBZ,MAAM,CAACK,IAAP,CAAY,yBAAZ,EAAsC;AAACH,EAAAA,OAAO,CAACI,CAAD,EAAG;AAACM,IAAAA,kBAAkB,GAACN,CAAnB;AAAqB;;AAAjC,CAAtC,EAAyE,CAAzE;AAA4E,IAAIO,mBAAJ;AAAwBb,MAAM,CAACK,IAAP,CAAY,8BAAZ,EAA2C;AAACH,EAAAA,OAAO,CAACI,CAAD,EAAG;AAACO,IAAAA,mBAAmB,GAACP,CAApB;AAAsB;;AAAlC,CAA3C,EAA+E,CAA/E;;AAS1oB,MAAMH,eAAN,CAAsB;AACjC;;;;AAIAW,EAAAA,WAAW,CAACC,gBAAD,EAAmBC,QAAnB,EAA6B;AACpC,SAAKD,gBAAL,GAAwBA,gBAAxB;AACA,SAAKE,oBAAL,GAA4BF,gBAAgB,CAACE,oBAA7C;AACA,SAAKD,QAAL,GAAgBA,QAAhB;AACA,SAAKE,SAAL,GAAiBX,YAAY,CAACS,QAAD,CAA7B,CAJoC,CAMpC;;AACA,SAAKG,QAAL,GAAgB,KAAKC,WAAL,CAAiB,KAAKH,oBAAL,CAA0BE,QAA3C,CAAhB;AAEAR,IAAAA,wBAAwB,CAACU,MAAzB,CAAgC,IAAhC;AACH;AAED;;;;;;AAIAD,EAAAA,WAAW,CAACD,QAAD,EAAW;AAClB,UAAMG,cAAc,GAAG,KAAKL,oBAAL,CAA0BK,cAAjD;;AAEA,YAAQ,KAAKN,QAAb;AACI,WAAKZ,QAAQ,CAACmB,OAAd;AACA,WAAKnB,QAAQ,CAACoB,UAAd;AACI,eAAOL,QAAP;;AACJ,WAAKf,QAAQ,CAACqB,kBAAd;AACI,cAAMC,GAAG,GAAGhB,sBAAsB,CAAC,KAAKO,oBAAL,CAA0BU,QAA3B,CAAlC;AAEA,eAAOD,GAAG,CAACE,GAAJ,CAAQC,EAAE,IAAIhB,mBAAmB,CAACS,cAAD,EAAiBO,EAAjB,CAAjC,CAAP;;AACJ;AACI,cAAM,IAAIpB,MAAM,CAACqB,KAAX,CAAkB,gCAA+B,KAAKd,QAAS,EAA/D,CAAN;AATR;AAWH;AAED;;;;;AAGAe,EAAAA,OAAO,CAAC,GAAGC,IAAJ,EAAU;AACb,SAAKd,SAAL,CAAee,IAAf,CAAoB,IAApB,EAA0B,KAAKhB,oBAA/B,EAAqD,GAAGe,IAAxD;AACH;AAED;;;;;;;;AAMAE,EAAAA,gBAAgB,CAACC,KAAD,EAAQC,GAAR,EAAaC,QAAb,EAAuBC,sBAAvB,EAA+C;AAC3D1B,IAAAA,kBAAkB,CAAC,KAAKK,oBAAN,EAA4BkB,KAA5B,EAAmCC,GAAnC,EAAwCC,QAAxC,EAAkDC,sBAAlD,CAAlB;AACH;AAED;;;;;AAGAC,EAAAA,IAAI,GAAG;AACH,QAAI;AACA5B,MAAAA,wBAAwB,CAAC6B,MAAzB,CAAgC,IAAhC;AACH,KAFD,CAEE,OAAOC,CAAP,EAAU;AACRC,MAAAA,OAAO,CAACC,IAAR,CAAc,8EAAd,EAA6FF,CAA7F;AACH;AACJ;AAED;;;;;;;AAKAG,EAAAA,mBAAmB,GAAG;AAClB,WAAO,KAAK3B,oBAAL,CAA0B4B,gBAAjC;AACH;;AAxEgC","sourcesContent":["import { Strategy } from '../constants';\nimport { getProcessor } from '../processors';\nimport { _ } from 'meteor/underscore';\nimport { Meteor } from 'meteor/meteor';\nimport extractIdsFromSelector from '../utils/extractIdsFromSelector';\nimport RedisSubscriptionManager from './RedisSubscriptionManager';\nimport syntheticProcessor from '../processors/synthetic';\nimport getDedicatedChannel from '../utils/getDedicatedChannel';\n\nexport default class RedisSubscriber {\n    /**\n     * @param publicationEntry\n     * @param strategy\n     */\n    constructor(publicationEntry, strategy) {\n        this.publicationEntry = publicationEntry;\n        this.observableCollection = publicationEntry.observableCollection;\n        this.strategy = strategy;\n        this.processor = getProcessor(strategy);\n\n        // We do this because we override the behavior of dedicated \"_id\" channels\n        this.channels = this.getChannels(this.observableCollection.channels);\n\n        RedisSubscriptionManager.attach(this);\n    }\n\n    /**\n     * @param channels\n     * @returns {*}\n     */\n    getChannels(channels) {\n        const collectionName = this.observableCollection.collectionName;\n\n        switch (this.strategy) {\n            case Strategy.DEFAULT:\n            case Strategy.LIMIT_SORT:\n                return channels;\n            case Strategy.DEDICATED_CHANNELS:\n                const ids = extractIdsFromSelector(this.observableCollection.selector);\n\n                return ids.map(id => getDedicatedChannel(collectionName, id));\n            default:\n                throw new Meteor.Error(`Strategy could not be found: ${this.strategy}`)\n        }\n    }\n\n    /**\n     * @param args\n     */\n    process(...args) {\n        this.processor.call(null, this.observableCollection, ...args);\n    }\n\n    /**\n     * @param event\n     * @param doc\n     * @param modifier\n     * @param modifiedTopLevelFields\n     */\n    processSynthetic(event, doc, modifier, modifiedTopLevelFields) {\n        syntheticProcessor(this.observableCollection, event, doc, modifier, modifiedTopLevelFields);\n    }\n\n    /**\n     * Detaches from RedisSubscriptionManager\n     */\n    stop() {\n        try {\n            RedisSubscriptionManager.detach(this);\n        } catch (e) {\n            console.warn(`[RedisSubscriber] Weird! There was an error while stopping the publication: `, e);\n        }\n    }\n\n    /**\n     * Retrieves the fields that are used for matching the validity of the document\n     *\n     * @returns {array}\n     */\n    getFieldsOfInterest() {\n        return this.observableCollection.fieldsOfInterest;\n    }\n}\n"]},"sourceType":"script","hash":"2c2a14b009dc8322287e73a929b9ce6ed3b8f52c"}

{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/promotions/promotionClientHelpers.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"imports/core/api/promotions/promotionClientHelpers.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/promotions/promotionClientHelpers.js","inputSourceMap":{"version":3,"sources":["imports/core/api/promotions/promotionClientHelpers.js"],"names":["PROMOTION_INVITED_BY_TYPE","PROMOTION_LOT_STATUS","getCurrentUserPermissionsForPromotion","currentUser","promotions","promotionId","promotion","find","_id","$metadata","permissions","getPromotionCustomerOwnerType","invitedBy","userId","organisations","USER","organisationUserIds","reduce","userIds","users","map","includes","ORGANISATION","ANY","clientGetBestPromotionLotStatus","promotionOptions","loanId","myPromotionLotStatuses","arr","promotionLots","filter","attributedToLink","status","indexOf","SOLD","BOOKED","AVAILABLE","shouldHideForLotStatus","forLotStatus","promotionLotStatus","isAttributed","shouldAnonymize","customerOwnerType","displayCustomerNames","shouldHide"],"mappings":"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","sourcesContent":["import { PROMOTION_INVITED_BY_TYPE } from './promotionConstants';\nimport { PROMOTION_LOT_STATUS } from '../promotionLots/promotionLotConstants';\n\nexport const getCurrentUserPermissionsForPromotion = ({\n  currentUser: { promotions = [] } = {},\n  promotionId,\n}) => {\n  const promotion = promotions.find(({ _id }) => _id === promotionId);\n  return promotion && promotion.$metadata.permissions;\n};\n\nexport const getPromotionCustomerOwnerType = ({ invitedBy, currentUser }) => {\n  const { _id: userId, organisations = [] } = currentUser;\n\n  // Is invited by nobody\n  if (!invitedBy) {\n    return null;\n  }\n\n  // Is invited by user\n  if (invitedBy === userId) {\n    return PROMOTION_INVITED_BY_TYPE.USER;\n  }\n\n  const organisationUserIds = organisations.reduce(\n    (userIds, { users = [] }) => [...userIds, ...users.map(({ _id }) => _id)],\n    [],\n  );\n\n  // Is invited by organisation\n  if (organisationUserIds.includes(invitedBy)) {\n    return PROMOTION_INVITED_BY_TYPE.ORGANISATION;\n  }\n\n  // Is invited by someone else\n  return PROMOTION_INVITED_BY_TYPE.ANY;\n};\n\nexport const clientGetBestPromotionLotStatus = (promotionOptions, loanId) => {\n  const myPromotionLotStatuses = promotionOptions\n    .reduce((arr, { promotionLots }) => [...arr, ...promotionLots], [])\n    .filter(({ attributedToLink = {} }) => attributedToLink._id === loanId)\n    .map(({ status }) => status);\n\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.SOLD) >= 0) {\n    return PROMOTION_LOT_STATUS.SOLD;\n  }\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.BOOKED) >= 0) {\n    return PROMOTION_LOT_STATUS.BOOKED;\n  }\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.AVAILABLE) >= 0) {\n    return PROMOTION_LOT_STATUS.AVAILABLE;\n  }\n\n  // return undefined if no promotion lots are attributed to this user\n};\n\nconst shouldHideForLotStatus = (\n  { forLotStatus = [] },\n  promotionLotStatus,\n  isAttributed,\n) => {\n  if (\n    promotionLotStatus === PROMOTION_LOT_STATUS.AVAILABLE\n    && forLotStatus.includes(promotionLotStatus)\n  ) {\n    return false;\n  }\n\n  // For status BOOKED and SOLD, we check that it is attributed\n  if (forLotStatus.includes(promotionLotStatus) && isAttributed) {\n    return false;\n  }\n\n  return true;\n};\n\nexport const shouldAnonymize = ({\n  customerOwnerType,\n  permissions,\n  promotionLotStatus = PROMOTION_LOT_STATUS.AVAILABLE,\n  isAttributed,\n}) => {\n  const { displayCustomerNames } = permissions;\n\n  if (displayCustomerNames === false || !customerOwnerType) {\n    return true;\n  }\n\n  const shouldHide = shouldHideForLotStatus(\n    displayCustomerNames,\n    promotionLotStatus,\n    isAttributed,\n  );\n\n  if (displayCustomerNames.invitedBy === PROMOTION_INVITED_BY_TYPE.ANY) {\n    return shouldHide;\n  }\n\n  switch (customerOwnerType) {\n  case PROMOTION_INVITED_BY_TYPE.USER:\n    return (\n      shouldHide\n        || ![\n          PROMOTION_INVITED_BY_TYPE.USER,\n          PROMOTION_INVITED_BY_TYPE.ORGANISATION,\n        ].includes(displayCustomerNames.invitedBy)\n    );\n  case PROMOTION_INVITED_BY_TYPE.ORGANISATION:\n    return (\n      shouldHide\n        || displayCustomerNames.invitedBy\n          !== PROMOTION_INVITED_BY_TYPE.ORGANISATION\n    );\n  default:\n    return true;\n  }\n};\n"]},"passPerPreset":false,"envName":"development","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/promotions/promotionClientHelpers.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/api/promotions/promotionClientHelpers.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _toConsumableArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/toConsumableArray\"));\n\nmodule.export({\n  getCurrentUserPermissionsForPromotion: function () {\n    return getCurrentUserPermissionsForPromotion;\n  },\n  getPromotionCustomerOwnerType: function () {\n    return getPromotionCustomerOwnerType;\n  },\n  clientGetBestPromotionLotStatus: function () {\n    return clientGetBestPromotionLotStatus;\n  },\n  shouldAnonymize: function () {\n    return shouldAnonymize;\n  }\n});\nvar PROMOTION_INVITED_BY_TYPE;\nmodule.link(\"./promotionConstants\", {\n  PROMOTION_INVITED_BY_TYPE: function (v) {\n    PROMOTION_INVITED_BY_TYPE = v;\n  }\n}, 0);\nvar PROMOTION_LOT_STATUS;\nmodule.link(\"../promotionLots/promotionLotConstants\", {\n  PROMOTION_LOT_STATUS: function (v) {\n    PROMOTION_LOT_STATUS = v;\n  }\n}, 1);\n\nvar getCurrentUserPermissionsForPromotion = function (_ref) {\n  var _ref$currentUser = _ref.currentUser;\n  _ref$currentUser = _ref$currentUser === void 0 ? {} : _ref$currentUser;\n  var _ref$currentUser$prom = _ref$currentUser.promotions,\n      promotions = _ref$currentUser$prom === void 0 ? [] : _ref$currentUser$prom,\n      promotionId = _ref.promotionId;\n  var promotion = promotions.find(function (_ref2) {\n    var _id = _ref2._id;\n    return _id === promotionId;\n  });\n  return promotion && promotion.$metadata.permissions;\n};\n\nvar getPromotionCustomerOwnerType = function (_ref3) {\n  var invitedBy = _ref3.invitedBy,\n      currentUser = _ref3.currentUser;\n  var userId = currentUser._id,\n      _currentUser$organisa = currentUser.organisations,\n      organisations = _currentUser$organisa === void 0 ? [] : _currentUser$organisa; // Is invited by nobody\n\n  if (!invitedBy) {\n    return null;\n  } // Is invited by user\n\n\n  if (invitedBy === userId) {\n    return PROMOTION_INVITED_BY_TYPE.USER;\n  }\n\n  var organisationUserIds = organisations.reduce(function (userIds, _ref4) {\n    var _ref4$users = _ref4.users,\n        users = _ref4$users === void 0 ? [] : _ref4$users;\n    return [].concat((0, _toConsumableArray2.default)(userIds), (0, _toConsumableArray2.default)(users.map(function (_ref5) {\n      var _id = _ref5._id;\n      return _id;\n    })));\n  }, []); // Is invited by organisation\n\n  if (organisationUserIds.includes(invitedBy)) {\n    return PROMOTION_INVITED_BY_TYPE.ORGANISATION;\n  } // Is invited by someone else\n\n\n  return PROMOTION_INVITED_BY_TYPE.ANY;\n};\n\nvar clientGetBestPromotionLotStatus = function (promotionOptions, loanId) {\n  var myPromotionLotStatuses = promotionOptions.reduce(function (arr, _ref6) {\n    var promotionLots = _ref6.promotionLots;\n    return [].concat((0, _toConsumableArray2.default)(arr), (0, _toConsumableArray2.default)(promotionLots));\n  }, []).filter(function (_ref7) {\n    var _ref7$attributedToLin = _ref7.attributedToLink,\n        attributedToLink = _ref7$attributedToLin === void 0 ? {} : _ref7$attributedToLin;\n    return attributedToLink._id === loanId;\n  }).map(function (_ref8) {\n    var status = _ref8.status;\n    return status;\n  });\n\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.SOLD) >= 0) {\n    return PROMOTION_LOT_STATUS.SOLD;\n  }\n\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.BOOKED) >= 0) {\n    return PROMOTION_LOT_STATUS.BOOKED;\n  }\n\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.AVAILABLE) >= 0) {\n    return PROMOTION_LOT_STATUS.AVAILABLE;\n  } // return undefined if no promotion lots are attributed to this user\n\n};\n\nvar shouldHideForLotStatus = function (_ref9, promotionLotStatus, isAttributed) {\n  var _ref9$forLotStatus = _ref9.forLotStatus,\n      forLotStatus = _ref9$forLotStatus === void 0 ? [] : _ref9$forLotStatus;\n\n  if (promotionLotStatus === PROMOTION_LOT_STATUS.AVAILABLE && forLotStatus.includes(promotionLotStatus)) {\n    return false;\n  } // For status BOOKED and SOLD, we check that it is attributed\n\n\n  if (forLotStatus.includes(promotionLotStatus) && isAttributed) {\n    return false;\n  }\n\n  return true;\n};\n\nvar shouldAnonymize = function (_ref10) {\n  var customerOwnerType = _ref10.customerOwnerType,\n      permissions = _ref10.permissions,\n      _ref10$promotionLotSt = _ref10.promotionLotStatus,\n      promotionLotStatus = _ref10$promotionLotSt === void 0 ? PROMOTION_LOT_STATUS.AVAILABLE : _ref10$promotionLotSt,\n      isAttributed = _ref10.isAttributed;\n  var displayCustomerNames = permissions.displayCustomerNames;\n\n  if (displayCustomerNames === false || !customerOwnerType) {\n    return true;\n  }\n\n  var shouldHide = shouldHideForLotStatus(displayCustomerNames, promotionLotStatus, isAttributed);\n\n  if (displayCustomerNames.invitedBy === PROMOTION_INVITED_BY_TYPE.ANY) {\n    return shouldHide;\n  }\n\n  switch (customerOwnerType) {\n    case PROMOTION_INVITED_BY_TYPE.USER:\n      return shouldHide || ![PROMOTION_INVITED_BY_TYPE.USER, PROMOTION_INVITED_BY_TYPE.ORGANISATION].includes(displayCustomerNames.invitedBy);\n\n    case PROMOTION_INVITED_BY_TYPE.ORGANISATION:\n      return shouldHide || displayCustomerNames.invitedBy !== PROMOTION_INVITED_BY_TYPE.ORGANISATION;\n\n    default:\n      return true;\n  }\n};","map":{"version":3,"sources":["imports/core/api/promotions/promotionClientHelpers.js"],"names":["PROMOTION_INVITED_BY_TYPE","getCurrentUserPermissionsForPromotion","currentUser","promotions","promotionId","promotion","_id","getPromotionCustomerOwnerType","organisations","invitedBy","organisationUserIds","users","clientGetBestPromotionLotStatus","myPromotionLotStatuses","promotionLots","attributedToLink","status","PROMOTION_LOT_STATUS","shouldHideForLotStatus","forLotStatus","promotionLotStatus","shouldAnonymize","isAttributed","displayCustomerNames","shouldHide"],"mappings":"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","sourcesContent":["import { PROMOTION_INVITED_BY_TYPE } from './promotionConstants';\nimport { PROMOTION_LOT_STATUS } from '../promotionLots/promotionLotConstants';\n\nexport const getCurrentUserPermissionsForPromotion = ({\n  currentUser: { promotions = [] } = {},\n  promotionId,\n}) => {\n  const promotion = promotions.find(({ _id }) => _id === promotionId);\n  return promotion && promotion.$metadata.permissions;\n};\n\nexport const getPromotionCustomerOwnerType = ({ invitedBy, currentUser }) => {\n  const { _id: userId, organisations = [] } = currentUser;\n\n  // Is invited by nobody\n  if (!invitedBy) {\n    return null;\n  }\n\n  // Is invited by user\n  if (invitedBy === userId) {\n    return PROMOTION_INVITED_BY_TYPE.USER;\n  }\n\n  const organisationUserIds = organisations.reduce(\n    (userIds, { users = [] }) => [...userIds, ...users.map(({ _id }) => _id)],\n    [],\n  );\n\n  // Is invited by organisation\n  if (organisationUserIds.includes(invitedBy)) {\n    return PROMOTION_INVITED_BY_TYPE.ORGANISATION;\n  }\n\n  // Is invited by someone else\n  return PROMOTION_INVITED_BY_TYPE.ANY;\n};\n\nexport const clientGetBestPromotionLotStatus = (promotionOptions, loanId) => {\n  const myPromotionLotStatuses = promotionOptions\n    .reduce((arr, { promotionLots }) => [...arr, ...promotionLots], [])\n    .filter(({ attributedToLink = {} }) => attributedToLink._id === loanId)\n    .map(({ status }) => status);\n\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.SOLD) >= 0) {\n    return PROMOTION_LOT_STATUS.SOLD;\n  }\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.BOOKED) >= 0) {\n    return PROMOTION_LOT_STATUS.BOOKED;\n  }\n  if (myPromotionLotStatuses.indexOf(PROMOTION_LOT_STATUS.AVAILABLE) >= 0) {\n    return PROMOTION_LOT_STATUS.AVAILABLE;\n  }\n\n  // return undefined if no promotion lots are attributed to this user\n};\n\nconst shouldHideForLotStatus = (\n  { forLotStatus = [] },\n  promotionLotStatus,\n  isAttributed,\n) => {\n  if (\n    promotionLotStatus === PROMOTION_LOT_STATUS.AVAILABLE\n    && forLotStatus.includes(promotionLotStatus)\n  ) {\n    return false;\n  }\n\n  // For status BOOKED and SOLD, we check that it is attributed\n  if (forLotStatus.includes(promotionLotStatus) && isAttributed) {\n    return false;\n  }\n\n  return true;\n};\n\nexport const shouldAnonymize = ({\n  customerOwnerType,\n  permissions,\n  promotionLotStatus = PROMOTION_LOT_STATUS.AVAILABLE,\n  isAttributed,\n}) => {\n  const { displayCustomerNames } = permissions;\n\n  if (displayCustomerNames === false || !customerOwnerType) {\n    return true;\n  }\n\n  const shouldHide = shouldHideForLotStatus(\n    displayCustomerNames,\n    promotionLotStatus,\n    isAttributed,\n  );\n\n  if (displayCustomerNames.invitedBy === PROMOTION_INVITED_BY_TYPE.ANY) {\n    return shouldHide;\n  }\n\n  switch (customerOwnerType) {\n  case PROMOTION_INVITED_BY_TYPE.USER:\n    return (\n      shouldHide\n        || ![\n          PROMOTION_INVITED_BY_TYPE.USER,\n          PROMOTION_INVITED_BY_TYPE.ORGANISATION,\n        ].includes(displayCustomerNames.invitedBy)\n    );\n  case PROMOTION_INVITED_BY_TYPE.ORGANISATION:\n    return (\n      shouldHide\n        || displayCustomerNames.invitedBy\n          !== PROMOTION_INVITED_BY_TYPE.ORGANISATION\n    );\n  default:\n    return true;\n  }\n};\n"]},"sourceType":"script","hash":"98388c29a2a028cd990316260a35d7dadcbd570b"}

{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/factories/factoriesHelpers.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"imports/core/api/factories/factoriesHelpers.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/factories/factoriesHelpers.js","inputSourceMap":{"version":3,"sources":["imports/core/api/factories/factoriesHelpers.js"],"names":["Factory","Mongo","pick","omit","uniq","uniqBy","CollectionService","COLLECTIONS","NOTIFICATIONS_COLLECTION","ACTIVITIES_COLLECTION","getSingularFactoryName","collection","LOANS_COLLECTION","BORROWERS_COLLECTION","PROPERTIES_COLLECTION","USERS_COLLECTION","TASKS_COLLECTION","OFFERS_COLLECTION","PROMOTIONS_COLLECTION","PROMOTION_OPTIONS_COLLECTION","PROMOTION_LOTS_COLLECTION","LOTS_COLLECTION","MORTGAGE_NOTES_COLLECTION","ORGANISATIONS_COLLECTION","LENDERS_COLLECTION","CONTACTS_COLLECTION","Error","arrayify","maybeArray","Array","isArray","findCollectionNameByLinkName","linkName","Collection","get","__links","linkConfig","_name","findLinkKeys","linkNames","links","Object","keys","insertDoc","doc","useFactories","factory","docExists","_id","findOne","create","error","message","insert","generator","scenario","ids","docs","docsById","pushId","id","pushDoc","createNestedObject","linkKeys","docToInsert","insertedDoc","_factory","linksToInsert","forEach","linkCollection","linkedDocs","linkedDoc","linkId","parentId","collectionService","addLink","metadata","$metadata","docsInCollection"],"mappings":"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","sourcesContent":["import { Factory } from 'meteor/dburles:factory';\nimport { Mongo } from 'meteor/mongo';\nimport pick from 'lodash/pick';\nimport omit from 'lodash/omit';\nimport uniq from 'lodash/uniq';\nimport uniqBy from 'lodash/uniqBy';\n\nimport CollectionService from '../helpers/CollectionService';\nimport { COLLECTIONS } from '../constants';\nimport { NOTIFICATIONS_COLLECTION } from '../notifications/notificationConstants';\nimport { ACTIVITIES_COLLECTION } from '../activities/activityConstants';\n\nconst getSingularFactoryName = (collection) => {\n  switch (collection) {\n  case COLLECTIONS.LOANS_COLLECTION:\n    return 'loan';\n  case COLLECTIONS.BORROWERS_COLLECTION:\n    return 'borrower';\n  case COLLECTIONS.PROPERTIES_COLLECTION:\n    return 'property';\n  case COLLECTIONS.USERS_COLLECTION:\n    return 'user';\n  case COLLECTIONS.TASKS_COLLECTION:\n    return 'task';\n  case COLLECTIONS.OFFERS_COLLECTION:\n    return 'offer';\n  case COLLECTIONS.PROMOTIONS_COLLECTION:\n    return 'promotion';\n  case COLLECTIONS.PROMOTION_OPTIONS_COLLECTION:\n    return 'promotionOption';\n  case COLLECTIONS.PROMOTION_LOTS_COLLECTION:\n    return 'promotionLot';\n  case COLLECTIONS.LOTS_COLLECTION:\n    return 'lot';\n  case COLLECTIONS.MORTGAGE_NOTES_COLLECTION:\n    return 'mortgageNote';\n  case COLLECTIONS.ORGANISATIONS_COLLECTION:\n    return 'organisation';\n  case COLLECTIONS.LENDERS_COLLECTION:\n    return 'lender';\n  case COLLECTIONS.CONTACTS_COLLECTION:\n    return 'contact';\n  case NOTIFICATIONS_COLLECTION:\n    return 'notification';\n  case ACTIVITIES_COLLECTION:\n    return 'activity';\n  default:\n    throw new Error(`No singular factory name found for ${collection}, add it in the generator`);\n  }\n};\n\nconst arrayify = maybeArray =>\n  (Array.isArray(maybeArray) ? maybeArray : [maybeArray]);\n\nconst findCollectionNameByLinkName = ({ collection, linkName }) =>\n  Mongo.Collection.get(collection).__links[linkName].linkConfig.collection\n    ._name;\n\nconst findLinkKeys = ({ collection }) => {\n  const { __links: linkNames = {} } = Mongo.Collection.get(collection);\n  const links = Object.keys(linkNames);\n  return links;\n};\n\nconst insertDoc = ({ doc, collection, useFactories, factory }) => {\n  let docExists = false;\n\n  if (doc._id) {\n    docExists = !!Mongo.Collection.get(collection).findOne(doc._id);\n  }\n\n  if (docExists) {\n    return doc;\n  }\n\n  if (useFactories && factory !== null) {\n    if (factory) {\n      return Factory.create(factory, doc);\n    }\n\n    try {\n      return Factory.create(collection, doc);\n    } catch (error) {\n      if (\n        error.message\n        && error.message === `Factory: There is no factory named ${collection}`\n      ) {\n        return Factory.create(getSingularFactoryName(collection), doc);\n      }\n      throw error;\n    }\n  }\n\n  const _id = Mongo.Collection.get(collection).insert(doc);\n  return Mongo.Collection.get(collection).findOne(_id);\n};\n\nconst generator = (scenario, { useFactories = true } = {}) => {\n  const ids = {};\n  const docs = {};\n  const docsById = {};\n\n  const pushId = ({ id, collection }) => {\n    ids[collection] = ids[collection] ? [...ids[collection], id] : [id];\n    ids[collection] = uniq(ids[collection]);\n  };\n\n  const pushDoc = ({ doc, collection }) => {\n    docs[collection] = docs[collection] ? [...docs[collection], doc] : [doc];\n    docs[collection] = uniqBy(docs[collection], '_id');\n\n    docsById[collection] = docsById[collection]\n      ? { ...docsById[collection], [doc._id]: doc }\n      : { [doc._id]: doc };\n  };\n\n  const createNestedObject = ({ doc, collection }) => {\n    const linkKeys = findLinkKeys({ doc, collection });\n\n    const docToInsert = omit(doc, [...linkKeys, '_factory', '$metadata']);\n\n    const insertedDoc = insertDoc({\n      collection,\n      doc: docToInsert,\n      useFactories,\n      factory: doc._factory,\n    });\n    const { _id: id } = insertedDoc;\n    pushId({ id, collection });\n    pushDoc({ doc: insertedDoc, collection });\n\n    const linksToInsert = pick(doc, linkKeys);\n\n    Object.keys(linksToInsert).forEach((linkName) => {\n      const linkCollection = findCollectionNameByLinkName({\n        collection,\n        linkName,\n      });\n      const linkedDocs = arrayify(linksToInsert[linkName]);\n      linkedDocs.forEach((linkedDoc) => {\n        const linkId = createNestedObject({\n          doc: linkedDoc,\n          collection: linkCollection,\n          parentId: id,\n        });\n        const collectionService = new CollectionService(Mongo.Collection.get(collection));\n        collectionService.addLink({\n          id,\n          linkName,\n          linkId,\n          metadata: linkedDoc.$metadata,\n        });\n      });\n    });\n\n    return id;\n  };\n\n  Object.keys(scenario).forEach((collection) => {\n    const docsInCollection = arrayify(scenario[collection]);\n    docsInCollection.forEach(doc => createNestedObject({ doc, collection }));\n  });\n\n  return { ids, docs, docsById };\n};\n\nexport default generator;\n"]},"passPerPreset":false,"envName":"development","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/factories/factoriesHelpers.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/api/factories/factoriesHelpers.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nlet Factory;\nmodule.link(\"meteor/dburles:factory\", {\n  Factory(v) {\n    Factory = v;\n  }\n\n}, 0);\nlet Mongo;\nmodule.link(\"meteor/mongo\", {\n  Mongo(v) {\n    Mongo = v;\n  }\n\n}, 1);\nlet pick;\nmodule.link(\"lodash/pick\", {\n  default(v) {\n    pick = v;\n  }\n\n}, 2);\nlet omit;\nmodule.link(\"lodash/omit\", {\n  default(v) {\n    omit = v;\n  }\n\n}, 3);\nlet uniq;\nmodule.link(\"lodash/uniq\", {\n  default(v) {\n    uniq = v;\n  }\n\n}, 4);\nlet uniqBy;\nmodule.link(\"lodash/uniqBy\", {\n  default(v) {\n    uniqBy = v;\n  }\n\n}, 5);\nlet CollectionService;\nmodule.link(\"../helpers/CollectionService\", {\n  default(v) {\n    CollectionService = v;\n  }\n\n}, 6);\nlet COLLECTIONS;\nmodule.link(\"../constants\", {\n  COLLECTIONS(v) {\n    COLLECTIONS = v;\n  }\n\n}, 7);\nlet NOTIFICATIONS_COLLECTION;\nmodule.link(\"../notifications/notificationConstants\", {\n  NOTIFICATIONS_COLLECTION(v) {\n    NOTIFICATIONS_COLLECTION = v;\n  }\n\n}, 8);\nlet ACTIVITIES_COLLECTION;\nmodule.link(\"../activities/activityConstants\", {\n  ACTIVITIES_COLLECTION(v) {\n    ACTIVITIES_COLLECTION = v;\n  }\n\n}, 9);\n\nconst getSingularFactoryName = collection => {\n  switch (collection) {\n    case COLLECTIONS.LOANS_COLLECTION:\n      return 'loan';\n\n    case COLLECTIONS.BORROWERS_COLLECTION:\n      return 'borrower';\n\n    case COLLECTIONS.PROPERTIES_COLLECTION:\n      return 'property';\n\n    case COLLECTIONS.USERS_COLLECTION:\n      return 'user';\n\n    case COLLECTIONS.TASKS_COLLECTION:\n      return 'task';\n\n    case COLLECTIONS.OFFERS_COLLECTION:\n      return 'offer';\n\n    case COLLECTIONS.PROMOTIONS_COLLECTION:\n      return 'promotion';\n\n    case COLLECTIONS.PROMOTION_OPTIONS_COLLECTION:\n      return 'promotionOption';\n\n    case COLLECTIONS.PROMOTION_LOTS_COLLECTION:\n      return 'promotionLot';\n\n    case COLLECTIONS.LOTS_COLLECTION:\n      return 'lot';\n\n    case COLLECTIONS.MORTGAGE_NOTES_COLLECTION:\n      return 'mortgageNote';\n\n    case COLLECTIONS.ORGANISATIONS_COLLECTION:\n      return 'organisation';\n\n    case COLLECTIONS.LENDERS_COLLECTION:\n      return 'lender';\n\n    case COLLECTIONS.CONTACTS_COLLECTION:\n      return 'contact';\n\n    case NOTIFICATIONS_COLLECTION:\n      return 'notification';\n\n    case ACTIVITIES_COLLECTION:\n      return 'activity';\n\n    default:\n      throw new Error(\"No singular factory name found for \".concat(collection, \", add it in the generator\"));\n  }\n};\n\nconst arrayify = maybeArray => Array.isArray(maybeArray) ? maybeArray : [maybeArray];\n\nconst findCollectionNameByLinkName = (_ref) => {\n  let {\n    collection,\n    linkName\n  } = _ref;\n  return Mongo.Collection.get(collection).__links[linkName].linkConfig.collection._name;\n};\n\nconst findLinkKeys = (_ref2) => {\n  let {\n    collection\n  } = _ref2;\n  const {\n    __links: linkNames = {}\n  } = Mongo.Collection.get(collection);\n  const links = Object.keys(linkNames);\n  return links;\n};\n\nconst insertDoc = (_ref3) => {\n  let {\n    doc,\n    collection,\n    useFactories,\n    factory\n  } = _ref3;\n  let docExists = false;\n\n  if (doc._id) {\n    docExists = !!Mongo.Collection.get(collection).findOne(doc._id);\n  }\n\n  if (docExists) {\n    return doc;\n  }\n\n  if (useFactories && factory !== null) {\n    if (factory) {\n      return Factory.create(factory, doc);\n    }\n\n    try {\n      return Factory.create(collection, doc);\n    } catch (error) {\n      if (error.message && error.message === \"Factory: There is no factory named \".concat(collection)) {\n        return Factory.create(getSingularFactoryName(collection), doc);\n      }\n\n      throw error;\n    }\n  }\n\n  const _id = Mongo.Collection.get(collection).insert(doc);\n\n  return Mongo.Collection.get(collection).findOne(_id);\n};\n\nconst generator = function (scenario) {\n  let {\n    useFactories = true\n  } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n  const ids = {};\n  const docs = {};\n  const docsById = {};\n\n  const pushId = (_ref4) => {\n    let {\n      id,\n      collection\n    } = _ref4;\n    ids[collection] = ids[collection] ? [...ids[collection], id] : [id];\n    ids[collection] = uniq(ids[collection]);\n  };\n\n  const pushDoc = (_ref5) => {\n    let {\n      doc,\n      collection\n    } = _ref5;\n    docs[collection] = docs[collection] ? [...docs[collection], doc] : [doc];\n    docs[collection] = uniqBy(docs[collection], '_id');\n    docsById[collection] = docsById[collection] ? (0, _objectSpread2.default)({}, docsById[collection], {\n      [doc._id]: doc\n    }) : {\n      [doc._id]: doc\n    };\n  };\n\n  const createNestedObject = (_ref6) => {\n    let {\n      doc,\n      collection\n    } = _ref6;\n    const linkKeys = findLinkKeys({\n      doc,\n      collection\n    });\n    const docToInsert = omit(doc, [...linkKeys, '_factory', '$metadata']);\n    const insertedDoc = insertDoc({\n      collection,\n      doc: docToInsert,\n      useFactories,\n      factory: doc._factory\n    });\n    const {\n      _id: id\n    } = insertedDoc;\n    pushId({\n      id,\n      collection\n    });\n    pushDoc({\n      doc: insertedDoc,\n      collection\n    });\n    const linksToInsert = pick(doc, linkKeys);\n    Object.keys(linksToInsert).forEach(linkName => {\n      const linkCollection = findCollectionNameByLinkName({\n        collection,\n        linkName\n      });\n      const linkedDocs = arrayify(linksToInsert[linkName]);\n      linkedDocs.forEach(linkedDoc => {\n        const linkId = createNestedObject({\n          doc: linkedDoc,\n          collection: linkCollection,\n          parentId: id\n        });\n        const collectionService = new CollectionService(Mongo.Collection.get(collection));\n        collectionService.addLink({\n          id,\n          linkName,\n          linkId,\n          metadata: linkedDoc.$metadata\n        });\n      });\n    });\n    return id;\n  };\n\n  Object.keys(scenario).forEach(collection => {\n    const docsInCollection = arrayify(scenario[collection]);\n    docsInCollection.forEach(doc => createNestedObject({\n      doc,\n      collection\n    }));\n  });\n  return {\n    ids,\n    docs,\n    docsById\n  };\n};\n\nmodule.exportDefault(generator);","map":{"version":3,"sources":["imports/core/api/factories/factoriesHelpers.js"],"names":["getSingularFactoryName","collection","COLLECTIONS","arrayify","maybeArray","Array","findCollectionNameByLinkName","linkName","Mongo","findLinkKeys","__links","linkNames","links","Object","insertDoc","factory","docExists","doc","useFactories","Factory","error","_id","generator","ids","docs","docsById","pushId","uniq","pushDoc","uniqBy","createNestedObject","linkKeys","docToInsert","omit","insertedDoc","_factory","id","linksToInsert","pick","linkCollection","linkedDocs","linkedDoc","linkId","parentId","collectionService","metadata","$metadata","docsInCollection","scenario"],"mappings":"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","sourcesContent":["import { Factory } from 'meteor/dburles:factory';\nimport { Mongo } from 'meteor/mongo';\nimport pick from 'lodash/pick';\nimport omit from 'lodash/omit';\nimport uniq from 'lodash/uniq';\nimport uniqBy from 'lodash/uniqBy';\n\nimport CollectionService from '../helpers/CollectionService';\nimport { COLLECTIONS } from '../constants';\nimport { NOTIFICATIONS_COLLECTION } from '../notifications/notificationConstants';\nimport { ACTIVITIES_COLLECTION } from '../activities/activityConstants';\n\nconst getSingularFactoryName = (collection) => {\n  switch (collection) {\n  case COLLECTIONS.LOANS_COLLECTION:\n    return 'loan';\n  case COLLECTIONS.BORROWERS_COLLECTION:\n    return 'borrower';\n  case COLLECTIONS.PROPERTIES_COLLECTION:\n    return 'property';\n  case COLLECTIONS.USERS_COLLECTION:\n    return 'user';\n  case COLLECTIONS.TASKS_COLLECTION:\n    return 'task';\n  case COLLECTIONS.OFFERS_COLLECTION:\n    return 'offer';\n  case COLLECTIONS.PROMOTIONS_COLLECTION:\n    return 'promotion';\n  case COLLECTIONS.PROMOTION_OPTIONS_COLLECTION:\n    return 'promotionOption';\n  case COLLECTIONS.PROMOTION_LOTS_COLLECTION:\n    return 'promotionLot';\n  case COLLECTIONS.LOTS_COLLECTION:\n    return 'lot';\n  case COLLECTIONS.MORTGAGE_NOTES_COLLECTION:\n    return 'mortgageNote';\n  case COLLECTIONS.ORGANISATIONS_COLLECTION:\n    return 'organisation';\n  case COLLECTIONS.LENDERS_COLLECTION:\n    return 'lender';\n  case COLLECTIONS.CONTACTS_COLLECTION:\n    return 'contact';\n  case NOTIFICATIONS_COLLECTION:\n    return 'notification';\n  case ACTIVITIES_COLLECTION:\n    return 'activity';\n  default:\n    throw new Error(`No singular factory name found for ${collection}, add it in the generator`);\n  }\n};\n\nconst arrayify = maybeArray =>\n  (Array.isArray(maybeArray) ? maybeArray : [maybeArray]);\n\nconst findCollectionNameByLinkName = ({ collection, linkName }) =>\n  Mongo.Collection.get(collection).__links[linkName].linkConfig.collection\n    ._name;\n\nconst findLinkKeys = ({ collection }) => {\n  const { __links: linkNames = {} } = Mongo.Collection.get(collection);\n  const links = Object.keys(linkNames);\n  return links;\n};\n\nconst insertDoc = ({ doc, collection, useFactories, factory }) => {\n  let docExists = false;\n\n  if (doc._id) {\n    docExists = !!Mongo.Collection.get(collection).findOne(doc._id);\n  }\n\n  if (docExists) {\n    return doc;\n  }\n\n  if (useFactories && factory !== null) {\n    if (factory) {\n      return Factory.create(factory, doc);\n    }\n\n    try {\n      return Factory.create(collection, doc);\n    } catch (error) {\n      if (\n        error.message\n        && error.message === `Factory: There is no factory named ${collection}`\n      ) {\n        return Factory.create(getSingularFactoryName(collection), doc);\n      }\n      throw error;\n    }\n  }\n\n  const _id = Mongo.Collection.get(collection).insert(doc);\n  return Mongo.Collection.get(collection).findOne(_id);\n};\n\nconst generator = (scenario, { useFactories = true } = {}) => {\n  const ids = {};\n  const docs = {};\n  const docsById = {};\n\n  const pushId = ({ id, collection }) => {\n    ids[collection] = ids[collection] ? [...ids[collection], id] : [id];\n    ids[collection] = uniq(ids[collection]);\n  };\n\n  const pushDoc = ({ doc, collection }) => {\n    docs[collection] = docs[collection] ? [...docs[collection], doc] : [doc];\n    docs[collection] = uniqBy(docs[collection], '_id');\n\n    docsById[collection] = docsById[collection]\n      ? { ...docsById[collection], [doc._id]: doc }\n      : { [doc._id]: doc };\n  };\n\n  const createNestedObject = ({ doc, collection }) => {\n    const linkKeys = findLinkKeys({ doc, collection });\n\n    const docToInsert = omit(doc, [...linkKeys, '_factory', '$metadata']);\n\n    const insertedDoc = insertDoc({\n      collection,\n      doc: docToInsert,\n      useFactories,\n      factory: doc._factory,\n    });\n    const { _id: id } = insertedDoc;\n    pushId({ id, collection });\n    pushDoc({ doc: insertedDoc, collection });\n\n    const linksToInsert = pick(doc, linkKeys);\n\n    Object.keys(linksToInsert).forEach((linkName) => {\n      const linkCollection = findCollectionNameByLinkName({\n        collection,\n        linkName,\n      });\n      const linkedDocs = arrayify(linksToInsert[linkName]);\n      linkedDocs.forEach((linkedDoc) => {\n        const linkId = createNestedObject({\n          doc: linkedDoc,\n          collection: linkCollection,\n          parentId: id,\n        });\n        const collectionService = new CollectionService(Mongo.Collection.get(collection));\n        collectionService.addLink({\n          id,\n          linkName,\n          linkId,\n          metadata: linkedDoc.$metadata,\n        });\n      });\n    });\n\n    return id;\n  };\n\n  Object.keys(scenario).forEach((collection) => {\n    const docsInCollection = arrayify(scenario[collection]);\n    docsInCollection.forEach(doc => createNestedObject({ doc, collection }));\n  });\n\n  return { ids, docs, docsById };\n};\n\nexport default generator;\n"]},"sourceType":"script","hash":"3965b51a11f6728b609d9c9ed80977d24f858df3"}

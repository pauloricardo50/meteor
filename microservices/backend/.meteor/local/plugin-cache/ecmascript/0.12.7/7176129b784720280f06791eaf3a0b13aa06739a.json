{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/packages/cultofcoders:redis-oplog/lib/vent/VentClient.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"packages/cultofcoders:redis-oplog/lib/vent/VentClient.js","filename":"/Users/Florian/dev/epotek/microservices/backend/packages/cultofcoders:redis-oplog/lib/vent/VentClient.js","passPerPreset":false,"envName":"development","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/packages/cultofcoders:redis-oplog/lib/vent/VentClient.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/cultofcoders:redis-oplog/lib/vent/VentClient.js"}},"code":"module.export({\n  default: () => VentClient\n});\nlet VentConstants;\nmodule.link(\"../constants\", {\n  VentConstants(v) {\n    VentConstants = v;\n  }\n\n}, 0);\nlet Random;\nmodule.link(\"meteor/random\", {\n  Random(v) {\n    Random = v;\n  }\n\n}, 1);\nlet DDPCommon;\nmodule.link(\"meteor/ddp-common\", {\n  DDPCommon(v) {\n    DDPCommon = v;\n  }\n\n}, 2);\n\nclass VentClient {\n  constructor() {\n    this.store = {};\n    this.listen(Meteor.connection);\n  }\n\n  subscribe(name) {\n    const subscription = new VentClientSubscription(this, name);\n    this.add(subscription);\n\n    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      args[_key - 1] = arguments[_key];\n    }\n\n    return subscription.subscribe(...args);\n  }\n\n  listen(ddpConnection) {\n    ddpConnection._stream.on('message', raw_msg => {\n      // avoid parsing unnecessary ddp events\n      const search = \"{\\\"msg\\\":\\\"changed\\\",\\\"\".concat(VentConstants.PREFIX, \"\\\":\\\"1\");\n\n      if (raw_msg.substr(0, search.length) !== search) {\n        return;\n      }\n\n      const msg = DDPCommon.parseDDP(raw_msg);\n      const subscription = this.store[msg.id];\n\n      if (subscription) {\n        subscription.handle(msg[VentConstants.EVENT_VARIABLE]);\n      }\n    });\n  }\n  /**\n   * {VentClientSubscription}\n   * @param subscription\n   */\n\n\n  add(subscription) {\n    this.store[subscription.id] = subscription;\n  }\n  /**\n   * @param {VentClientSubscription} subscription\n   */\n\n\n  remove(subscription) {\n    delete this.store[subscription.id];\n  }\n\n}\n\n/**\n * Handles Vent subscription\n */\nclass VentClientSubscription {\n  constructor(client, name) {\n    this.client = client;\n    this._name = name;\n    this._id = Random.id();\n  }\n\n  get id() {\n    return VentConstants.getPrefix(this._id, this._name);\n  }\n  /**\n   * Subscribes to Meteor\n   *\n   * @param args\n   * @returns {*}\n   */\n\n\n  subscribe() {\n    const self = this;\n\n    for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n      args[_key2] = arguments[_key2];\n    }\n\n    const handler = Meteor.subscribe(this._name, this._id, ...args);\n    const oldStop = handler.stop;\n    Object.assign(handler, {\n      listen(eventHandler) {\n        if (!_.isFunction(eventHandler)) {\n          throw new Meteor.Error('invalid-argument', 'You should pass a function to listen()');\n        }\n\n        self._eventHandler = eventHandler;\n      },\n\n      stop() {\n        self.client.remove(self);\n        return oldStop.call(handler);\n      }\n\n    });\n    return handler;\n  }\n  /**\n   * Watches the incomming events\n   */\n\n\n  handle(event) {\n    if (this._eventHandler) {\n      this._eventHandler(event);\n    } else {}\n  }\n\n}","map":{"version":3,"sources":["packages/cultofcoders:redis-oplog/lib/vent/VentClient.js"],"names":["module","export","default","VentClient","VentConstants","link","v","Random","DDPCommon","constructor","store","listen","Meteor","connection","subscribe","name","subscription","VentClientSubscription","add","args","ddpConnection","_stream","on","raw_msg","search","PREFIX","substr","length","msg","parseDDP","id","handle","EVENT_VARIABLE","remove","client","_name","_id","getPrefix","self","handler","oldStop","stop","Object","assign","eventHandler","_","isFunction","Error","_eventHandler","call","event"],"mappings":"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","sourcesContent":["import {VentConstants} from '../constants';\nimport {Random} from 'meteor/random';\nimport {DDPCommon} from 'meteor/ddp-common';\n\n/**\n * Handles vents inside Meteor\n */\nexport default class VentClient {\n    constructor() {\n        this.store = {};\n        this.listen(Meteor.connection);\n    }\n\n    subscribe(name, ...args) {\n        const subscription = new VentClientSubscription(this, name);\n        this.add(subscription);\n\n        return subscription.subscribe(...args);\n    }\n\n    listen(ddpConnection) {\n        ddpConnection._stream.on('message', (raw_msg) => {\n            // avoid parsing unnecessary ddp events\n            const search = `{\"msg\":\"changed\",\"${VentConstants.PREFIX}\":\"1`;\n            if (raw_msg.substr(0, search.length) !== search) {\n                return;\n            }\n\n            const msg = DDPCommon.parseDDP(raw_msg);\n            const subscription = this.store[msg.id];\n            if (subscription) {\n                subscription.handle(msg[VentConstants.EVENT_VARIABLE]);\n            }\n        });\n    }\n\n    /**\n     * {VentClientSubscription}\n     * @param subscription\n     */\n    add(subscription) {\n        this.store[subscription.id] = subscription;\n    }\n\n    /**\n     * @param {VentClientSubscription} subscription\n     */\n    remove(subscription) {\n        delete this.store[subscription.id];\n    }\n}\n\n/**\n * Handles Vent subscription\n */\nclass VentClientSubscription {\n    constructor(client, name) {\n        this.client = client;\n        this._name = name;\n        this._id = Random.id();\n    }\n\n    get id() {\n        return VentConstants.getPrefix(this._id, this._name);\n    }\n\n    /**\n     * Subscribes to Meteor\n     *\n     * @param args\n     * @returns {*}\n     */\n    subscribe(...args) {\n        const self = this;\n\n        const handler = Meteor.subscribe(this._name, this._id, ...args);\n\n        const oldStop = handler.stop;\n        Object.assign(handler, {\n            listen(eventHandler) {\n                if (!_.isFunction(eventHandler)) {\n                    throw new Meteor.Error('invalid-argument', 'You should pass a function to listen()');\n                }\n\n                self._eventHandler = eventHandler;\n            },\n            stop() {\n                self.client.remove(self);\n\n                return oldStop.call(handler);\n            }\n        });\n\n        return handler;\n    }\n\n    /**\n     * Watches the incomming events\n     */\n    handle(event) {\n        if (this._eventHandler) {\n            this._eventHandler(event);\n        } else {\n\n        }\n    }\n}"]},"sourceType":"script","hash":"7176129b784720280f06791eaf3a0b13aa06739a"}

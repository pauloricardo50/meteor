{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/helpers/server/QueryCacher.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"imports/core/api/helpers/server/QueryCacher.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/helpers/server/QueryCacher.js","inputSourceMap":{"version":3,"sources":["imports/core/api/helpers/server/QueryCacher.js"],"names":["Meteor","BaseResultCacher","EJSON","hashObject","cloneDeep","require","DEFAULT_TTL","QueryCacher","constructor","config","store","generateQueryId","queryName","params","stringify","getHash","cacheId","parse","split","getDataToHash","dataToHash","MD5","fetch","query","countCursor","cacheData","hash","undefined","cachedHash","data","fetchData","storeData","invalidateCache","cacheExists","setCache","findAndInvalidateCache","ttl","setTimeout"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { BaseResultCacher } from 'meteor/cultofcoders:grapher';\nimport { EJSON } from 'meteor/ejson';\nimport hashObject from 'object-hash';\n\nconst cloneDeep = require('lodash/cloneDeep');\n\nconst DEFAULT_TTL = 1000 * 60 * 60; // 1 hour\n\nexport default class QueryCacher extends BaseResultCacher {\n  constructor(config = {}) {\n    super(config);\n    this.store = {};\n  }\n\n  generateQueryId(queryName, params) {\n    // Store the queryname for reuse later\n    if (!this.queryName) {\n      this.queryName = queryName;\n    }\n    return `${queryName}::${EJSON.stringify(params)}`;\n  }\n\n  getHash(cacheId) {\n    const params = EJSON.parse(cacheId.split('::')[1]);\n    const { getDataToHash = () => null } = this.config;\n\n    const dataToHash = getDataToHash(params);\n    return hashObject.MD5(dataToHash);\n  }\n\n  fetch(cacheId, { query, countCursor }) {\n    const cacheData = this.store[cacheId];\n    const hash = this.getHash(cacheId);\n\n    if (cacheData !== undefined) {\n      const { hash: cachedHash, data } = cacheData;\n\n      if (hash === cachedHash) {\n        return cloneDeep(data);\n      }\n    }\n\n    const data = BaseResultCacher.fetchData({ query, countCursor }); // this.fetchData is not a function\n    this.storeData({ cacheId, data, hash });\n\n    return data;\n  }\n\n  invalidateCache(cacheId) {\n    delete this.store[cacheId];\n  }\n\n  cacheExists(cacheId) {\n    return !!this.store[cacheId];\n  }\n\n  setCache(cacheId, cacheData) {\n    this.store[cacheId] = cacheData;\n  }\n\n  findAndInvalidateCache(params) {\n    const cacheId = this.generateQueryId(this.queryName, params);\n    if (this.cacheExists(cacheId)) {\n      this.invalidateCache(cacheId);\n    }\n  }\n\n  storeData({ cacheId, data, hash }) {\n    const ttl = this.config.ttl || DEFAULT_TTL;\n    this.setCache(cacheId, { data: cloneDeep(data), hash });\n\n    Meteor.setTimeout(() => {\n      this.invalidateCache(cacheId);\n    }, ttl);\n  }\n}\n"]},"passPerPreset":false,"envName":"production","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/helpers/server/QueryCacher.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/api/helpers/server/QueryCacher.js"}},"code":"module.export({\n  default: () => QueryCacher\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet BaseResultCacher;\nmodule.link(\"meteor/cultofcoders:grapher\", {\n  BaseResultCacher(v) {\n    BaseResultCacher = v;\n  }\n\n}, 1);\nlet EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON(v) {\n    EJSON = v;\n  }\n\n}, 2);\nlet hashObject;\nmodule.link(\"object-hash\", {\n  default(v) {\n    hashObject = v;\n  }\n\n}, 3);\n\nconst cloneDeep = require('lodash/cloneDeep');\n\nconst DEFAULT_TTL = 1000 * 60 * 60; // 1 hour\n\nclass QueryCacher extends BaseResultCacher {\n  constructor(config = {}) {\n    super(config);\n    this.store = {};\n  }\n\n  generateQueryId(queryName, params) {\n    // Store the queryname for reuse later\n    if (!this.queryName) {\n      this.queryName = queryName;\n    }\n\n    return `${queryName}::${EJSON.stringify(params)}`;\n  }\n\n  getHash(cacheId) {\n    const params = EJSON.parse(cacheId.split('::')[1]);\n    const {\n      getDataToHash = () => null\n    } = this.config;\n    const dataToHash = getDataToHash(params);\n    return hashObject.MD5(dataToHash);\n  }\n\n  fetch(cacheId, {\n    query,\n    countCursor\n  }) {\n    const cacheData = this.store[cacheId];\n    const hash = this.getHash(cacheId);\n\n    if (cacheData !== undefined) {\n      const {\n        hash: cachedHash,\n        data\n      } = cacheData;\n\n      if (hash === cachedHash) {\n        return cloneDeep(data);\n      }\n    }\n\n    const data = BaseResultCacher.fetchData({\n      query,\n      countCursor\n    }); // this.fetchData is not a function\n\n    this.storeData({\n      cacheId,\n      data,\n      hash\n    });\n    return data;\n  }\n\n  invalidateCache(cacheId) {\n    delete this.store[cacheId];\n  }\n\n  cacheExists(cacheId) {\n    return !!this.store[cacheId];\n  }\n\n  setCache(cacheId, cacheData) {\n    this.store[cacheId] = cacheData;\n  }\n\n  findAndInvalidateCache(params) {\n    const cacheId = this.generateQueryId(this.queryName, params);\n\n    if (this.cacheExists(cacheId)) {\n      this.invalidateCache(cacheId);\n    }\n  }\n\n  storeData({\n    cacheId,\n    data,\n    hash\n  }) {\n    const ttl = this.config.ttl || DEFAULT_TTL;\n    this.setCache(cacheId, {\n      data: cloneDeep(data),\n      hash\n    });\n    Meteor.setTimeout(() => {\n      this.invalidateCache(cacheId);\n    }, ttl);\n  }\n\n}","map":{"version":3,"sources":["imports/core/api/helpers/server/QueryCacher.js"],"names":["Meteor","cloneDeep","require","DEFAULT_TTL","constructor","config","generateQueryId","queryName","EJSON","getHash","params","cacheId","getDataToHash","dataToHash","hashObject","fetch","countCursor","cacheData","hash","data","invalidateCache","cacheExists","setCache","findAndInvalidateCache","storeData","ttl"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { BaseResultCacher } from 'meteor/cultofcoders:grapher';\nimport { EJSON } from 'meteor/ejson';\nimport hashObject from 'object-hash';\n\nconst cloneDeep = require('lodash/cloneDeep');\n\nconst DEFAULT_TTL = 1000 * 60 * 60; // 1 hour\n\nexport default class QueryCacher extends BaseResultCacher {\n  constructor(config = {}) {\n    super(config);\n    this.store = {};\n  }\n\n  generateQueryId(queryName, params) {\n    // Store the queryname for reuse later\n    if (!this.queryName) {\n      this.queryName = queryName;\n    }\n    return `${queryName}::${EJSON.stringify(params)}`;\n  }\n\n  getHash(cacheId) {\n    const params = EJSON.parse(cacheId.split('::')[1]);\n    const { getDataToHash = () => null } = this.config;\n\n    const dataToHash = getDataToHash(params);\n    return hashObject.MD5(dataToHash);\n  }\n\n  fetch(cacheId, { query, countCursor }) {\n    const cacheData = this.store[cacheId];\n    const hash = this.getHash(cacheId);\n\n    if (cacheData !== undefined) {\n      const { hash: cachedHash, data } = cacheData;\n\n      if (hash === cachedHash) {\n        return cloneDeep(data);\n      }\n    }\n\n    const data = BaseResultCacher.fetchData({ query, countCursor }); // this.fetchData is not a function\n    this.storeData({ cacheId, data, hash });\n\n    return data;\n  }\n\n  invalidateCache(cacheId) {\n    delete this.store[cacheId];\n  }\n\n  cacheExists(cacheId) {\n    return !!this.store[cacheId];\n  }\n\n  setCache(cacheId, cacheData) {\n    this.store[cacheId] = cacheData;\n  }\n\n  findAndInvalidateCache(params) {\n    const cacheId = this.generateQueryId(this.queryName, params);\n    if (this.cacheExists(cacheId)) {\n      this.invalidateCache(cacheId);\n    }\n  }\n\n  storeData({ cacheId, data, hash }) {\n    const ttl = this.config.ttl || DEFAULT_TTL;\n    this.setCache(cacheId, { data: cloneDeep(data), hash });\n\n    Meteor.setTimeout(() => {\n      this.invalidateCache(cacheId);\n    }, ttl);\n  }\n}\n"]},"sourceType":"script","hash":"b9854093a873b5915d7fc3efffc882194abdcfee"}

{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/LoanCalculator.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"imports/core/utils/Calculator/LoanCalculator.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/LoanCalculator.js","inputSourceMap":{"version":3,"sources":["imports/core/utils/Calculator/LoanCalculator.js"],"names":["OWN_FUNDS_TYPES","getLoanDocuments","OWN_FUNDS_USAGE_TYPES","filesPercent","getMissingDocumentIds","getRefinancingFormArray","NotaryFeesCalculator","getCountedArray","getPercent","withLoanCalculator","SuperClass","getProjectValue","loan","structureId","propAndWork","getPropAndWork","value","getFees","total","getTotalUsed","ownFunds","selectStructureKey","key","reduce","sum","getTotalPledged","filter","usageType","PLEDGE","notaryFees","calculator","getFeesCalculator","calculatedNotaryFees","getNotaryFeesForLoan","canton","selectPropertyKey","getInterests","interestRates","finalInterestRates","currentInterestRates","offer","loanTranches","loanValue","selectLoanValue","interests","getInterestsWithTranches","tranches","getTheoreticalInterests","propertyValue","selectPropertyValue","propertyWork","firstRank","Math","min","amortizationGoal","secondRank","max","firstRankInterests","theoreticalInterestRate","secondRankInterests","theoreticalInterestRate2ndRank","getTheoreticalMaintenance","theoreticalMaintenanceRate","getAmortization","offerOverride","selectOffer","offerToUse","oldAmortizationGoal","amortizationRate","getAmortizationRate","amortizationYears","amortization","getTheoreticalAmortization","borrowRatio","getBorrowRatio","getAmortizationRateBase","cacheFix","getMonthly","getTheoreticalPropertyCost","asObject","maintenance","getTheoreticalMonthly","propertyCost","expensesToAddToTheoreticalCost","getFormattedExpenses","add","getIncomeRatio","cost","income","getTotalIncome","borrowers","ratio","wantedLoan","getMaxBorrowRatio","maxBorrowRatio","loanHasMinimalInformation","structure","selectStructure","length","getLoanFilesProgress","fileArray","doc","getMissingLoanDocuments","getTotalFinancing","getNonPledgedOwnFunds","getPledgedOwnFunds","getUsedFundsOfType","type","ownFundType","ownFundUsageType","getRemainingFundsOfType","getFunds","BANK_FORTUNE","WITHDRAW","undefined","getTotalRemainingFunds","Object","values","THIRD_PARTY_FORTUNE","refinancingPercent","array","getMortgageNoteIncrease","mortgageNoteIds","mortgageNotes","propertyMortgageNotes","selectProperty","borrowerMortgageNotes","getMortgageNotes","structureMortgageNotes","map","id","find","_id","allMortgageNotes","mortgageNoteValue","getCashUsed","INSURANCE_2","getCashRatio","fees","cashUsed","cashRatio","hasEnoughCash","minCash","structureIsValid","incomeRatio","maxIncomeRatio","allowPledge","getEstimatedRevenues","estimatedCommission","getEstimatedReferralRevenues","referralCommission","getRequiredOwnFunds","projectValue","getMissingOwnFunds","fundsRequired","totalCurrentFunds","isMissingOwnFunds","missingOwnFunds","ownFundsRoundingAmount","hasTooMuchOwnFunds","hasCompleteStructure","structures","some"],"mappings":"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","sourcesContent":["// @flow\nimport { OWN_FUNDS_TYPES } from 'core/api/constants';\nimport { getLoanDocuments } from '../../api/files/documents';\nimport { OWN_FUNDS_USAGE_TYPES } from '../../api/constants';\nimport {\n  filesPercent,\n  getMissingDocumentIds,\n} from '../../api/files/fileHelpers';\nimport getRefinancingFormArray from '../../arrays/RefinancingFormArray';\nimport NotaryFeesCalculator from '../notaryFees/NotaryFeesCalculator';\nimport { getCountedArray } from '../formArrayHelpers';\nimport { getPercent } from '../general';\n\nexport const withLoanCalculator = (SuperClass = class {}) =>\n  class extends SuperClass {\n    getProjectValue({ loan, structureId }) {\n      const propAndWork = this.getPropAndWork({ loan, structureId });\n      if (!propAndWork) {\n        return 0;\n      }\n\n      const value = propAndWork + this.getFees({ loan, structureId }).total;\n\n      return value;\n    }\n\n    getTotalUsed({ loan, structureId }) {\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds',\n      });\n      return ownFunds.reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getTotalPledged({ loan, structureId }) {\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds',\n      });\n      return ownFunds\n        .filter(({ usageType }) => usageType === OWN_FUNDS_USAGE_TYPES.PLEDGE)\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getFees({ loan, structureId }): number {\n      const notaryFees = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'notaryFees',\n      });\n\n      // Custom notary fees are provided\n      if (notaryFees === 0 || notaryFees) {\n        return { total: notaryFees };\n      }\n\n      const calculator = this.getFeesCalculator({ loan, structureId });\n\n      const calculatedNotaryFees = calculator.getNotaryFeesForLoan({\n        loan,\n        structureId,\n      });\n\n      return calculatedNotaryFees;\n    }\n\n    getFeesCalculator({ loan, structureId }) {\n      const canton = this.selectPropertyKey({\n        loan,\n        structureId,\n        key: 'canton',\n      });\n      return new NotaryFeesCalculator({ canton });\n    }\n\n    getInterests({ loan, interestRates, structureId }) {\n      let finalInterestRates = interestRates || loan.currentInterestRates;\n      const offer = this.selectStructureKey({\n        loan,\n        key: 'offer',\n        structureId,\n      });\n      const loanTranches = this.selectStructureKey({\n        loan,\n        key: 'loanTranches',\n        structureId,\n      });\n      const loanValue = this.selectLoanValue({ loan, structureId });\n      if (offer) {\n        finalInterestRates = offer;\n      }\n\n      const interests = this.getInterestsWithTranches({\n        tranches: loanTranches,\n        interestRates: finalInterestRates,\n      });\n\n      return (interests * loanValue) / 12;\n    }\n\n    getTheoreticalInterests({ loan, structureId }) {\n      const loanValue = this.selectLoanValue({ loan, structureId });\n      const propertyValue = this.selectPropertyValue({ loan, structureId });\n      const propertyWork = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'propertyWork',\n      }) || 0;\n      const firstRank = Math.min(\n        loanValue,\n        this.amortizationGoal * (propertyValue + propertyWork),\n      );\n      const secondRank = Math.max(0, loanValue - firstRank);\n\n      const firstRankInterests = firstRank * this.theoreticalInterestRate;\n      const secondRankInterests = secondRank\n        * (this.theoreticalInterestRate2ndRank || this.theoreticalInterestRate);\n\n      return (firstRankInterests + secondRankInterests) / 12;\n    }\n\n    getTheoreticalMaintenance({ loan, structureId }) {\n      return (\n        (this.getPropAndWork({ loan, structureId })\n          * this.theoreticalMaintenanceRate)\n        / 12\n      );\n    }\n\n    getAmortization({ loan, structureId, offerOverride }) {\n      const offer = this.selectOffer({ loan, structureId });\n      const loanValue = this.selectLoanValue({ loan, structureId });\n      const offerToUse = offerOverride || offer;\n\n      if (offerToUse) {\n        // Temporarily change amortizationGoal\n        const oldAmortizationGoal = this.amortizationGoal;\n        this.amortizationGoal = offerToUse.amortizationGoal;\n\n        const amortizationRate = this.getAmortizationRate({\n          loan,\n          amortizationYears: offerToUse.amortizationYears,\n          structureId,\n        });\n\n        const amortization = (amortizationRate * loanValue) / 12;\n\n        this.amortizationGoal = oldAmortizationGoal;\n\n        return amortization;\n      }\n\n      const amortizationRate = this.getAmortizationRate({ loan, structureId });\n      return (amortizationRate * loanValue) / 12;\n    }\n\n    getTheoreticalAmortization({ loan, structureId }) {\n      const loanValue = this.selectLoanValue({ loan, structureId });\n\n      return (this.getAmortizationRate({ loan, structureId }) * loanValue) / 12;\n    }\n\n    getAmortizationRate({ loan, amortizationYears, structureId }) {\n      const borrowRatio = this.getBorrowRatio({ loan, structureId });\n      return this.getAmortizationRateBase({\n        borrowRatio,\n        amortizationYears,\n        // Prevent caching of this function if amortizationGoal has changed\n        cacheFix: this.amortizationGoal,\n      });\n    }\n\n    getMonthly({ loan, interestRates, structureId }) {\n      return (\n        this.getInterests({ loan, interestRates, structureId })\n        + this.getAmortization({ loan, structureId })\n      );\n    }\n\n    getTheoreticalPropertyCost({ loan, structureId, asObject = false }) {\n      const interests = this.getTheoreticalInterests({ loan, structureId });\n      const amortization = this.getTheoreticalAmortization({\n        loan,\n        structureId,\n      });\n      const maintenance = this.getTheoreticalMaintenance({ loan, structureId });\n      return asObject\n        ? {\n          interests,\n          amortization,\n          maintenance,\n          total: interests + amortization + maintenance,\n        }\n        : interests + amortization + maintenance;\n    }\n\n    getTheoreticalMonthly({ loan, structureId }) {\n      const propertyCost = this.getTheoreticalPropertyCost({\n        loan,\n        structureId,\n      });\n      const expensesToAddToTheoreticalCost = this.getFormattedExpenses({ loan, structureId }).add / 12;\n\n      return propertyCost + expensesToAddToTheoreticalCost;\n    }\n\n    getIncomeRatio({ loan, structureId }) {\n      const cost = this.getTheoreticalMonthly({ loan, structureId });\n      const income = this.getTotalIncome({ borrowers: loan.borrowers });\n      const ratio = cost / (income / 12);\n\n      if (ratio > 1 || ratio < 0) {\n        return 1;\n      }\n\n      return ratio;\n    }\n\n    getBorrowRatio({ loan, structureId }) {\n      const wantedLoan = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'wantedLoan',\n      });\n      const propAndWork = this.getPropAndWork({ loan, structureId });\n      return wantedLoan / propAndWork;\n    }\n\n    getMaxBorrowRatio() {\n      return this.maxBorrowRatio;\n    }\n\n    loanHasMinimalInformation({ loan }) {\n      const structure = this.selectStructure({ loan });\n\n      return !!(\n        structure.ownFunds\n        && structure.ownFunds.length > 0\n        && this.selectPropertyValue({ loan })\n        && this.selectLoanValue({ loan })\n      );\n    }\n\n    getLoanFilesProgress({ loan }) {\n      return filesPercent({ fileArray: getLoanDocuments({ loan }), doc: loan });\n    }\n\n    getMissingLoanDocuments({ loan }) {\n      return getMissingDocumentIds({\n        fileArray: getLoanDocuments({ loan }),\n        doc: loan,\n      });\n    }\n\n    getTotalFinancing({ loan, structureId }) {\n      return (\n        this.selectStructureKey({ loan, structureId, key: 'wantedLoan' })\n        + this.getNonPledgedOwnFunds({ loan, structureId })\n      );\n    }\n\n    getNonPledgedOwnFunds({ loan, structureId }) {\n      const ownFunds = this.selectStructureKey({ loan, structureId, key: 'ownFunds' }) || [];\n      return ownFunds\n        .filter(({ usageType }) => usageType !== OWN_FUNDS_USAGE_TYPES.PLEDGE)\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getPledgedOwnFunds({ loan, structureId }) {\n      const ownFunds = this.selectStructureKey({ loan, structureId, key: 'ownFunds' }) || [];\n      return ownFunds\n        .filter(({ usageType }) => usageType === OWN_FUNDS_USAGE_TYPES.PLEDGE)\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getUsedFundsOfType({ loan, type, usageType, structureId }) {\n      const ownFunds = this.selectStructureKey({ loan, structureId, key: 'ownFunds' }) || [];\n      return ownFunds\n        .filter(({ type: ownFundType }) => (type ? ownFundType === type : true))\n        .filter(({ usageType: ownFundUsageType }) =>\n          (usageType ? ownFundUsageType === usageType : true))\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getRemainingFundsOfType({ loan, structureId, type }) {\n      const ownFunds = this.getFunds({ loan, type, structureId });\n      return (\n        ownFunds\n        - this.getUsedFundsOfType({\n          loan,\n          type,\n          structureId,\n          usageType:\n            type !== OWN_FUNDS_TYPES.BANK_FORTUNE\n              ? OWN_FUNDS_USAGE_TYPES.WITHDRAW\n              : undefined,\n        })\n      );\n    }\n\n    getTotalRemainingFunds({ loan, structureId }) {\n      // Don't count extra third party fortune, as it is not a real \"loan\" from them\n      return Object.values(OWN_FUNDS_TYPES)\n        .filter(type => type !== OWN_FUNDS_TYPES.THIRD_PARTY_FORTUNE)\n        .reduce(\n          (sum, type) =>\n            sum + this.getRemainingFundsOfType({ loan, structureId, type }),\n          0,\n        );\n    }\n\n    refinancingPercent({ loan }) {\n      const array = getCountedArray(getRefinancingFormArray({ loan }), loan);\n      return getPercent(array);\n    }\n\n    getMortgageNoteIncrease({ loan, structureId }) {\n      const { borrowers = [] } = loan;\n      const { mortgageNoteIds = [] } = this.selectStructure({\n        loan,\n        structureId,\n      });\n\n      const { mortgageNotes: propertyMortgageNotes = [] } = this.selectProperty({ loan, structureId });\n      const borrowerMortgageNotes = this.getMortgageNotes({ borrowers });\n      const structureMortgageNotes = mortgageNoteIds.map(id =>\n        borrowerMortgageNotes.find(({ _id }) => _id === id));\n\n      const allMortgageNotes = [\n        ...structureMortgageNotes,\n        ...propertyMortgageNotes,\n      ];\n      const mortgageNoteValue = allMortgageNotes.reduce(\n        (total, { value }) => total + (value || 0),\n        0,\n      );\n      const loanValue = this.selectLoanValue({ loan, structureId });\n\n      return Math.max(0, loanValue - mortgageNoteValue);\n    }\n\n    getCashUsed({ loan, structureId }) {\n      const { ownFunds } = this.selectStructure({ loan, structureId });\n\n      return ownFunds\n        .filter(({ type, usageType }) =>\n          type !== OWN_FUNDS_TYPES.INSURANCE_2\n            && usageType !== OWN_FUNDS_USAGE_TYPES.PLEDGE)\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getCashRatio({ loan, structureId }) {\n      const propAndWork = this.getPropAndWork({ loan, structureId });\n      const fees = this.getFees({ loan, structureId }).total;\n      const cashUsed = this.getCashUsed({ loan, structureId });\n\n      const cashRatio = (cashUsed - fees) / propAndWork;\n      return cashRatio;\n    }\n\n    hasEnoughCash({ loan, structureId }) {\n      return this.getCashRatio({ loan, structureId }) >= this.minCash;\n    }\n\n    structureIsValid({ loan, structureId }) {\n      const incomeRatio = this.getIncomeRatio({ loan, structureId });\n      const borrowRatio = this.getBorrowRatio({ loan, structureId });\n\n      if (\n        incomeRatio > this.maxIncomeRatio\n        || borrowRatio > this.maxBorrowRatio\n      ) {\n        return false;\n      }\n\n      if (\n        !this.allowPledge\n        && this.getPledgedOwnFunds({ loan, structureId }) > 0\n      ) {\n        return false;\n      }\n\n      return true;\n    }\n\n    getEstimatedRevenues({ loan, structureId }) {\n      const propertyValue = this.selectPropertyValue({ loan, structureId });\n      return propertyValue * this.estimatedCommission;\n    }\n\n    getEstimatedReferralRevenues({ loan, structureId }) {\n      return (\n        this.getEstimatedRevenues({ loan, structureId })\n        * this.referralCommission\n      );\n    }\n\n    getRequiredOwnFunds({ loan, structureId }) {\n      const projectValue = this.getProjectValue({ loan, structureId });\n      const loanValue = this.selectLoanValue({ loan, structureId });\n      return projectValue - loanValue;\n    }\n\n    getMissingOwnFunds({ loan, structureId }) {\n      const fundsRequired = this.getRequiredOwnFunds({ loan, structureId });\n      const totalCurrentFunds = this.getNonPledgedOwnFunds({\n        loan,\n        structureId,\n      });\n\n      return fundsRequired - totalCurrentFunds;\n    }\n\n    isMissingOwnFunds({ loan, structureId }) {\n      const missingOwnFunds = this.getMissingOwnFunds({ loan, structureId });\n      return missingOwnFunds >= this.ownFundsRoundingAmount;\n    }\n\n    hasTooMuchOwnFunds({ loan, structureId }) {\n      const missingOwnFunds = this.getMissingOwnFunds({ loan, structureId });\n      return missingOwnFunds <= -this.ownFundsRoundingAmount;\n    }\n\n    hasCompleteStructure({ loan }) {\n      return loan.structures.some(({ id }) => {\n        const fundsRequired = this.getRequiredOwnFunds({\n          loan,\n          structureId: id,\n        });\n\n        if (fundsRequired === 0) {\n          return false;\n        }\n\n        if (\n          !this.isMissingOwnFunds({ loan, structureId: id })\n          && !this.hasTooMuchOwnFunds({ loan, structureId: id })\n        ) {\n          return true;\n        }\n\n        return false;\n      });\n    }\n  };\n"]},"passPerPreset":false,"envName":"development","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/LoanCalculator.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/utils/Calculator/LoanCalculator.js"}},"code":"module.export({\n  withLoanCalculator: () => withLoanCalculator\n});\nlet OWN_FUNDS_TYPES;\nmodule.link(\"../../api/constants\", {\n  OWN_FUNDS_TYPES(v) {\n    OWN_FUNDS_TYPES = v;\n  }\n\n}, 0);\nlet getLoanDocuments;\nmodule.link(\"../../api/files/documents\", {\n  getLoanDocuments(v) {\n    getLoanDocuments = v;\n  }\n\n}, 1);\nlet OWN_FUNDS_USAGE_TYPES;\nmodule.link(\"../../api/constants\", {\n  OWN_FUNDS_USAGE_TYPES(v) {\n    OWN_FUNDS_USAGE_TYPES = v;\n  }\n\n}, 2);\nlet filesPercent, getMissingDocumentIds;\nmodule.link(\"../../api/files/fileHelpers\", {\n  filesPercent(v) {\n    filesPercent = v;\n  },\n\n  getMissingDocumentIds(v) {\n    getMissingDocumentIds = v;\n  }\n\n}, 3);\nlet getRefinancingFormArray;\nmodule.link(\"../../arrays/RefinancingFormArray\", {\n  default(v) {\n    getRefinancingFormArray = v;\n  }\n\n}, 4);\nlet NotaryFeesCalculator;\nmodule.link(\"../notaryFees/NotaryFeesCalculator\", {\n  default(v) {\n    NotaryFeesCalculator = v;\n  }\n\n}, 5);\nlet getCountedArray;\nmodule.link(\"../formArrayHelpers\", {\n  getCountedArray(v) {\n    getCountedArray = v;\n  }\n\n}, 6);\nlet getPercent;\nmodule.link(\"../general\", {\n  getPercent(v) {\n    getPercent = v;\n  }\n\n}, 7);\n\nconst withLoanCalculator = function () {\n  let SuperClass = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : class {};\n  return class extends SuperClass {\n    getProjectValue(_ref) {\n      let {\n        loan,\n        structureId\n      } = _ref;\n      const propAndWork = this.getPropAndWork({\n        loan,\n        structureId\n      });\n\n      if (!propAndWork) {\n        return 0;\n      }\n\n      const value = propAndWork + this.getFees({\n        loan,\n        structureId\n      }).total;\n      return value;\n    }\n\n    getTotalUsed(_ref2) {\n      let {\n        loan,\n        structureId\n      } = _ref2;\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds'\n      });\n      return ownFunds.reduce((sum, _ref3) => {\n        let {\n          value\n        } = _ref3;\n        return sum + value;\n      }, 0);\n    }\n\n    getTotalPledged(_ref4) {\n      let {\n        loan,\n        structureId\n      } = _ref4;\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds'\n      });\n      return ownFunds.filter((_ref5) => {\n        let {\n          usageType\n        } = _ref5;\n        return usageType === OWN_FUNDS_USAGE_TYPES.PLEDGE;\n      }).reduce((sum, _ref6) => {\n        let {\n          value\n        } = _ref6;\n        return sum + value;\n      }, 0);\n    }\n\n    getFees(_ref7) {\n      let {\n        loan,\n        structureId\n      } = _ref7;\n      const notaryFees = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'notaryFees'\n      }); // Custom notary fees are provided\n\n      if (notaryFees === 0 || notaryFees) {\n        return {\n          total: notaryFees\n        };\n      }\n\n      const calculator = this.getFeesCalculator({\n        loan,\n        structureId\n      });\n      const calculatedNotaryFees = calculator.getNotaryFeesForLoan({\n        loan,\n        structureId\n      });\n      return calculatedNotaryFees;\n    }\n\n    getFeesCalculator(_ref8) {\n      let {\n        loan,\n        structureId\n      } = _ref8;\n      const canton = this.selectPropertyKey({\n        loan,\n        structureId,\n        key: 'canton'\n      });\n      return new NotaryFeesCalculator({\n        canton\n      });\n    }\n\n    getInterests(_ref9) {\n      let {\n        loan,\n        interestRates,\n        structureId\n      } = _ref9;\n      let finalInterestRates = interestRates || loan.currentInterestRates;\n      const offer = this.selectStructureKey({\n        loan,\n        key: 'offer',\n        structureId\n      });\n      const loanTranches = this.selectStructureKey({\n        loan,\n        key: 'loanTranches',\n        structureId\n      });\n      const loanValue = this.selectLoanValue({\n        loan,\n        structureId\n      });\n\n      if (offer) {\n        finalInterestRates = offer;\n      }\n\n      const interests = this.getInterestsWithTranches({\n        tranches: loanTranches,\n        interestRates: finalInterestRates\n      });\n      return interests * loanValue / 12;\n    }\n\n    getTheoreticalInterests(_ref10) {\n      let {\n        loan,\n        structureId\n      } = _ref10;\n      const loanValue = this.selectLoanValue({\n        loan,\n        structureId\n      });\n      const propertyValue = this.selectPropertyValue({\n        loan,\n        structureId\n      });\n      const propertyWork = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'propertyWork'\n      }) || 0;\n      const firstRank = Math.min(loanValue, this.amortizationGoal * (propertyValue + propertyWork));\n      const secondRank = Math.max(0, loanValue - firstRank);\n      const firstRankInterests = firstRank * this.theoreticalInterestRate;\n      const secondRankInterests = secondRank * (this.theoreticalInterestRate2ndRank || this.theoreticalInterestRate);\n      return (firstRankInterests + secondRankInterests) / 12;\n    }\n\n    getTheoreticalMaintenance(_ref11) {\n      let {\n        loan,\n        structureId\n      } = _ref11;\n      return this.getPropAndWork({\n        loan,\n        structureId\n      }) * this.theoreticalMaintenanceRate / 12;\n    }\n\n    getAmortization(_ref12) {\n      let {\n        loan,\n        structureId,\n        offerOverride\n      } = _ref12;\n      const offer = this.selectOffer({\n        loan,\n        structureId\n      });\n      const loanValue = this.selectLoanValue({\n        loan,\n        structureId\n      });\n      const offerToUse = offerOverride || offer;\n\n      if (offerToUse) {\n        // Temporarily change amortizationGoal\n        const oldAmortizationGoal = this.amortizationGoal;\n        this.amortizationGoal = offerToUse.amortizationGoal;\n        const amortizationRate = this.getAmortizationRate({\n          loan,\n          amortizationYears: offerToUse.amortizationYears,\n          structureId\n        });\n        const amortization = amortizationRate * loanValue / 12;\n        this.amortizationGoal = oldAmortizationGoal;\n        return amortization;\n      }\n\n      const amortizationRate = this.getAmortizationRate({\n        loan,\n        structureId\n      });\n      return amortizationRate * loanValue / 12;\n    }\n\n    getTheoreticalAmortization(_ref13) {\n      let {\n        loan,\n        structureId\n      } = _ref13;\n      const loanValue = this.selectLoanValue({\n        loan,\n        structureId\n      });\n      return this.getAmortizationRate({\n        loan,\n        structureId\n      }) * loanValue / 12;\n    }\n\n    getAmortizationRate(_ref14) {\n      let {\n        loan,\n        amortizationYears,\n        structureId\n      } = _ref14;\n      const borrowRatio = this.getBorrowRatio({\n        loan,\n        structureId\n      });\n      return this.getAmortizationRateBase({\n        borrowRatio,\n        amortizationYears,\n        // Prevent caching of this function if amortizationGoal has changed\n        cacheFix: this.amortizationGoal\n      });\n    }\n\n    getMonthly(_ref15) {\n      let {\n        loan,\n        interestRates,\n        structureId\n      } = _ref15;\n      return this.getInterests({\n        loan,\n        interestRates,\n        structureId\n      }) + this.getAmortization({\n        loan,\n        structureId\n      });\n    }\n\n    getTheoreticalPropertyCost(_ref16) {\n      let {\n        loan,\n        structureId,\n        asObject = false\n      } = _ref16;\n      const interests = this.getTheoreticalInterests({\n        loan,\n        structureId\n      });\n      const amortization = this.getTheoreticalAmortization({\n        loan,\n        structureId\n      });\n      const maintenance = this.getTheoreticalMaintenance({\n        loan,\n        structureId\n      });\n      return asObject ? {\n        interests,\n        amortization,\n        maintenance,\n        total: interests + amortization + maintenance\n      } : interests + amortization + maintenance;\n    }\n\n    getTheoreticalMonthly(_ref17) {\n      let {\n        loan,\n        structureId\n      } = _ref17;\n      const propertyCost = this.getTheoreticalPropertyCost({\n        loan,\n        structureId\n      });\n      const expensesToAddToTheoreticalCost = this.getFormattedExpenses({\n        loan,\n        structureId\n      }).add / 12;\n      return propertyCost + expensesToAddToTheoreticalCost;\n    }\n\n    getIncomeRatio(_ref18) {\n      let {\n        loan,\n        structureId\n      } = _ref18;\n      const cost = this.getTheoreticalMonthly({\n        loan,\n        structureId\n      });\n      const income = this.getTotalIncome({\n        borrowers: loan.borrowers\n      });\n      const ratio = cost / (income / 12);\n\n      if (ratio > 1 || ratio < 0) {\n        return 1;\n      }\n\n      return ratio;\n    }\n\n    getBorrowRatio(_ref19) {\n      let {\n        loan,\n        structureId\n      } = _ref19;\n      const wantedLoan = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'wantedLoan'\n      });\n      const propAndWork = this.getPropAndWork({\n        loan,\n        structureId\n      });\n      return wantedLoan / propAndWork;\n    }\n\n    getMaxBorrowRatio() {\n      return this.maxBorrowRatio;\n    }\n\n    loanHasMinimalInformation(_ref20) {\n      let {\n        loan\n      } = _ref20;\n      const structure = this.selectStructure({\n        loan\n      });\n      return !!(structure.ownFunds && structure.ownFunds.length > 0 && this.selectPropertyValue({\n        loan\n      }) && this.selectLoanValue({\n        loan\n      }));\n    }\n\n    getLoanFilesProgress(_ref21) {\n      let {\n        loan\n      } = _ref21;\n      return filesPercent({\n        fileArray: getLoanDocuments({\n          loan\n        }),\n        doc: loan\n      });\n    }\n\n    getMissingLoanDocuments(_ref22) {\n      let {\n        loan\n      } = _ref22;\n      return getMissingDocumentIds({\n        fileArray: getLoanDocuments({\n          loan\n        }),\n        doc: loan\n      });\n    }\n\n    getTotalFinancing(_ref23) {\n      let {\n        loan,\n        structureId\n      } = _ref23;\n      return this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'wantedLoan'\n      }) + this.getNonPledgedOwnFunds({\n        loan,\n        structureId\n      });\n    }\n\n    getNonPledgedOwnFunds(_ref24) {\n      let {\n        loan,\n        structureId\n      } = _ref24;\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds'\n      }) || [];\n      return ownFunds.filter((_ref25) => {\n        let {\n          usageType\n        } = _ref25;\n        return usageType !== OWN_FUNDS_USAGE_TYPES.PLEDGE;\n      }).reduce((sum, _ref26) => {\n        let {\n          value\n        } = _ref26;\n        return sum + value;\n      }, 0);\n    }\n\n    getPledgedOwnFunds(_ref27) {\n      let {\n        loan,\n        structureId\n      } = _ref27;\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds'\n      }) || [];\n      return ownFunds.filter((_ref28) => {\n        let {\n          usageType\n        } = _ref28;\n        return usageType === OWN_FUNDS_USAGE_TYPES.PLEDGE;\n      }).reduce((sum, _ref29) => {\n        let {\n          value\n        } = _ref29;\n        return sum + value;\n      }, 0);\n    }\n\n    getUsedFundsOfType(_ref30) {\n      let {\n        loan,\n        type,\n        usageType,\n        structureId\n      } = _ref30;\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds'\n      }) || [];\n      return ownFunds.filter((_ref31) => {\n        let {\n          type: ownFundType\n        } = _ref31;\n        return type ? ownFundType === type : true;\n      }).filter((_ref32) => {\n        let {\n          usageType: ownFundUsageType\n        } = _ref32;\n        return usageType ? ownFundUsageType === usageType : true;\n      }).reduce((sum, _ref33) => {\n        let {\n          value\n        } = _ref33;\n        return sum + value;\n      }, 0);\n    }\n\n    getRemainingFundsOfType(_ref34) {\n      let {\n        loan,\n        structureId,\n        type\n      } = _ref34;\n      const ownFunds = this.getFunds({\n        loan,\n        type,\n        structureId\n      });\n      return ownFunds - this.getUsedFundsOfType({\n        loan,\n        type,\n        structureId,\n        usageType: type !== OWN_FUNDS_TYPES.BANK_FORTUNE ? OWN_FUNDS_USAGE_TYPES.WITHDRAW : undefined\n      });\n    }\n\n    getTotalRemainingFunds(_ref35) {\n      let {\n        loan,\n        structureId\n      } = _ref35;\n      // Don't count extra third party fortune, as it is not a real \"loan\" from them\n      return Object.values(OWN_FUNDS_TYPES).filter(type => type !== OWN_FUNDS_TYPES.THIRD_PARTY_FORTUNE).reduce((sum, type) => sum + this.getRemainingFundsOfType({\n        loan,\n        structureId,\n        type\n      }), 0);\n    }\n\n    refinancingPercent(_ref36) {\n      let {\n        loan\n      } = _ref36;\n      const array = getCountedArray(getRefinancingFormArray({\n        loan\n      }), loan);\n      return getPercent(array);\n    }\n\n    getMortgageNoteIncrease(_ref37) {\n      let {\n        loan,\n        structureId\n      } = _ref37;\n      const {\n        borrowers = []\n      } = loan;\n      const {\n        mortgageNoteIds = []\n      } = this.selectStructure({\n        loan,\n        structureId\n      });\n      const {\n        mortgageNotes: propertyMortgageNotes = []\n      } = this.selectProperty({\n        loan,\n        structureId\n      });\n      const borrowerMortgageNotes = this.getMortgageNotes({\n        borrowers\n      });\n      const structureMortgageNotes = mortgageNoteIds.map(id => borrowerMortgageNotes.find((_ref38) => {\n        let {\n          _id\n        } = _ref38;\n        return _id === id;\n      }));\n      const allMortgageNotes = [...structureMortgageNotes, ...propertyMortgageNotes];\n      const mortgageNoteValue = allMortgageNotes.reduce((total, _ref39) => {\n        let {\n          value\n        } = _ref39;\n        return total + (value || 0);\n      }, 0);\n      const loanValue = this.selectLoanValue({\n        loan,\n        structureId\n      });\n      return Math.max(0, loanValue - mortgageNoteValue);\n    }\n\n    getCashUsed(_ref40) {\n      let {\n        loan,\n        structureId\n      } = _ref40;\n      const {\n        ownFunds\n      } = this.selectStructure({\n        loan,\n        structureId\n      });\n      return ownFunds.filter((_ref41) => {\n        let {\n          type,\n          usageType\n        } = _ref41;\n        return type !== OWN_FUNDS_TYPES.INSURANCE_2 && usageType !== OWN_FUNDS_USAGE_TYPES.PLEDGE;\n      }).reduce((sum, _ref42) => {\n        let {\n          value\n        } = _ref42;\n        return sum + value;\n      }, 0);\n    }\n\n    getCashRatio(_ref43) {\n      let {\n        loan,\n        structureId\n      } = _ref43;\n      const propAndWork = this.getPropAndWork({\n        loan,\n        structureId\n      });\n      const fees = this.getFees({\n        loan,\n        structureId\n      }).total;\n      const cashUsed = this.getCashUsed({\n        loan,\n        structureId\n      });\n      const cashRatio = (cashUsed - fees) / propAndWork;\n      return cashRatio;\n    }\n\n    hasEnoughCash(_ref44) {\n      let {\n        loan,\n        structureId\n      } = _ref44;\n      return this.getCashRatio({\n        loan,\n        structureId\n      }) >= this.minCash;\n    }\n\n    structureIsValid(_ref45) {\n      let {\n        loan,\n        structureId\n      } = _ref45;\n      const incomeRatio = this.getIncomeRatio({\n        loan,\n        structureId\n      });\n      const borrowRatio = this.getBorrowRatio({\n        loan,\n        structureId\n      });\n\n      if (incomeRatio > this.maxIncomeRatio || borrowRatio > this.maxBorrowRatio) {\n        return false;\n      }\n\n      if (!this.allowPledge && this.getPledgedOwnFunds({\n        loan,\n        structureId\n      }) > 0) {\n        return false;\n      }\n\n      return true;\n    }\n\n    getEstimatedRevenues(_ref46) {\n      let {\n        loan,\n        structureId\n      } = _ref46;\n      const propertyValue = this.selectPropertyValue({\n        loan,\n        structureId\n      });\n      return propertyValue * this.estimatedCommission;\n    }\n\n    getEstimatedReferralRevenues(_ref47) {\n      let {\n        loan,\n        structureId\n      } = _ref47;\n      return this.getEstimatedRevenues({\n        loan,\n        structureId\n      }) * this.referralCommission;\n    }\n\n    getRequiredOwnFunds(_ref48) {\n      let {\n        loan,\n        structureId\n      } = _ref48;\n      const projectValue = this.getProjectValue({\n        loan,\n        structureId\n      });\n      const loanValue = this.selectLoanValue({\n        loan,\n        structureId\n      });\n      return projectValue - loanValue;\n    }\n\n    getMissingOwnFunds(_ref49) {\n      let {\n        loan,\n        structureId\n      } = _ref49;\n      const fundsRequired = this.getRequiredOwnFunds({\n        loan,\n        structureId\n      });\n      const totalCurrentFunds = this.getNonPledgedOwnFunds({\n        loan,\n        structureId\n      });\n      return fundsRequired - totalCurrentFunds;\n    }\n\n    isMissingOwnFunds(_ref50) {\n      let {\n        loan,\n        structureId\n      } = _ref50;\n      const missingOwnFunds = this.getMissingOwnFunds({\n        loan,\n        structureId\n      });\n      return missingOwnFunds >= this.ownFundsRoundingAmount;\n    }\n\n    hasTooMuchOwnFunds(_ref51) {\n      let {\n        loan,\n        structureId\n      } = _ref51;\n      const missingOwnFunds = this.getMissingOwnFunds({\n        loan,\n        structureId\n      });\n      return missingOwnFunds <= -this.ownFundsRoundingAmount;\n    }\n\n    hasCompleteStructure(_ref52) {\n      let {\n        loan\n      } = _ref52;\n      return loan.structures.some((_ref53) => {\n        let {\n          id\n        } = _ref53;\n        const fundsRequired = this.getRequiredOwnFunds({\n          loan,\n          structureId: id\n        });\n\n        if (fundsRequired === 0) {\n          return false;\n        }\n\n        if (!this.isMissingOwnFunds({\n          loan,\n          structureId: id\n        }) && !this.hasTooMuchOwnFunds({\n          loan,\n          structureId: id\n        })) {\n          return true;\n        }\n\n        return false;\n      });\n    }\n\n  };\n};","map":{"version":3,"sources":["imports/core/utils/Calculator/LoanCalculator.js"],"names":["withLoanCalculator","SuperClass","getProjectValue","structureId","propAndWork","value","getTotalUsed","ownFunds","key","sum","getTotalPledged","usageType","OWN_FUNDS_USAGE_TYPES","getFees","notaryFees","total","calculator","calculatedNotaryFees","getFeesCalculator","canton","getInterests","finalInterestRates","interestRates","loan","offer","loanTranches","loanValue","interests","tranches","getTheoreticalInterests","propertyValue","propertyWork","firstRank","Math","secondRank","firstRankInterests","secondRankInterests","getTheoreticalMaintenance","getAmortization","offerOverride","offerToUse","oldAmortizationGoal","amortizationRate","amortizationYears","amortization","getTheoreticalAmortization","getAmortizationRate","borrowRatio","cacheFix","amortizationGoal","getMonthly","getTheoreticalPropertyCost","asObject","maintenance","getTheoreticalMonthly","propertyCost","expensesToAddToTheoreticalCost","getIncomeRatio","cost","income","borrowers","ratio","getBorrowRatio","wantedLoan","getMaxBorrowRatio","loanHasMinimalInformation","structure","getLoanFilesProgress","filesPercent","fileArray","getLoanDocuments","doc","getMissingLoanDocuments","getMissingDocumentIds","getTotalFinancing","getNonPledgedOwnFunds","getPledgedOwnFunds","getUsedFundsOfType","type","ownFundType","ownFundUsageType","getRemainingFundsOfType","OWN_FUNDS_TYPES","undefined","getTotalRemainingFunds","refinancingPercent","array","getCountedArray","getRefinancingFormArray","getPercent","getMortgageNoteIncrease","mortgageNoteIds","mortgageNotes","propertyMortgageNotes","borrowerMortgageNotes","structureMortgageNotes","id","_id","allMortgageNotes","mortgageNoteValue","getCashUsed","getCashRatio","fees","cashUsed","cashRatio","hasEnoughCash","structureIsValid","incomeRatio","getEstimatedRevenues","getEstimatedReferralRevenues","getRequiredOwnFunds","projectValue","getMissingOwnFunds","fundsRequired","totalCurrentFunds","isMissingOwnFunds","missingOwnFunds","hasTooMuchOwnFunds","hasCompleteStructure"],"mappings":"AAAA,MAAA,CAAA,MAAA,CAAA;AAAA,EAAA,kBAAA,EAAA,MAAA;AAAA,CAAA;AAAA,IAAA,eAAA;AAAA,MAAA,CAAA,IAAA,CAAA,qBAAA,EAAA;AAAA,EAAA,eAAA,CAAA,CAAA,EAAA;AAAA,IAAA,eAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,gBAAA;AAAA,MAAA,CAAA,IAAA,CAAA,2BAAA,EAAA;AAAA,EAAA,gBAAA,CAAA,CAAA,EAAA;AAAA,IAAA,gBAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,qBAAA;AAAA,MAAA,CAAA,IAAA,CAAA,qBAAA,EAAA;AAAA,EAAA,qBAAA,CAAA,CAAA,EAAA;AAAA,IAAA,qBAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,YAAA,EAAA,qBAAA;AAAA,MAAA,CAAA,IAAA,CAAA,6BAAA,EAAA;AAAA,EAAA,YAAA,CAAA,CAAA,EAAA;AAAA,IAAA,YAAA,GAAA,CAAA;AAAA,GAAA;;AAAA,EAAA,qBAAA,CAAA,CAAA,EAAA;AAAA,IAAA,qBAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,uBAAA;AAAA,MAAA,CAAA,IAAA,CAAA,mCAAA,EAAA;AAAA,EAAA,OAAA,CAAA,CAAA,EAAA;AAAA,IAAA,uBAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,oBAAA;AAAA,MAAA,CAAA,IAAA,CAAA,oCAAA,EAAA;AAAA,EAAA,OAAA,CAAA,CAAA,EAAA;AAAA,IAAA,oBAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,eAAA;AAAA,MAAA,CAAA,IAAA,CAAA,qBAAA,EAAA;AAAA,EAAA,eAAA,CAAA,CAAA,EAAA;AAAA,IAAA,eAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;AAAA,IAAA,UAAA;AAAA,MAAA,CAAA,IAAA,CAAA,YAAA,EAAA;AAAA,EAAA,UAAA,CAAA,CAAA,EAAA;AAAA,IAAA,UAAA,GAAA,CAAA;AAAA;;AAAA,CAAA,EAAA,CAAA;;AAaO,MAAMA,kBAAkB,GAAG;AAAA,MAACC,UAAD,uEAAc,MAAd,EAAA;AAAA,SAChC,cAAA,UAAA,CAAyB;AACvBC,IAAAA,eAAe,OAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQC,QAAAA;AAAR,OAAuB;AACrC,YAAMC,WAAW,GAAG,KAAA,cAAA,CAAoB;AAAA,QAAA,IAAA;AAAQD,QAAAA;AAAR,OAApB,CAApB;;AACA,UAAI,CAAJ,WAAA,EAAkB;AAChB,eAAA,CAAA;AACD;;AAED,YAAME,KAAK,GAAGD,WAAW,GAAG,KAAA,OAAA,CAAa;AAAA,QAAA,IAAA;AAAQD,QAAAA;AAAR,OAAb,EAA5B,KAAA;AAEA,aAAA,KAAA;AACD;;AAEDG,IAAAA,YAAY,QAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQH,QAAAA;AAAR,OAAuB;AAClC,YAAMI,QAAQ,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAGvCC,QAAAA,GAAG,EAAE;AAHkC,OAAxB,CAAjB;AAKA,aAAOD,QAAQ,CAARA,MAAAA,CAAgB,CAAA,GAAA;AAAA,YAAM;AAAEF,UAAAA;AAAF,SAAN;AAAA,eAAoBI,GAAG,GAAvCF,KAAgB;AAAA,OAAhBA,EAAP,CAAOA,CAAP;AACD;;AAEDG,IAAAA,eAAe,QAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQP,QAAAA;AAAR,OAAuB;AACrC,YAAMI,QAAQ,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAGvCC,QAAAA,GAAG,EAAE;AAHkC,OAAxB,CAAjB;AAKA,aAAOD,QAAQ,CAARA,MAAAA,CACG;AAAA,YAAC;AAAEI,UAAAA;AAAF,SAAD;AAAA,eAAmBA,SAAS,KAAKC,qBAAqB,CADzDL,MACG;AAAA,OADHA,EAAAA,MAAAA,CAEG,CAAA,GAAA;AAAA,YAAM;AAAEF,UAAAA;AAAF,SAAN;AAAA,eAAoBI,GAAG,GAF1BF,KAEG;AAAA,OAFHA,EAAP,CAAOA,CAAP;AAGD;;AAEDM,IAAAA,OAAO,QAAgC;AAAA,UAA/B;AAAA,QAAA,IAAA;AAAQV,QAAAA;AAAR,OAA+B;AACrC,YAAMW,UAAU,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAGzCN,QAAAA,GAAG,EAAE;AAHoC,OAAxB,CAAnB,CADqC,CAOrC;;AACA,UAAIM,UAAU,KAAVA,CAAAA,IAAJ,UAAA,EAAoC;AAClC,eAAO;AAAEC,UAAAA,KAAK,EAAED;AAAT,SAAP;AACD;;AAED,YAAME,UAAU,GAAG,KAAA,iBAAA,CAAuB;AAAA,QAAA,IAAA;AAAQb,QAAAA;AAAR,OAAvB,CAAnB;AAEA,YAAMc,oBAAoB,GAAG,UAAU,CAAV,oBAAA,CAAgC;AAAA,QAAA,IAAA;AAE3Dd,QAAAA;AAF2D,OAAhC,CAA7B;AAKA,aAAA,oBAAA;AACD;;AAEDe,IAAAA,iBAAiB,QAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQf,QAAAA;AAAR,OAAuB;AACvC,YAAMgB,MAAM,GAAG,KAAA,iBAAA,CAAuB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAGpCX,QAAAA,GAAG,EAAE;AAH+B,OAAvB,CAAf;AAKA,aAAO,IAAA,oBAAA,CAAyB;AAAEW,QAAAA;AAAF,OAAzB,CAAP;AACD;;AAEDC,IAAAA,YAAY,QAAuC;AAAA,UAAtC;AAAA,QAAA,IAAA;AAAA,QAAA,aAAA;AAAuBjB,QAAAA;AAAvB,OAAsC;AACjD,UAAIkB,kBAAkB,GAAGC,aAAa,IAAIC,IAAI,CAA9C,oBAAA;AACA,YAAMC,KAAK,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAEpChB,QAAAA,GAAG,EAFiC,OAAA;AAGpCL,QAAAA;AAHoC,OAAxB,CAAd;AAKA,YAAMsB,YAAY,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAE3CjB,QAAAA,GAAG,EAFwC,cAAA;AAG3CL,QAAAA;AAH2C,OAAxB,CAArB;AAKA,YAAMuB,SAAS,GAAG,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQvB,QAAAA;AAAR,OAArB,CAAlB;;AACA,UAAA,KAAA,EAAW;AACTkB,QAAAA,kBAAkB,GAAlBA,KAAAA;AACD;;AAED,YAAMM,SAAS,GAAG,KAAA,wBAAA,CAA8B;AAC9CC,QAAAA,QAAQ,EADsC,YAAA;AAE9CN,QAAAA,aAAa,EAAED;AAF+B,OAA9B,CAAlB;AAKA,aAAQM,SAAS,GAAV,SAACA,GAAR,EAAA;AACD;;AAEDE,IAAAA,uBAAuB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQ1B,QAAAA;AAAR,OAAuB;AAC7C,YAAMuB,SAAS,GAAG,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQvB,QAAAA;AAAR,OAArB,CAAlB;AACA,YAAM2B,aAAa,GAAG,KAAA,mBAAA,CAAyB;AAAA,QAAA,IAAA;AAAQ3B,QAAAA;AAAR,OAAzB,CAAtB;AACA,YAAM4B,YAAY,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAG3CvB,QAAAA,GAAG,EAAE;AAHsC,OAAxB,KAArB,CAAA;AAKA,YAAMwB,SAAS,GAAGC,IAAI,CAAJA,GAAAA,CAAAA,SAAAA,EAEhB,KAAA,gBAAA,IAAyBH,aAAa,GAFxC,YAEE,CAFgBG,CAAlB;AAIA,YAAMC,UAAU,GAAGD,IAAI,CAAJA,GAAAA,CAAAA,CAAAA,EAAYP,SAAS,GAAxC,SAAmBO,CAAnB;AAEA,YAAME,kBAAkB,GAAGH,SAAS,GAAG,KAAvC,uBAAA;AACA,YAAMI,mBAAmB,GAAGF,UAAU,IACjC,KAAA,8BAAA,IAAuC,KAD5C,uBAAsC,CAAtC;AAGA,aAAO,CAACC,kBAAkB,GAAnB,mBAAA,IAAP,EAAA;AACD;;AAEDE,IAAAA,yBAAyB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQlC,QAAAA;AAAR,OAAuB;AAC/C,aACG,KAAA,cAAA,CAAoB;AAAA,QAAA,IAAA;AAAQA,QAAAA;AAAR,OAApB,IACG,KADJ,0BAAC,GADH,EAAA;AAKD;;AAEDmC,IAAAA,eAAe,SAAuC;AAAA,UAAtC;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAAqBC,QAAAA;AAArB,OAAsC;AACpD,YAAMf,KAAK,GAAG,KAAA,WAAA,CAAiB;AAAA,QAAA,IAAA;AAAQrB,QAAAA;AAAR,OAAjB,CAAd;AACA,YAAMuB,SAAS,GAAG,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQvB,QAAAA;AAAR,OAArB,CAAlB;AACA,YAAMqC,UAAU,GAAGD,aAAa,IAAhC,KAAA;;AAEA,UAAA,UAAA,EAAgB;AACd;AACA,cAAME,mBAAmB,GAAG,KAA5B,gBAAA;AACA,aAAA,gBAAA,GAAwBD,UAAU,CAAlC,gBAAA;AAEA,cAAME,gBAAgB,GAAG,KAAA,mBAAA,CAAyB;AAAA,UAAA,IAAA;AAEhDC,UAAAA,iBAAiB,EAAEH,UAAU,CAFmB,iBAAA;AAGhDrC,UAAAA;AAHgD,SAAzB,CAAzB;AAMA,cAAMyC,YAAY,GAAIF,gBAAgB,GAAjB,SAACA,GAAtB,EAAA;AAEA,aAAA,gBAAA,GAAA,mBAAA;AAEA,eAAA,YAAA;AACD;;AAED,YAAMA,gBAAgB,GAAG,KAAA,mBAAA,CAAyB;AAAA,QAAA,IAAA;AAAQvC,QAAAA;AAAR,OAAzB,CAAzB;AACA,aAAQuC,gBAAgB,GAAjB,SAACA,GAAR,EAAA;AACD;;AAEDG,IAAAA,0BAA0B,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQ1C,QAAAA;AAAR,OAAuB;AAChD,YAAMuB,SAAS,GAAG,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQvB,QAAAA;AAAR,OAArB,CAAlB;AAEA,aAAQ,KAAA,mBAAA,CAAyB;AAAA,QAAA,IAAA;AAAQA,QAAAA;AAAR,OAAzB,IAAD,SAAC,GAAR,EAAA;AACD;;AAED2C,IAAAA,mBAAmB,SAA2C;AAAA,UAA1C;AAAA,QAAA,IAAA;AAAA,QAAA,iBAAA;AAA2B3C,QAAAA;AAA3B,OAA0C;AAC5D,YAAM4C,WAAW,GAAG,KAAA,cAAA,CAAoB;AAAA,QAAA,IAAA;AAAQ5C,QAAAA;AAAR,OAApB,CAApB;AACA,aAAO,KAAA,uBAAA,CAA6B;AAAA,QAAA,WAAA;AAAA,QAAA,iBAAA;AAGlC;AACA6C,QAAAA,QAAQ,EAAE,KAAKC;AAJmB,OAA7B,CAAP;AAMD;;AAEDC,IAAAA,UAAU,SAAuC;AAAA,UAAtC;AAAA,QAAA,IAAA;AAAA,QAAA,aAAA;AAAuB/C,QAAAA;AAAvB,OAAsC;AAC/C,aACE,KAAA,YAAA,CAAkB;AAAA,QAAA,IAAA;AAAA,QAAA,aAAA;AAAuBA,QAAAA;AAAvB,OAAlB,IACE,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQA,QAAAA;AAAR,OAArB,CAFJ;AAID;;AAEDgD,IAAAA,0BAA0B,SAA0C;AAAA,UAAzC;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAAqBC,QAAAA,QAAQ,GAAG;AAAhC,OAAyC;AAClE,YAAMzB,SAAS,GAAG,KAAA,uBAAA,CAA6B;AAAA,QAAA,IAAA;AAAQxB,QAAAA;AAAR,OAA7B,CAAlB;AACA,YAAMyC,YAAY,GAAG,KAAA,0BAAA,CAAgC;AAAA,QAAA,IAAA;AAEnDzC,QAAAA;AAFmD,OAAhC,CAArB;AAIA,YAAMkD,WAAW,GAAG,KAAA,yBAAA,CAA+B;AAAA,QAAA,IAAA;AAAQlD,QAAAA;AAAR,OAA/B,CAApB;AACA,aAAOiD,QAAQ,GACX;AAAA,QAAA,SAAA;AAAA,QAAA,YAAA;AAAA,QAAA,WAAA;AAIArC,QAAAA,KAAK,EAAEY,SAAS,GAATA,YAAAA,GAA2B0B;AAJlC,OADW,GAOX1B,SAAS,GAATA,YAAAA,GAPJ,WAAA;AAQD;;AAED2B,IAAAA,qBAAqB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQnD,QAAAA;AAAR,OAAuB;AAC3C,YAAMoD,YAAY,GAAG,KAAA,0BAAA,CAAgC;AAAA,QAAA,IAAA;AAEnDpD,QAAAA;AAFmD,OAAhC,CAArB;AAIA,YAAMqD,8BAA8B,GAAG,KAAA,oBAAA,CAA0B;AAAA,QAAA,IAAA;AAAQrD,QAAAA;AAAR,OAA1B,EAAA,GAAA,GAAvC,EAAA;AAEA,aAAOoD,YAAY,GAAnB,8BAAA;AACD;;AAEDE,IAAAA,cAAc,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQtD,QAAAA;AAAR,OAAuB;AACpC,YAAMuD,IAAI,GAAG,KAAA,qBAAA,CAA2B;AAAA,QAAA,IAAA;AAAQvD,QAAAA;AAAR,OAA3B,CAAb;AACA,YAAMwD,MAAM,GAAG,KAAA,cAAA,CAAoB;AAAEC,QAAAA,SAAS,EAAErC,IAAI,CAACqC;AAAlB,OAApB,CAAf;AACA,YAAMC,KAAK,GAAGH,IAAI,IAAIC,MAAM,GAA5B,EAAkB,CAAlB;;AAEA,UAAIE,KAAK,GAALA,CAAAA,IAAaA,KAAK,GAAtB,CAAA,EAA4B;AAC1B,eAAA,CAAA;AACD;;AAED,aAAA,KAAA;AACD;;AAEDC,IAAAA,cAAc,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQ3D,QAAAA;AAAR,OAAuB;AACpC,YAAM4D,UAAU,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAGzCvD,QAAAA,GAAG,EAAE;AAHoC,OAAxB,CAAnB;AAKA,YAAMJ,WAAW,GAAG,KAAA,cAAA,CAAoB;AAAA,QAAA,IAAA;AAAQD,QAAAA;AAAR,OAApB,CAApB;AACA,aAAO4D,UAAU,GAAjB,WAAA;AACD;;AAEDC,IAAAA,iBAAiB,GAAG;AAClB,aAAO,KAAP,cAAA;AACD;;AAEDC,IAAAA,yBAAyB,SAAW;AAAA,UAAV;AAAE1C,QAAAA;AAAF,OAAU;AAClC,YAAM2C,SAAS,GAAG,KAAA,eAAA,CAAqB;AAAE3C,QAAAA;AAAF,OAArB,CAAlB;AAEA,aAAO,CAAC,EACN,SAAS,CAAT,QAAA,IACG2C,SAAS,CAATA,QAAAA,CAAAA,MAAAA,GADH,CAAA,IAEG,KAAA,mBAAA,CAAyB;AAAE3C,QAAAA;AAAF,OAAzB,CAFH,IAGG,KAAA,eAAA,CAAqB;AAAEA,QAAAA;AAAF,OAArB,CAJG,CAAR;AAMD;;AAED4C,IAAAA,oBAAoB,SAAW;AAAA,UAAV;AAAE5C,QAAAA;AAAF,OAAU;AAC7B,aAAO6C,YAAY,CAAC;AAAEC,QAAAA,SAAS,EAAEC,gBAAgB,CAAC;AAAE/C,UAAAA;AAAF,SAAD,CAA7B;AAAyCgD,QAAAA,GAAG,EAAEhD;AAA9C,OAAD,CAAnB;AACD;;AAEDiD,IAAAA,uBAAuB,SAAW;AAAA,UAAV;AAAEjD,QAAAA;AAAF,OAAU;AAChC,aAAOkD,qBAAqB,CAAC;AAC3BJ,QAAAA,SAAS,EAAEC,gBAAgB,CAAC;AAAE/C,UAAAA;AAAF,SAAD,CADA;AAE3BgD,QAAAA,GAAG,EAAEhD;AAFsB,OAAD,CAA5B;AAID;;AAEDmD,IAAAA,iBAAiB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQvE,QAAAA;AAAR,OAAuB;AACvC,aACE,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAAqBK,QAAAA,GAAG,EAAE;AAA1B,OAAxB,IACE,KAAA,qBAAA,CAA2B;AAAA,QAAA,IAAA;AAAQL,QAAAA;AAAR,OAA3B,CAFJ;AAID;;AAEDwE,IAAAA,qBAAqB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQxE,QAAAA;AAAR,OAAuB;AAC3C,YAAMI,QAAQ,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAAqBC,QAAAA,GAAG,EAAE;AAA1B,OAAxB,KAAjB,EAAA;AACA,aAAOD,QAAQ,CAARA,MAAAA,CACG;AAAA,YAAC;AAAEI,UAAAA;AAAF,SAAD;AAAA,eAAmBA,SAAS,KAAKC,qBAAqB,CADzDL,MACG;AAAA,OADHA,EAAAA,MAAAA,CAEG,CAAA,GAAA;AAAA,YAAM;AAAEF,UAAAA;AAAF,SAAN;AAAA,eAAoBI,GAAG,GAF1BF,KAEG;AAAA,OAFHA,EAAP,CAAOA,CAAP;AAGD;;AAEDqE,IAAAA,kBAAkB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQzE,QAAAA;AAAR,OAAuB;AACxC,YAAMI,QAAQ,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAAqBC,QAAAA,GAAG,EAAE;AAA1B,OAAxB,KAAjB,EAAA;AACA,aAAOD,QAAQ,CAARA,MAAAA,CACG;AAAA,YAAC;AAAEI,UAAAA;AAAF,SAAD;AAAA,eAAmBA,SAAS,KAAKC,qBAAqB,CADzDL,MACG;AAAA,OADHA,EAAAA,MAAAA,CAEG,CAAA,GAAA;AAAA,YAAM;AAAEF,UAAAA;AAAF,SAAN;AAAA,eAAoBI,GAAG,GAF1BF,KAEG;AAAA,OAFHA,EAAP,CAAOA,CAAP;AAGD;;AAEDsE,IAAAA,kBAAkB,SAAyC;AAAA,UAAxC;AAAA,QAAA,IAAA;AAAA,QAAA,IAAA;AAAA,QAAA,SAAA;AAAyB1E,QAAAA;AAAzB,OAAwC;AACzD,YAAMI,QAAQ,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAAqBC,QAAAA,GAAG,EAAE;AAA1B,OAAxB,KAAjB,EAAA;AACA,aAAOD,QAAQ,CAARA,MAAAA,CACG;AAAA,YAAC;AAAEuE,UAAAA,IAAI,EAAEC;AAAR,SAAD;AAAA,eAA4BD,IAAI,GAAGC,WAAW,KAAd,IAAA,GADnCxE,IACG;AAAA,OADHA,EAAAA,MAAAA,CAEG;AAAA,YAAC;AAAEI,UAAAA,SAAS,EAAEqE;AAAb,SAAD;AAAA,eACLrE,SAAS,GAAGqE,gBAAgB,KAAnB,SAAA,GAHPzE,IAEG;AAAA,OAFHA,EAAAA,MAAAA,CAIG,CAAA,GAAA;AAAA,YAAM;AAAEF,UAAAA;AAAF,SAAN;AAAA,eAAoBI,GAAG,GAJ1BF,KAIG;AAAA,OAJHA,EAAP,CAAOA,CAAP;AAKD;;AAED0E,IAAAA,uBAAuB,SAA8B;AAAA,UAA7B;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAAqBH,QAAAA;AAArB,OAA6B;AACnD,YAAMvE,QAAQ,GAAG,KAAA,QAAA,CAAc;AAAA,QAAA,IAAA;AAAA,QAAA,IAAA;AAAcJ,QAAAA;AAAd,OAAd,CAAjB;AACA,aACEI,QAAQ,GACN,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAIxBI,QAAAA,SAAS,EACPmE,IAAI,KAAKI,eAAe,CAAxBJ,YAAAA,GACIlE,qBAAqB,CADzBkE,QAAAA,GAEIK;AAPkB,OAAxB,CAFJ;AAYD;;AAEDC,IAAAA,sBAAsB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQjF,QAAAA;AAAR,OAAuB;AAC5C;AACA,aAAO,MAAM,CAAN,MAAA,CAAA,eAAA,EAAA,MAAA,CACG2E,IAAI,IAAIA,IAAI,KAAKI,eAAe,CADnC,mBAAA,EAAA,MAAA,CAGH,CAAA,GAAA,EAAA,IAAA,KACEzE,GAAG,GAAG,KAAA,uBAAA,CAA6B;AAAA,QAAA,IAAA;AAAA,QAAA,WAAA;AAAqBqE,QAAAA;AAArB,OAA7B,CAJL,EAAP,CAAO,CAAP;AAOD;;AAEDO,IAAAA,kBAAkB,SAAW;AAAA,UAAV;AAAE9D,QAAAA;AAAF,OAAU;AAC3B,YAAM+D,KAAK,GAAGC,eAAe,CAACC,uBAAuB,CAAC;AAAEjE,QAAAA;AAAF,OAAD,CAAxB,EAA7B,IAA6B,CAA7B;AACA,aAAOkE,UAAU,CAAjB,KAAiB,CAAjB;AACD;;AAEDC,IAAAA,uBAAuB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQvF,QAAAA;AAAR,OAAuB;AAC7C,YAAM;AAAEyD,QAAAA,SAAS,GAAG;AAAd,UAAN,IAAA;AACA,YAAM;AAAE+B,QAAAA,eAAe,GAAG;AAApB,UAA2B,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAEpDxF,QAAAA;AAFoD,OAArB,CAAjC;AAKA,YAAM;AAAEyF,QAAAA,aAAa,EAAEC,qBAAqB,GAAG;AAAzC,UAAgD,KAAA,cAAA,CAAoB;AAAA,QAAA,IAAA;AAAQ1F,QAAAA;AAAR,OAApB,CAAtD;AACA,YAAM2F,qBAAqB,GAAG,KAAA,gBAAA,CAAsB;AAAElC,QAAAA;AAAF,OAAtB,CAA9B;AACA,YAAMmC,sBAAsB,GAAG,eAAe,CAAf,GAAA,CAAoBC,EAAE,IACnD,qBAAqB,CAArB,IAAA,CAA2B;AAAA,YAAC;AAAEC,UAAAA;AAAF,SAAD;AAAA,eAAaA,GAAG,KAD7C,EAC6B;AAAA,OAA3B,CAD6B,CAA/B;AAGA,YAAMC,gBAAgB,GAAG,CACvB,GADuB,sBAAA,EAEvB,GAFF,qBAAyB,CAAzB;AAIA,YAAMC,iBAAiB,GAAGD,gBAAgB,CAAhBA,MAAAA,CACxB,CAAA,KAAA;AAAA,YAAQ;AAAE7F,UAAAA;AAAF,SAAR;AAAA,eAAsBU,KAAK,IAAIV,KAAK,IADZ6F,CACG,CAA3B;AAAA,OADwBA,EAA1B,CAA0BA,CAA1B;AAIA,YAAMxE,SAAS,GAAG,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQvB,QAAAA;AAAR,OAArB,CAAlB;AAEA,aAAO8B,IAAI,CAAJA,GAAAA,CAAAA,CAAAA,EAAYP,SAAS,GAA5B,iBAAOO,CAAP;AACD;;AAEDmE,IAAAA,WAAW,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQjG,QAAAA;AAAR,OAAuB;AACjC,YAAM;AAAEI,QAAAA;AAAF,UAAe,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQJ,QAAAA;AAAR,OAArB,CAArB;AAEA,aAAOI,QAAQ,CAARA,MAAAA,CACG;AAAA,YAAC;AAAA,UAAA,IAAA;AAAQI,UAAAA;AAAR,SAAD;AAAA,eACNmE,IAAI,KAAKI,eAAe,CAAxBJ,WAAAA,IACKnE,SAAS,KAAKC,qBAAqB,CAHrCL,MACG;AAAA,OADHA,EAAAA,MAAAA,CAIG,CAAA,GAAA;AAAA,YAAM;AAAEF,UAAAA;AAAF,SAAN;AAAA,eAAoBI,GAAG,GAJ1BF,KAIG;AAAA,OAJHA,EAAP,CAAOA,CAAP;AAKD;;AAED8F,IAAAA,YAAY,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQlG,QAAAA;AAAR,OAAuB;AAClC,YAAMC,WAAW,GAAG,KAAA,cAAA,CAAoB;AAAA,QAAA,IAAA;AAAQD,QAAAA;AAAR,OAApB,CAApB;AACA,YAAMmG,IAAI,GAAG,KAAA,OAAA,CAAa;AAAA,QAAA,IAAA;AAAQnG,QAAAA;AAAR,OAAb,EAAb,KAAA;AACA,YAAMoG,QAAQ,GAAG,KAAA,WAAA,CAAiB;AAAA,QAAA,IAAA;AAAQpG,QAAAA;AAAR,OAAjB,CAAjB;AAEA,YAAMqG,SAAS,GAAG,CAACD,QAAQ,GAAT,IAAA,IAAlB,WAAA;AACA,aAAA,SAAA;AACD;;AAEDE,IAAAA,aAAa,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQtG,QAAAA;AAAR,OAAuB;AACnC,aAAO,KAAA,YAAA,CAAkB;AAAA,QAAA,IAAA;AAAQA,QAAAA;AAAR,OAAlB,KAA4C,KAAnD,OAAA;AACD;;AAEDuG,IAAAA,gBAAgB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQvG,QAAAA;AAAR,OAAuB;AACtC,YAAMwG,WAAW,GAAG,KAAA,cAAA,CAAoB;AAAA,QAAA,IAAA;AAAQxG,QAAAA;AAAR,OAApB,CAApB;AACA,YAAM4C,WAAW,GAAG,KAAA,cAAA,CAAoB;AAAA,QAAA,IAAA;AAAQ5C,QAAAA;AAAR,OAApB,CAApB;;AAEA,UACEwG,WAAW,GAAG,KAAdA,cAAAA,IACG5D,WAAW,GAAG,KAFnB,cAAA,EAGE;AACA,eAAA,KAAA;AACD;;AAED,UACE,CAAC,KAAD,WAAA,IACG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAQ5C,QAAAA;AAAR,OAAxB,IAFL,CAAA,EAGE;AACA,eAAA,KAAA;AACD;;AAED,aAAA,IAAA;AACD;;AAEDyG,IAAAA,oBAAoB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQzG,QAAAA;AAAR,OAAuB;AAC1C,YAAM2B,aAAa,GAAG,KAAA,mBAAA,CAAyB;AAAA,QAAA,IAAA;AAAQ3B,QAAAA;AAAR,OAAzB,CAAtB;AACA,aAAO2B,aAAa,GAAG,KAAvB,mBAAA;AACD;;AAED+E,IAAAA,4BAA4B,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQ1G,QAAAA;AAAR,OAAuB;AAClD,aACE,KAAA,oBAAA,CAA0B;AAAA,QAAA,IAAA;AAAQA,QAAAA;AAAR,OAA1B,IACE,KAFJ,kBAAA;AAID;;AAED2G,IAAAA,mBAAmB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQ3G,QAAAA;AAAR,OAAuB;AACzC,YAAM4G,YAAY,GAAG,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQ5G,QAAAA;AAAR,OAArB,CAArB;AACA,YAAMuB,SAAS,GAAG,KAAA,eAAA,CAAqB;AAAA,QAAA,IAAA;AAAQvB,QAAAA;AAAR,OAArB,CAAlB;AACA,aAAO4G,YAAY,GAAnB,SAAA;AACD;;AAEDC,IAAAA,kBAAkB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQ7G,QAAAA;AAAR,OAAuB;AACxC,YAAM8G,aAAa,GAAG,KAAA,mBAAA,CAAyB;AAAA,QAAA,IAAA;AAAQ9G,QAAAA;AAAR,OAAzB,CAAtB;AACA,YAAM+G,iBAAiB,GAAG,KAAA,qBAAA,CAA2B;AAAA,QAAA,IAAA;AAEnD/G,QAAAA;AAFmD,OAA3B,CAA1B;AAKA,aAAO8G,aAAa,GAApB,iBAAA;AACD;;AAEDE,IAAAA,iBAAiB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQhH,QAAAA;AAAR,OAAuB;AACvC,YAAMiH,eAAe,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAQjH,QAAAA;AAAR,OAAxB,CAAxB;AACA,aAAOiH,eAAe,IAAI,KAA1B,sBAAA;AACD;;AAEDC,IAAAA,kBAAkB,SAAwB;AAAA,UAAvB;AAAA,QAAA,IAAA;AAAQlH,QAAAA;AAAR,OAAuB;AACxC,YAAMiH,eAAe,GAAG,KAAA,kBAAA,CAAwB;AAAA,QAAA,IAAA;AAAQjH,QAAAA;AAAR,OAAxB,CAAxB;AACA,aAAOiH,eAAe,IAAI,CAAC,KAA3B,sBAAA;AACD;;AAEDE,IAAAA,oBAAoB,SAAW;AAAA,UAAV;AAAE/F,QAAAA;AAAF,OAAU;AAC7B,aAAO,IAAI,CAAJ,UAAA,CAAA,IAAA,CAAqB,YAAY;AAAA,YAAX;AAAEyE,UAAAA;AAAF,SAAW;AACtC,cAAMiB,aAAa,GAAG,KAAA,mBAAA,CAAyB;AAAA,UAAA,IAAA;AAE7C9G,UAAAA,WAAW,EAAE6F;AAFgC,SAAzB,CAAtB;;AAKA,YAAIiB,aAAa,KAAjB,CAAA,EAAyB;AACvB,iBAAA,KAAA;AACD;;AAED,YACE,CAAC,KAAA,iBAAA,CAAuB;AAAA,UAAA,IAAA;AAAQ9G,UAAAA,WAAW,EAAE6F;AAArB,SAAvB,CAAD,IACG,CAAC,KAAA,kBAAA,CAAwB;AAAA,UAAA,IAAA;AAAQ7F,UAAAA,WAAW,EAAE6F;AAArB,SAAxB,CAFN,EAGE;AACA,iBAAA,IAAA;AACD;;AAED,eAAA,KAAA;AAjBF,OAAO,CAAP;AAmBD;;AA/asB,GADO;AAAA,CAA3B","sourcesContent":["// @flow\nimport { OWN_FUNDS_TYPES } from 'core/api/constants';\nimport { getLoanDocuments } from '../../api/files/documents';\nimport { OWN_FUNDS_USAGE_TYPES } from '../../api/constants';\nimport {\n  filesPercent,\n  getMissingDocumentIds,\n} from '../../api/files/fileHelpers';\nimport getRefinancingFormArray from '../../arrays/RefinancingFormArray';\nimport NotaryFeesCalculator from '../notaryFees/NotaryFeesCalculator';\nimport { getCountedArray } from '../formArrayHelpers';\nimport { getPercent } from '../general';\n\nexport const withLoanCalculator = (SuperClass = class {}) =>\n  class extends SuperClass {\n    getProjectValue({ loan, structureId }) {\n      const propAndWork = this.getPropAndWork({ loan, structureId });\n      if (!propAndWork) {\n        return 0;\n      }\n\n      const value = propAndWork + this.getFees({ loan, structureId }).total;\n\n      return value;\n    }\n\n    getTotalUsed({ loan, structureId }) {\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds',\n      });\n      return ownFunds.reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getTotalPledged({ loan, structureId }) {\n      const ownFunds = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'ownFunds',\n      });\n      return ownFunds\n        .filter(({ usageType }) => usageType === OWN_FUNDS_USAGE_TYPES.PLEDGE)\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getFees({ loan, structureId }): number {\n      const notaryFees = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'notaryFees',\n      });\n\n      // Custom notary fees are provided\n      if (notaryFees === 0 || notaryFees) {\n        return { total: notaryFees };\n      }\n\n      const calculator = this.getFeesCalculator({ loan, structureId });\n\n      const calculatedNotaryFees = calculator.getNotaryFeesForLoan({\n        loan,\n        structureId,\n      });\n\n      return calculatedNotaryFees;\n    }\n\n    getFeesCalculator({ loan, structureId }) {\n      const canton = this.selectPropertyKey({\n        loan,\n        structureId,\n        key: 'canton',\n      });\n      return new NotaryFeesCalculator({ canton });\n    }\n\n    getInterests({ loan, interestRates, structureId }) {\n      let finalInterestRates = interestRates || loan.currentInterestRates;\n      const offer = this.selectStructureKey({\n        loan,\n        key: 'offer',\n        structureId,\n      });\n      const loanTranches = this.selectStructureKey({\n        loan,\n        key: 'loanTranches',\n        structureId,\n      });\n      const loanValue = this.selectLoanValue({ loan, structureId });\n      if (offer) {\n        finalInterestRates = offer;\n      }\n\n      const interests = this.getInterestsWithTranches({\n        tranches: loanTranches,\n        interestRates: finalInterestRates,\n      });\n\n      return (interests * loanValue) / 12;\n    }\n\n    getTheoreticalInterests({ loan, structureId }) {\n      const loanValue = this.selectLoanValue({ loan, structureId });\n      const propertyValue = this.selectPropertyValue({ loan, structureId });\n      const propertyWork = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'propertyWork',\n      }) || 0;\n      const firstRank = Math.min(\n        loanValue,\n        this.amortizationGoal * (propertyValue + propertyWork),\n      );\n      const secondRank = Math.max(0, loanValue - firstRank);\n\n      const firstRankInterests = firstRank * this.theoreticalInterestRate;\n      const secondRankInterests = secondRank\n        * (this.theoreticalInterestRate2ndRank || this.theoreticalInterestRate);\n\n      return (firstRankInterests + secondRankInterests) / 12;\n    }\n\n    getTheoreticalMaintenance({ loan, structureId }) {\n      return (\n        (this.getPropAndWork({ loan, structureId })\n          * this.theoreticalMaintenanceRate)\n        / 12\n      );\n    }\n\n    getAmortization({ loan, structureId, offerOverride }) {\n      const offer = this.selectOffer({ loan, structureId });\n      const loanValue = this.selectLoanValue({ loan, structureId });\n      const offerToUse = offerOverride || offer;\n\n      if (offerToUse) {\n        // Temporarily change amortizationGoal\n        const oldAmortizationGoal = this.amortizationGoal;\n        this.amortizationGoal = offerToUse.amortizationGoal;\n\n        const amortizationRate = this.getAmortizationRate({\n          loan,\n          amortizationYears: offerToUse.amortizationYears,\n          structureId,\n        });\n\n        const amortization = (amortizationRate * loanValue) / 12;\n\n        this.amortizationGoal = oldAmortizationGoal;\n\n        return amortization;\n      }\n\n      const amortizationRate = this.getAmortizationRate({ loan, structureId });\n      return (amortizationRate * loanValue) / 12;\n    }\n\n    getTheoreticalAmortization({ loan, structureId }) {\n      const loanValue = this.selectLoanValue({ loan, structureId });\n\n      return (this.getAmortizationRate({ loan, structureId }) * loanValue) / 12;\n    }\n\n    getAmortizationRate({ loan, amortizationYears, structureId }) {\n      const borrowRatio = this.getBorrowRatio({ loan, structureId });\n      return this.getAmortizationRateBase({\n        borrowRatio,\n        amortizationYears,\n        // Prevent caching of this function if amortizationGoal has changed\n        cacheFix: this.amortizationGoal,\n      });\n    }\n\n    getMonthly({ loan, interestRates, structureId }) {\n      return (\n        this.getInterests({ loan, interestRates, structureId })\n        + this.getAmortization({ loan, structureId })\n      );\n    }\n\n    getTheoreticalPropertyCost({ loan, structureId, asObject = false }) {\n      const interests = this.getTheoreticalInterests({ loan, structureId });\n      const amortization = this.getTheoreticalAmortization({\n        loan,\n        structureId,\n      });\n      const maintenance = this.getTheoreticalMaintenance({ loan, structureId });\n      return asObject\n        ? {\n          interests,\n          amortization,\n          maintenance,\n          total: interests + amortization + maintenance,\n        }\n        : interests + amortization + maintenance;\n    }\n\n    getTheoreticalMonthly({ loan, structureId }) {\n      const propertyCost = this.getTheoreticalPropertyCost({\n        loan,\n        structureId,\n      });\n      const expensesToAddToTheoreticalCost = this.getFormattedExpenses({ loan, structureId }).add / 12;\n\n      return propertyCost + expensesToAddToTheoreticalCost;\n    }\n\n    getIncomeRatio({ loan, structureId }) {\n      const cost = this.getTheoreticalMonthly({ loan, structureId });\n      const income = this.getTotalIncome({ borrowers: loan.borrowers });\n      const ratio = cost / (income / 12);\n\n      if (ratio > 1 || ratio < 0) {\n        return 1;\n      }\n\n      return ratio;\n    }\n\n    getBorrowRatio({ loan, structureId }) {\n      const wantedLoan = this.selectStructureKey({\n        loan,\n        structureId,\n        key: 'wantedLoan',\n      });\n      const propAndWork = this.getPropAndWork({ loan, structureId });\n      return wantedLoan / propAndWork;\n    }\n\n    getMaxBorrowRatio() {\n      return this.maxBorrowRatio;\n    }\n\n    loanHasMinimalInformation({ loan }) {\n      const structure = this.selectStructure({ loan });\n\n      return !!(\n        structure.ownFunds\n        && structure.ownFunds.length > 0\n        && this.selectPropertyValue({ loan })\n        && this.selectLoanValue({ loan })\n      );\n    }\n\n    getLoanFilesProgress({ loan }) {\n      return filesPercent({ fileArray: getLoanDocuments({ loan }), doc: loan });\n    }\n\n    getMissingLoanDocuments({ loan }) {\n      return getMissingDocumentIds({\n        fileArray: getLoanDocuments({ loan }),\n        doc: loan,\n      });\n    }\n\n    getTotalFinancing({ loan, structureId }) {\n      return (\n        this.selectStructureKey({ loan, structureId, key: 'wantedLoan' })\n        + this.getNonPledgedOwnFunds({ loan, structureId })\n      );\n    }\n\n    getNonPledgedOwnFunds({ loan, structureId }) {\n      const ownFunds = this.selectStructureKey({ loan, structureId, key: 'ownFunds' }) || [];\n      return ownFunds\n        .filter(({ usageType }) => usageType !== OWN_FUNDS_USAGE_TYPES.PLEDGE)\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getPledgedOwnFunds({ loan, structureId }) {\n      const ownFunds = this.selectStructureKey({ loan, structureId, key: 'ownFunds' }) || [];\n      return ownFunds\n        .filter(({ usageType }) => usageType === OWN_FUNDS_USAGE_TYPES.PLEDGE)\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getUsedFundsOfType({ loan, type, usageType, structureId }) {\n      const ownFunds = this.selectStructureKey({ loan, structureId, key: 'ownFunds' }) || [];\n      return ownFunds\n        .filter(({ type: ownFundType }) => (type ? ownFundType === type : true))\n        .filter(({ usageType: ownFundUsageType }) =>\n          (usageType ? ownFundUsageType === usageType : true))\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getRemainingFundsOfType({ loan, structureId, type }) {\n      const ownFunds = this.getFunds({ loan, type, structureId });\n      return (\n        ownFunds\n        - this.getUsedFundsOfType({\n          loan,\n          type,\n          structureId,\n          usageType:\n            type !== OWN_FUNDS_TYPES.BANK_FORTUNE\n              ? OWN_FUNDS_USAGE_TYPES.WITHDRAW\n              : undefined,\n        })\n      );\n    }\n\n    getTotalRemainingFunds({ loan, structureId }) {\n      // Don't count extra third party fortune, as it is not a real \"loan\" from them\n      return Object.values(OWN_FUNDS_TYPES)\n        .filter(type => type !== OWN_FUNDS_TYPES.THIRD_PARTY_FORTUNE)\n        .reduce(\n          (sum, type) =>\n            sum + this.getRemainingFundsOfType({ loan, structureId, type }),\n          0,\n        );\n    }\n\n    refinancingPercent({ loan }) {\n      const array = getCountedArray(getRefinancingFormArray({ loan }), loan);\n      return getPercent(array);\n    }\n\n    getMortgageNoteIncrease({ loan, structureId }) {\n      const { borrowers = [] } = loan;\n      const { mortgageNoteIds = [] } = this.selectStructure({\n        loan,\n        structureId,\n      });\n\n      const { mortgageNotes: propertyMortgageNotes = [] } = this.selectProperty({ loan, structureId });\n      const borrowerMortgageNotes = this.getMortgageNotes({ borrowers });\n      const structureMortgageNotes = mortgageNoteIds.map(id =>\n        borrowerMortgageNotes.find(({ _id }) => _id === id));\n\n      const allMortgageNotes = [\n        ...structureMortgageNotes,\n        ...propertyMortgageNotes,\n      ];\n      const mortgageNoteValue = allMortgageNotes.reduce(\n        (total, { value }) => total + (value || 0),\n        0,\n      );\n      const loanValue = this.selectLoanValue({ loan, structureId });\n\n      return Math.max(0, loanValue - mortgageNoteValue);\n    }\n\n    getCashUsed({ loan, structureId }) {\n      const { ownFunds } = this.selectStructure({ loan, structureId });\n\n      return ownFunds\n        .filter(({ type, usageType }) =>\n          type !== OWN_FUNDS_TYPES.INSURANCE_2\n            && usageType !== OWN_FUNDS_USAGE_TYPES.PLEDGE)\n        .reduce((sum, { value }) => sum + value, 0);\n    }\n\n    getCashRatio({ loan, structureId }) {\n      const propAndWork = this.getPropAndWork({ loan, structureId });\n      const fees = this.getFees({ loan, structureId }).total;\n      const cashUsed = this.getCashUsed({ loan, structureId });\n\n      const cashRatio = (cashUsed - fees) / propAndWork;\n      return cashRatio;\n    }\n\n    hasEnoughCash({ loan, structureId }) {\n      return this.getCashRatio({ loan, structureId }) >= this.minCash;\n    }\n\n    structureIsValid({ loan, structureId }) {\n      const incomeRatio = this.getIncomeRatio({ loan, structureId });\n      const borrowRatio = this.getBorrowRatio({ loan, structureId });\n\n      if (\n        incomeRatio > this.maxIncomeRatio\n        || borrowRatio > this.maxBorrowRatio\n      ) {\n        return false;\n      }\n\n      if (\n        !this.allowPledge\n        && this.getPledgedOwnFunds({ loan, structureId }) > 0\n      ) {\n        return false;\n      }\n\n      return true;\n    }\n\n    getEstimatedRevenues({ loan, structureId }) {\n      const propertyValue = this.selectPropertyValue({ loan, structureId });\n      return propertyValue * this.estimatedCommission;\n    }\n\n    getEstimatedReferralRevenues({ loan, structureId }) {\n      return (\n        this.getEstimatedRevenues({ loan, structureId })\n        * this.referralCommission\n      );\n    }\n\n    getRequiredOwnFunds({ loan, structureId }) {\n      const projectValue = this.getProjectValue({ loan, structureId });\n      const loanValue = this.selectLoanValue({ loan, structureId });\n      return projectValue - loanValue;\n    }\n\n    getMissingOwnFunds({ loan, structureId }) {\n      const fundsRequired = this.getRequiredOwnFunds({ loan, structureId });\n      const totalCurrentFunds = this.getNonPledgedOwnFunds({\n        loan,\n        structureId,\n      });\n\n      return fundsRequired - totalCurrentFunds;\n    }\n\n    isMissingOwnFunds({ loan, structureId }) {\n      const missingOwnFunds = this.getMissingOwnFunds({ loan, structureId });\n      return missingOwnFunds >= this.ownFundsRoundingAmount;\n    }\n\n    hasTooMuchOwnFunds({ loan, structureId }) {\n      const missingOwnFunds = this.getMissingOwnFunds({ loan, structureId });\n      return missingOwnFunds <= -this.ownFundsRoundingAmount;\n    }\n\n    hasCompleteStructure({ loan }) {\n      return loan.structures.some(({ id }) => {\n        const fundsRequired = this.getRequiredOwnFunds({\n          loan,\n          structureId: id,\n        });\n\n        if (fundsRequired === 0) {\n          return false;\n        }\n\n        if (\n          !this.isMissingOwnFunds({ loan, structureId: id })\n          && !this.hasTooMuchOwnFunds({ loan, structureId: id })\n        ) {\n          return true;\n        }\n\n        return false;\n      });\n    }\n  };\n"]},"sourceType":"script","hash":"14a22434324006c955521fac3f2cc22f06ccab32"}

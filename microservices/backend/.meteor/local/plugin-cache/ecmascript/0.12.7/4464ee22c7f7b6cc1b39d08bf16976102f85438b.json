{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/loanFunctions.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"imports/core/utils/loanFunctions.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/loanFunctions.js","inputSourceMap":{"version":3,"sources":["imports/core/utils/loanFunctions.js"],"names":["Meteor","STEPS","TASK_STATUS","Calculator","formatLoanWithStructure","selectedStructure","structures","properties","offers","promotionOptions","borrowers","length","undefined","structure","foundStructure","find","id","propertyId","property","_id","promotionOptionId","promotionOption","formatPromotionOptionIntoProperty","offerId","offer","mortgageNoteIds","borrowerMortgageNotes","reduce","arr","mortgageNotes","notes","map","formatLoanWithDocuments","loan","structureProperty","propertyDocuments","documents","formatLoanWithPromotion","selectProperty","structureId","shouldSendStepNotification","prevStep","nextStep","SOLVENCY","REQUEST","OFFERS","nextDueTaskReducer","tasksCache","tasks","activeTasks","filter","status","taskStatus","isPrivate","assigneeLink","assigneeId","ACTIVE","userId","tasksWithoutDate","dueAt","sort","createdAt","A","B","task","noDueDate","sortedTasks"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { STEPS, TASK_STATUS } from '../api/constants';\nimport Calculator from './Calculator';\n\nexport const formatLoanWithStructure = ({\n  selectedStructure,\n  structures = [],\n  properties,\n  offers,\n  promotionOptions,\n  borrowers = [],\n}) => {\n  if (structures.length === 0) {\n    return undefined;\n  }\n\n  let structure = {};\n\n  if (selectedStructure) {\n    const foundStructure = structures.find(({ id }) => id === selectedStructure);\n\n    if (foundStructure) {\n      structure = foundStructure;\n\n      if (structure.propertyId) {\n        const property = properties.find(({ _id }) => _id === structure.propertyId);\n        structure = { ...structure, property };\n      }\n\n      if (structure.promotionOptionId) {\n        const promotionOption = promotionOptions.find(({ _id }) => _id === structure.promotionOptionId);\n        structure = {\n          ...structure,\n          property: Calculator.formatPromotionOptionIntoProperty(promotionOption),\n        };\n      }\n\n      if (structure.offerId) {\n        const offer = offers.find(({ _id }) => _id === structure.offerId);\n        structure = { ...structure, offer };\n      }\n\n      if (structure.mortgageNoteIds) {\n        const borrowerMortgageNotes = borrowers.reduce(\n          (arr, { mortgageNotes: notes = [] }) => [...arr, ...notes],\n          [],\n        );\n        const mortgageNotes = structure.mortgageNoteIds.map(id =>\n          borrowerMortgageNotes.find(({ _id }) => _id === id));\n\n        structure = { ...structure, mortgageNotes };\n      }\n    } else {\n      structure = {};\n    }\n\n    return structure;\n  }\n\n  return structure;\n};\n\nexport const formatLoanWithDocuments = (loan) => {\n  if (!loan || !loan.structure) {\n    return loan;\n  }\n\n  const { structure, properties = [] } = loan;\n  const { property, propertyId } = structure;\n  const structureProperty = properties.find(({ _id }) => _id === propertyId);\n  const propertyDocuments = structureProperty && structureProperty.documents;\n\n  return {\n    ...loan,\n    structure: {\n      ...structure,\n      property: property && {\n        ...property,\n        documents: propertyDocuments,\n      },\n    },\n  };\n};\n\nexport const formatLoanWithPromotion = (loan) => {\n  if (loan.structure.promotionOptionId) {\n    const property = Calculator.selectProperty({\n      loan,\n      // Do this to make sure we're getting the promotionOption and not the\n      // fake property created from it\n      structureId: loan.structure.id,\n    });\n    return { ...loan, structure: { ...loan.structure, property } };\n  }\n\n  return loan;\n};\n\nexport const shouldSendStepNotification = (prevStep, nextStep) =>\n  (prevStep === STEPS.SOLVENCY || prevStep === STEPS.REQUEST)\n  && nextStep === STEPS.OFFERS;\n\nexport const nextDueTaskReducer = ({ tasksCache: tasks = [] }) => {\n  const activeTasks = tasks.filter(({\n    status: taskStatus,\n    isPrivate = false,\n    assigneeLink: { _id: assigneeId } = {},\n  }) => {\n    if (taskStatus !== TASK_STATUS.ACTIVE) {\n      return false;\n    }\n\n    if (isPrivate && assigneeId) {\n      return assigneeId === Meteor.userId();\n    }\n\n    return true;\n  });\n  const tasksWithoutDate = activeTasks\n    .filter(({ dueAt }) => !dueAt)\n    .sort(({ createdAt: A }, { createdAt: B }) => A - B);\n\n  if (tasksWithoutDate.length > 0) {\n    const task = tasksWithoutDate[0];\n    return { ...task, dueAt: task.createdAt, noDueDate: true };\n  }\n\n  const sortedTasks = activeTasks.sort(({ dueAt: A }, { dueAt: B }) => A - B);\n\n  if (sortedTasks.length > 0) {\n    return sortedTasks[0];\n  }\n};\n"]},"passPerPreset":false,"envName":"development","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/loanFunctions.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/utils/loanFunctions.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _toConsumableArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/toConsumableArray\"));\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nmodule.export({\n  formatLoanWithStructure: function () {\n    return formatLoanWithStructure;\n  },\n  formatLoanWithDocuments: function () {\n    return formatLoanWithDocuments;\n  },\n  formatLoanWithPromotion: function () {\n    return formatLoanWithPromotion;\n  },\n  shouldSendStepNotification: function () {\n    return shouldSendStepNotification;\n  },\n  nextDueTaskReducer: function () {\n    return nextDueTaskReducer;\n  }\n});\nvar Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor: function (v) {\n    Meteor = v;\n  }\n}, 0);\nvar STEPS, TASK_STATUS;\nmodule.link(\"../api/constants\", {\n  STEPS: function (v) {\n    STEPS = v;\n  },\n  TASK_STATUS: function (v) {\n    TASK_STATUS = v;\n  }\n}, 1);\nvar Calculator;\nmodule.link(\"./Calculator\", {\n  \"default\": function (v) {\n    Calculator = v;\n  }\n}, 2);\n\nvar formatLoanWithStructure = function (_ref) {\n  var selectedStructure = _ref.selectedStructure,\n      _ref$structures = _ref.structures,\n      structures = _ref$structures === void 0 ? [] : _ref$structures,\n      properties = _ref.properties,\n      offers = _ref.offers,\n      promotionOptions = _ref.promotionOptions,\n      _ref$borrowers = _ref.borrowers,\n      borrowers = _ref$borrowers === void 0 ? [] : _ref$borrowers;\n\n  if (structures.length === 0) {\n    return undefined;\n  }\n\n  var structure = {};\n\n  if (selectedStructure) {\n    var foundStructure = structures.find(function (_ref2) {\n      var id = _ref2.id;\n      return id === selectedStructure;\n    });\n\n    if (foundStructure) {\n      structure = foundStructure;\n\n      if (structure.propertyId) {\n        var property = properties.find(function (_ref3) {\n          var _id = _ref3._id;\n          return _id === structure.propertyId;\n        });\n        structure = (0, _objectSpread2.default)({}, structure, {\n          property: property\n        });\n      }\n\n      if (structure.promotionOptionId) {\n        var promotionOption = promotionOptions.find(function (_ref4) {\n          var _id = _ref4._id;\n          return _id === structure.promotionOptionId;\n        });\n        structure = (0, _objectSpread2.default)({}, structure, {\n          property: Calculator.formatPromotionOptionIntoProperty(promotionOption)\n        });\n      }\n\n      if (structure.offerId) {\n        var offer = offers.find(function (_ref5) {\n          var _id = _ref5._id;\n          return _id === structure.offerId;\n        });\n        structure = (0, _objectSpread2.default)({}, structure, {\n          offer: offer\n        });\n      }\n\n      if (structure.mortgageNoteIds) {\n        var borrowerMortgageNotes = borrowers.reduce(function (arr, _ref6) {\n          var _ref6$mortgageNotes = _ref6.mortgageNotes,\n              notes = _ref6$mortgageNotes === void 0 ? [] : _ref6$mortgageNotes;\n          return [].concat((0, _toConsumableArray2.default)(arr), (0, _toConsumableArray2.default)(notes));\n        }, []);\n        var mortgageNotes = structure.mortgageNoteIds.map(function (id) {\n          return borrowerMortgageNotes.find(function (_ref7) {\n            var _id = _ref7._id;\n            return _id === id;\n          });\n        });\n        structure = (0, _objectSpread2.default)({}, structure, {\n          mortgageNotes: mortgageNotes\n        });\n      }\n    } else {\n      structure = {};\n    }\n\n    return structure;\n  }\n\n  return structure;\n};\n\nvar formatLoanWithDocuments = function (loan) {\n  if (!loan || !loan.structure) {\n    return loan;\n  }\n\n  var structure = loan.structure,\n      _loan$properties = loan.properties,\n      properties = _loan$properties === void 0 ? [] : _loan$properties;\n  var property = structure.property,\n      propertyId = structure.propertyId;\n  var structureProperty = properties.find(function (_ref8) {\n    var _id = _ref8._id;\n    return _id === propertyId;\n  });\n  var propertyDocuments = structureProperty && structureProperty.documents;\n  return (0, _objectSpread2.default)({}, loan, {\n    structure: (0, _objectSpread2.default)({}, structure, {\n      property: property && (0, _objectSpread2.default)({}, property, {\n        documents: propertyDocuments\n      })\n    })\n  });\n};\n\nvar formatLoanWithPromotion = function (loan) {\n  if (loan.structure.promotionOptionId) {\n    var property = Calculator.selectProperty({\n      loan: loan,\n      // Do this to make sure we're getting the promotionOption and not the\n      // fake property created from it\n      structureId: loan.structure.id\n    });\n    return (0, _objectSpread2.default)({}, loan, {\n      structure: (0, _objectSpread2.default)({}, loan.structure, {\n        property: property\n      })\n    });\n  }\n\n  return loan;\n};\n\nvar shouldSendStepNotification = function (prevStep, nextStep) {\n  return (prevStep === STEPS.SOLVENCY || prevStep === STEPS.REQUEST) && nextStep === STEPS.OFFERS;\n};\n\nvar nextDueTaskReducer = function (_ref9) {\n  var _ref9$tasksCache = _ref9.tasksCache,\n      tasks = _ref9$tasksCache === void 0 ? [] : _ref9$tasksCache;\n  var activeTasks = tasks.filter(function (_ref10) {\n    var taskStatus = _ref10.status,\n        _ref10$isPrivate = _ref10.isPrivate,\n        isPrivate = _ref10$isPrivate === void 0 ? false : _ref10$isPrivate,\n        _ref10$assigneeLink = _ref10.assigneeLink;\n    _ref10$assigneeLink = _ref10$assigneeLink === void 0 ? {} : _ref10$assigneeLink;\n    var assigneeId = _ref10$assigneeLink._id;\n\n    if (taskStatus !== TASK_STATUS.ACTIVE) {\n      return false;\n    }\n\n    if (isPrivate && assigneeId) {\n      return assigneeId === Meteor.userId();\n    }\n\n    return true;\n  });\n  var tasksWithoutDate = activeTasks.filter(function (_ref11) {\n    var dueAt = _ref11.dueAt;\n    return !dueAt;\n  }).sort(function (_ref12, _ref13) {\n    var A = _ref12.createdAt;\n    var B = _ref13.createdAt;\n    return A - B;\n  });\n\n  if (tasksWithoutDate.length > 0) {\n    var task = tasksWithoutDate[0];\n    return (0, _objectSpread2.default)({}, task, {\n      dueAt: task.createdAt,\n      noDueDate: true\n    });\n  }\n\n  var sortedTasks = activeTasks.sort(function (_ref14, _ref15) {\n    var A = _ref14.dueAt;\n    var B = _ref15.dueAt;\n    return A - B;\n  });\n\n  if (sortedTasks.length > 0) {\n    return sortedTasks[0];\n  }\n};","map":{"version":3,"sources":["imports/core/utils/loanFunctions.js"],"names":["Meteor","formatLoanWithStructure","structures","borrowers","structure","foundStructure","id","property","properties","_id","promotionOption","promotionOptions","Calculator","offer","offers","borrowerMortgageNotes","mortgageNotes","notes","formatLoanWithDocuments","loan","propertyId","structureProperty","propertyDocuments","documents","formatLoanWithPromotion","structureId","shouldSendStepNotification","prevStep","STEPS","nextStep","nextDueTaskReducer","tasksCache","tasks","activeTasks","status","isPrivate","assigneeLink","assigneeId","taskStatus","TASK_STATUS","tasksWithoutDate","dueAt","createdAt","A","B","task","noDueDate","sortedTasks"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { STEPS, TASK_STATUS } from '../api/constants';\nimport Calculator from './Calculator';\n\nexport const formatLoanWithStructure = ({\n  selectedStructure,\n  structures = [],\n  properties,\n  offers,\n  promotionOptions,\n  borrowers = [],\n}) => {\n  if (structures.length === 0) {\n    return undefined;\n  }\n\n  let structure = {};\n\n  if (selectedStructure) {\n    const foundStructure = structures.find(({ id }) => id === selectedStructure);\n\n    if (foundStructure) {\n      structure = foundStructure;\n\n      if (structure.propertyId) {\n        const property = properties.find(({ _id }) => _id === structure.propertyId);\n        structure = { ...structure, property };\n      }\n\n      if (structure.promotionOptionId) {\n        const promotionOption = promotionOptions.find(({ _id }) => _id === structure.promotionOptionId);\n        structure = {\n          ...structure,\n          property: Calculator.formatPromotionOptionIntoProperty(promotionOption),\n        };\n      }\n\n      if (structure.offerId) {\n        const offer = offers.find(({ _id }) => _id === structure.offerId);\n        structure = { ...structure, offer };\n      }\n\n      if (structure.mortgageNoteIds) {\n        const borrowerMortgageNotes = borrowers.reduce(\n          (arr, { mortgageNotes: notes = [] }) => [...arr, ...notes],\n          [],\n        );\n        const mortgageNotes = structure.mortgageNoteIds.map(id =>\n          borrowerMortgageNotes.find(({ _id }) => _id === id));\n\n        structure = { ...structure, mortgageNotes };\n      }\n    } else {\n      structure = {};\n    }\n\n    return structure;\n  }\n\n  return structure;\n};\n\nexport const formatLoanWithDocuments = (loan) => {\n  if (!loan || !loan.structure) {\n    return loan;\n  }\n\n  const { structure, properties = [] } = loan;\n  const { property, propertyId } = structure;\n  const structureProperty = properties.find(({ _id }) => _id === propertyId);\n  const propertyDocuments = structureProperty && structureProperty.documents;\n\n  return {\n    ...loan,\n    structure: {\n      ...structure,\n      property: property && {\n        ...property,\n        documents: propertyDocuments,\n      },\n    },\n  };\n};\n\nexport const formatLoanWithPromotion = (loan) => {\n  if (loan.structure.promotionOptionId) {\n    const property = Calculator.selectProperty({\n      loan,\n      // Do this to make sure we're getting the promotionOption and not the\n      // fake property created from it\n      structureId: loan.structure.id,\n    });\n    return { ...loan, structure: { ...loan.structure, property } };\n  }\n\n  return loan;\n};\n\nexport const shouldSendStepNotification = (prevStep, nextStep) =>\n  (prevStep === STEPS.SOLVENCY || prevStep === STEPS.REQUEST)\n  && nextStep === STEPS.OFFERS;\n\nexport const nextDueTaskReducer = ({ tasksCache: tasks = [] }) => {\n  const activeTasks = tasks.filter(({\n    status: taskStatus,\n    isPrivate = false,\n    assigneeLink: { _id: assigneeId } = {},\n  }) => {\n    if (taskStatus !== TASK_STATUS.ACTIVE) {\n      return false;\n    }\n\n    if (isPrivate && assigneeId) {\n      return assigneeId === Meteor.userId();\n    }\n\n    return true;\n  });\n  const tasksWithoutDate = activeTasks\n    .filter(({ dueAt }) => !dueAt)\n    .sort(({ createdAt: A }, { createdAt: B }) => A - B);\n\n  if (tasksWithoutDate.length > 0) {\n    const task = tasksWithoutDate[0];\n    return { ...task, dueAt: task.createdAt, noDueDate: true };\n  }\n\n  const sortedTasks = activeTasks.sort(({ dueAt: A }, { dueAt: B }) => A - B);\n\n  if (sortedTasks.length > 0) {\n    return sortedTasks[0];\n  }\n};\n"]},"sourceType":"script","hash":"4464ee22c7f7b6cc1b39d08bf16976102f85438b"}

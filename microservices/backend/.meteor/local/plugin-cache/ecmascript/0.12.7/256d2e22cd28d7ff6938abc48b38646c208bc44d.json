{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/BorrowerCalculator.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"imports/core/utils/Calculator/BorrowerCalculator.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/BorrowerCalculator.js","inputSourceMap":{"version":3,"sources":["imports/core/utils/Calculator/BorrowerCalculator.js"],"names":["OWN_FUNDS_TYPES","getBorrowerDocuments","filesPercent","getMissingDocumentIds","getBorrowerInfoArray","getBorrowerFinanceArray","getBorrowerSimpleArray","arrayify","getPercent","getCountedArray","getMissingFieldIds","getFormValuesHashMultiple","MiddlewareManager","INCOME_CONSIDERATION_TYPES","EXPENSE_TYPES","borrowerExtractorMiddleware","BONUS_ALGORITHMS","REAL_ESTATE_INCOME_ALGORITHMS","withBorrowerCalculator","SuperClass","constructor","config","type","INSURANCE_2","INSURANCE_3A","BANK_3A","INSURANCE_3B","includes","initBorrowerCalculator","middleware","borrowerMiddleware","middlewareManager","applyToAllMethods","getArrayValues","borrowers","key","mapFunc","sum","forEach","borrower","length","map","i","value","reduce","tot","val","Math","max","round","getBonuses","obj","bonusExists","bonusKeys","Object","keys","filter","getBonusIncome","total","acc","arr","bonusAlgorithm","WEAK_AVERAGE","getConsideredValue","values","history","bonusHistoryToConsider","weighting","bonusConsideration","valuesToConsider","slice","getBorrowerCompletion","loan","getBorrowerFilesProgress","percent","personalInfoPercent","percentages","count","fileArray","id","_id","doc","getFunds","isTypeWithArrayValues","sumValues","getFortune","BANK_FORTUNE","getThirdPartyFortune","THIRD_PARTY_FORTUNE","getExpenses","getInsurance2","getInsurance3A","getBank3A","getInsurance3B","getInsuranceFortune","func","getCashFortune","getMissingBorrowerFields","res","missingIds","formArray","borrowerId","formArray2","getMissingBorrowerDocuments","getOtherFortune","getOtherIncome","getTotalFunds","getRealEstateFortune","getRealEstateValue","getRealEstateDebt","getRealEstateIncome","realEstateIncome","income","realEstateIncomeConsideration","getRealEstateIncomeTotal","realEstateIncomeAlgorithm","POSITIVE_NEGATIVE_SPLIT","shouldUseNetSalary","incomeConsiderationType","NET","getSalary","getNetSalary","getFortuneReturns","fortuneReturnsRatio","getTotalIncome","borrowerIncome","getFormattedExpenses","subtract","getRetirement","argMap","age","gender","index","getYearsToRetirement","getAmortizationDuration","retirement","min","Array","isArray","array","b","personalFormArray","financeFormArray","personalInfoPercentSimple","simpleFormArray","borrowerInfoPercent","borrowerFinancePercent","getBorrowerFormHash","t","getNetFortune","getMortgageNotes","mortgageNotes","notes","getRealEstateExpenses","realEstate","realEstateCost","getRealEstateCost","getRealEstateDeltas","allRealEstate","expenses","amortizationRate","getAmortizationRateBase","borrowRatio","getBorrowRatio","propertyValue","getTheoreticalMonthly","propAndWork","loanValue","sumArray","v","getAllExpenses","deltas","REAL_ESTATE_DELTA_NEGATIVE","delta","REAL_ESTATE_DELTA_POSITIVE","getGroupedExpenses","THEORETICAL_REAL_ESTATE","flattenedExpenses","concat","x","description","shouldSubtractExpenseFromIncome","expenseType","expensesSubtractFromIncome","groupRealEstateDeltas","groupedExpenses","toSubtractFromIncome","negativeDeltas","positiveDeltas","getGroupedExpensesBySide","expensesBySide","expenseTypeIsDelta","subtractExpenseTypeFromIncome","formatRealEstateExpenses","add","indexOf","getCommentsForExpenseType","comments","expensesOfType","comment","getCommentsForOtherIncomeType","otherIncome","otherIncomeOfType","canCalculateSolvency"],"mappings":"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","sourcesContent":["// @flow\nimport { OWN_FUNDS_TYPES } from 'imports/core/api/constants';\nimport { getBorrowerDocuments } from 'imports/core/api/files/documents';\nimport {\n  filesPercent,\n  getMissingDocumentIds,\n} from '../../api/files/fileHelpers';\nimport {\n  getBorrowerInfoArray,\n  getBorrowerFinanceArray,\n  getBorrowerSimpleArray,\n} from '../../arrays/BorrowerFormArray';\nimport { arrayify, getPercent } from '../general';\nimport {\n  getCountedArray,\n  getMissingFieldIds,\n  getFormValuesHashMultiple,\n} from '../formArrayHelpers';\nimport MiddlewareManager from '../MiddlewareManager';\nimport { INCOME_CONSIDERATION_TYPES, EXPENSE_TYPES } from '../../api/constants';\nimport { borrowerExtractorMiddleware } from './middleware';\nimport {\n  BONUS_ALGORITHMS,\n  REAL_ESTATE_INCOME_ALGORITHMS,\n} from '../../config/financeConstants';\n\nexport const withBorrowerCalculator = (SuperClass = class {}) =>\n  class extends SuperClass {\n    constructor(config) {\n      super(config);\n      this.initBorrowerCalculator(config);\n    }\n\n    initBorrowerCalculator(config) {\n      const middleware = (config && config.borrowerMiddleware) || borrowerExtractorMiddleware;\n      const middlewareManager = new MiddlewareManager(this);\n      middlewareManager.applyToAllMethods([middleware]);\n    }\n\n    getArrayValues({ borrowers, key, mapFunc }) {\n      let sum = 0;\n\n      arrayify(borrowers).forEach((borrower) => {\n        if (!borrower[key]) {\n          return 0;\n        }\n        sum += [\n          ...(borrower[key] && borrower[key].length > 0\n            ? borrower[key].map(mapFunc || (i => i.value))\n            : []),\n        ].reduce((tot, val) => (val > 0 && tot + val) || tot, 0);\n      });\n\n      return Math.max(0, Math.round(sum));\n    }\n\n    getBonuses({ borrowers }) {\n      return arrayify(borrowers).reduce((obj, borrower) => {\n        if (!borrower.bonusExists) {\n          return obj;\n        }\n\n        const bonusKeys = Object.keys(borrower).filter(key =>\n          key.includes('bonus')\n            && key !== 'bonusExists'\n            && borrower[key] >= 0\n            && borrower[key] !== null);\n\n        bonusKeys.forEach((key) => {\n          const value = borrower[key];\n\n          if (obj[key]) {\n            obj = { ...obj, [key]: obj[key] + value };\n          } else {\n            obj = { ...obj, [key]: value };\n          }\n        });\n\n        return obj;\n      }, {});\n    }\n\n    getBonusIncome({ borrowers }) {\n      const bonusKeys = [\n        'bonus2015',\n        'bonus2016',\n        'bonus2017',\n        'bonus2018',\n        'bonus2019',\n      ];\n      const total = arrayify(borrowers).reduce((acc, borrower) => {\n        if (!borrower.bonusExists) {\n          return acc + 0;\n        }\n\n        const arr = bonusKeys\n          .map(key => borrower[key])\n          .filter(val =>\n            (this.bonusAlgorithm === BONUS_ALGORITHMS.WEAK_AVERAGE\n              ? val > 0\n              : true));\n\n        return (\n          acc\n          + this.getConsideredValue({\n            values: arr,\n            history: this.bonusHistoryToConsider,\n            weighting: this.bonusConsideration,\n          })\n        );\n      }, 0);\n      return Math.max(0, Math.round(total));\n    }\n\n    getConsideredValue({ values, history, weighting }) {\n      const valuesToConsider = values.slice(Math.max(0, values.length - history));\n      const sum = valuesToConsider.reduce((tot, val = 0) => tot + val, 0);\n      return (weighting * sum) / valuesToConsider.length || 0;\n    }\n\n    getBorrowerCompletion({ loan, borrowers }) {\n      return (\n        (this.getBorrowerFilesProgress({ loan, borrowers }).percent\n          + this.personalInfoPercent({ borrowers }))\n        / 2\n      );\n    }\n\n    getBorrowerFilesProgress({ loan, borrowers }) {\n      const percentages = arrayify(borrowers).reduce(\n        (total, borrower) => {\n          const { percent, count } = filesPercent({\n            fileArray: getBorrowerDocuments({ loan, id: borrower._id }, this),\n            doc: borrower,\n          });\n          return {\n            percent: total.percent + percent * count,\n            count: total.count + count,\n          };\n        },\n        { percent: 0, count: 0 },\n      );\n\n      return {\n        ...percentages,\n        percent:\n          percentages.count === 0 ? 1 : percentages.percent / percentages.count,\n      };\n    }\n\n    isTypeWithArrayValues = type =>\n      [\n        OWN_FUNDS_TYPES.INSURANCE_2,\n        OWN_FUNDS_TYPES.INSURANCE_3A,\n        OWN_FUNDS_TYPES.BANK_3A,\n        OWN_FUNDS_TYPES.INSURANCE_3B,\n      ].includes(type);\n\n    getFunds({ borrowers, type }) {\n      if (this.isTypeWithArrayValues(type)) {\n        return this.getArrayValues({ borrowers, key: type });\n      }\n\n      return this.sumValues({ borrowers, keys: type });\n    }\n\n    getFortune({ borrowers }) {\n      return this.sumValues({ borrowers, keys: OWN_FUNDS_TYPES.BANK_FORTUNE });\n    }\n\n    getThirdPartyFortune({ borrowers }) {\n      const val = this.sumValues({\n        borrowers,\n        keys: OWN_FUNDS_TYPES.THIRD_PARTY_FORTUNE,\n      });\n      return val;\n    }\n\n    getExpenses({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: 'expenses' });\n    }\n\n    getInsurance2({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_2,\n      });\n    }\n\n    getInsurance3A({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_3A,\n      });\n    }\n\n    getBank3A({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: OWN_FUNDS_TYPES.BANK_3A });\n    }\n\n    getInsurance3B({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_3B,\n      });\n    }\n\n    getInsuranceFortune({ borrowers }) {\n      return [\n        this.getInsurance2,\n        this.getInsurance3A,\n        this.getInsurance3B,\n        this.getBank3A,\n      ].reduce((sum, func) => sum + func({ borrowers }), 0);\n    }\n\n    getCashFortune({ borrowers }) {\n      return [\n        this.getFortune,\n        this.getThirdPartyFortune,\n        this.getInsurance3A,\n        this.getInsurance3B,\n        this.getBank3A,\n      ].reduce((sum, func) => sum + func({ borrowers }), 0);\n    }\n\n    getMissingBorrowerFields({ borrowers }) {\n      const res = arrayify(borrowers).reduce((missingIds, borrower) => {\n        const formArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: borrower._id,\n        });\n        const formArray2 = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: borrower._id,\n        });\n\n        return [\n          ...missingIds,\n          ...getMissingFieldIds(formArray, borrower),\n          ...getMissingFieldIds(formArray2, borrower),\n        ];\n      }, []);\n\n      return res;\n    }\n\n    getMissingBorrowerDocuments({ loan, borrowers }) {\n      return arrayify(borrowers).reduce(\n        (missingIds, borrower) => [\n          ...missingIds,\n          ...getMissingDocumentIds({\n            doc: borrower,\n            fileArray: getBorrowerDocuments({ loan, id: borrower._id }, this),\n          }),\n        ],\n        [],\n      );\n    }\n\n    getOtherFortune({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: 'otherFortune' });\n    }\n\n    getOtherIncome({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: 'otherIncome' });\n    }\n\n    getTotalFunds({ borrowers }) {\n      return (\n        this.getFortune({ borrowers })\n        + this.getThirdPartyFortune({ borrowers })\n        + this.getInsuranceFortune({ borrowers })\n      );\n    }\n\n    getRealEstateFortune({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({ value = 0, loan = 0 }) => value - loan,\n      });\n    }\n\n    getRealEstateValue({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: 'realEstate' });\n    }\n\n    getRealEstateDebt({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({ loan = 0 }) => loan,\n      });\n    }\n\n    getRealEstateIncome({ borrowers }) {\n      const realEstateIncome = this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({ income = 0 }) => income,\n      }) * this.realEstateIncomeConsideration;\n\n      return realEstateIncome;\n    }\n\n    getRealEstateIncomeTotal({ borrowers }) {\n      if (\n        this.realEstateIncomeAlgorithm\n        === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT\n      ) {\n        return 0;\n      }\n\n      return this.getRealEstateIncome({ borrowers });\n    }\n\n    shouldUseNetSalary() {\n      return this.incomeConsiderationType === INCOME_CONSIDERATION_TYPES.NET;\n    }\n\n    getSalary({ borrowers }) {\n      if (this.shouldUseNetSalary()) {\n        return this.getNetSalary({ borrowers });\n      }\n      return this.sumValues({ borrowers, keys: 'salary' });\n    }\n\n    getNetSalary({ borrowers }) {\n      return this.sumValues({ borrowers, keys: 'netSalary' });\n    }\n\n    getFortuneReturns({ borrowers }) {\n      if (this.fortuneReturnsRatio) {\n        return this.fortuneReturnsRatio * this.getFortune({ borrowers });\n      }\n\n      return 0;\n    }\n\n    getTotalIncome({ borrowers }) {\n      let sum = arrayify(borrowers).reduce((total, borrower) => {\n        let borrowerIncome = 0;\n        borrowerIncome += this.getSalary({ borrowers: borrower }) || 0;\n        borrowerIncome += this.getBonusIncome({ borrowers: borrower }) || 0;\n        borrowerIncome += this.getOtherIncome({ borrowers: borrower }) || 0;\n        borrowerIncome += this.getFortuneReturns({ borrowers: borrower }) || 0;\n        borrowerIncome\n          += this.getRealEstateIncomeTotal({ borrowers: borrower }) || 0;\n        return total + borrowerIncome;\n      }, 0);\n\n      sum -= this.getFormattedExpenses({ borrowers }).subtract || 0;\n\n      return sum;\n    }\n\n    getRetirement({ borrowers }) {\n      const argMap = borrowers.reduce(\n        (obj, { age, gender }, index) => ({\n          ...obj,\n          [`${`age${index + 1}`}`]: age,\n          [`${`gender${index + 1}`}`]: gender,\n        }),\n        {},\n      );\n      return this.getYearsToRetirement(argMap);\n    }\n\n    getAmortizationDuration({ borrowers }) {\n      const retirement = this.getRetirement({ borrowers });\n      return Math.min(15, retirement);\n    }\n\n    // personalInfoPercent - Determines the completion rate of the borrower's\n    // personal information forms\n    personalInfoPercent({ borrowers }) {\n      if (!borrowers || (Array.isArray(borrowers) && !borrowers.length)) {\n        return 0;\n      }\n\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const personalFormArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n        });\n        const financeFormArray = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n        });\n        return [\n          ...arr,\n          ...getCountedArray(personalFormArray, b),\n          ...getCountedArray(financeFormArray, b),\n        ];\n      }, []);\n\n      return getPercent(array);\n    }\n\n    personalInfoPercentSimple({ borrowers, loan }) {\n      if ((!borrowers || !borrowers.length) && !loan.borrowers.length) {\n        return 0;\n      }\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const simpleFormArray = getBorrowerSimpleArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n          loan,\n        });\n        return [...arr, ...getCountedArray(simpleFormArray, b)];\n      }, []);\n\n      return getPercent(array);\n    }\n\n    borrowerInfoPercent({ borrowers }) {\n      if (!borrowers || !borrowers.length) {\n        return 0;\n      }\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const personalFormArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n        });\n        return [...arr, ...getCountedArray(personalFormArray, b)];\n      }, []);\n\n      return getPercent(array);\n    }\n\n    borrowerFinancePercent({ borrowers }) {\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const financeFormArray = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n        });\n        return [...arr, ...getCountedArray(financeFormArray, b)];\n      }, []);\n\n      return getPercent(array);\n    }\n\n    getBorrowerFormHash({ borrowers }) {\n      return getFormValuesHashMultiple(arrayify(borrowers).reduce(\n        (arr, borrower) => [\n          ...arr,\n          {\n            formArray: getBorrowerFinanceArray({\n              borrowers: arrayify(borrowers),\n              borrowerId: borrower._id,\n            }),\n            doc: borrower,\n          },\n          {\n            formArray: getBorrowerInfoArray({\n              borrowers: arrayify(borrowers),\n              borrowerId: borrower._id,\n            }),\n            doc: borrower,\n          },\n        ],\n        [],\n      ));\n    }\n\n    sumValues({ borrowers, keys }) {\n      return arrayify(keys).reduce(\n        (total, key) =>\n          total + arrayify(borrowers).reduce((t, b) => t + (b[key] || 0), 0),\n        0,\n      );\n    }\n\n    getNetFortune({ borrowers }) {\n      return (\n        this.getTotalFunds({ borrowers })\n        + this.getRealEstateFortune({ borrowers })\n        + this.getOtherFortune({ borrowers })\n      );\n    }\n\n    getMortgageNotes({ borrowers }) {\n      return borrowers.reduce(\n        (arr, { mortgageNotes: notes = [] }) => [...arr, ...notes],\n        [],\n      );\n    }\n\n    getRealEstateExpenses({ borrowers }) {\n      const realEstate = arrayify(borrowers).reduce(\n        (arr, borrower) => [...arr, ...(borrower.realEstate || [])],\n        [],\n      );\n      const realEstateCost = realEstate.reduce(\n        (tot, obj) => tot + this.getRealEstateCost(obj),\n        0,\n      );\n\n      return realEstateCost;\n    }\n\n    getRealEstateDeltas({ borrowers }) {\n      const allRealEstate = arrayify(borrowers)\n        .map(({ realEstate }) => realEstate)\n        .reduce((arr, realEstate) => [...arr, ...realEstate], []);\n\n      return allRealEstate.map((realEstate) => {\n        const { income } = realEstate;\n        const expenses = this.getRealEstateCost(realEstate) * 12;\n\n        return (\n          Math.round(income * this.realEstateIncomeConsideration) - expenses\n        );\n      });\n    }\n\n    getRealEstateCost({ loan, value }) {\n      const amortizationRate = this.getAmortizationRateBase({\n        borrowRatio: super.getBorrowRatio({ loan, propertyValue: value }),\n      });\n\n      return super.getTheoreticalMonthly({\n        propAndWork: value,\n        loanValue: loan,\n        amortizationRate,\n      }).total;\n    }\n\n    sumArray(arr) {\n      return arr.reduce((tot, v = 0) => tot + v, 0);\n    }\n\n    // Returns an object with all the types of expenses, combined between\n    // borrowers:\n    // {\n    //  LEASING: 23000,\n    //  WELFARE: 4000,\n    //  THEORETICAL_REAL_ESTATE: 30000,\n    //  etc\n    // }\n    getAllExpenses({ borrowers }) {\n      if (\n        this.realEstateIncomeAlgorithm\n        === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT\n      ) {\n        const deltas = this.getRealEstateDeltas({\n          borrowers,\n        });\n        return {\n          // Negative deltas should be made positive so they can be added to expenses\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE]: -this.sumArray(deltas.filter(delta => delta < 0)),\n          // Positive deltas should be made negative so they can be subtracted from income,\n          // and therefore increase income\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE]: -this.sumArray(deltas.filter(delta => delta > 0)),\n          ...this.getGroupedExpenses({ borrowers }),\n        };\n      }\n\n      return {\n        [EXPENSE_TYPES.THEORETICAL_REAL_ESTATE]:\n          this.getRealEstateExpenses({ borrowers }) * 12, // All expenses are annualized\n        ...this.getGroupedExpenses({ borrowers }),\n      };\n    }\n\n    // Same as getAllExpenses, but without real estate expenses\n    getGroupedExpenses({ borrowers }) {\n      const flattenedExpenses = []\n        .concat([], ...arrayify(borrowers).map(({ expenses }) => expenses))\n        .filter(x => x);\n      return flattenedExpenses.reduce(\n        (obj, { value, description }) => ({\n          ...obj,\n          [description]: (obj[description] || 0) + value,\n        }),\n        {},\n      );\n    }\n\n    shouldSubtractExpenseFromIncome(expenseType) {\n      return this.expensesSubtractFromIncome.includes(expenseType);\n    }\n\n    groupRealEstateDeltas({ groupedExpenses, expenses, toSubtractFromIncome }) {\n      const negativeDeltas = expenses[EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE];\n      const positiveDeltas = expenses[EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE];\n\n      if (toSubtractFromIncome) {\n        // If we want to get expenses to subtract from income, add the\n        // positiveDeltas negatively, so they are in fact added to income\n        return {\n          ...groupedExpenses,\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE]: positiveDeltas,\n        };\n      }\n\n      return {\n        ...groupedExpenses,\n        [EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE]: negativeDeltas,\n      };\n    }\n\n    // Returns an object with all expenses to subtract from income\n    // or all expenses to add to expenses, depending on the param `toSubtractFromIncome`¨\n    // {\n    //  LEASING: 23000,\n    // }\n    getGroupedExpensesBySide({ borrowers, toSubtractFromIncome = true }) {\n      const expenses = this.getAllExpenses({ borrowers });\n\n      const expensesBySide = Object.keys(expenses)\n        .filter(expenseType => !this.expenseTypeIsDelta(expenseType))\n        .filter((expenseType) => {\n          const subtractExpenseTypeFromIncome = this.expensesSubtractFromIncome.includes(expenseType);\n          return toSubtractFromIncome\n            ? subtractExpenseTypeFromIncome\n            : !subtractExpenseTypeFromIncome;\n        });\n\n      const groupedExpenses = expensesBySide.reduce(\n        (obj, expenseType) => ({\n          ...obj,\n          [expenseType]: expenses[expenseType],\n        }),\n        {},\n      );\n\n      if (\n        this.realEstateIncomeAlgorithm\n        === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT\n      ) {\n        return this.groupRealEstateDeltas({\n          groupedExpenses,\n          expenses,\n          toSubtractFromIncome,\n        });\n      }\n\n      return groupedExpenses;\n    }\n\n    expenseTypeIsDelta(expenseType) {\n      return [\n        EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE,\n        EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE,\n      ].includes(expenseType);\n    }\n\n    formatRealEstateExpenses({ obj, expenseType, value }) {\n      if (expenseType === EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE) {\n        return { ...obj, add: obj.add + value };\n      }\n\n      return { ...obj, subtract: obj.subtract + value };\n    }\n\n    // Returns an object with 2 keys, `subtract` and `add` that contain the sum\n    // of all expenses to \"subtract from income\" and \"add to expenses\", respectively\n    getFormattedExpenses({ borrowers }) {\n      const expenses = this.getAllExpenses({ borrowers });\n\n      return Object.keys(expenses).reduce(\n        (obj, expenseType) => {\n          const value = expenses[expenseType];\n          if (this.expenseTypeIsDelta(expenseType)) {\n            return this.formatRealEstateExpenses({ obj, expenseType, value });\n          }\n\n          if (this.expensesSubtractFromIncome.indexOf(expenseType) >= 0) {\n            return { ...obj, subtract: obj.subtract + value };\n          }\n\n          return { ...obj, add: obj.add + value };\n        },\n        { subtract: 0, add: 0 },\n      );\n    }\n\n    getCommentsForExpenseType({ borrowers, type }) {\n      return arrayify(borrowers).reduce((comments, { expenses = [] }) => {\n        const expensesOfType = expenses.filter(({ description }) => description === type);\n        return [\n          ...comments,\n          ...expensesOfType.map(({ comment }) => comment),\n        ].filter(x => x);\n      }, []);\n    }\n\n    getCommentsForOtherIncomeType({ borrowers, type }) {\n      return arrayify(borrowers).reduce((comments, { otherIncome = [] }) => {\n        const otherIncomeOfType = otherIncome.filter(({ description }) => description === type);\n        return [\n          ...comments,\n          ...otherIncomeOfType.map(({ comment }) => comment),\n        ].filter(x => x);\n      }, []);\n    }\n\n    canCalculateSolvency({ borrowers }) {\n      if (!borrowers.length) {\n        return false;\n      }\n\n      if (this.getCashFortune({ borrowers }) === 0) {\n        return false;\n      }\n\n      if (this.getSalary({ borrowers }) === 0) {\n        return false;\n      }\n\n      return true;\n    }\n  };\n"]},"passPerPreset":false,"envName":"production","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/BorrowerCalculator.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/utils/Calculator/BorrowerCalculator.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nmodule.export({\n  withBorrowerCalculator: () => withBorrowerCalculator\n});\nlet OWN_FUNDS_TYPES;\nmodule.link(\"../../api/constants\", {\n  OWN_FUNDS_TYPES(v) {\n    OWN_FUNDS_TYPES = v;\n  }\n\n}, 0);\nlet getBorrowerDocuments;\nmodule.link(\"../../api/files/documents\", {\n  getBorrowerDocuments(v) {\n    getBorrowerDocuments = v;\n  }\n\n}, 1);\nlet filesPercent, getMissingDocumentIds;\nmodule.link(\"../../api/files/fileHelpers\", {\n  filesPercent(v) {\n    filesPercent = v;\n  },\n\n  getMissingDocumentIds(v) {\n    getMissingDocumentIds = v;\n  }\n\n}, 2);\nlet getBorrowerInfoArray, getBorrowerFinanceArray, getBorrowerSimpleArray;\nmodule.link(\"../../arrays/BorrowerFormArray\", {\n  getBorrowerInfoArray(v) {\n    getBorrowerInfoArray = v;\n  },\n\n  getBorrowerFinanceArray(v) {\n    getBorrowerFinanceArray = v;\n  },\n\n  getBorrowerSimpleArray(v) {\n    getBorrowerSimpleArray = v;\n  }\n\n}, 3);\nlet arrayify, getPercent;\nmodule.link(\"../general\", {\n  arrayify(v) {\n    arrayify = v;\n  },\n\n  getPercent(v) {\n    getPercent = v;\n  }\n\n}, 4);\nlet getCountedArray, getMissingFieldIds, getFormValuesHashMultiple;\nmodule.link(\"../formArrayHelpers\", {\n  getCountedArray(v) {\n    getCountedArray = v;\n  },\n\n  getMissingFieldIds(v) {\n    getMissingFieldIds = v;\n  },\n\n  getFormValuesHashMultiple(v) {\n    getFormValuesHashMultiple = v;\n  }\n\n}, 5);\nlet MiddlewareManager;\nmodule.link(\"../MiddlewareManager\", {\n  default(v) {\n    MiddlewareManager = v;\n  }\n\n}, 6);\nlet INCOME_CONSIDERATION_TYPES, EXPENSE_TYPES;\nmodule.link(\"../../api/constants\", {\n  INCOME_CONSIDERATION_TYPES(v) {\n    INCOME_CONSIDERATION_TYPES = v;\n  },\n\n  EXPENSE_TYPES(v) {\n    EXPENSE_TYPES = v;\n  }\n\n}, 7);\nlet borrowerExtractorMiddleware;\nmodule.link(\"./middleware\", {\n  borrowerExtractorMiddleware(v) {\n    borrowerExtractorMiddleware = v;\n  }\n\n}, 8);\nlet BONUS_ALGORITHMS, REAL_ESTATE_INCOME_ALGORITHMS;\nmodule.link(\"../../config/financeConstants\", {\n  BONUS_ALGORITHMS(v) {\n    BONUS_ALGORITHMS = v;\n  },\n\n  REAL_ESTATE_INCOME_ALGORITHMS(v) {\n    REAL_ESTATE_INCOME_ALGORITHMS = v;\n  }\n\n}, 9);\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nconst withBorrowerCalculator = (SuperClass = class {}) => {\n  var _temp;\n\n  return _temp = class extends SuperClass {\n    constructor(config) {\n      super(config);\n\n      _defineProperty(this, \"isTypeWithArrayValues\", type => [OWN_FUNDS_TYPES.INSURANCE_2, OWN_FUNDS_TYPES.INSURANCE_3A, OWN_FUNDS_TYPES.BANK_3A, OWN_FUNDS_TYPES.INSURANCE_3B].includes(type));\n\n      this.initBorrowerCalculator(config);\n    }\n\n    initBorrowerCalculator(config) {\n      const middleware = config && config.borrowerMiddleware || borrowerExtractorMiddleware;\n      const middlewareManager = new MiddlewareManager(this);\n      middlewareManager.applyToAllMethods([middleware]);\n    }\n\n    getArrayValues({\n      borrowers,\n      key,\n      mapFunc\n    }) {\n      let sum = 0;\n      arrayify(borrowers).forEach(borrower => {\n        if (!borrower[key]) {\n          return 0;\n        }\n\n        sum += [...(borrower[key] && borrower[key].length > 0 ? borrower[key].map(mapFunc || (i => i.value)) : [])].reduce((tot, val) => val > 0 && tot + val || tot, 0);\n      });\n      return Math.max(0, Math.round(sum));\n    }\n\n    getBonuses({\n      borrowers\n    }) {\n      return arrayify(borrowers).reduce((obj, borrower) => {\n        if (!borrower.bonusExists) {\n          return obj;\n        }\n\n        const bonusKeys = Object.keys(borrower).filter(key => key.includes('bonus') && key !== 'bonusExists' && borrower[key] >= 0 && borrower[key] !== null);\n        bonusKeys.forEach(key => {\n          const value = borrower[key];\n\n          if (obj[key]) {\n            obj = (0, _objectSpread2.default)({}, obj, {\n              [key]: obj[key] + value\n            });\n          } else {\n            obj = (0, _objectSpread2.default)({}, obj, {\n              [key]: value\n            });\n          }\n        });\n        return obj;\n      }, {});\n    }\n\n    getBonusIncome({\n      borrowers\n    }) {\n      const bonusKeys = ['bonus2015', 'bonus2016', 'bonus2017', 'bonus2018', 'bonus2019'];\n      const total = arrayify(borrowers).reduce((acc, borrower) => {\n        if (!borrower.bonusExists) {\n          return acc + 0;\n        }\n\n        const arr = bonusKeys.map(key => borrower[key]).filter(val => this.bonusAlgorithm === BONUS_ALGORITHMS.WEAK_AVERAGE ? val > 0 : true);\n        return acc + this.getConsideredValue({\n          values: arr,\n          history: this.bonusHistoryToConsider,\n          weighting: this.bonusConsideration\n        });\n      }, 0);\n      return Math.max(0, Math.round(total));\n    }\n\n    getConsideredValue({\n      values,\n      history,\n      weighting\n    }) {\n      const valuesToConsider = values.slice(Math.max(0, values.length - history));\n      const sum = valuesToConsider.reduce((tot, val = 0) => tot + val, 0);\n      return weighting * sum / valuesToConsider.length || 0;\n    }\n\n    getBorrowerCompletion({\n      loan,\n      borrowers\n    }) {\n      return (this.getBorrowerFilesProgress({\n        loan,\n        borrowers\n      }).percent + this.personalInfoPercent({\n        borrowers\n      })) / 2;\n    }\n\n    getBorrowerFilesProgress({\n      loan,\n      borrowers\n    }) {\n      const percentages = arrayify(borrowers).reduce((total, borrower) => {\n        const {\n          percent,\n          count\n        } = filesPercent({\n          fileArray: getBorrowerDocuments({\n            loan,\n            id: borrower._id\n          }, this),\n          doc: borrower\n        });\n        return {\n          percent: total.percent + percent * count,\n          count: total.count + count\n        };\n      }, {\n        percent: 0,\n        count: 0\n      });\n      return (0, _objectSpread2.default)({}, percentages, {\n        percent: percentages.count === 0 ? 1 : percentages.percent / percentages.count\n      });\n    }\n\n    getFunds({\n      borrowers,\n      type\n    }) {\n      if (this.isTypeWithArrayValues(type)) {\n        return this.getArrayValues({\n          borrowers,\n          key: type\n        });\n      }\n\n      return this.sumValues({\n        borrowers,\n        keys: type\n      });\n    }\n\n    getFortune({\n      borrowers\n    }) {\n      return this.sumValues({\n        borrowers,\n        keys: OWN_FUNDS_TYPES.BANK_FORTUNE\n      });\n    }\n\n    getThirdPartyFortune({\n      borrowers\n    }) {\n      const val = this.sumValues({\n        borrowers,\n        keys: OWN_FUNDS_TYPES.THIRD_PARTY_FORTUNE\n      });\n      return val;\n    }\n\n    getExpenses({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'expenses'\n      });\n    }\n\n    getInsurance2({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_2\n      });\n    }\n\n    getInsurance3A({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_3A\n      });\n    }\n\n    getBank3A({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.BANK_3A\n      });\n    }\n\n    getInsurance3B({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_3B\n      });\n    }\n\n    getInsuranceFortune({\n      borrowers\n    }) {\n      return [this.getInsurance2, this.getInsurance3A, this.getInsurance3B, this.getBank3A].reduce((sum, func) => sum + func({\n        borrowers\n      }), 0);\n    }\n\n    getCashFortune({\n      borrowers\n    }) {\n      return [this.getFortune, this.getThirdPartyFortune, this.getInsurance3A, this.getInsurance3B, this.getBank3A].reduce((sum, func) => sum + func({\n        borrowers\n      }), 0);\n    }\n\n    getMissingBorrowerFields({\n      borrowers\n    }) {\n      const res = arrayify(borrowers).reduce((missingIds, borrower) => {\n        const formArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: borrower._id\n        });\n        const formArray2 = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: borrower._id\n        });\n        return [...missingIds, ...getMissingFieldIds(formArray, borrower), ...getMissingFieldIds(formArray2, borrower)];\n      }, []);\n      return res;\n    }\n\n    getMissingBorrowerDocuments({\n      loan,\n      borrowers\n    }) {\n      return arrayify(borrowers).reduce((missingIds, borrower) => [...missingIds, ...getMissingDocumentIds({\n        doc: borrower,\n        fileArray: getBorrowerDocuments({\n          loan,\n          id: borrower._id\n        }, this)\n      })], []);\n    }\n\n    getOtherFortune({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'otherFortune'\n      });\n    }\n\n    getOtherIncome({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'otherIncome'\n      });\n    }\n\n    getTotalFunds({\n      borrowers\n    }) {\n      return this.getFortune({\n        borrowers\n      }) + this.getThirdPartyFortune({\n        borrowers\n      }) + this.getInsuranceFortune({\n        borrowers\n      });\n    }\n\n    getRealEstateFortune({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({\n          value = 0,\n          loan = 0\n        }) => value - loan\n      });\n    }\n\n    getRealEstateValue({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'realEstate'\n      });\n    }\n\n    getRealEstateDebt({\n      borrowers\n    }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({\n          loan = 0\n        }) => loan\n      });\n    }\n\n    getRealEstateIncome({\n      borrowers\n    }) {\n      const realEstateIncome = this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({\n          income = 0\n        }) => income\n      }) * this.realEstateIncomeConsideration;\n      return realEstateIncome;\n    }\n\n    getRealEstateIncomeTotal({\n      borrowers\n    }) {\n      if (this.realEstateIncomeAlgorithm === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT) {\n        return 0;\n      }\n\n      return this.getRealEstateIncome({\n        borrowers\n      });\n    }\n\n    shouldUseNetSalary() {\n      return this.incomeConsiderationType === INCOME_CONSIDERATION_TYPES.NET;\n    }\n\n    getSalary({\n      borrowers\n    }) {\n      if (this.shouldUseNetSalary()) {\n        return this.getNetSalary({\n          borrowers\n        });\n      }\n\n      return this.sumValues({\n        borrowers,\n        keys: 'salary'\n      });\n    }\n\n    getNetSalary({\n      borrowers\n    }) {\n      return this.sumValues({\n        borrowers,\n        keys: 'netSalary'\n      });\n    }\n\n    getFortuneReturns({\n      borrowers\n    }) {\n      if (this.fortuneReturnsRatio) {\n        return this.fortuneReturnsRatio * this.getFortune({\n          borrowers\n        });\n      }\n\n      return 0;\n    }\n\n    getTotalIncome({\n      borrowers\n    }) {\n      let sum = arrayify(borrowers).reduce((total, borrower) => {\n        let borrowerIncome = 0;\n        borrowerIncome += this.getSalary({\n          borrowers: borrower\n        }) || 0;\n        borrowerIncome += this.getBonusIncome({\n          borrowers: borrower\n        }) || 0;\n        borrowerIncome += this.getOtherIncome({\n          borrowers: borrower\n        }) || 0;\n        borrowerIncome += this.getFortuneReturns({\n          borrowers: borrower\n        }) || 0;\n        borrowerIncome += this.getRealEstateIncomeTotal({\n          borrowers: borrower\n        }) || 0;\n        return total + borrowerIncome;\n      }, 0);\n      sum -= this.getFormattedExpenses({\n        borrowers\n      }).subtract || 0;\n      return sum;\n    }\n\n    getRetirement({\n      borrowers\n    }) {\n      const argMap = borrowers.reduce((obj, {\n        age,\n        gender\n      }, index) => (0, _objectSpread2.default)({}, obj, {\n        [`${`age${index + 1}`}`]: age,\n        [`${`gender${index + 1}`}`]: gender\n      }), {});\n      return this.getYearsToRetirement(argMap);\n    }\n\n    getAmortizationDuration({\n      borrowers\n    }) {\n      const retirement = this.getRetirement({\n        borrowers\n      });\n      return Math.min(15, retirement);\n    } // personalInfoPercent - Determines the completion rate of the borrower's\n    // personal information forms\n\n\n    personalInfoPercent({\n      borrowers\n    }) {\n      if (!borrowers || Array.isArray(borrowers) && !borrowers.length) {\n        return 0;\n      }\n\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const personalFormArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id\n        });\n        const financeFormArray = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id\n        });\n        return [...arr, ...getCountedArray(personalFormArray, b), ...getCountedArray(financeFormArray, b)];\n      }, []);\n      return getPercent(array);\n    }\n\n    personalInfoPercentSimple({\n      borrowers,\n      loan\n    }) {\n      if ((!borrowers || !borrowers.length) && !loan.borrowers.length) {\n        return 0;\n      }\n\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const simpleFormArray = getBorrowerSimpleArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n          loan\n        });\n        return [...arr, ...getCountedArray(simpleFormArray, b)];\n      }, []);\n      return getPercent(array);\n    }\n\n    borrowerInfoPercent({\n      borrowers\n    }) {\n      if (!borrowers || !borrowers.length) {\n        return 0;\n      }\n\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const personalFormArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id\n        });\n        return [...arr, ...getCountedArray(personalFormArray, b)];\n      }, []);\n      return getPercent(array);\n    }\n\n    borrowerFinancePercent({\n      borrowers\n    }) {\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const financeFormArray = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id\n        });\n        return [...arr, ...getCountedArray(financeFormArray, b)];\n      }, []);\n      return getPercent(array);\n    }\n\n    getBorrowerFormHash({\n      borrowers\n    }) {\n      return getFormValuesHashMultiple(arrayify(borrowers).reduce((arr, borrower) => [...arr, {\n        formArray: getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: borrower._id\n        }),\n        doc: borrower\n      }, {\n        formArray: getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: borrower._id\n        }),\n        doc: borrower\n      }], []));\n    }\n\n    sumValues({\n      borrowers,\n      keys\n    }) {\n      return arrayify(keys).reduce((total, key) => total + arrayify(borrowers).reduce((t, b) => t + (b[key] || 0), 0), 0);\n    }\n\n    getNetFortune({\n      borrowers\n    }) {\n      return this.getTotalFunds({\n        borrowers\n      }) + this.getRealEstateFortune({\n        borrowers\n      }) + this.getOtherFortune({\n        borrowers\n      });\n    }\n\n    getMortgageNotes({\n      borrowers\n    }) {\n      return borrowers.reduce((arr, {\n        mortgageNotes: notes = []\n      }) => [...arr, ...notes], []);\n    }\n\n    getRealEstateExpenses({\n      borrowers\n    }) {\n      const realEstate = arrayify(borrowers).reduce((arr, borrower) => [...arr, ...(borrower.realEstate || [])], []);\n      const realEstateCost = realEstate.reduce((tot, obj) => tot + this.getRealEstateCost(obj), 0);\n      return realEstateCost;\n    }\n\n    getRealEstateDeltas({\n      borrowers\n    }) {\n      const allRealEstate = arrayify(borrowers).map(({\n        realEstate\n      }) => realEstate).reduce((arr, realEstate) => [...arr, ...realEstate], []);\n      return allRealEstate.map(realEstate => {\n        const {\n          income\n        } = realEstate;\n        const expenses = this.getRealEstateCost(realEstate) * 12;\n        return Math.round(income * this.realEstateIncomeConsideration) - expenses;\n      });\n    }\n\n    getRealEstateCost({\n      loan,\n      value\n    }) {\n      const amortizationRate = this.getAmortizationRateBase({\n        borrowRatio: super.getBorrowRatio({\n          loan,\n          propertyValue: value\n        })\n      });\n      return super.getTheoreticalMonthly({\n        propAndWork: value,\n        loanValue: loan,\n        amortizationRate\n      }).total;\n    }\n\n    sumArray(arr) {\n      return arr.reduce((tot, v = 0) => tot + v, 0);\n    } // Returns an object with all the types of expenses, combined between\n    // borrowers:\n    // {\n    //  LEASING: 23000,\n    //  WELFARE: 4000,\n    //  THEORETICAL_REAL_ESTATE: 30000,\n    //  etc\n    // }\n\n\n    getAllExpenses({\n      borrowers\n    }) {\n      if (this.realEstateIncomeAlgorithm === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT) {\n        const deltas = this.getRealEstateDeltas({\n          borrowers\n        });\n        return (0, _objectSpread2.default)({\n          // Negative deltas should be made positive so they can be added to expenses\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE]: -this.sumArray(deltas.filter(delta => delta < 0)),\n          // Positive deltas should be made negative so they can be subtracted from income,\n          // and therefore increase income\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE]: -this.sumArray(deltas.filter(delta => delta > 0))\n        }, this.getGroupedExpenses({\n          borrowers\n        }));\n      }\n\n      return (0, _objectSpread2.default)({\n        [EXPENSE_TYPES.THEORETICAL_REAL_ESTATE]: this.getRealEstateExpenses({\n          borrowers\n        }) * 12\n      }, this.getGroupedExpenses({\n        borrowers\n      }));\n    } // Same as getAllExpenses, but without real estate expenses\n\n\n    getGroupedExpenses({\n      borrowers\n    }) {\n      const flattenedExpenses = [].concat([], ...arrayify(borrowers).map(({\n        expenses\n      }) => expenses)).filter(x => x);\n      return flattenedExpenses.reduce((obj, {\n        value,\n        description\n      }) => (0, _objectSpread2.default)({}, obj, {\n        [description]: (obj[description] || 0) + value\n      }), {});\n    }\n\n    shouldSubtractExpenseFromIncome(expenseType) {\n      return this.expensesSubtractFromIncome.includes(expenseType);\n    }\n\n    groupRealEstateDeltas({\n      groupedExpenses,\n      expenses,\n      toSubtractFromIncome\n    }) {\n      const negativeDeltas = expenses[EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE];\n      const positiveDeltas = expenses[EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE];\n\n      if (toSubtractFromIncome) {\n        // If we want to get expenses to subtract from income, add the\n        // positiveDeltas negatively, so they are in fact added to income\n        return (0, _objectSpread2.default)({}, groupedExpenses, {\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE]: positiveDeltas\n        });\n      }\n\n      return (0, _objectSpread2.default)({}, groupedExpenses, {\n        [EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE]: negativeDeltas\n      });\n    } // Returns an object with all expenses to subtract from income\n    // or all expenses to add to expenses, depending on the param `toSubtractFromIncome`¨\n    // {\n    //  LEASING: 23000,\n    // }\n\n\n    getGroupedExpensesBySide({\n      borrowers,\n      toSubtractFromIncome = true\n    }) {\n      const expenses = this.getAllExpenses({\n        borrowers\n      });\n      const expensesBySide = Object.keys(expenses).filter(expenseType => !this.expenseTypeIsDelta(expenseType)).filter(expenseType => {\n        const subtractExpenseTypeFromIncome = this.expensesSubtractFromIncome.includes(expenseType);\n        return toSubtractFromIncome ? subtractExpenseTypeFromIncome : !subtractExpenseTypeFromIncome;\n      });\n      const groupedExpenses = expensesBySide.reduce((obj, expenseType) => (0, _objectSpread2.default)({}, obj, {\n        [expenseType]: expenses[expenseType]\n      }), {});\n\n      if (this.realEstateIncomeAlgorithm === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT) {\n        return this.groupRealEstateDeltas({\n          groupedExpenses,\n          expenses,\n          toSubtractFromIncome\n        });\n      }\n\n      return groupedExpenses;\n    }\n\n    expenseTypeIsDelta(expenseType) {\n      return [EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE, EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE].includes(expenseType);\n    }\n\n    formatRealEstateExpenses({\n      obj,\n      expenseType,\n      value\n    }) {\n      if (expenseType === EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE) {\n        return (0, _objectSpread2.default)({}, obj, {\n          add: obj.add + value\n        });\n      }\n\n      return (0, _objectSpread2.default)({}, obj, {\n        subtract: obj.subtract + value\n      });\n    } // Returns an object with 2 keys, `subtract` and `add` that contain the sum\n    // of all expenses to \"subtract from income\" and \"add to expenses\", respectively\n\n\n    getFormattedExpenses({\n      borrowers\n    }) {\n      const expenses = this.getAllExpenses({\n        borrowers\n      });\n      return Object.keys(expenses).reduce((obj, expenseType) => {\n        const value = expenses[expenseType];\n\n        if (this.expenseTypeIsDelta(expenseType)) {\n          return this.formatRealEstateExpenses({\n            obj,\n            expenseType,\n            value\n          });\n        }\n\n        if (this.expensesSubtractFromIncome.indexOf(expenseType) >= 0) {\n          return (0, _objectSpread2.default)({}, obj, {\n            subtract: obj.subtract + value\n          });\n        }\n\n        return (0, _objectSpread2.default)({}, obj, {\n          add: obj.add + value\n        });\n      }, {\n        subtract: 0,\n        add: 0\n      });\n    }\n\n    getCommentsForExpenseType({\n      borrowers,\n      type\n    }) {\n      return arrayify(borrowers).reduce((comments, {\n        expenses = []\n      }) => {\n        const expensesOfType = expenses.filter(({\n          description\n        }) => description === type);\n        return [...comments, ...expensesOfType.map(({\n          comment\n        }) => comment)].filter(x => x);\n      }, []);\n    }\n\n    getCommentsForOtherIncomeType({\n      borrowers,\n      type\n    }) {\n      return arrayify(borrowers).reduce((comments, {\n        otherIncome = []\n      }) => {\n        const otherIncomeOfType = otherIncome.filter(({\n          description\n        }) => description === type);\n        return [...comments, ...otherIncomeOfType.map(({\n          comment\n        }) => comment)].filter(x => x);\n      }, []);\n    }\n\n    canCalculateSolvency({\n      borrowers\n    }) {\n      if (!borrowers.length) {\n        return false;\n      }\n\n      if (this.getCashFortune({\n        borrowers\n      }) === 0) {\n        return false;\n      }\n\n      if (this.getSalary({\n        borrowers\n      }) === 0) {\n        return false;\n      }\n\n      return true;\n    }\n\n  }, _temp;\n};","map":{"version":3,"sources":["imports/core/utils/Calculator/BorrowerCalculator.js"],"names":["withBorrowerCalculator","SuperClass","constructor","initBorrowerCalculator","middleware","config","middlewareManager","getArrayValues","mapFunc","sum","arrayify","borrower","i","val","tot","Math","getBonuses","borrowers","bonusKeys","Object","key","value","obj","getBonusIncome","total","acc","arr","BONUS_ALGORITHMS","values","history","weighting","bonusConsideration","getConsideredValue","valuesToConsider","getBorrowerCompletion","getBorrowerFilesProgress","percentages","count","filesPercent","fileArray","getBorrowerDocuments","id","_id","doc","percent","type","OWN_FUNDS_TYPES","getFunds","keys","getFortune","BANK_FORTUNE","getThirdPartyFortune","THIRD_PARTY_FORTUNE","getExpenses","getInsurance2","INSURANCE_2","getInsurance3A","INSURANCE_3A","getBank3A","BANK_3A","getInsurance3B","INSURANCE_3B","getInsuranceFortune","func","getCashFortune","getMissingBorrowerFields","res","formArray","getBorrowerInfoArray","borrowerId","formArray2","getBorrowerFinanceArray","getMissingFieldIds","getMissingBorrowerDocuments","getMissingDocumentIds","getOtherFortune","getOtherIncome","getTotalFunds","getRealEstateFortune","loan","getRealEstateValue","getRealEstateDebt","getRealEstateIncome","realEstateIncome","income","getRealEstateIncomeTotal","REAL_ESTATE_INCOME_ALGORITHMS","shouldUseNetSalary","INCOME_CONSIDERATION_TYPES","getSalary","getNetSalary","getFortuneReturns","getTotalIncome","borrowerIncome","getRetirement","argMap","gender","index","getAmortizationDuration","retirement","personalInfoPercent","Array","array","personalFormArray","b","financeFormArray","getCountedArray","getPercent","personalInfoPercentSimple","simpleFormArray","getBorrowerSimpleArray","borrowerInfoPercent","borrowerFinancePercent","getBorrowerFormHash","getFormValuesHashMultiple","sumValues","t","getNetFortune","getMortgageNotes","mortgageNotes","notes","getRealEstateExpenses","realEstate","realEstateCost","getRealEstateDeltas","allRealEstate","expenses","getRealEstateCost","amortizationRate","borrowRatio","propertyValue","propAndWork","loanValue","sumArray","v","getAllExpenses","deltas","EXPENSE_TYPES","delta","getGroupedExpenses","flattenedExpenses","x","description","shouldSubtractExpenseFromIncome","groupRealEstateDeltas","toSubtractFromIncome","negativeDeltas","positiveDeltas","getGroupedExpensesBySide","expensesBySide","expenseType","subtractExpenseTypeFromIncome","groupedExpenses","expenseTypeIsDelta","formatRealEstateExpenses","add","subtract","getFormattedExpenses","getCommentsForExpenseType","expensesOfType","comment","getCommentsForOtherIncomeType","otherIncome","otherIncomeOfType","canCalculateSolvency"],"mappings":"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","sourcesContent":["// @flow\nimport { OWN_FUNDS_TYPES } from 'imports/core/api/constants';\nimport { getBorrowerDocuments } from 'imports/core/api/files/documents';\nimport {\n  filesPercent,\n  getMissingDocumentIds,\n} from '../../api/files/fileHelpers';\nimport {\n  getBorrowerInfoArray,\n  getBorrowerFinanceArray,\n  getBorrowerSimpleArray,\n} from '../../arrays/BorrowerFormArray';\nimport { arrayify, getPercent } from '../general';\nimport {\n  getCountedArray,\n  getMissingFieldIds,\n  getFormValuesHashMultiple,\n} from '../formArrayHelpers';\nimport MiddlewareManager from '../MiddlewareManager';\nimport { INCOME_CONSIDERATION_TYPES, EXPENSE_TYPES } from '../../api/constants';\nimport { borrowerExtractorMiddleware } from './middleware';\nimport {\n  BONUS_ALGORITHMS,\n  REAL_ESTATE_INCOME_ALGORITHMS,\n} from '../../config/financeConstants';\n\nexport const withBorrowerCalculator = (SuperClass = class {}) =>\n  class extends SuperClass {\n    constructor(config) {\n      super(config);\n      this.initBorrowerCalculator(config);\n    }\n\n    initBorrowerCalculator(config) {\n      const middleware = (config && config.borrowerMiddleware) || borrowerExtractorMiddleware;\n      const middlewareManager = new MiddlewareManager(this);\n      middlewareManager.applyToAllMethods([middleware]);\n    }\n\n    getArrayValues({ borrowers, key, mapFunc }) {\n      let sum = 0;\n\n      arrayify(borrowers).forEach((borrower) => {\n        if (!borrower[key]) {\n          return 0;\n        }\n        sum += [\n          ...(borrower[key] && borrower[key].length > 0\n            ? borrower[key].map(mapFunc || (i => i.value))\n            : []),\n        ].reduce((tot, val) => (val > 0 && tot + val) || tot, 0);\n      });\n\n      return Math.max(0, Math.round(sum));\n    }\n\n    getBonuses({ borrowers }) {\n      return arrayify(borrowers).reduce((obj, borrower) => {\n        if (!borrower.bonusExists) {\n          return obj;\n        }\n\n        const bonusKeys = Object.keys(borrower).filter(key =>\n          key.includes('bonus')\n            && key !== 'bonusExists'\n            && borrower[key] >= 0\n            && borrower[key] !== null);\n\n        bonusKeys.forEach((key) => {\n          const value = borrower[key];\n\n          if (obj[key]) {\n            obj = { ...obj, [key]: obj[key] + value };\n          } else {\n            obj = { ...obj, [key]: value };\n          }\n        });\n\n        return obj;\n      }, {});\n    }\n\n    getBonusIncome({ borrowers }) {\n      const bonusKeys = [\n        'bonus2015',\n        'bonus2016',\n        'bonus2017',\n        'bonus2018',\n        'bonus2019',\n      ];\n      const total = arrayify(borrowers).reduce((acc, borrower) => {\n        if (!borrower.bonusExists) {\n          return acc + 0;\n        }\n\n        const arr = bonusKeys\n          .map(key => borrower[key])\n          .filter(val =>\n            (this.bonusAlgorithm === BONUS_ALGORITHMS.WEAK_AVERAGE\n              ? val > 0\n              : true));\n\n        return (\n          acc\n          + this.getConsideredValue({\n            values: arr,\n            history: this.bonusHistoryToConsider,\n            weighting: this.bonusConsideration,\n          })\n        );\n      }, 0);\n      return Math.max(0, Math.round(total));\n    }\n\n    getConsideredValue({ values, history, weighting }) {\n      const valuesToConsider = values.slice(Math.max(0, values.length - history));\n      const sum = valuesToConsider.reduce((tot, val = 0) => tot + val, 0);\n      return (weighting * sum) / valuesToConsider.length || 0;\n    }\n\n    getBorrowerCompletion({ loan, borrowers }) {\n      return (\n        (this.getBorrowerFilesProgress({ loan, borrowers }).percent\n          + this.personalInfoPercent({ borrowers }))\n        / 2\n      );\n    }\n\n    getBorrowerFilesProgress({ loan, borrowers }) {\n      const percentages = arrayify(borrowers).reduce(\n        (total, borrower) => {\n          const { percent, count } = filesPercent({\n            fileArray: getBorrowerDocuments({ loan, id: borrower._id }, this),\n            doc: borrower,\n          });\n          return {\n            percent: total.percent + percent * count,\n            count: total.count + count,\n          };\n        },\n        { percent: 0, count: 0 },\n      );\n\n      return {\n        ...percentages,\n        percent:\n          percentages.count === 0 ? 1 : percentages.percent / percentages.count,\n      };\n    }\n\n    isTypeWithArrayValues = type =>\n      [\n        OWN_FUNDS_TYPES.INSURANCE_2,\n        OWN_FUNDS_TYPES.INSURANCE_3A,\n        OWN_FUNDS_TYPES.BANK_3A,\n        OWN_FUNDS_TYPES.INSURANCE_3B,\n      ].includes(type);\n\n    getFunds({ borrowers, type }) {\n      if (this.isTypeWithArrayValues(type)) {\n        return this.getArrayValues({ borrowers, key: type });\n      }\n\n      return this.sumValues({ borrowers, keys: type });\n    }\n\n    getFortune({ borrowers }) {\n      return this.sumValues({ borrowers, keys: OWN_FUNDS_TYPES.BANK_FORTUNE });\n    }\n\n    getThirdPartyFortune({ borrowers }) {\n      const val = this.sumValues({\n        borrowers,\n        keys: OWN_FUNDS_TYPES.THIRD_PARTY_FORTUNE,\n      });\n      return val;\n    }\n\n    getExpenses({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: 'expenses' });\n    }\n\n    getInsurance2({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_2,\n      });\n    }\n\n    getInsurance3A({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_3A,\n      });\n    }\n\n    getBank3A({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: OWN_FUNDS_TYPES.BANK_3A });\n    }\n\n    getInsurance3B({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: OWN_FUNDS_TYPES.INSURANCE_3B,\n      });\n    }\n\n    getInsuranceFortune({ borrowers }) {\n      return [\n        this.getInsurance2,\n        this.getInsurance3A,\n        this.getInsurance3B,\n        this.getBank3A,\n      ].reduce((sum, func) => sum + func({ borrowers }), 0);\n    }\n\n    getCashFortune({ borrowers }) {\n      return [\n        this.getFortune,\n        this.getThirdPartyFortune,\n        this.getInsurance3A,\n        this.getInsurance3B,\n        this.getBank3A,\n      ].reduce((sum, func) => sum + func({ borrowers }), 0);\n    }\n\n    getMissingBorrowerFields({ borrowers }) {\n      const res = arrayify(borrowers).reduce((missingIds, borrower) => {\n        const formArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: borrower._id,\n        });\n        const formArray2 = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: borrower._id,\n        });\n\n        return [\n          ...missingIds,\n          ...getMissingFieldIds(formArray, borrower),\n          ...getMissingFieldIds(formArray2, borrower),\n        ];\n      }, []);\n\n      return res;\n    }\n\n    getMissingBorrowerDocuments({ loan, borrowers }) {\n      return arrayify(borrowers).reduce(\n        (missingIds, borrower) => [\n          ...missingIds,\n          ...getMissingDocumentIds({\n            doc: borrower,\n            fileArray: getBorrowerDocuments({ loan, id: borrower._id }, this),\n          }),\n        ],\n        [],\n      );\n    }\n\n    getOtherFortune({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: 'otherFortune' });\n    }\n\n    getOtherIncome({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: 'otherIncome' });\n    }\n\n    getTotalFunds({ borrowers }) {\n      return (\n        this.getFortune({ borrowers })\n        + this.getThirdPartyFortune({ borrowers })\n        + this.getInsuranceFortune({ borrowers })\n      );\n    }\n\n    getRealEstateFortune({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({ value = 0, loan = 0 }) => value - loan,\n      });\n    }\n\n    getRealEstateValue({ borrowers }) {\n      return this.getArrayValues({ borrowers, key: 'realEstate' });\n    }\n\n    getRealEstateDebt({ borrowers }) {\n      return this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({ loan = 0 }) => loan,\n      });\n    }\n\n    getRealEstateIncome({ borrowers }) {\n      const realEstateIncome = this.getArrayValues({\n        borrowers,\n        key: 'realEstate',\n        mapFunc: ({ income = 0 }) => income,\n      }) * this.realEstateIncomeConsideration;\n\n      return realEstateIncome;\n    }\n\n    getRealEstateIncomeTotal({ borrowers }) {\n      if (\n        this.realEstateIncomeAlgorithm\n        === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT\n      ) {\n        return 0;\n      }\n\n      return this.getRealEstateIncome({ borrowers });\n    }\n\n    shouldUseNetSalary() {\n      return this.incomeConsiderationType === INCOME_CONSIDERATION_TYPES.NET;\n    }\n\n    getSalary({ borrowers }) {\n      if (this.shouldUseNetSalary()) {\n        return this.getNetSalary({ borrowers });\n      }\n      return this.sumValues({ borrowers, keys: 'salary' });\n    }\n\n    getNetSalary({ borrowers }) {\n      return this.sumValues({ borrowers, keys: 'netSalary' });\n    }\n\n    getFortuneReturns({ borrowers }) {\n      if (this.fortuneReturnsRatio) {\n        return this.fortuneReturnsRatio * this.getFortune({ borrowers });\n      }\n\n      return 0;\n    }\n\n    getTotalIncome({ borrowers }) {\n      let sum = arrayify(borrowers).reduce((total, borrower) => {\n        let borrowerIncome = 0;\n        borrowerIncome += this.getSalary({ borrowers: borrower }) || 0;\n        borrowerIncome += this.getBonusIncome({ borrowers: borrower }) || 0;\n        borrowerIncome += this.getOtherIncome({ borrowers: borrower }) || 0;\n        borrowerIncome += this.getFortuneReturns({ borrowers: borrower }) || 0;\n        borrowerIncome\n          += this.getRealEstateIncomeTotal({ borrowers: borrower }) || 0;\n        return total + borrowerIncome;\n      }, 0);\n\n      sum -= this.getFormattedExpenses({ borrowers }).subtract || 0;\n\n      return sum;\n    }\n\n    getRetirement({ borrowers }) {\n      const argMap = borrowers.reduce(\n        (obj, { age, gender }, index) => ({\n          ...obj,\n          [`${`age${index + 1}`}`]: age,\n          [`${`gender${index + 1}`}`]: gender,\n        }),\n        {},\n      );\n      return this.getYearsToRetirement(argMap);\n    }\n\n    getAmortizationDuration({ borrowers }) {\n      const retirement = this.getRetirement({ borrowers });\n      return Math.min(15, retirement);\n    }\n\n    // personalInfoPercent - Determines the completion rate of the borrower's\n    // personal information forms\n    personalInfoPercent({ borrowers }) {\n      if (!borrowers || (Array.isArray(borrowers) && !borrowers.length)) {\n        return 0;\n      }\n\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const personalFormArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n        });\n        const financeFormArray = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n        });\n        return [\n          ...arr,\n          ...getCountedArray(personalFormArray, b),\n          ...getCountedArray(financeFormArray, b),\n        ];\n      }, []);\n\n      return getPercent(array);\n    }\n\n    personalInfoPercentSimple({ borrowers, loan }) {\n      if ((!borrowers || !borrowers.length) && !loan.borrowers.length) {\n        return 0;\n      }\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const simpleFormArray = getBorrowerSimpleArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n          loan,\n        });\n        return [...arr, ...getCountedArray(simpleFormArray, b)];\n      }, []);\n\n      return getPercent(array);\n    }\n\n    borrowerInfoPercent({ borrowers }) {\n      if (!borrowers || !borrowers.length) {\n        return 0;\n      }\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const personalFormArray = getBorrowerInfoArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n        });\n        return [...arr, ...getCountedArray(personalFormArray, b)];\n      }, []);\n\n      return getPercent(array);\n    }\n\n    borrowerFinancePercent({ borrowers }) {\n      const array = arrayify(borrowers).reduce((arr, b) => {\n        const financeFormArray = getBorrowerFinanceArray({\n          borrowers: arrayify(borrowers),\n          borrowerId: b._id,\n        });\n        return [...arr, ...getCountedArray(financeFormArray, b)];\n      }, []);\n\n      return getPercent(array);\n    }\n\n    getBorrowerFormHash({ borrowers }) {\n      return getFormValuesHashMultiple(arrayify(borrowers).reduce(\n        (arr, borrower) => [\n          ...arr,\n          {\n            formArray: getBorrowerFinanceArray({\n              borrowers: arrayify(borrowers),\n              borrowerId: borrower._id,\n            }),\n            doc: borrower,\n          },\n          {\n            formArray: getBorrowerInfoArray({\n              borrowers: arrayify(borrowers),\n              borrowerId: borrower._id,\n            }),\n            doc: borrower,\n          },\n        ],\n        [],\n      ));\n    }\n\n    sumValues({ borrowers, keys }) {\n      return arrayify(keys).reduce(\n        (total, key) =>\n          total + arrayify(borrowers).reduce((t, b) => t + (b[key] || 0), 0),\n        0,\n      );\n    }\n\n    getNetFortune({ borrowers }) {\n      return (\n        this.getTotalFunds({ borrowers })\n        + this.getRealEstateFortune({ borrowers })\n        + this.getOtherFortune({ borrowers })\n      );\n    }\n\n    getMortgageNotes({ borrowers }) {\n      return borrowers.reduce(\n        (arr, { mortgageNotes: notes = [] }) => [...arr, ...notes],\n        [],\n      );\n    }\n\n    getRealEstateExpenses({ borrowers }) {\n      const realEstate = arrayify(borrowers).reduce(\n        (arr, borrower) => [...arr, ...(borrower.realEstate || [])],\n        [],\n      );\n      const realEstateCost = realEstate.reduce(\n        (tot, obj) => tot + this.getRealEstateCost(obj),\n        0,\n      );\n\n      return realEstateCost;\n    }\n\n    getRealEstateDeltas({ borrowers }) {\n      const allRealEstate = arrayify(borrowers)\n        .map(({ realEstate }) => realEstate)\n        .reduce((arr, realEstate) => [...arr, ...realEstate], []);\n\n      return allRealEstate.map((realEstate) => {\n        const { income } = realEstate;\n        const expenses = this.getRealEstateCost(realEstate) * 12;\n\n        return (\n          Math.round(income * this.realEstateIncomeConsideration) - expenses\n        );\n      });\n    }\n\n    getRealEstateCost({ loan, value }) {\n      const amortizationRate = this.getAmortizationRateBase({\n        borrowRatio: super.getBorrowRatio({ loan, propertyValue: value }),\n      });\n\n      return super.getTheoreticalMonthly({\n        propAndWork: value,\n        loanValue: loan,\n        amortizationRate,\n      }).total;\n    }\n\n    sumArray(arr) {\n      return arr.reduce((tot, v = 0) => tot + v, 0);\n    }\n\n    // Returns an object with all the types of expenses, combined between\n    // borrowers:\n    // {\n    //  LEASING: 23000,\n    //  WELFARE: 4000,\n    //  THEORETICAL_REAL_ESTATE: 30000,\n    //  etc\n    // }\n    getAllExpenses({ borrowers }) {\n      if (\n        this.realEstateIncomeAlgorithm\n        === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT\n      ) {\n        const deltas = this.getRealEstateDeltas({\n          borrowers,\n        });\n        return {\n          // Negative deltas should be made positive so they can be added to expenses\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE]: -this.sumArray(deltas.filter(delta => delta < 0)),\n          // Positive deltas should be made negative so they can be subtracted from income,\n          // and therefore increase income\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE]: -this.sumArray(deltas.filter(delta => delta > 0)),\n          ...this.getGroupedExpenses({ borrowers }),\n        };\n      }\n\n      return {\n        [EXPENSE_TYPES.THEORETICAL_REAL_ESTATE]:\n          this.getRealEstateExpenses({ borrowers }) * 12, // All expenses are annualized\n        ...this.getGroupedExpenses({ borrowers }),\n      };\n    }\n\n    // Same as getAllExpenses, but without real estate expenses\n    getGroupedExpenses({ borrowers }) {\n      const flattenedExpenses = []\n        .concat([], ...arrayify(borrowers).map(({ expenses }) => expenses))\n        .filter(x => x);\n      return flattenedExpenses.reduce(\n        (obj, { value, description }) => ({\n          ...obj,\n          [description]: (obj[description] || 0) + value,\n        }),\n        {},\n      );\n    }\n\n    shouldSubtractExpenseFromIncome(expenseType) {\n      return this.expensesSubtractFromIncome.includes(expenseType);\n    }\n\n    groupRealEstateDeltas({ groupedExpenses, expenses, toSubtractFromIncome }) {\n      const negativeDeltas = expenses[EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE];\n      const positiveDeltas = expenses[EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE];\n\n      if (toSubtractFromIncome) {\n        // If we want to get expenses to subtract from income, add the\n        // positiveDeltas negatively, so they are in fact added to income\n        return {\n          ...groupedExpenses,\n          [EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE]: positiveDeltas,\n        };\n      }\n\n      return {\n        ...groupedExpenses,\n        [EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE]: negativeDeltas,\n      };\n    }\n\n    // Returns an object with all expenses to subtract from income\n    // or all expenses to add to expenses, depending on the param `toSubtractFromIncome`¨\n    // {\n    //  LEASING: 23000,\n    // }\n    getGroupedExpensesBySide({ borrowers, toSubtractFromIncome = true }) {\n      const expenses = this.getAllExpenses({ borrowers });\n\n      const expensesBySide = Object.keys(expenses)\n        .filter(expenseType => !this.expenseTypeIsDelta(expenseType))\n        .filter((expenseType) => {\n          const subtractExpenseTypeFromIncome = this.expensesSubtractFromIncome.includes(expenseType);\n          return toSubtractFromIncome\n            ? subtractExpenseTypeFromIncome\n            : !subtractExpenseTypeFromIncome;\n        });\n\n      const groupedExpenses = expensesBySide.reduce(\n        (obj, expenseType) => ({\n          ...obj,\n          [expenseType]: expenses[expenseType],\n        }),\n        {},\n      );\n\n      if (\n        this.realEstateIncomeAlgorithm\n        === REAL_ESTATE_INCOME_ALGORITHMS.POSITIVE_NEGATIVE_SPLIT\n      ) {\n        return this.groupRealEstateDeltas({\n          groupedExpenses,\n          expenses,\n          toSubtractFromIncome,\n        });\n      }\n\n      return groupedExpenses;\n    }\n\n    expenseTypeIsDelta(expenseType) {\n      return [\n        EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE,\n        EXPENSE_TYPES.REAL_ESTATE_DELTA_POSITIVE,\n      ].includes(expenseType);\n    }\n\n    formatRealEstateExpenses({ obj, expenseType, value }) {\n      if (expenseType === EXPENSE_TYPES.REAL_ESTATE_DELTA_NEGATIVE) {\n        return { ...obj, add: obj.add + value };\n      }\n\n      return { ...obj, subtract: obj.subtract + value };\n    }\n\n    // Returns an object with 2 keys, `subtract` and `add` that contain the sum\n    // of all expenses to \"subtract from income\" and \"add to expenses\", respectively\n    getFormattedExpenses({ borrowers }) {\n      const expenses = this.getAllExpenses({ borrowers });\n\n      return Object.keys(expenses).reduce(\n        (obj, expenseType) => {\n          const value = expenses[expenseType];\n          if (this.expenseTypeIsDelta(expenseType)) {\n            return this.formatRealEstateExpenses({ obj, expenseType, value });\n          }\n\n          if (this.expensesSubtractFromIncome.indexOf(expenseType) >= 0) {\n            return { ...obj, subtract: obj.subtract + value };\n          }\n\n          return { ...obj, add: obj.add + value };\n        },\n        { subtract: 0, add: 0 },\n      );\n    }\n\n    getCommentsForExpenseType({ borrowers, type }) {\n      return arrayify(borrowers).reduce((comments, { expenses = [] }) => {\n        const expensesOfType = expenses.filter(({ description }) => description === type);\n        return [\n          ...comments,\n          ...expensesOfType.map(({ comment }) => comment),\n        ].filter(x => x);\n      }, []);\n    }\n\n    getCommentsForOtherIncomeType({ borrowers, type }) {\n      return arrayify(borrowers).reduce((comments, { otherIncome = [] }) => {\n        const otherIncomeOfType = otherIncome.filter(({ description }) => description === type);\n        return [\n          ...comments,\n          ...otherIncomeOfType.map(({ comment }) => comment),\n        ].filter(x => x);\n      }, []);\n    }\n\n    canCalculateSolvency({ borrowers }) {\n      if (!borrowers.length) {\n        return false;\n      }\n\n      if (this.getCashFortune({ borrowers }) === 0) {\n        return false;\n      }\n\n      if (this.getSalary({ borrowers }) === 0) {\n        return false;\n      }\n\n      return true;\n    }\n  };\n"]},"sourceType":"script","hash":"256d2e22cd28d7ff6938abc48b38646c208bc44d"}

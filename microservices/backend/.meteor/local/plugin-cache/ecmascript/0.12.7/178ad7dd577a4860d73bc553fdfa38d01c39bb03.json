{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/loans/test/server/proLoans.expose.app-test.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"imports/core/api/loans/test/server/proLoans.expose.app-test.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/loans/test/server/proLoans.expose.app-test.js","inputSourceMap":{"version":3,"sources":["imports/core/api/loans/test/server/proLoans.expose.app-test.js"],"names":["Meteor","Match","SecurityService","UserService","QueryCacher","query","getLoanIds","expose","firewall","userId","params","providedUserId","calledByUserId","isUserAdmin","checkUserIsPro","validateParams","promotionId","Maybe","OneOf","String","Object","propertyId","resolver","users","fetch","$filters","referredByUserLink","loans","_id","reduce","allLoans","userLoans","map","resolve","_sleepForMs","cacher","getDataToHash","withReferredBy","ttl","cacheResults"],"mappings":"AAAA,SAASA,MAAT,QAAuB,eAAvB;AACA,SAASC,KAAT,QAAsB,cAAtB;AAEA,OAAOC,eAAP;AACA,OAAOC,WAAP;AACA,OAAOC,WAAP;AACA,OAAOC,KAAP;AACA,SAASC,UAAT;AAEAD,KAAK,CAACE,MAAN,CAAa;AACXC,EAAAA,QAAQ,CAACC,MAAD,EAASC,MAAT,EAAiB;AACvB,UAAM;AAAED,MAAAA,MAAM,EAAEE;AAAV,QAA6BD,MAAnC;AACAA,IAAAA,MAAM,CAACE,cAAP,GAAwBH,MAAxB;;AAEA,QAAIP,eAAe,CAACW,WAAhB,CAA4BJ,MAA5B,KAAuCE,cAA3C,EAA2D;AACzDD,MAAAA,MAAM,CAACD,MAAP,GAAgBE,cAAhB;AACD,KAFD,MAEO;AACLD,MAAAA,MAAM,CAACD,MAAP,GAAgBA,MAAhB;AACD;;AAEDP,IAAAA,eAAe,CAACY,cAAhB,CAA+BL,MAA/B;AACD,GAZU;;AAaXM,EAAAA,cAAc,EAAE;AACdC,IAAAA,WAAW,EAAEf,KAAK,CAACgB,KAAN,CAAYhB,KAAK,CAACiB,KAAN,CAAYC,MAAZ,EAAoBC,MAApB,CAAZ,CADC;AAEdC,IAAAA,UAAU,EAAEpB,KAAK,CAACgB,KAAN,CAAYhB,KAAK,CAACiB,KAAN,CAAYC,MAAZ,EAAoBC,MAApB,CAAZ,CAFE;AAGdX,IAAAA,MAAM,EAAEU,MAHM;AAIdP,IAAAA,cAAc,EAAEO;AAJF;AAbL,CAAb;;AAqBA,MAAMG,QAAQ,GAAIZ,MAAD,IAAY;AAC3B,QAAM;AAAED,IAAAA;AAAF,MAAaC,MAAnB;AACA,QAAMa,KAAK,GAAGpB,WAAW,CAACqB,KAAZ,CAAkB;AAC9BC,IAAAA,QAAQ,EAAE;AAAEC,MAAAA,kBAAkB,EAAEjB;AAAtB,KADoB;AAE9BkB,IAAAA,KAAK,EAAE;AAAEC,MAAAA,GAAG,EAAE;AAAP;AAFuB,GAAlB,CAAd;AAKA,QAAMD,KAAK,GAAGJ,KAAK,CAACM,MAAN,CACZ,CAACC,QAAD,EAAW;AAAEH,IAAAA,KAAK,EAAEI,SAAS,GAAG;AAArB,GAAX,KAAyC,CACvC,GAAGD,QADoC,EAEvC,GAAGC,SAAS,CAACC,GAAV,CAAc,CAAC;AAAEJ,IAAAA;AAAF,GAAD,KAAaA,GAA3B,CAFoC,CAD7B,EAKZ,EALY,CAAd;AAQA,SAAOD,KAAP;AACD,CAhBD;;AAkBAtB,KAAK,CAAC4B,OAAN,CAAevB,MAAD,IAAY;AACxBV,EAAAA,MAAM,CAACkC,WAAP,CAAmB,GAAnB;;AACA,SAAOZ,QAAQ,CAACZ,MAAD,CAAf;AACD,CAHD;AAKA,MAAMyB,MAAM,GAAG,IAAI/B,WAAJ,CAAgB;AAC7BgC,EAAAA,aAAa,EAAE9B,UAAU,CAAC;AAAE+B,IAAAA,cAAc,EAAE;AAAlB,GAAD,CADI;AAE7BC,EAAAA,GAAG,EAAE,KAAK,EAAL,GAAU;AAFc,CAAhB,CAAf;AAKAjC,KAAK,CAACkC,YAAN,CAAmBJ,MAAnB","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match } from 'meteor/check';\n\nimport SecurityService from 'core/api/security';\nimport UserService from 'core/api/users/server/UserService';\nimport QueryCacher from 'core/api/helpers/server/QueryCacher';\nimport query from '../proLoans.app-test';\nimport { getLoanIds } from '../../server/resolvers';\n\nquery.expose({\n  firewall(userId, params) {\n    const { userId: providedUserId } = params;\n    params.calledByUserId = userId;\n\n    if (SecurityService.isUserAdmin(userId) && providedUserId) {\n      params.userId = providedUserId;\n    } else {\n      params.userId = userId;\n    }\n\n    SecurityService.checkUserIsPro(userId);\n  },\n  validateParams: {\n    promotionId: Match.Maybe(Match.OneOf(String, Object)),\n    propertyId: Match.Maybe(Match.OneOf(String, Object)),\n    userId: String,\n    calledByUserId: String,\n  },\n});\n\nconst resolver = (params) => {\n  const { userId } = params;\n  const users = UserService.fetch({\n    $filters: { referredByUserLink: userId },\n    loans: { _id: 1 },\n  });\n\n  const loans = users.reduce(\n    (allLoans, { loans: userLoans = [] }) => [\n      ...allLoans,\n      ...userLoans.map(({ _id }) => _id),\n    ],\n    [],\n  );\n\n  return loans;\n};\n\nquery.resolve((params) => {\n  Meteor._sleepForMs(500);\n  return resolver(params);\n});\n\nconst cacher = new QueryCacher({\n  getDataToHash: getLoanIds({ withReferredBy: true }),\n  ttl: 60 * 60 * 1000,\n});\n\nquery.cacheResults(cacher);\n"]},"passPerPreset":false,"envName":"development","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/loans/test/server/proLoans.expose.app-test.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/api/loans/test/server/proLoans.expose.app-test.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet Match;\nmodule.link(\"meteor/check\", {\n  Match(v) {\n    Match = v;\n  }\n\n}, 1);\nlet SecurityService;\nmodule.link(\"../../../security\", {\n  default(v) {\n    SecurityService = v;\n  }\n\n}, 2);\nlet UserService;\nmodule.link(\"../../../users/server/UserService\", {\n  default(v) {\n    UserService = v;\n  }\n\n}, 3);\nlet QueryCacher;\nmodule.link(\"../../../helpers/server/QueryCacher\", {\n  default(v) {\n    QueryCacher = v;\n  }\n\n}, 4);\nlet query;\nmodule.link(\"../proLoans.app-test\", {\n  default(v) {\n    query = v;\n  }\n\n}, 5);\nlet getLoanIds;\nmodule.link(\"../../server/resolvers\", {\n  getLoanIds(v) {\n    getLoanIds = v;\n  }\n\n}, 6);\nquery.expose({\n  firewall(userId, params) {\n    const {\n      userId: providedUserId\n    } = params;\n    params.calledByUserId = userId;\n\n    if (SecurityService.isUserAdmin(userId) && providedUserId) {\n      params.userId = providedUserId;\n    } else {\n      params.userId = userId;\n    }\n\n    SecurityService.checkUserIsPro(userId);\n  },\n\n  validateParams: {\n    promotionId: Match.Maybe(Match.OneOf(String, Object)),\n    propertyId: Match.Maybe(Match.OneOf(String, Object)),\n    userId: String,\n    calledByUserId: String\n  }\n});\n\nconst resolver = params => {\n  const {\n    userId\n  } = params;\n  const users = UserService.fetch({\n    $filters: {\n      referredByUserLink: userId\n    },\n    loans: {\n      _id: 1\n    }\n  });\n  const loans = users.reduce((allLoans, {\n    loans: userLoans = []\n  }) => [...allLoans, ...userLoans.map(({\n    _id\n  }) => _id)], []);\n  return loans;\n};\n\nquery.resolve(params => {\n  Meteor._sleepForMs(500);\n\n  return resolver(params);\n});\nconst cacher = new QueryCacher({\n  getDataToHash: getLoanIds({\n    withReferredBy: true\n  }),\n  ttl: 60 * 60 * 1000\n});\nquery.cacheResults(cacher);","map":{"version":3,"sources":["imports/core/api/loans/test/server/proLoans.expose.app-test.js"],"names":["query","firewall","userId","providedUserId","params","SecurityService","validateParams","promotionId","Match","propertyId","calledByUserId","String","resolver","users","$filters","referredByUserLink","loans","_id","userLoans","Meteor","cacher","getDataToHash","getLoanIds","withReferredBy","ttl"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Match } from 'meteor/check';\n\nimport SecurityService from 'core/api/security';\nimport UserService from 'core/api/users/server/UserService';\nimport QueryCacher from 'core/api/helpers/server/QueryCacher';\nimport query from '../proLoans.app-test';\nimport { getLoanIds } from '../../server/resolvers';\n\nquery.expose({\n  firewall(userId, params) {\n    const { userId: providedUserId } = params;\n    params.calledByUserId = userId;\n\n    if (SecurityService.isUserAdmin(userId) && providedUserId) {\n      params.userId = providedUserId;\n    } else {\n      params.userId = userId;\n    }\n\n    SecurityService.checkUserIsPro(userId);\n  },\n  validateParams: {\n    promotionId: Match.Maybe(Match.OneOf(String, Object)),\n    propertyId: Match.Maybe(Match.OneOf(String, Object)),\n    userId: String,\n    calledByUserId: String,\n  },\n});\n\nconst resolver = (params) => {\n  const { userId } = params;\n  const users = UserService.fetch({\n    $filters: { referredByUserLink: userId },\n    loans: { _id: 1 },\n  });\n\n  const loans = users.reduce(\n    (allLoans, { loans: userLoans = [] }) => [\n      ...allLoans,\n      ...userLoans.map(({ _id }) => _id),\n    ],\n    [],\n  );\n\n  return loans;\n};\n\nquery.resolve((params) => {\n  Meteor._sleepForMs(500);\n  return resolver(params);\n});\n\nconst cacher = new QueryCacher({\n  getDataToHash: getLoanIds({ withReferredBy: true }),\n  ttl: 60 * 60 * 1000,\n});\n\nquery.cacheResults(cacher);\n"]},"sourceType":"script","hash":"178ad7dd577a4860d73bc553fdfa38d01c39bb03"}

{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/promotionOptions/server/PromotionOptionService.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"imports/core/api/promotionOptions/server/PromotionOptionService.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/promotionOptions/server/PromotionOptionService.js","inputSourceMap":{"version":3,"sources":["imports/core/api/promotionOptions/server/PromotionOptionService.js"],"names":["Meteor","LoanService","CollectionService","fullPromotionOption","PromotionOptions","PromotionOptionService","constructor","promotionLotId","loanId","promotionOptions","fetchOne","$filters","_id","promotionLots","existingPromotionOption","find","some","lot","Error","promotionOptionId","insert","promotionLotLinks","addLink","id","linkName","linkId","promotionId","getPromotion","priorityOrder","getPromotionPriorityOrder","setPromotionPriorityOrder","rest","_update","get","collection","createQuery","promotionOption","promotion","remove","loan","newPriorityOrder","filter","changePriorityOrder","change","optionIndex","indexOf","length","slice","increasePriorityOrder","reducePriorityOrder"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport LoanService from '../../loans/server/LoanService';\nimport CollectionService from '../../helpers/CollectionService';\nimport { fullPromotionOption } from '../../fragments';\nimport PromotionOptions from '../promotionOptions';\n\nexport class PromotionOptionService extends CollectionService {\n  constructor() {\n    super(PromotionOptions);\n  }\n\n  get(promotionOptionId) {\n    return this.collection\n      .createQuery({\n        $filters: { _id: promotionOptionId },\n        ...fullPromotionOption(),\n      })\n      .fetchOne();\n  }\n\n  getPromotion(promotionOptionId) {\n    const promotionOption = this.fetchOne({\n      $filters: { _id: promotionOptionId },\n      promotionLots: { promotion: { _id: 1 } },\n    });\n\n    return (\n      promotionOption.promotionLots\n      && promotionOption.promotionLots[0].promotion\n    );\n  }\n\n  remove({ promotionOptionId }) {\n    const {\n      loan: { _id: loanId },\n    } = this.fetchOne({\n      $filters: { _id: promotionOptionId },\n      loan: { _id: 1 },\n    });\n\n    const promotionId = this.getPromotion(promotionOptionId)._id;\n\n    const newPriorityOrder = LoanService.getPromotionPriorityOrder({\n      loanId,\n      promotionId,\n    }).filter(id => id !== promotionOptionId);\n    LoanService.setPromotionPriorityOrder({\n      loanId,\n      promotionId,\n      priorityOrder: newPriorityOrder,\n    });\n\n    return super.remove(promotionOptionId);\n  }\n\n  insert = ({ promotionLotId, loanId }) => {\n    const { promotionOptions } = LoanService.fetchOne({\n      $filters: { _id: loanId },\n      promotionOptions: { _id: 1, promotionLots: { _id: 1 } },\n    });\n\n    const existingPromotionOption = promotionOptions\n      && promotionOptions.find(({ promotionLots }) =>\n        promotionLots\n          && promotionLots.some(lot => lot._id === promotionLotId));\n\n    if (existingPromotionOption) {\n      throw new Meteor.Error('Vous avez déjà choisi ce lot. Essayez de rafraîchir la page.');\n    }\n\n    const promotionOptionId = super.insert({\n      promotionLotLinks: [{ _id: promotionLotId }],\n    });\n    LoanService.addLink({\n      id: loanId,\n      linkName: 'promotionOptions',\n      linkId: promotionOptionId,\n    });\n    const promotionId = this.getPromotion(promotionOptionId)._id;\n    const priorityOrder = LoanService.getPromotionPriorityOrder({\n      loanId,\n      promotionId,\n    });\n    LoanService.setPromotionPriorityOrder({\n      loanId,\n      promotionId,\n      priorityOrder: [...priorityOrder, promotionOptionId],\n    });\n    return promotionOptionId;\n  };\n\n  update = ({ promotionOptionId, ...rest }) =>\n    this._update({ id: promotionOptionId, ...rest });\n\n  changePriorityOrder({ promotionOptionId, change }) {\n    const promotionOption = this.get(promotionOptionId);\n    const { loan } = promotionOption;\n    const { _id: promotionId } = this.getPromotion(promotionOptionId);\n    const priorityOrder = LoanService.getPromotionPriorityOrder({\n      loanId: loan._id,\n      promotionId,\n    });\n    const optionIndex = priorityOrder.indexOf(promotionOptionId);\n\n    if (change < 0 && optionIndex === 0) {\n      return false;\n    }\n\n    if (change > 0 && optionIndex === priorityOrder.length - 1) {\n      return false;\n    }\n\n    const newPriorityOrder = priorityOrder.slice();\n    newPriorityOrder[optionIndex] = priorityOrder[optionIndex + change];\n    newPriorityOrder[optionIndex + change] = promotionOptionId;\n\n    return LoanService.setPromotionPriorityOrder({\n      loanId: loan._id,\n      promotionId,\n      priorityOrder: newPriorityOrder,\n    });\n  }\n\n  increasePriorityOrder({ promotionOptionId }) {\n    return this.changePriorityOrder({ promotionOptionId, change: -1 });\n  }\n\n  reducePriorityOrder({ promotionOptionId }) {\n    return this.changePriorityOrder({ promotionOptionId, change: 1 });\n  }\n}\n\nexport default new PromotionOptionService();\n"]},"passPerPreset":false,"envName":"production","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/promotionOptions/server/PromotionOptionService.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/api/promotionOptions/server/PromotionOptionService.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nvar _objectWithoutProperties2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutProperties\"));\n\nmodule.export({\n  PromotionOptionService: () => PromotionOptionService\n});\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet LoanService;\nmodule.link(\"../../loans/server/LoanService\", {\n  default(v) {\n    LoanService = v;\n  }\n\n}, 1);\nlet CollectionService;\nmodule.link(\"../../helpers/CollectionService\", {\n  default(v) {\n    CollectionService = v;\n  }\n\n}, 2);\nlet fullPromotionOption;\nmodule.link(\"../../fragments\", {\n  fullPromotionOption(v) {\n    fullPromotionOption = v;\n  }\n\n}, 3);\nlet PromotionOptions;\nmodule.link(\"../promotionOptions\", {\n  default(v) {\n    PromotionOptions = v;\n  }\n\n}, 4);\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nclass PromotionOptionService extends CollectionService {\n  constructor() {\n    super(PromotionOptions);\n\n    _defineProperty(this, \"insert\", ({\n      promotionLotId,\n      loanId\n    }) => {\n      const {\n        promotionOptions\n      } = LoanService.fetchOne({\n        $filters: {\n          _id: loanId\n        },\n        promotionOptions: {\n          _id: 1,\n          promotionLots: {\n            _id: 1\n          }\n        }\n      });\n      const existingPromotionOption = promotionOptions && promotionOptions.find(({\n        promotionLots\n      }) => promotionLots && promotionLots.some(lot => lot._id === promotionLotId));\n\n      if (existingPromotionOption) {\n        throw new Meteor.Error('Vous avez déjà choisi ce lot. Essayez de rafraîchir la page.');\n      }\n\n      const promotionOptionId = super.insert({\n        promotionLotLinks: [{\n          _id: promotionLotId\n        }]\n      });\n      LoanService.addLink({\n        id: loanId,\n        linkName: 'promotionOptions',\n        linkId: promotionOptionId\n      });\n\n      const promotionId = this.getPromotion(promotionOptionId)._id;\n\n      const priorityOrder = LoanService.getPromotionPriorityOrder({\n        loanId,\n        promotionId\n      });\n      LoanService.setPromotionPriorityOrder({\n        loanId,\n        promotionId,\n        priorityOrder: [...priorityOrder, promotionOptionId]\n      });\n      return promotionOptionId;\n    });\n\n    _defineProperty(this, \"update\", (_ref) => {\n      let {\n        promotionOptionId\n      } = _ref,\n          rest = (0, _objectWithoutProperties2.default)(_ref, [\"promotionOptionId\"]);\n      return this._update((0, _objectSpread2.default)({\n        id: promotionOptionId\n      }, rest));\n    });\n  }\n\n  get(promotionOptionId) {\n    return this.collection.createQuery((0, _objectSpread2.default)({\n      $filters: {\n        _id: promotionOptionId\n      }\n    }, fullPromotionOption())).fetchOne();\n  }\n\n  getPromotion(promotionOptionId) {\n    const promotionOption = this.fetchOne({\n      $filters: {\n        _id: promotionOptionId\n      },\n      promotionLots: {\n        promotion: {\n          _id: 1\n        }\n      }\n    });\n    return promotionOption.promotionLots && promotionOption.promotionLots[0].promotion;\n  }\n\n  remove({\n    promotionOptionId\n  }) {\n    const {\n      loan: {\n        _id: loanId\n      }\n    } = this.fetchOne({\n      $filters: {\n        _id: promotionOptionId\n      },\n      loan: {\n        _id: 1\n      }\n    });\n\n    const promotionId = this.getPromotion(promotionOptionId)._id;\n\n    const newPriorityOrder = LoanService.getPromotionPriorityOrder({\n      loanId,\n      promotionId\n    }).filter(id => id !== promotionOptionId);\n    LoanService.setPromotionPriorityOrder({\n      loanId,\n      promotionId,\n      priorityOrder: newPriorityOrder\n    });\n    return super.remove(promotionOptionId);\n  }\n\n  changePriorityOrder({\n    promotionOptionId,\n    change\n  }) {\n    const promotionOption = this.get(promotionOptionId);\n    const {\n      loan\n    } = promotionOption;\n    const {\n      _id: promotionId\n    } = this.getPromotion(promotionOptionId);\n    const priorityOrder = LoanService.getPromotionPriorityOrder({\n      loanId: loan._id,\n      promotionId\n    });\n    const optionIndex = priorityOrder.indexOf(promotionOptionId);\n\n    if (change < 0 && optionIndex === 0) {\n      return false;\n    }\n\n    if (change > 0 && optionIndex === priorityOrder.length - 1) {\n      return false;\n    }\n\n    const newPriorityOrder = priorityOrder.slice();\n    newPriorityOrder[optionIndex] = priorityOrder[optionIndex + change];\n    newPriorityOrder[optionIndex + change] = promotionOptionId;\n    return LoanService.setPromotionPriorityOrder({\n      loanId: loan._id,\n      promotionId,\n      priorityOrder: newPriorityOrder\n    });\n  }\n\n  increasePriorityOrder({\n    promotionOptionId\n  }) {\n    return this.changePriorityOrder({\n      promotionOptionId,\n      change: -1\n    });\n  }\n\n  reducePriorityOrder({\n    promotionOptionId\n  }) {\n    return this.changePriorityOrder({\n      promotionOptionId,\n      change: 1\n    });\n  }\n\n}\n\nmodule.exportDefault(new PromotionOptionService());","map":{"version":3,"sources":["imports/core/api/promotionOptions/server/PromotionOptionService.js"],"names":["constructor","get","$filters","_id","promotionOptionId","fullPromotionOption","getPromotion","promotionOption","promotionLots","promotion","remove","loan","loanId","promotionId","newPriorityOrder","id","LoanService","priorityOrder","promotionOptions","existingPromotionOption","lot","Meteor","promotionLotLinks","promotionLotId","linkName","linkId","rest","changePriorityOrder","change","optionIndex","increasePriorityOrder","reducePriorityOrder"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport LoanService from '../../loans/server/LoanService';\nimport CollectionService from '../../helpers/CollectionService';\nimport { fullPromotionOption } from '../../fragments';\nimport PromotionOptions from '../promotionOptions';\n\nexport class PromotionOptionService extends CollectionService {\n  constructor() {\n    super(PromotionOptions);\n  }\n\n  get(promotionOptionId) {\n    return this.collection\n      .createQuery({\n        $filters: { _id: promotionOptionId },\n        ...fullPromotionOption(),\n      })\n      .fetchOne();\n  }\n\n  getPromotion(promotionOptionId) {\n    const promotionOption = this.fetchOne({\n      $filters: { _id: promotionOptionId },\n      promotionLots: { promotion: { _id: 1 } },\n    });\n\n    return (\n      promotionOption.promotionLots\n      && promotionOption.promotionLots[0].promotion\n    );\n  }\n\n  remove({ promotionOptionId }) {\n    const {\n      loan: { _id: loanId },\n    } = this.fetchOne({\n      $filters: { _id: promotionOptionId },\n      loan: { _id: 1 },\n    });\n\n    const promotionId = this.getPromotion(promotionOptionId)._id;\n\n    const newPriorityOrder = LoanService.getPromotionPriorityOrder({\n      loanId,\n      promotionId,\n    }).filter(id => id !== promotionOptionId);\n    LoanService.setPromotionPriorityOrder({\n      loanId,\n      promotionId,\n      priorityOrder: newPriorityOrder,\n    });\n\n    return super.remove(promotionOptionId);\n  }\n\n  insert = ({ promotionLotId, loanId }) => {\n    const { promotionOptions } = LoanService.fetchOne({\n      $filters: { _id: loanId },\n      promotionOptions: { _id: 1, promotionLots: { _id: 1 } },\n    });\n\n    const existingPromotionOption = promotionOptions\n      && promotionOptions.find(({ promotionLots }) =>\n        promotionLots\n          && promotionLots.some(lot => lot._id === promotionLotId));\n\n    if (existingPromotionOption) {\n      throw new Meteor.Error('Vous avez déjà choisi ce lot. Essayez de rafraîchir la page.');\n    }\n\n    const promotionOptionId = super.insert({\n      promotionLotLinks: [{ _id: promotionLotId }],\n    });\n    LoanService.addLink({\n      id: loanId,\n      linkName: 'promotionOptions',\n      linkId: promotionOptionId,\n    });\n    const promotionId = this.getPromotion(promotionOptionId)._id;\n    const priorityOrder = LoanService.getPromotionPriorityOrder({\n      loanId,\n      promotionId,\n    });\n    LoanService.setPromotionPriorityOrder({\n      loanId,\n      promotionId,\n      priorityOrder: [...priorityOrder, promotionOptionId],\n    });\n    return promotionOptionId;\n  };\n\n  update = ({ promotionOptionId, ...rest }) =>\n    this._update({ id: promotionOptionId, ...rest });\n\n  changePriorityOrder({ promotionOptionId, change }) {\n    const promotionOption = this.get(promotionOptionId);\n    const { loan } = promotionOption;\n    const { _id: promotionId } = this.getPromotion(promotionOptionId);\n    const priorityOrder = LoanService.getPromotionPriorityOrder({\n      loanId: loan._id,\n      promotionId,\n    });\n    const optionIndex = priorityOrder.indexOf(promotionOptionId);\n\n    if (change < 0 && optionIndex === 0) {\n      return false;\n    }\n\n    if (change > 0 && optionIndex === priorityOrder.length - 1) {\n      return false;\n    }\n\n    const newPriorityOrder = priorityOrder.slice();\n    newPriorityOrder[optionIndex] = priorityOrder[optionIndex + change];\n    newPriorityOrder[optionIndex + change] = promotionOptionId;\n\n    return LoanService.setPromotionPriorityOrder({\n      loanId: loan._id,\n      promotionId,\n      priorityOrder: newPriorityOrder,\n    });\n  }\n\n  increasePriorityOrder({ promotionOptionId }) {\n    return this.changePriorityOrder({ promotionOptionId, change: -1 });\n  }\n\n  reducePriorityOrder({ promotionOptionId }) {\n    return this.changePriorityOrder({ promotionOptionId, change: 1 });\n  }\n}\n\nexport default new PromotionOptionService();\n"]},"sourceType":"script","hash":"12e8ef0ec21d5b8695d0a3cf3a37a1ec2a7ac1b4"}

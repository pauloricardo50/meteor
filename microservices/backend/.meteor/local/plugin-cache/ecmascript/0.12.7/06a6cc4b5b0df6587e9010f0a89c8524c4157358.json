{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/lenderRules/server/LenderRulesService.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"imports/core/api/lenderRules/server/LenderRulesService.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/lenderRules/server/LenderRulesService.js","inputSourceMap":{"version":3,"sources":["imports/core/api/lenderRules/server/LenderRulesService.js"],"names":["Meteor","OrganisationService","LenderRules","CollectionService","DEFAULT_VALUE_FOR_ALL","DEFAULT_MAIN_RESIDENCE_RULES","DEFAULT_SECONDARY_RESIDENCE_RULES","LenderRulesService","constructor","remove","lenderRulesId","initialize","organisationId","id1","insert","object","logicRules","id2","maxBorrowRatio","id3","lenderRules","fetchOne","$filters","_id","filter","and","order","length","addLink","id","linkName","linkId","update","Error","_update","updateFilter","name","setOrder","orders","ids","Object","keys","numbers","values","sort","a","b","fetch","$in","organisation","organisationLink","forEach","num","index","nextOrder"],"mappings":"AAAA,SAASA,MAAT,QAAuB,eAAvB;AAEA,OAAOC,mBAAP;AACA,OAAOC,WAAP;AACA,OAAOC,iBAAP;AACA,SACEC,qBADF,EAEEC,4BAFF,EAGEC,iCAHF;;AAMA,MAAMC,kBAAN,SAAiCJ,iBAAjC,CAAmD;AACjDK,EAAAA,WAAW,GAAG;AACZ,UAAMN,WAAN;AACD;;AAEDO,EAAAA,MAAM,CAAC;AAAEC,IAAAA;AAAF,GAAD,EAAoB;AACxB,WAAO,MAAMD,MAAN,CAAaC,aAAb,CAAP;AACD;;AAEDC,EAAAA,UAAU,CAAC;AAAEC,IAAAA;AAAF,GAAD,EAAqB;AAC7B,UAAMC,GAAG,GAAG,KAAKC,MAAL,CAAY;AACtBF,MAAAA,cADsB;AAEtBG,MAAAA,MAAM,EAAEX,qBAFc;AAGtBY,MAAAA,UAAU,EAAE,CAAC,IAAD;AAHU,KAAZ,CAAZ;AAKA,UAAMC,GAAG,GAAG,KAAKH,MAAL,CAAY;AACtBF,MAAAA,cADsB;AAEtBG,MAAAA,MAAM,EAAE;AAAEG,QAAAA,cAAc,EAAE;AAAlB,OAFc;AAGtBF,MAAAA,UAAU,EAAEX;AAHU,KAAZ,CAAZ;AAKA,UAAMc,GAAG,GAAG,KAAKL,MAAL,CAAY;AACtBF,MAAAA,cADsB;AAEtBG,MAAAA,MAAM,EAAE;AAAEG,QAAAA,cAAc,EAAE;AAAlB,OAFc;AAGtBF,MAAAA,UAAU,EAAEV;AAHU,KAAZ,CAAZ;AAMA,WAAO,CAACO,GAAD,EAAMI,GAAN,EAAWE,GAAX,CAAP;AACD;;AAEDL,EAAAA,MAAM,CAAC;AAAEF,IAAAA,cAAF;AAAkBG,IAAAA,MAAM,GAAG,EAA3B;AAA+BC,IAAAA;AAA/B,GAAD,EAA8C;AAClD,UAAM;AAAEI,MAAAA,WAAW,GAAG;AAAhB,QAAuBnB,mBAAmB,CAACoB,QAApB,CAA6B;AACxDC,MAAAA,QAAQ,EAAE;AAAEC,QAAAA,GAAG,EAAEX;AAAP,OAD8C;AAExDQ,MAAAA,WAAW,EAAE;AAAEG,QAAAA,GAAG,EAAE;AAAP;AAF2C,KAA7B,CAA7B;AAKA,UAAMb,aAAa,GAAG,MAAMI,MAAN,CAAa,EACjC,GAAGC,MAD8B;AAEjCS,MAAAA,MAAM,EAAE;AAAEC,QAAAA,GAAG,EAAET;AAAP,OAFyB;AAGjCU,MAAAA,KAAK,EAAEN,WAAW,CAACO;AAHc,KAAb,CAAtB;AAMA,SAAKC,OAAL,CAAa;AACXC,MAAAA,EAAE,EAAEnB,aADO;AAEXoB,MAAAA,QAAQ,EAAE,cAFC;AAGXC,MAAAA,MAAM,EAAEnB;AAHG,KAAb;AAMA,WAAOF,aAAP;AACD;;AAEDsB,EAAAA,MAAM,CAAC;AAAEtB,IAAAA,aAAF;AAAiBK,IAAAA;AAAjB,GAAD,EAA4B;AAChC,QAAIA,MAAM,CAACS,MAAX,EAAmB;AACjB,YAAM,IAAIxB,MAAM,CAACiC,KAAX,CAAiB,oCAAjB,CAAN;AACD;;AAED,WAAO,KAAKC,OAAL,CAAa;AAAEL,MAAAA,EAAE,EAAEnB,aAAN;AAAqBK,MAAAA;AAArB,KAAb,CAAP;AACD;;AAEDoB,EAAAA,YAAY,CAAC;AAAEzB,IAAAA,aAAF;AAAiBM,IAAAA,UAAjB;AAA6BoB,IAAAA;AAA7B,GAAD,EAAsC;AAChD,WAAO,KAAKF,OAAL,CAAa;AAClBL,MAAAA,EAAE,EAAEnB,aADc;AAElBK,MAAAA,MAAM,EAAE;AAAES,QAAAA,MAAM,EAAE;AAAEC,UAAAA,GAAG,EAAET;AAAP,SAAV;AAA+BoB,QAAAA;AAA/B;AAFU,KAAb,CAAP;AAID;;AAEDC,EAAAA,QAAQ,CAAC;AAAEC,IAAAA;AAAF,GAAD,EAAa;AACnB,UAAMC,GAAG,GAAGC,MAAM,CAACC,IAAP,CAAYH,MAAZ,CAAZ;AACA,UAAMI,OAAO,GAAGF,MAAM,CAACG,MAAP,CAAcL,MAAd,EAAsBM,IAAtB,CAA2B,CAACC,CAAD,EAAIC,CAAJ,KAAUD,CAAC,GAAGC,CAAzC,CAAhB;AAEA,UAAM1B,WAAW,GAAG,KAAK2B,KAAL,CAAW;AAC7BzB,MAAAA,QAAQ,EAAE;AAAEC,QAAAA,GAAG,EAAE;AAAEyB,UAAAA,GAAG,EAAET;AAAP;AAAP,OADmB;AAE7BU,MAAAA,YAAY,EAAE;AAAE1B,QAAAA,GAAG,EAAE;AAAP,OAFe;AAG7B2B,MAAAA,gBAAgB,EAAE;AAHW,KAAX,CAApB;AAMA9B,IAAAA,WAAW,CAAC+B,OAAZ,CAAoB,CAAC;AAAEF,MAAAA,YAAY,EAAE;AAAE1B,QAAAA;AAAF;AAAhB,KAAD,KAA+B;AACjD,UAAIA,GAAG,KAAKH,WAAW,CAAC,CAAD,CAAX,CAAe6B,YAAf,CAA4B1B,GAAxC,EAA6C;AAC3C,cAAM,IAAIvB,MAAM,CAACiC,KAAX,CAAiB,4DAAjB,CAAN;AACD;AACF,KAJD;AAMAS,IAAAA,OAAO,CAACS,OAAR,CAAgB,CAACC,GAAD,EAAMC,KAAN,KAAgB;AAC9B,UAAIA,KAAK,KAAKD,GAAd,EAAmB;AACjB,cAAM,IAAIpD,MAAM,CAACiC,KAAX,CAAiB,0DAAjB,CAAN;AACD;AACF,KAJD;AAMAO,IAAAA,MAAM,CAACC,IAAP,CAAYH,MAAZ,EAAoBa,OAApB,CAA6BzC,aAAD,IAAmB;AAC7C,YAAM4C,SAAS,GAAGhB,MAAM,CAAC5B,aAAD,CAAxB;AACA,WAAKsB,MAAL,CAAY;AAAEtB,QAAAA,aAAF;AAAiBK,QAAAA,MAAM,EAAE;AAAEW,UAAAA,KAAK,EAAE4B;AAAT;AAAzB,OAAZ;AACD,KAHD;AAID;;AA3FgD;;AA8FnD,eAAe,IAAI/C,kBAAJ,EAAf","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport OrganisationService from '../../organisations/server/OrganisationService';\nimport LenderRules from '../lenderRules';\nimport CollectionService from '../../helpers/CollectionService';\nimport {\n  DEFAULT_VALUE_FOR_ALL,\n  DEFAULT_MAIN_RESIDENCE_RULES,\n  DEFAULT_SECONDARY_RESIDENCE_RULES,\n} from '../lenderRulesConstants';\n\nclass LenderRulesService extends CollectionService {\n  constructor() {\n    super(LenderRules);\n  }\n\n  remove({ lenderRulesId }) {\n    return super.remove(lenderRulesId);\n  }\n\n  initialize({ organisationId }) {\n    const id1 = this.insert({\n      organisationId,\n      object: DEFAULT_VALUE_FOR_ALL,\n      logicRules: [true],\n    });\n    const id2 = this.insert({\n      organisationId,\n      object: { maxBorrowRatio: 0.8 },\n      logicRules: DEFAULT_MAIN_RESIDENCE_RULES,\n    });\n    const id3 = this.insert({\n      organisationId,\n      object: { maxBorrowRatio: 0.7 },\n      logicRules: DEFAULT_SECONDARY_RESIDENCE_RULES,\n    });\n\n    return [id1, id2, id3];\n  }\n\n  insert({ organisationId, object = {}, logicRules }) {\n    const { lenderRules = [] } = OrganisationService.fetchOne({\n      $filters: { _id: organisationId },\n      lenderRules: { _id: 1 },\n    });\n\n    const lenderRulesId = super.insert({\n      ...object,\n      filter: { and: logicRules },\n      order: lenderRules.length,\n    });\n\n    this.addLink({\n      id: lenderRulesId,\n      linkName: 'organisation',\n      linkId: organisationId,\n    });\n\n    return lenderRulesId;\n  }\n\n  update({ lenderRulesId, object }) {\n    if (object.filter) {\n      throw new Meteor.Error('You can not update the filter here');\n    }\n\n    return this._update({ id: lenderRulesId, object });\n  }\n\n  updateFilter({ lenderRulesId, logicRules, name }) {\n    return this._update({\n      id: lenderRulesId,\n      object: { filter: { and: logicRules }, name },\n    });\n  }\n\n  setOrder({ orders }) {\n    const ids = Object.keys(orders);\n    const numbers = Object.values(orders).sort((a, b) => a - b);\n\n    const lenderRules = this.fetch({\n      $filters: { _id: { $in: ids } },\n      organisation: { _id: 1 },\n      organisationLink: 1,\n    });\n\n    lenderRules.forEach(({ organisation: { _id } }) => {\n      if (_id !== lenderRules[0].organisation._id) {\n        throw new Meteor.Error('Tous les filtres doivent appartenir à la même organisation');\n      }\n    });\n\n    numbers.forEach((num, index) => {\n      if (index !== num) {\n        throw new Meteor.Error(\"L'ordre des filtres doit commencer par 0 et être continu\");\n      }\n    });\n\n    Object.keys(orders).forEach((lenderRulesId) => {\n      const nextOrder = orders[lenderRulesId];\n      this.update({ lenderRulesId, object: { order: nextOrder } });\n    });\n  }\n}\n\nexport default new LenderRulesService();\n"]},"passPerPreset":false,"envName":"production","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/lenderRules/server/LenderRulesService.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/api/lenderRules/server/LenderRulesService.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nlet Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nlet OrganisationService;\nmodule.link(\"../../organisations/server/OrganisationService\", {\n  default(v) {\n    OrganisationService = v;\n  }\n\n}, 1);\nlet LenderRules;\nmodule.link(\"../lenderRules\", {\n  default(v) {\n    LenderRules = v;\n  }\n\n}, 2);\nlet CollectionService;\nmodule.link(\"../../helpers/CollectionService\", {\n  default(v) {\n    CollectionService = v;\n  }\n\n}, 3);\nlet DEFAULT_VALUE_FOR_ALL, DEFAULT_MAIN_RESIDENCE_RULES, DEFAULT_SECONDARY_RESIDENCE_RULES;\nmodule.link(\"../lenderRulesConstants\", {\n  DEFAULT_VALUE_FOR_ALL(v) {\n    DEFAULT_VALUE_FOR_ALL = v;\n  },\n\n  DEFAULT_MAIN_RESIDENCE_RULES(v) {\n    DEFAULT_MAIN_RESIDENCE_RULES = v;\n  },\n\n  DEFAULT_SECONDARY_RESIDENCE_RULES(v) {\n    DEFAULT_SECONDARY_RESIDENCE_RULES = v;\n  }\n\n}, 4);\n\nclass LenderRulesService extends CollectionService {\n  constructor() {\n    super(LenderRules);\n  }\n\n  remove({\n    lenderRulesId\n  }) {\n    return super.remove(lenderRulesId);\n  }\n\n  initialize({\n    organisationId\n  }) {\n    const id1 = this.insert({\n      organisationId,\n      object: DEFAULT_VALUE_FOR_ALL,\n      logicRules: [true]\n    });\n    const id2 = this.insert({\n      organisationId,\n      object: {\n        maxBorrowRatio: 0.8\n      },\n      logicRules: DEFAULT_MAIN_RESIDENCE_RULES\n    });\n    const id3 = this.insert({\n      organisationId,\n      object: {\n        maxBorrowRatio: 0.7\n      },\n      logicRules: DEFAULT_SECONDARY_RESIDENCE_RULES\n    });\n    return [id1, id2, id3];\n  }\n\n  insert({\n    organisationId,\n    object = {},\n    logicRules\n  }) {\n    const {\n      lenderRules = []\n    } = OrganisationService.fetchOne({\n      $filters: {\n        _id: organisationId\n      },\n      lenderRules: {\n        _id: 1\n      }\n    });\n    const lenderRulesId = super.insert((0, _objectSpread2.default)({}, object, {\n      filter: {\n        and: logicRules\n      },\n      order: lenderRules.length\n    }));\n    this.addLink({\n      id: lenderRulesId,\n      linkName: 'organisation',\n      linkId: organisationId\n    });\n    return lenderRulesId;\n  }\n\n  update({\n    lenderRulesId,\n    object\n  }) {\n    if (object.filter) {\n      throw new Meteor.Error('You can not update the filter here');\n    }\n\n    return this._update({\n      id: lenderRulesId,\n      object\n    });\n  }\n\n  updateFilter({\n    lenderRulesId,\n    logicRules,\n    name\n  }) {\n    return this._update({\n      id: lenderRulesId,\n      object: {\n        filter: {\n          and: logicRules\n        },\n        name\n      }\n    });\n  }\n\n  setOrder({\n    orders\n  }) {\n    const ids = Object.keys(orders);\n    const numbers = Object.values(orders).sort((a, b) => a - b);\n    const lenderRules = this.fetch({\n      $filters: {\n        _id: {\n          $in: ids\n        }\n      },\n      organisation: {\n        _id: 1\n      },\n      organisationLink: 1\n    });\n    lenderRules.forEach(({\n      organisation: {\n        _id\n      }\n    }) => {\n      if (_id !== lenderRules[0].organisation._id) {\n        throw new Meteor.Error('Tous les filtres doivent appartenir à la même organisation');\n      }\n    });\n    numbers.forEach((num, index) => {\n      if (index !== num) {\n        throw new Meteor.Error(\"L'ordre des filtres doit commencer par 0 et être continu\");\n      }\n    });\n    Object.keys(orders).forEach(lenderRulesId => {\n      const nextOrder = orders[lenderRulesId];\n      this.update({\n        lenderRulesId,\n        object: {\n          order: nextOrder\n        }\n      });\n    });\n  }\n\n}\n\nmodule.exportDefault(new LenderRulesService());","map":{"version":3,"sources":["imports/core/api/lenderRules/server/LenderRulesService.js"],"names":["constructor","remove","lenderRulesId","initialize","organisationId","id1","object","logicRules","id2","maxBorrowRatio","DEFAULT_MAIN_RESIDENCE_RULES","id3","DEFAULT_SECONDARY_RESIDENCE_RULES","insert","lenderRules","$filters","_id","filter","and","order","length","id","linkName","linkId","update","Meteor","updateFilter","name","setOrder","orders","ids","Object","numbers","a","$in","organisation","organisationLink","index","nextOrder"],"mappings":"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","sourcesContent":["import { Meteor } from 'meteor/meteor';\n\nimport OrganisationService from '../../organisations/server/OrganisationService';\nimport LenderRules from '../lenderRules';\nimport CollectionService from '../../helpers/CollectionService';\nimport {\n  DEFAULT_VALUE_FOR_ALL,\n  DEFAULT_MAIN_RESIDENCE_RULES,\n  DEFAULT_SECONDARY_RESIDENCE_RULES,\n} from '../lenderRulesConstants';\n\nclass LenderRulesService extends CollectionService {\n  constructor() {\n    super(LenderRules);\n  }\n\n  remove({ lenderRulesId }) {\n    return super.remove(lenderRulesId);\n  }\n\n  initialize({ organisationId }) {\n    const id1 = this.insert({\n      organisationId,\n      object: DEFAULT_VALUE_FOR_ALL,\n      logicRules: [true],\n    });\n    const id2 = this.insert({\n      organisationId,\n      object: { maxBorrowRatio: 0.8 },\n      logicRules: DEFAULT_MAIN_RESIDENCE_RULES,\n    });\n    const id3 = this.insert({\n      organisationId,\n      object: { maxBorrowRatio: 0.7 },\n      logicRules: DEFAULT_SECONDARY_RESIDENCE_RULES,\n    });\n\n    return [id1, id2, id3];\n  }\n\n  insert({ organisationId, object = {}, logicRules }) {\n    const { lenderRules = [] } = OrganisationService.fetchOne({\n      $filters: { _id: organisationId },\n      lenderRules: { _id: 1 },\n    });\n\n    const lenderRulesId = super.insert({\n      ...object,\n      filter: { and: logicRules },\n      order: lenderRules.length,\n    });\n\n    this.addLink({\n      id: lenderRulesId,\n      linkName: 'organisation',\n      linkId: organisationId,\n    });\n\n    return lenderRulesId;\n  }\n\n  update({ lenderRulesId, object }) {\n    if (object.filter) {\n      throw new Meteor.Error('You can not update the filter here');\n    }\n\n    return this._update({ id: lenderRulesId, object });\n  }\n\n  updateFilter({ lenderRulesId, logicRules, name }) {\n    return this._update({\n      id: lenderRulesId,\n      object: { filter: { and: logicRules }, name },\n    });\n  }\n\n  setOrder({ orders }) {\n    const ids = Object.keys(orders);\n    const numbers = Object.values(orders).sort((a, b) => a - b);\n\n    const lenderRules = this.fetch({\n      $filters: { _id: { $in: ids } },\n      organisation: { _id: 1 },\n      organisationLink: 1,\n    });\n\n    lenderRules.forEach(({ organisation: { _id } }) => {\n      if (_id !== lenderRules[0].organisation._id) {\n        throw new Meteor.Error('Tous les filtres doivent appartenir à la même organisation');\n      }\n    });\n\n    numbers.forEach((num, index) => {\n      if (index !== num) {\n        throw new Meteor.Error(\"L'ordre des filtres doit commencer par 0 et être continu\");\n      }\n    });\n\n    Object.keys(orders).forEach((lenderRulesId) => {\n      const nextOrder = orders[lenderRulesId];\n      this.update({ lenderRulesId, object: { order: nextOrder } });\n    });\n  }\n}\n\nexport default new LenderRulesService();\n"]},"sourceType":"script","hash":"06a6cc4b5b0df6587e9010f0a89c8524c4157358"}

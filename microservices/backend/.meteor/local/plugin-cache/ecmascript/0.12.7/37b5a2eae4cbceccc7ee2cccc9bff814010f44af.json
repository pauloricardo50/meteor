{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/LenderRulesInitializator.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"imports/core/utils/Calculator/LenderRulesInitializator.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/LenderRulesInitializator.js","inputSourceMap":{"version":3,"sources":["imports/core/utils/Calculator/LenderRulesInitializator.js"],"names":["parseFilter","getMatchingRules","LENDER_RULES_VARIABLES","OWN_FUNDS_TYPES","withLenderRulesInitializator","SuperClass","constructor","settings","lenderRules","organisationName","length","organisation","name","initialize","loan","structureId","sortedlenderRules","sort","order","orderA","orderB","setOrganisationName","ruleOrigin","matchedRules","globalRules","getGlobalLenderRules","applyRules","primaryRules","getPrimaryLenderRules","secondaryRules","getSecondaryLenderRules","cleanUpUnusedRules","storeRuleOrigin","rules","lenderRulesId","Object","keys","forEach","ruleName","getOriginOfRule","find","_id","getLenderRulesVariables","RESIDENCE_TYPE","residenceType","CANTON","selectPropertyKey","key","WANTED_LOAN","selectStructureKey","PROPERTY_VALUE","selectPropertyValue","INSIDE_AREA","BANK_FORTUNE","getFortune","BORROW_RATIO","getBorrowRatio","INCOME","getTotalIncome","PROPERTY_TYPE","ZIP_CODE","REMAINING_BANK_FORTUNE","getRemainingFundsOfType","type","filter","and","matchingRules","lenderRulesIsSecondary","map","some","variable","includes","names","x","rulesToApply","rule","undefined","maxIncomeRatioTight","maxBorrowRatioWithPledge"],"mappings":"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","sourcesContent":["import { parseFilter } from 'core/api/lenderRules/helpers';\nimport { getMatchingRules } from '../../api/lenderRules/helpers';\nimport { LENDER_RULES_VARIABLES, OWN_FUNDS_TYPES } from '../../api/constants';\n\n// @flow\n\nexport const withLenderRulesInitializator = (SuperClass = class {}) =>\n  class extends SuperClass {\n    constructor(settings) {\n      super(settings);\n      this.initialize(settings);\n    }\n\n    initialize({ loan, structureId, lenderRules = [] }) {\n      if (!(loan && lenderRules && lenderRules.length > 0)) {\n        return;\n      }\n\n      const sortedlenderRules = lenderRules.sort(({ order: orderA }, { order: orderB }) => orderA - orderB);\n\n      // Store the rules for retrieval later\n      this.lenderRules = sortedlenderRules;\n      this.setOrganisationName(sortedlenderRules);\n      this.ruleOrigin = {};\n      this.matchedRules = [];\n\n      // Global rules\n      const globalRules = this.getGlobalLenderRules({\n        loan,\n        structureId,\n        lenderRules: sortedlenderRules,\n      });\n      this.applyRules(globalRules);\n\n      // Primary rules depend only on raw data\n      const primaryRules = this.getPrimaryLenderRules({\n        loan,\n        structureId,\n        lenderRules: sortedlenderRules,\n      });\n      this.applyRules(primaryRules);\n\n      // Secondary rules depend on what is calculated with the rules applied from the primary rules\n      const secondaryRules = this.getSecondaryLenderRules({\n        loan,\n        structureId,\n        lenderRules: sortedlenderRules,\n      });\n      this.applyRules(secondaryRules);\n\n      this.cleanUpUnusedRules();\n    }\n\n    setOrganisationName = (lenderRules) => {\n      this.organisationName = lenderRules.length\n        ? lenderRules[0].organisation && lenderRules[0].organisation.name\n        : null;\n    };\n\n    storeRuleOrigin(rules, lenderRulesId) {\n      Object.keys(rules).forEach((ruleName) => {\n        this.ruleOrigin[ruleName] = lenderRulesId;\n      });\n    }\n\n    getOriginOfRule(ruleName) {\n      const lenderRulesId = this.ruleOrigin[ruleName];\n      const lenderRules = this.lenderRules.find(({ _id }) => _id === lenderRulesId);\n      return lenderRules;\n    }\n\n    getLenderRulesVariables({ loan, structureId }) {\n      return {\n        [LENDER_RULES_VARIABLES.RESIDENCE_TYPE]: loan.residenceType,\n        [LENDER_RULES_VARIABLES.CANTON]: this.selectPropertyKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.CANTON,\n        }),\n        [LENDER_RULES_VARIABLES.WANTED_LOAN]: this.selectStructureKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.WANTED_LOAN,\n        }),\n        [LENDER_RULES_VARIABLES.PROPERTY_VALUE]: this.selectPropertyValue({\n          loan,\n          structureId,\n        }),\n        [LENDER_RULES_VARIABLES.INSIDE_AREA]: this.selectPropertyKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.INSIDE_AREA,\n        }),\n        [LENDER_RULES_VARIABLES.BANK_FORTUNE]: this.getFortune({ loan }),\n        [LENDER_RULES_VARIABLES.BORROW_RATIO]: this.getBorrowRatio({\n          loan,\n          structureId,\n        }),\n        [LENDER_RULES_VARIABLES.INCOME]: this.getTotalIncome({ loan }),\n        [LENDER_RULES_VARIABLES.PROPERTY_TYPE]: this.selectPropertyKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.PROPERTY_TYPE,\n        }),\n        [LENDER_RULES_VARIABLES.ZIP_CODE]: this.selectPropertyKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.ZIP_CODE,\n        }),\n        [LENDER_RULES_VARIABLES.REMAINING_BANK_FORTUNE]: this.getRemainingFundsOfType({\n          loan,\n          structureId,\n          type: OWN_FUNDS_TYPES.BANK_FORTUNE,\n        }),\n      };\n    }\n\n    getGlobalLenderRules({ lenderRules }) {\n      const globalRules = lenderRules.filter(({ filter }) =>\n        filter.and && filter.and.length === 1 && filter.and[0] === true);\n      const matchingRules = getMatchingRules(\n        globalRules,\n        {},\n        this.storeRuleOrigin,\n      );\n      return matchingRules;\n    }\n\n    getPrimaryLenderRules({ loan, structureId, lenderRules }) {\n      const primaryRules = lenderRules.filter(rules => !this.lenderRulesIsSecondary(rules));\n      const matchingRules = getMatchingRules(\n        primaryRules,\n        this.getLenderRulesVariables({ loan, structureId }),\n        this.storeRuleOrigin,\n      );\n      return matchingRules;\n    }\n\n    // Gets the secondary lender rules that require other lender rules to\n    // already have been applied\n    getSecondaryLenderRules({ loan, structureId, lenderRules }) {\n      const secondaryRules = lenderRules.filter(this.lenderRulesIsSecondary);\n      const matchingRules = getMatchingRules(\n        secondaryRules,\n        this.getLenderRulesVariables({ loan, structureId }),\n        this.storeRuleOrigin,\n      );\n      return matchingRules;\n    }\n\n    lenderRulesIsSecondary({ filter }) {\n      return filter.and\n        .map(parseFilter)\n        .some(({ variable }) =>\n          [\n            LENDER_RULES_VARIABLES.BORROW_RATIO,\n            LENDER_RULES_VARIABLES.INCOME,\n          ].includes(variable));\n    }\n\n    applyRules(rules) {\n      if (rules.names) {\n        this.matchedRules = [\n          ...this.matchedRules,\n          ...rules.names.filter(x => x),\n        ];\n      }\n\n      const rulesToApply = [\n        'adminComments',\n        'allowPledge',\n        'amortizationGoal',\n        'amortizationYears',\n        'bonusAlgorithm',\n        'bonusConsideration',\n        'bonusHistoryToConsider',\n        'companyIncomeConsideration',\n        'companyIncomeHistoryToConsider',\n        'dividendsConsideration',\n        'dividendsHistoryToConsider',\n        'expensesSubtractFromIncome',\n        'fortuneReturnsRatio',\n        'incomeConsiderationType',\n        'investmentIncomeConsideration',\n        'maxBorrowRatio',\n        'maxIncomeRatio',\n        'pdfComments',\n        'pensionIncomeConsideration',\n        'realEstateIncomeAlgorithm',\n        'realEstateIncomeConsideration',\n        'realEstateIncomeConsiderationType',\n        'theoreticalInterestRate',\n        'theoreticalInterestRate2ndRank',\n        'theoreticalMaintenanceRate',\n      ];\n\n      rulesToApply.forEach((rule) => {\n        if (rules[rule] !== undefined && rules[rule] !== null) {\n          this[rule] = rules[rule];\n        }\n      });\n    }\n\n    cleanUpUnusedRules() {\n      this.maxIncomeRatioTight = 0;\n      this.maxBorrowRatioWithPledge = 0;\n    }\n  };\n"]},"passPerPreset":false,"envName":"development","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$4","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$5","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/utils/Calculator/LenderRulesInitializator.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/utils/Calculator/LenderRulesInitializator.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _toConsumableArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/toConsumableArray\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nmodule.export({\n  withLenderRulesInitializator: function () {\n    return withLenderRulesInitializator;\n  }\n});\nvar parseFilter;\nmodule.link(\"../../api/lenderRules/helpers\", {\n  parseFilter: function (v) {\n    parseFilter = v;\n  }\n}, 0);\nvar getMatchingRules;\nmodule.link(\"../../api/lenderRules/helpers\", {\n  getMatchingRules: function (v) {\n    getMatchingRules = v;\n  }\n}, 1);\nvar LENDER_RULES_VARIABLES, OWN_FUNDS_TYPES;\nmodule.link(\"../../api/constants\", {\n  LENDER_RULES_VARIABLES: function (v) {\n    LENDER_RULES_VARIABLES = v;\n  },\n  OWN_FUNDS_TYPES: function (v) {\n    OWN_FUNDS_TYPES = v;\n  }\n}, 2);\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nvar withLenderRulesInitializator = function () {\n  var SuperClass = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] :\n  /*#__PURE__*/\n  function () {\n    function _class() {}\n\n    return _class;\n  }();\n\n  var _temp;\n\n  return _temp =\n  /*#__PURE__*/\n  function (_SuperClass) {\n    (0, _inheritsLoose2.default)(_temp, _SuperClass);\n\n    function _temp(settings) {\n      var _this;\n\n      _this = _SuperClass.call(this, settings) || this;\n\n      _defineProperty((0, _assertThisInitialized2.default)(_this), \"setOrganisationName\", function (lenderRules) {\n        _this.organisationName = lenderRules.length ? lenderRules[0].organisation && lenderRules[0].organisation.name : null;\n      });\n\n      _this.initialize(settings);\n\n      return _this;\n    }\n\n    var _proto = _temp.prototype;\n\n    _proto.initialize = function () {\n      function initialize(_ref) {\n        var loan = _ref.loan,\n            structureId = _ref.structureId,\n            _ref$lenderRules = _ref.lenderRules,\n            lenderRules = _ref$lenderRules === void 0 ? [] : _ref$lenderRules;\n\n        if (!(loan && lenderRules && lenderRules.length > 0)) {\n          return;\n        }\n\n        var sortedlenderRules = lenderRules.sort(function (_ref2, _ref3) {\n          var orderA = _ref2.order;\n          var orderB = _ref3.order;\n          return orderA - orderB;\n        }); // Store the rules for retrieval later\n\n        this.lenderRules = sortedlenderRules;\n        this.setOrganisationName(sortedlenderRules);\n        this.ruleOrigin = {};\n        this.matchedRules = []; // Global rules\n\n        var globalRules = this.getGlobalLenderRules({\n          loan: loan,\n          structureId: structureId,\n          lenderRules: sortedlenderRules\n        });\n        this.applyRules(globalRules); // Primary rules depend only on raw data\n\n        var primaryRules = this.getPrimaryLenderRules({\n          loan: loan,\n          structureId: structureId,\n          lenderRules: sortedlenderRules\n        });\n        this.applyRules(primaryRules); // Secondary rules depend on what is calculated with the rules applied from the primary rules\n\n        var secondaryRules = this.getSecondaryLenderRules({\n          loan: loan,\n          structureId: structureId,\n          lenderRules: sortedlenderRules\n        });\n        this.applyRules(secondaryRules);\n        this.cleanUpUnusedRules();\n      }\n\n      return initialize;\n    }();\n\n    _proto.storeRuleOrigin = function () {\n      function storeRuleOrigin(rules, lenderRulesId) {\n        var _this2 = this;\n\n        Object.keys(rules).forEach(function (ruleName) {\n          _this2.ruleOrigin[ruleName] = lenderRulesId;\n        });\n      }\n\n      return storeRuleOrigin;\n    }();\n\n    _proto.getOriginOfRule = function () {\n      function getOriginOfRule(ruleName) {\n        var lenderRulesId = this.ruleOrigin[ruleName];\n        var lenderRules = this.lenderRules.find(function (_ref4) {\n          var _id = _ref4._id;\n          return _id === lenderRulesId;\n        });\n        return lenderRules;\n      }\n\n      return getOriginOfRule;\n    }();\n\n    _proto.getLenderRulesVariables = function () {\n      function getLenderRulesVariables(_ref5) {\n        var _ref6;\n\n        var loan = _ref5.loan,\n            structureId = _ref5.structureId;\n        return _ref6 = {}, _ref6[LENDER_RULES_VARIABLES.RESIDENCE_TYPE] = loan.residenceType, _ref6[LENDER_RULES_VARIABLES.CANTON] = this.selectPropertyKey({\n          loan: loan,\n          structureId: structureId,\n          key: LENDER_RULES_VARIABLES.CANTON\n        }), _ref6[LENDER_RULES_VARIABLES.WANTED_LOAN] = this.selectStructureKey({\n          loan: loan,\n          structureId: structureId,\n          key: LENDER_RULES_VARIABLES.WANTED_LOAN\n        }), _ref6[LENDER_RULES_VARIABLES.PROPERTY_VALUE] = this.selectPropertyValue({\n          loan: loan,\n          structureId: structureId\n        }), _ref6[LENDER_RULES_VARIABLES.INSIDE_AREA] = this.selectPropertyKey({\n          loan: loan,\n          structureId: structureId,\n          key: LENDER_RULES_VARIABLES.INSIDE_AREA\n        }), _ref6[LENDER_RULES_VARIABLES.BANK_FORTUNE] = this.getFortune({\n          loan: loan\n        }), _ref6[LENDER_RULES_VARIABLES.BORROW_RATIO] = this.getBorrowRatio({\n          loan: loan,\n          structureId: structureId\n        }), _ref6[LENDER_RULES_VARIABLES.INCOME] = this.getTotalIncome({\n          loan: loan\n        }), _ref6[LENDER_RULES_VARIABLES.PROPERTY_TYPE] = this.selectPropertyKey({\n          loan: loan,\n          structureId: structureId,\n          key: LENDER_RULES_VARIABLES.PROPERTY_TYPE\n        }), _ref6[LENDER_RULES_VARIABLES.ZIP_CODE] = this.selectPropertyKey({\n          loan: loan,\n          structureId: structureId,\n          key: LENDER_RULES_VARIABLES.ZIP_CODE\n        }), _ref6[LENDER_RULES_VARIABLES.REMAINING_BANK_FORTUNE] = this.getRemainingFundsOfType({\n          loan: loan,\n          structureId: structureId,\n          type: OWN_FUNDS_TYPES.BANK_FORTUNE\n        }), _ref6;\n      }\n\n      return getLenderRulesVariables;\n    }();\n\n    _proto.getGlobalLenderRules = function () {\n      function getGlobalLenderRules(_ref7) {\n        var lenderRules = _ref7.lenderRules;\n        var globalRules = lenderRules.filter(function (_ref8) {\n          var filter = _ref8.filter;\n          return filter.and && filter.and.length === 1 && filter.and[0] === true;\n        });\n        var matchingRules = getMatchingRules(globalRules, {}, this.storeRuleOrigin);\n        return matchingRules;\n      }\n\n      return getGlobalLenderRules;\n    }();\n\n    _proto.getPrimaryLenderRules = function () {\n      function getPrimaryLenderRules(_ref9) {\n        var _this3 = this;\n\n        var loan = _ref9.loan,\n            structureId = _ref9.structureId,\n            lenderRules = _ref9.lenderRules;\n        var primaryRules = lenderRules.filter(function (rules) {\n          return !_this3.lenderRulesIsSecondary(rules);\n        });\n        var matchingRules = getMatchingRules(primaryRules, this.getLenderRulesVariables({\n          loan: loan,\n          structureId: structureId\n        }), this.storeRuleOrigin);\n        return matchingRules;\n      }\n\n      return getPrimaryLenderRules;\n    }() // Gets the secondary lender rules that require other lender rules to\n    // already have been applied\n    ;\n\n    _proto.getSecondaryLenderRules = function () {\n      function getSecondaryLenderRules(_ref10) {\n        var loan = _ref10.loan,\n            structureId = _ref10.structureId,\n            lenderRules = _ref10.lenderRules;\n        var secondaryRules = lenderRules.filter(this.lenderRulesIsSecondary);\n        var matchingRules = getMatchingRules(secondaryRules, this.getLenderRulesVariables({\n          loan: loan,\n          structureId: structureId\n        }), this.storeRuleOrigin);\n        return matchingRules;\n      }\n\n      return getSecondaryLenderRules;\n    }();\n\n    _proto.lenderRulesIsSecondary = function () {\n      function lenderRulesIsSecondary(_ref11) {\n        var filter = _ref11.filter;\n        return filter.and.map(parseFilter).some(function (_ref12) {\n          var variable = _ref12.variable;\n          return [LENDER_RULES_VARIABLES.BORROW_RATIO, LENDER_RULES_VARIABLES.INCOME].includes(variable);\n        });\n      }\n\n      return lenderRulesIsSecondary;\n    }();\n\n    _proto.applyRules = function () {\n      function applyRules(rules) {\n        var _this4 = this;\n\n        if (rules.names) {\n          this.matchedRules = [].concat((0, _toConsumableArray2.default)(this.matchedRules), (0, _toConsumableArray2.default)(rules.names.filter(function (x) {\n            return x;\n          })));\n        }\n\n        var rulesToApply = ['adminComments', 'allowPledge', 'amortizationGoal', 'amortizationYears', 'bonusAlgorithm', 'bonusConsideration', 'bonusHistoryToConsider', 'companyIncomeConsideration', 'companyIncomeHistoryToConsider', 'dividendsConsideration', 'dividendsHistoryToConsider', 'expensesSubtractFromIncome', 'fortuneReturnsRatio', 'incomeConsiderationType', 'investmentIncomeConsideration', 'maxBorrowRatio', 'maxIncomeRatio', 'pdfComments', 'pensionIncomeConsideration', 'realEstateIncomeAlgorithm', 'realEstateIncomeConsideration', 'realEstateIncomeConsiderationType', 'theoreticalInterestRate', 'theoreticalInterestRate2ndRank', 'theoreticalMaintenanceRate'];\n        rulesToApply.forEach(function (rule) {\n          if (rules[rule] !== undefined && rules[rule] !== null) {\n            _this4[rule] = rules[rule];\n          }\n        });\n      }\n\n      return applyRules;\n    }();\n\n    _proto.cleanUpUnusedRules = function () {\n      function cleanUpUnusedRules() {\n        this.maxIncomeRatioTight = 0;\n        this.maxBorrowRatioWithPledge = 0;\n      }\n\n      return cleanUpUnusedRules;\n    }();\n\n    return _temp;\n  }(SuperClass), _temp;\n};","map":{"version":3,"sources":["imports/core/utils/Calculator/LenderRulesInitializator.js"],"names":["withLenderRulesInitializator","constructor","initialize","lenderRules","loan","sortedlenderRules","order","orderA","orderB","globalRules","structureId","primaryRules","secondaryRules","storeRuleOrigin","Object","ruleName","getOriginOfRule","lenderRulesId","_id","getLenderRulesVariables","LENDER_RULES_VARIABLES","key","CANTON","WANTED_LOAN","INSIDE_AREA","PROPERTY_TYPE","ZIP_CODE","type","OWN_FUNDS_TYPES","BANK_FORTUNE","getGlobalLenderRules","filter","matchingRules","getMatchingRules","getPrimaryLenderRules","rules","getSecondaryLenderRules","lenderRulesIsSecondary","variable","applyRules","x","rulesToApply","rule","cleanUpUnusedRules"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAMO,IAAMA,4BAA4B,GAAG,YAAA;AAAA,MAAA,UAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA,MAAA,KAAA;;AAAA,SAAA,KAAA;AAAA;AAAA;AAAA;;AAExCC,mBAAW,QAAXA,EAAsB;AAAA;;AACpB,qCAAA,QAAA;;AADoB,MAAA,eAAA,8CAAA,qBAAA,EA6CCE,UAAAA,WAAD,EAAiB;AACrC,cAAA,gBAAA,GAAwBA,WAAW,CAAXA,MAAAA,GACpBA,WAAW,CAAXA,CAAW,CAAXA,CAAAA,YAAAA,IAA+BA,WAAW,CAAXA,CAAW,CAAXA,CAAAA,YAAAA,CADXA,IAAAA,GAAxB,IAAA;AA9CoB,OAAA,CAAA;;AAEpB,YAAA,UAAA,CAAA,QAAA;;AAFoB;AAGrB;;AALuC;;AAAA,WAOxCD,UAPwC;AAOxCA,gCAAoD;AAAA,YAAzC,IAAyC,QAAzC,IAAyC;AAAA,YAAzC,WAAyC,QAAzC,WAAyC;AAAA,oCAApBC,WAAoB;AAAA,YAApBA,WAAoB,iCAAN,EAAM;;AAClD,YAAI,EAAEC,IAAI,IAAJA,WAAAA,IAAuBD,WAAW,CAAXA,MAAAA,GAA7B,CAAI,CAAJ,EAAsD;AACpD;AACD;;AAED,YAAME,iBAAiB,GAAG,WAAW,CAAX,IAAA,CAAiB;AAAA,cAAUE,MAAV,SAAGD,KAAH;AAAA,cAA6BE,MAA7B,SAAsBF,KAAtB;AAAA,iBAA0CC,MAAM,GALzC,MAKP;AAAA,SAAjB,CAA1B,CALkD,CAOlD;;AACA,aAAA,WAAA,GAAA,iBAAA;AACA,aAAA,mBAAA,CAAA,iBAAA;AACA,aAAA,UAAA,GAAA,EAAA;AACA,aAAA,YAAA,GAXkD,EAWlD,CAXkD,CAalD;;AACA,YAAME,WAAW,GAAG,KAAA,oBAAA,CAA0B;AAC5CL,UAAAA,IAD4C,EAC5CA,IAD4C;AAE5CM,UAAAA,WAF4C,EAE5CA,WAF4C;AAG5CP,UAAAA,WAAW,EAAEE;AAH+B,SAA1B,CAApB;AAKA,aAAA,UAAA,CAnBkD,WAmBlD,EAnBkD,CAqBlD;;AACA,YAAMM,YAAY,GAAG,KAAA,qBAAA,CAA2B;AAC9CP,UAAAA,IAD8C,EAC9CA,IAD8C;AAE9CM,UAAAA,WAF8C,EAE9CA,WAF8C;AAG9CP,UAAAA,WAAW,EAAEE;AAHiC,SAA3B,CAArB;AAKA,aAAA,UAAA,CA3BkD,YA2BlD,EA3BkD,CA6BlD;;AACA,YAAMO,cAAc,GAAG,KAAA,uBAAA,CAA6B;AAClDR,UAAAA,IADkD,EAClDA,IADkD;AAElDM,UAAAA,WAFkD,EAElDA,WAFkD;AAGlDP,UAAAA,WAAW,EAAEE;AAHqC,SAA7B,CAAvB;AAKA,aAAA,UAAA,CAAA,cAAA;AAEA,aAAA,kBAAA;AACD;;AA7CuC;AAAA;;AAAA,WAqDxCQ,eArDwC;AAqDxCA,+BAAe,KAAfA,EAAe,aAAfA,EAAsC;AAAA;;AACpCC,QAAAA,MAAM,CAANA,IAAAA,CAAAA,KAAAA,EAAAA,OAAAA,CAA4BC,UAAAA,QAAD,EAAc;AACvC,UAAA,MAAA,CAAA,UAAA,CAAA,QAAA,IAAA,aAAA;AADFD,SAAAA;AAGD;;AAzDuC;AAAA;;AAAA,WA2DxCE,eA3DwC;AA2DxCA,+BAAe,QAAfA,EAA0B;AACxB,YAAMC,aAAa,GAAG,KAAA,UAAA,CAAtB,QAAsB,CAAtB;AACA,YAAMd,WAAW,GAAG,KAAA,WAAA,CAAA,IAAA,CAAsB;AAAA,cAAGe,GAAH,SAAGA,GAAH;AAAA,iBAAaA,GAAG,KAA1D,aAA0C;AAAA,SAAtB,CAApB;AACA,eAAA,WAAA;AACD;;AA/DuC;AAAA;;AAAA,WAiExCC,uBAjEwC;AAiExCA,8CAA+C;AAAA;;AAAA,YAAvB,IAAuB,SAAvB,IAAuB;AAAA,YAAfT,WAAe,SAAfA,WAAe;AAC7C,iCACGU,sBAAsB,CAAvB,cADF,IAC2ChB,IAAI,CADxC,aAAP,QAEGgB,sBAAsB,CAAvB,MAFF,IAEmC,KAAA,iBAAA,CAAuB;AACtDhB,UAAAA,IADsD,EACtDA,IADsD;AAEtDM,UAAAA,WAFsD,EAEtDA,WAFsD;AAGtDW,UAAAA,GAAG,EAAED,sBAAsB,CAACE;AAH0B,SAAvB,CAFnC,QAOGF,sBAAsB,CAAvB,WAPF,IAOwC,KAAA,kBAAA,CAAwB;AAC5DhB,UAAAA,IAD4D,EAC5DA,IAD4D;AAE5DM,UAAAA,WAF4D,EAE5DA,WAF4D;AAG5DW,UAAAA,GAAG,EAAED,sBAAsB,CAACG;AAHgC,SAAxB,CAPxC,QAYGH,sBAAsB,CAAvB,cAZF,IAY2C,KAAA,mBAAA,CAAyB;AAChEhB,UAAAA,IADgE,EAChEA,IADgE;AAEhEM,UAAAA,WAAAA,EAAAA;AAFgE,SAAzB,CAZ3C,QAgBGU,sBAAsB,CAAvB,WAhBF,IAgBwC,KAAA,iBAAA,CAAuB;AAC3DhB,UAAAA,IAD2D,EAC3DA,IAD2D;AAE3DM,UAAAA,WAF2D,EAE3DA,WAF2D;AAG3DW,UAAAA,GAAG,EAAED,sBAAsB,CAACI;AAH+B,SAAvB,CAhBxC,QAqBGJ,sBAAsB,CAAvB,YArBF,IAqByC,KAAA,UAAA,CAAgB;AAAEhB,UAAAA,IAAAA,EAAAA;AAAF,SAAhB,CArBzC,QAsBGgB,sBAAsB,CAAvB,YAtBF,IAsByC,KAAA,cAAA,CAAoB;AACzDhB,UAAAA,IADyD,EACzDA,IADyD;AAEzDM,UAAAA,WAAAA,EAAAA;AAFyD,SAApB,CAtBzC,QA0BGU,sBAAsB,CAAvB,MA1BF,IA0BmC,KAAA,cAAA,CAAoB;AAAEhB,UAAAA,IAAAA,EAAAA;AAAF,SAApB,CA1BnC,QA2BGgB,sBAAsB,CAAvB,aA3BF,IA2B0C,KAAA,iBAAA,CAAuB;AAC7DhB,UAAAA,IAD6D,EAC7DA,IAD6D;AAE7DM,UAAAA,WAF6D,EAE7DA,WAF6D;AAG7DW,UAAAA,GAAG,EAAED,sBAAsB,CAACK;AAHiC,SAAvB,CA3B1C,QAgCGL,sBAAsB,CAAvB,QAhCF,IAgCqC,KAAA,iBAAA,CAAuB;AACxDhB,UAAAA,IADwD,EACxDA,IADwD;AAExDM,UAAAA,WAFwD,EAExDA,WAFwD;AAGxDW,UAAAA,GAAG,EAAED,sBAAsB,CAACM;AAH4B,SAAvB,CAhCrC,QAqCGN,sBAAsB,CAAvB,sBArCF,IAqCmD,KAAA,uBAAA,CAA6B;AAC5EhB,UAAAA,IAD4E,EAC5EA,IAD4E;AAE5EM,UAAAA,WAF4E,EAE5EA,WAF4E;AAG5EiB,UAAAA,IAAI,EAAEC,eAAe,CAACC;AAHsD,SAA7B,CArCnD;AA2CD;;AA7GuC;AAAA;;AAAA,WA+GxCC,oBA/GwC;AA+GxCA,2CAAsC;AAAA,YAAf3B,WAAe,SAAfA,WAAe;AACpC,YAAMM,WAAW,GAAGN,WAAW,CAAXA,MAAAA,CAAmB;AAAA,cAAG4B,MAAH,SAAGA,MAAH;AAAA,iBACrCA,MAAM,CAANA,GAAAA,IAAcA,MAAM,CAANA,GAAAA,CAAAA,MAAAA,KAAdA,CAAAA,IAAyCA,MAAM,CAANA,GAAAA,CAAAA,CAAAA,MAD3C,IAAuC;AAAA,SAAnB5B,CAApB;AAEA,YAAM6B,aAAa,GAAGC,gBAAgB,CAAA,WAAA,EAAA,EAAA,EAGpC,KAHF,eAAsC,CAAtC;AAKA,eAAA,aAAA;AACD;;AAxHuC;AAAA;;AAAA,WA0HxCC,qBA1HwC;AA0HxCA,4CAA0D;AAAA;;AAAA,YAApC,IAAoC,SAApC,IAAoC;AAAA,YAApC,WAAoC,SAApC,WAAoC;AAAA,YAAf/B,WAAe,SAAfA,WAAe;AACxD,YAAMQ,YAAY,GAAGR,WAAW,CAAXA,MAAAA,CAAmBgC,UAAAA,KAAK;AAAA,iBAAI,CAAC,MAAA,CAAA,sBAAA,CAAlD,KAAkD,CAAL;AAAA,SAAxBhC,CAArB;AACA,YAAM6B,aAAa,GAAGC,gBAAgB,CAAA,YAAA,EAEpC,KAAA,uBAAA,CAA6B;AAAE7B,UAAAA,IAAF,EAAEA,IAAF;AAAQM,UAAAA,WAAAA,EAAAA;AAAR,SAA7B,CAFoC,EAGpC,KAHF,eAAsC,CAAtC;AAKA,eAAA,aAAA;AAhIqB;;AADiB;AAAA,QAoIxC;AACA;AArIwC;;AAAA,WAsIxC0B,uBAtIwC;AAsIxCA,+CAA4D;AAAA,YAApC,IAAoC,UAApC,IAAoC;AAAA,YAApC,WAAoC,UAApC,WAAoC;AAAA,YAAfjC,WAAe,UAAfA,WAAe;AAC1D,YAAMS,cAAc,GAAGT,WAAW,CAAXA,MAAAA,CAAmB,KAA1C,sBAAuBA,CAAvB;AACA,YAAM6B,aAAa,GAAGC,gBAAgB,CAAA,cAAA,EAEpC,KAAA,uBAAA,CAA6B;AAAE7B,UAAAA,IAAF,EAAEA,IAAF;AAAQM,UAAAA,WAAAA,EAAAA;AAAR,SAA7B,CAFoC,EAGpC,KAHF,eAAsC,CAAtC;AAKA,eAAA,aAAA;AACD;;AA9IuC;AAAA;;AAAA,WAgJxC2B,sBAhJwC;AAgJxCA,8CAAmC;AAAA,YAAVN,MAAU,UAAVA,MAAU;AACjC,eAAOA,MAAM,CAANA,GAAAA,CAAAA,GAAAA,CAAAA,WAAAA,EAAAA,IAAAA,CAEC;AAAA,cAAGO,QAAH,UAAGA,QAAH;AAAA,iBACJ,CACElB,sBAAsB,CADxB,YAAA,EAEEA,sBAAsB,CAFxB,MAAA,EAAA,QAAA,CAHJ,QAGI,CADI;AAAA,SAFDW,CAAP;AAOD;;AAxJuC;AAAA;;AAAA,WA0JxCQ,UA1JwC;AA0JxCA,0BAAU,KAAVA,EAAkB;AAAA;;AAChB,YAAIJ,KAAK,CAAT,KAAA,EAAiB;AACf,eAAA,YAAA,8CACK,KADe,YAApB,oCAEKA,KAAK,CAALA,KAAAA,CAAAA,MAAAA,CAAmBK,UAAAA,CAAC;AAAA,mBAFzB,CAEyB;AAAA,WAApBL,CAFL;AAID;;AAED,YAAMM,YAAY,GAAG,CAAA,eAAA,EAAA,aAAA,EAAA,kBAAA,EAAA,mBAAA,EAAA,gBAAA,EAAA,oBAAA,EAAA,wBAAA,EAAA,4BAAA,EAAA,gCAAA,EAAA,wBAAA,EAAA,4BAAA,EAAA,4BAAA,EAAA,qBAAA,EAAA,yBAAA,EAAA,+BAAA,EAAA,gBAAA,EAAA,gBAAA,EAAA,aAAA,EAAA,4BAAA,EAAA,2BAAA,EAAA,+BAAA,EAAA,mCAAA,EAAA,yBAAA,EAAA,gCAAA,EAArB,4BAAqB,CAArB;AA4BAA,QAAAA,YAAY,CAAZA,OAAAA,CAAsBC,UAAAA,IAAD,EAAU;AAC7B,cAAIP,KAAK,CAALA,IAAK,CAALA,KAAAA,SAAAA,IAA6BA,KAAK,CAALA,IAAK,CAALA,KAAjC,IAAA,EAAuD;AACrD,YAAA,MAAA,CAAA,IAAA,CAAA,GAAaA,KAAK,CAAlB,IAAkB,CAAlB;AACD;AAHHM,SAAAA;AAKD;;AAnMuC;AAAA;;AAAA,WAqMxCE,kBArMwC;AAqMxCA,oCAAqB;AACnB,aAAA,mBAAA,GAAA,CAAA;AACA,aAAA,wBAAA,GAAA,CAAA;AACD;;AAxMuC;AAAA;;AAAA;AAAA,IAC1C,UAD0C,CAAA,EAAA,KAAA;AAArC,CAAA","sourcesContent":["import { parseFilter } from 'core/api/lenderRules/helpers';\nimport { getMatchingRules } from '../../api/lenderRules/helpers';\nimport { LENDER_RULES_VARIABLES, OWN_FUNDS_TYPES } from '../../api/constants';\n\n// @flow\n\nexport const withLenderRulesInitializator = (SuperClass = class {}) =>\n  class extends SuperClass {\n    constructor(settings) {\n      super(settings);\n      this.initialize(settings);\n    }\n\n    initialize({ loan, structureId, lenderRules = [] }) {\n      if (!(loan && lenderRules && lenderRules.length > 0)) {\n        return;\n      }\n\n      const sortedlenderRules = lenderRules.sort(({ order: orderA }, { order: orderB }) => orderA - orderB);\n\n      // Store the rules for retrieval later\n      this.lenderRules = sortedlenderRules;\n      this.setOrganisationName(sortedlenderRules);\n      this.ruleOrigin = {};\n      this.matchedRules = [];\n\n      // Global rules\n      const globalRules = this.getGlobalLenderRules({\n        loan,\n        structureId,\n        lenderRules: sortedlenderRules,\n      });\n      this.applyRules(globalRules);\n\n      // Primary rules depend only on raw data\n      const primaryRules = this.getPrimaryLenderRules({\n        loan,\n        structureId,\n        lenderRules: sortedlenderRules,\n      });\n      this.applyRules(primaryRules);\n\n      // Secondary rules depend on what is calculated with the rules applied from the primary rules\n      const secondaryRules = this.getSecondaryLenderRules({\n        loan,\n        structureId,\n        lenderRules: sortedlenderRules,\n      });\n      this.applyRules(secondaryRules);\n\n      this.cleanUpUnusedRules();\n    }\n\n    setOrganisationName = (lenderRules) => {\n      this.organisationName = lenderRules.length\n        ? lenderRules[0].organisation && lenderRules[0].organisation.name\n        : null;\n    };\n\n    storeRuleOrigin(rules, lenderRulesId) {\n      Object.keys(rules).forEach((ruleName) => {\n        this.ruleOrigin[ruleName] = lenderRulesId;\n      });\n    }\n\n    getOriginOfRule(ruleName) {\n      const lenderRulesId = this.ruleOrigin[ruleName];\n      const lenderRules = this.lenderRules.find(({ _id }) => _id === lenderRulesId);\n      return lenderRules;\n    }\n\n    getLenderRulesVariables({ loan, structureId }) {\n      return {\n        [LENDER_RULES_VARIABLES.RESIDENCE_TYPE]: loan.residenceType,\n        [LENDER_RULES_VARIABLES.CANTON]: this.selectPropertyKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.CANTON,\n        }),\n        [LENDER_RULES_VARIABLES.WANTED_LOAN]: this.selectStructureKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.WANTED_LOAN,\n        }),\n        [LENDER_RULES_VARIABLES.PROPERTY_VALUE]: this.selectPropertyValue({\n          loan,\n          structureId,\n        }),\n        [LENDER_RULES_VARIABLES.INSIDE_AREA]: this.selectPropertyKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.INSIDE_AREA,\n        }),\n        [LENDER_RULES_VARIABLES.BANK_FORTUNE]: this.getFortune({ loan }),\n        [LENDER_RULES_VARIABLES.BORROW_RATIO]: this.getBorrowRatio({\n          loan,\n          structureId,\n        }),\n        [LENDER_RULES_VARIABLES.INCOME]: this.getTotalIncome({ loan }),\n        [LENDER_RULES_VARIABLES.PROPERTY_TYPE]: this.selectPropertyKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.PROPERTY_TYPE,\n        }),\n        [LENDER_RULES_VARIABLES.ZIP_CODE]: this.selectPropertyKey({\n          loan,\n          structureId,\n          key: LENDER_RULES_VARIABLES.ZIP_CODE,\n        }),\n        [LENDER_RULES_VARIABLES.REMAINING_BANK_FORTUNE]: this.getRemainingFundsOfType({\n          loan,\n          structureId,\n          type: OWN_FUNDS_TYPES.BANK_FORTUNE,\n        }),\n      };\n    }\n\n    getGlobalLenderRules({ lenderRules }) {\n      const globalRules = lenderRules.filter(({ filter }) =>\n        filter.and && filter.and.length === 1 && filter.and[0] === true);\n      const matchingRules = getMatchingRules(\n        globalRules,\n        {},\n        this.storeRuleOrigin,\n      );\n      return matchingRules;\n    }\n\n    getPrimaryLenderRules({ loan, structureId, lenderRules }) {\n      const primaryRules = lenderRules.filter(rules => !this.lenderRulesIsSecondary(rules));\n      const matchingRules = getMatchingRules(\n        primaryRules,\n        this.getLenderRulesVariables({ loan, structureId }),\n        this.storeRuleOrigin,\n      );\n      return matchingRules;\n    }\n\n    // Gets the secondary lender rules that require other lender rules to\n    // already have been applied\n    getSecondaryLenderRules({ loan, structureId, lenderRules }) {\n      const secondaryRules = lenderRules.filter(this.lenderRulesIsSecondary);\n      const matchingRules = getMatchingRules(\n        secondaryRules,\n        this.getLenderRulesVariables({ loan, structureId }),\n        this.storeRuleOrigin,\n      );\n      return matchingRules;\n    }\n\n    lenderRulesIsSecondary({ filter }) {\n      return filter.and\n        .map(parseFilter)\n        .some(({ variable }) =>\n          [\n            LENDER_RULES_VARIABLES.BORROW_RATIO,\n            LENDER_RULES_VARIABLES.INCOME,\n          ].includes(variable));\n    }\n\n    applyRules(rules) {\n      if (rules.names) {\n        this.matchedRules = [\n          ...this.matchedRules,\n          ...rules.names.filter(x => x),\n        ];\n      }\n\n      const rulesToApply = [\n        'adminComments',\n        'allowPledge',\n        'amortizationGoal',\n        'amortizationYears',\n        'bonusAlgorithm',\n        'bonusConsideration',\n        'bonusHistoryToConsider',\n        'companyIncomeConsideration',\n        'companyIncomeHistoryToConsider',\n        'dividendsConsideration',\n        'dividendsHistoryToConsider',\n        'expensesSubtractFromIncome',\n        'fortuneReturnsRatio',\n        'incomeConsiderationType',\n        'investmentIncomeConsideration',\n        'maxBorrowRatio',\n        'maxIncomeRatio',\n        'pdfComments',\n        'pensionIncomeConsideration',\n        'realEstateIncomeAlgorithm',\n        'realEstateIncomeConsideration',\n        'realEstateIncomeConsiderationType',\n        'theoreticalInterestRate',\n        'theoreticalInterestRate2ndRank',\n        'theoreticalMaintenanceRate',\n      ];\n\n      rulesToApply.forEach((rule) => {\n        if (rules[rule] !== undefined && rules[rule] !== null) {\n          this[rule] = rules[rule];\n        }\n      });\n    }\n\n    cleanUpUnusedRules() {\n      this.maxIncomeRatioTight = 0;\n      this.maxBorrowRatioWithPledge = 0;\n    }\n  };\n"]},"sourceType":"script","hash":"37b5a2eae4cbceccc7ee2cccc9bff814010f44af"}

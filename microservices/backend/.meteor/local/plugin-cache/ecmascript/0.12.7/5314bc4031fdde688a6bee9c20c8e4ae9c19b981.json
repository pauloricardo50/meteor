{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/containerToolkit/withSmartQuery.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties",["flow",{}],"jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.osx.x86_64"},"sourceFileName":"imports/core/api/containerToolkit/withSmartQuery.js","filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/containerToolkit/withSmartQuery.js","inputSourceMap":{"version":3,"sources":["imports/core/api/containerToolkit/withSmartQuery.js"],"names":["withQuery","mapProps","compose","branch","renderComponent","lifecycle","withLoading","MissingDoc","ClientEventService","addQueryToRefetch","removeQueryToRefetch","makeSkipContainer","makeRenderMissingDocIfNoData","render","single","renderFunc","props","isLoading","data","makeMapProps","dataName","error","rest","withQueryRefetcher","queryName","componentDidMount","refetch","addListener","componentWillUnmount","removeListener","withGlobalQueryManager","reactive","refetchOnMethodCall","shouldActivateGlobalRefetch","global","window","x","withSmartQueryArgs","query","params","Object","queryOptions","renderMissingDoc","Function","smallLoader","calculateParams","withSmartQuery","skip","completeQuery","clone","container","loadOnRefetch"],"mappings":"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","sourcesContent":["// @flow\nimport { withQuery } from 'meteor/cultofcoders:grapher-react';\nimport {\n  mapProps,\n  compose,\n  branch,\n  renderComponent,\n  lifecycle,\n} from 'recompose';\nimport { withLoading } from '../../components/Loading';\nimport MissingDoc from '../../components/MissingDoc';\nimport ClientEventService from '../events/ClientEventService';\nimport {\n  addQueryToRefetch,\n  removeQueryToRefetch,\n} from '../methods/clientQueryManager';\nimport makeSkipContainer from './skipContainer';\n\n// render the missing doc component only when we want to\nconst makeRenderMissingDocIfNoData = (render: boolean = false, { single }) => {\n  let renderFunc;\n  if (typeof render === 'function') {\n    renderFunc = props =>\n      render(props) && single && (!props.isLoading && !props.data);\n  } else {\n    renderFunc = ({ isLoading, data }) =>\n      render && single && (!isLoading && !data);\n  }\n\n  return branch(renderFunc, renderComponent(MissingDoc));\n};\n\n// Use proper name for data, and remove unnecessary props from children\n// error should be thrown and catched by our errorboundaries anyways\n// or displayed by an alert\nconst makeMapProps = dataName =>\n  mapProps(({ data, isLoading, error, ...rest }) => ({\n    [dataName]: data,\n    ...rest,\n  }));\n\nconst withQueryRefetcher = ({ queryName }) =>\n  lifecycle({\n    componentDidMount() {\n      const { refetch } = this.props;\n\n      if (refetch) {\n        ClientEventService.addListener(queryName, refetch);\n      }\n    },\n    componentWillUnmount() {\n      const { refetch } = this.props;\n      if (refetch) {\n        ClientEventService.removeListener(queryName, refetch);\n      }\n    },\n  });\n\n// This adds all non-reactive queries on the window object, and removes them\n// when the query disappears\n// These queries can then all be refreshed from `clientMethodsConfig`\n// every time a method is called\nconst withGlobalQueryManager = (\n  { queryName },\n  { reactive },\n  refetchOnMethodCall,\n) => {\n  const shouldActivateGlobalRefetch = refetchOnMethodCall && !reactive && global.window;\n\n  if (!shouldActivateGlobalRefetch) {\n    return x => x;\n  }\n\n  return lifecycle({\n    componentDidMount() {\n      addQueryToRefetch(queryName, refetchOnMethodCall);\n    },\n    componentWillUnmount() {\n      removeQueryToRefetch(queryName);\n    },\n  });\n};\n\ntype withSmartQueryArgs = {\n  query: () => mixed,\n  params: (props: Object) => Object,\n  queryOptions?: { single: boolean },\n  dataName?: string,\n  renderMissingDoc?: boolean | Function,\n  smallLoader?: boolean,\n};\n\nconst calculateParams = (params, props) => {\n  if (typeof params === 'function') {\n    return params(props);\n  }\n  return params;\n};\n\nconst withSmartQuery = ({\n  query,\n  params = {},\n  queryOptions = { single: false },\n  dataName = 'data',\n  // used to bypass the missing doc component\n  renderMissingDoc = true,\n  smallLoader = false,\n  refetchOnMethodCall = 'all',\n  skip,\n}: withSmartQueryArgs) => {\n  let completeQuery;\n\n  if (typeof query === 'function') {\n    completeQuery = props => query(props).clone(calculateParams(params, props));\n  } else {\n    completeQuery = props => query.clone(calculateParams(params, props));\n  }\n\n  const container = compose(\n    withGlobalQueryManager(query, queryOptions, refetchOnMethodCall),\n    withQuery(completeQuery, { loadOnRefetch: false, ...queryOptions }),\n    withLoading(smallLoader),\n    makeRenderMissingDocIfNoData(renderMissingDoc, queryOptions),\n    makeMapProps(dataName),\n    withQueryRefetcher(query),\n  );\n\n  if (skip) {\n    return makeSkipContainer(container, skip);\n  }\n\n  return container;\n};\n\nexport default withSmartQuery;\n"]},"passPerPreset":false,"envName":"development","cwd":"/Users/Florian/dev/epotek/microservices/backend","root":"/Users/Florian/dev/epotek/microservices/backend","plugins":[{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"/Users/Florian/dev/epotek/microservices/backend/imports/core/api/containerToolkit/withSmartQuery.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"imports/core/api/containerToolkit/withSmartQuery.js"}},"code":"var _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread\"));\n\nvar _objectWithoutProperties2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutProperties\"));\n\nlet withQuery;\nmodule.link(\"meteor/cultofcoders:grapher-react\", {\n  withQuery(v) {\n    withQuery = v;\n  }\n\n}, 0);\nlet mapProps, compose, branch, renderComponent, lifecycle;\nmodule.link(\"recompose\", {\n  mapProps(v) {\n    mapProps = v;\n  },\n\n  compose(v) {\n    compose = v;\n  },\n\n  branch(v) {\n    branch = v;\n  },\n\n  renderComponent(v) {\n    renderComponent = v;\n  },\n\n  lifecycle(v) {\n    lifecycle = v;\n  }\n\n}, 1);\nlet withLoading;\nmodule.link(\"../../components/Loading\", {\n  withLoading(v) {\n    withLoading = v;\n  }\n\n}, 2);\nlet MissingDoc;\nmodule.link(\"../../components/MissingDoc\", {\n  default(v) {\n    MissingDoc = v;\n  }\n\n}, 3);\nlet ClientEventService;\nmodule.link(\"../events/ClientEventService\", {\n  default(v) {\n    ClientEventService = v;\n  }\n\n}, 4);\nlet addQueryToRefetch, removeQueryToRefetch;\nmodule.link(\"../methods/clientQueryManager\", {\n  addQueryToRefetch(v) {\n    addQueryToRefetch = v;\n  },\n\n  removeQueryToRefetch(v) {\n    removeQueryToRefetch = v;\n  }\n\n}, 5);\nlet makeSkipContainer;\nmodule.link(\"./skipContainer\", {\n  default(v) {\n    makeSkipContainer = v;\n  }\n\n}, 6);\n\n// render the missing doc component only when we want to\nconst makeRenderMissingDocIfNoData = (render = false, {\n  single\n}) => {\n  let renderFunc;\n\n  if (typeof render === 'function') {\n    renderFunc = props => render(props) && single && !props.isLoading && !props.data;\n  } else {\n    renderFunc = ({\n      isLoading,\n      data\n    }) => render && single && !isLoading && !data;\n  }\n\n  return branch(renderFunc, renderComponent(MissingDoc));\n}; // Use proper name for data, and remove unnecessary props from children\n// error should be thrown and catched by our errorboundaries anyways\n// or displayed by an alert\n\n\nconst makeMapProps = dataName => mapProps((_ref) => {\n  let {\n    data,\n    isLoading,\n    error\n  } = _ref,\n      rest = (0, _objectWithoutProperties2.default)(_ref, [\"data\", \"isLoading\", \"error\"]);\n  return (0, _objectSpread2.default)({\n    [dataName]: data\n  }, rest);\n});\n\nconst withQueryRefetcher = ({\n  queryName\n}) => lifecycle({\n  componentDidMount() {\n    const {\n      refetch\n    } = this.props;\n\n    if (refetch) {\n      ClientEventService.addListener(queryName, refetch);\n    }\n  },\n\n  componentWillUnmount() {\n    const {\n      refetch\n    } = this.props;\n\n    if (refetch) {\n      ClientEventService.removeListener(queryName, refetch);\n    }\n  }\n\n}); // This adds all non-reactive queries on the window object, and removes them\n// when the query disappears\n// These queries can then all be refreshed from `clientMethodsConfig`\n// every time a method is called\n\n\nconst withGlobalQueryManager = ({\n  queryName\n}, {\n  reactive\n}, refetchOnMethodCall) => {\n  const shouldActivateGlobalRefetch = refetchOnMethodCall && !reactive && global.window;\n\n  if (!shouldActivateGlobalRefetch) {\n    return x => x;\n  }\n\n  return lifecycle({\n    componentDidMount() {\n      addQueryToRefetch(queryName, refetchOnMethodCall);\n    },\n\n    componentWillUnmount() {\n      removeQueryToRefetch(queryName);\n    }\n\n  });\n};\n\nconst calculateParams = (params, props) => {\n  if (typeof params === 'function') {\n    return params(props);\n  }\n\n  return params;\n};\n\nconst withSmartQuery = ({\n  query,\n  params = {},\n  queryOptions = {\n    single: false\n  },\n  dataName = 'data',\n  // used to bypass the missing doc component\n  renderMissingDoc = true,\n  smallLoader = false,\n  refetchOnMethodCall = 'all',\n  skip\n}) => {\n  let completeQuery;\n\n  if (typeof query === 'function') {\n    completeQuery = props => query(props).clone(calculateParams(params, props));\n  } else {\n    completeQuery = props => query.clone(calculateParams(params, props));\n  }\n\n  const container = compose(withGlobalQueryManager(query, queryOptions, refetchOnMethodCall), withQuery(completeQuery, (0, _objectSpread2.default)({\n    loadOnRefetch: false\n  }, queryOptions)), withLoading(smallLoader), makeRenderMissingDocIfNoData(renderMissingDoc, queryOptions), makeMapProps(dataName), withQueryRefetcher(query));\n\n  if (skip) {\n    return makeSkipContainer(container, skip);\n  }\n\n  return container;\n};\n\nmodule.exportDefault(withSmartQuery);","map":{"version":3,"sources":["imports/core/api/containerToolkit/withSmartQuery.js"],"names":["makeRenderMissingDocIfNoData","render","single","renderFunc","props","data","branch","renderComponent","makeMapProps","dataName","mapProps","rest","withQueryRefetcher","queryName","lifecycle","componentDidMount","refetch","ClientEventService","componentWillUnmount","withGlobalQueryManager","reactive","shouldActivateGlobalRefetch","refetchOnMethodCall","global","x","addQueryToRefetch","removeQueryToRefetch","calculateParams","params","withSmartQuery","queryOptions","renderMissingDoc","smallLoader","skip","completeQuery","query","container","compose","withQuery","loadOnRefetch","withLoading","makeSkipContainer"],"mappings":"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","sourcesContent":["// @flow\nimport { withQuery } from 'meteor/cultofcoders:grapher-react';\nimport {\n  mapProps,\n  compose,\n  branch,\n  renderComponent,\n  lifecycle,\n} from 'recompose';\nimport { withLoading } from '../../components/Loading';\nimport MissingDoc from '../../components/MissingDoc';\nimport ClientEventService from '../events/ClientEventService';\nimport {\n  addQueryToRefetch,\n  removeQueryToRefetch,\n} from '../methods/clientQueryManager';\nimport makeSkipContainer from './skipContainer';\n\n// render the missing doc component only when we want to\nconst makeRenderMissingDocIfNoData = (render: boolean = false, { single }) => {\n  let renderFunc;\n  if (typeof render === 'function') {\n    renderFunc = props =>\n      render(props) && single && (!props.isLoading && !props.data);\n  } else {\n    renderFunc = ({ isLoading, data }) =>\n      render && single && (!isLoading && !data);\n  }\n\n  return branch(renderFunc, renderComponent(MissingDoc));\n};\n\n// Use proper name for data, and remove unnecessary props from children\n// error should be thrown and catched by our errorboundaries anyways\n// or displayed by an alert\nconst makeMapProps = dataName =>\n  mapProps(({ data, isLoading, error, ...rest }) => ({\n    [dataName]: data,\n    ...rest,\n  }));\n\nconst withQueryRefetcher = ({ queryName }) =>\n  lifecycle({\n    componentDidMount() {\n      const { refetch } = this.props;\n\n      if (refetch) {\n        ClientEventService.addListener(queryName, refetch);\n      }\n    },\n    componentWillUnmount() {\n      const { refetch } = this.props;\n      if (refetch) {\n        ClientEventService.removeListener(queryName, refetch);\n      }\n    },\n  });\n\n// This adds all non-reactive queries on the window object, and removes them\n// when the query disappears\n// These queries can then all be refreshed from `clientMethodsConfig`\n// every time a method is called\nconst withGlobalQueryManager = (\n  { queryName },\n  { reactive },\n  refetchOnMethodCall,\n) => {\n  const shouldActivateGlobalRefetch = refetchOnMethodCall && !reactive && global.window;\n\n  if (!shouldActivateGlobalRefetch) {\n    return x => x;\n  }\n\n  return lifecycle({\n    componentDidMount() {\n      addQueryToRefetch(queryName, refetchOnMethodCall);\n    },\n    componentWillUnmount() {\n      removeQueryToRefetch(queryName);\n    },\n  });\n};\n\ntype withSmartQueryArgs = {\n  query: () => mixed,\n  params: (props: Object) => Object,\n  queryOptions?: { single: boolean },\n  dataName?: string,\n  renderMissingDoc?: boolean | Function,\n  smallLoader?: boolean,\n};\n\nconst calculateParams = (params, props) => {\n  if (typeof params === 'function') {\n    return params(props);\n  }\n  return params;\n};\n\nconst withSmartQuery = ({\n  query,\n  params = {},\n  queryOptions = { single: false },\n  dataName = 'data',\n  // used to bypass the missing doc component\n  renderMissingDoc = true,\n  smallLoader = false,\n  refetchOnMethodCall = 'all',\n  skip,\n}: withSmartQueryArgs) => {\n  let completeQuery;\n\n  if (typeof query === 'function') {\n    completeQuery = props => query(props).clone(calculateParams(params, props));\n  } else {\n    completeQuery = props => query.clone(calculateParams(params, props));\n  }\n\n  const container = compose(\n    withGlobalQueryManager(query, queryOptions, refetchOnMethodCall),\n    withQuery(completeQuery, { loadOnRefetch: false, ...queryOptions }),\n    withLoading(smallLoader),\n    makeRenderMissingDocIfNoData(renderMissingDoc, queryOptions),\n    makeMapProps(dataName),\n    withQueryRefetcher(query),\n  );\n\n  if (skip) {\n    return makeSkipContainer(container, skip);\n  }\n\n  return container;\n};\n\nexport default withSmartQuery;\n"]},"sourceType":"script","hash":"5314bc4031fdde688a6bee9c20c8e4ae9c19b981"}

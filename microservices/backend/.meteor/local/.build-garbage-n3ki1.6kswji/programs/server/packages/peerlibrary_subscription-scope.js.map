{"version":3,"sources":["meteor://ðŸ’»app/packages/peerlibrary_subscription-scope/server.coffee","meteor://ðŸ’»app/server.coffee"],"names":["extendPublish","name","func","options","newFunc","args","enabled","originalAdded","originalChanged","publish","scopeFieldName","_subscriptionId","enableScope","added","collectionName","id","fields","_","clone","call","changed","apply"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,aAAA,CAAc,UAACC,IAAD,EAAOC,IAAP,EAAaC,OAAb;AACZ,MAAAC,OAAA;;AAAAA,SAAA,GAAU,aAACC,IAAD;AACR,QAAAC,OAAA,EAAAC,aAAA,EAAAC,eAAA,EAAAC,OAAA,EAAAC,cAAA;AAAAD,WAAA,GAAU,IAAV;AAEAC,kBAAA,GAAiB,QAAQD,OAAO,CAACE,eAAhB,EAAjB;AAEAL,WAAA,GAAU,KAAV;;AAEAG,WAAO,CAACG,WAAR,GAAsB;ACApB,aDCAN,OAAA,GAAU,ICDV;ADAoB,KAAtB;;AAGAC,iBAAA,GAAgBE,OAAO,CAACI,KAAxB;;AACAJ,WAAO,CAACI,KAAR,GAAgB,UAACC,cAAD,EAAiBC,EAAjB,EAAqBC,MAArB;ACAd;ADEA,UAAGV,OAAH;AACEU,cAAA,GAASC,CAAC,CAACC,KAAF,CAAQF,MAAR,CAAT;AACAA,cAAO,CAAAN,cAAA,CAAP,GAAyB,CAAzB;ACAD;;AACD,aDCAH,aAAa,CAACY,IAAd,CAAmB,IAAnB,EAAsBL,cAAtB,EAAsCC,EAAtC,EAA0CC,MAA1C,CCDA;ADLc,KAAhB;;AAQAR,mBAAA,GAAkBC,OAAO,CAACW,OAA1B;;AACAX,WAAO,CAACW,OAAR,GAAkB,UAACN,cAAD,EAAiBC,EAAjB,EAAqBC,MAArB;ACAhB;ADEA,UAAGV,OAAA,IAAYI,cAAA,IAAkBM,MAAjC;AACEA,cAAA,GAASC,CAAC,CAACC,KAAF,CAAQF,MAAR,CAAT;AACA,eAAOA,MAAO,CAAAN,cAAA,CAAd;ACAD;;AACD,aDCAF,eAAe,CAACW,IAAhB,CAAqB,IAArB,EAAwBL,cAAxB,EAAwCC,EAAxC,EAA4CC,MAA5C,CCDA;ADLgB,KAAlB;;ACOA,WDCAd,IAAI,CAACmB,KAAL,CAAWZ,OAAX,EAAoBJ,IAApB,CCDA;AD3BQ,GAAV;;AC6BA,SDCA,CAACJ,IAAD,EAAOG,OAAP,EAAgBD,OAAhB,CCDA;AD9BF,G","file":"/packages/peerlibrary_subscription-scope.js","sourcesContent":["extendPublish (name, func, options) ->\n  newFunc = (args...) ->\n    publish = @\n\n    scopeFieldName = \"_sub_#{publish._subscriptionId}\"\n\n    enabled = false\n\n    publish.enableScope = ->\n      enabled = true\n\n    originalAdded = publish.added\n    publish.added = (collectionName, id, fields) ->\n      # Add our scoping field.\n      if enabled\n        fields = _.clone fields\n        fields[scopeFieldName] = 1\n\n      originalAdded.call @, collectionName, id, fields\n\n    originalChanged = publish.changed\n    publish.changed = (collectionName, id, fields) ->\n      # We do not allow changes to our scoping field.\n      if enabled and scopeFieldName of fields\n        fields = _.clone fields\n        delete fields[scopeFieldName]\n\n      originalChanged.call @, collectionName, id, fields\n\n    func.apply publish, args\n\n  [name, newFunc, options]\n","extendPublish(function(name, func, options) {\n  var newFunc;\n  newFunc = function(...args) {\n    var enabled, originalAdded, originalChanged, publish, scopeFieldName;\n    publish = this;\n    scopeFieldName = `_sub_${publish._subscriptionId}`;\n    enabled = false;\n    publish.enableScope = function() {\n      return enabled = true;\n    };\n    originalAdded = publish.added;\n    publish.added = function(collectionName, id, fields) {\n      // Add our scoping field.\n      if (enabled) {\n        fields = _.clone(fields);\n        fields[scopeFieldName] = 1;\n      }\n      return originalAdded.call(this, collectionName, id, fields);\n    };\n    originalChanged = publish.changed;\n    publish.changed = function(collectionName, id, fields) {\n      // We do not allow changes to our scoping field.\n      if (enabled && scopeFieldName in fields) {\n        fields = _.clone(fields);\n        delete fields[scopeFieldName];\n      }\n      return originalChanged.call(this, collectionName, id, fields);\n    };\n    return func.apply(publish, args);\n  };\n  return [name, newFunc, options];\n});\n"]}
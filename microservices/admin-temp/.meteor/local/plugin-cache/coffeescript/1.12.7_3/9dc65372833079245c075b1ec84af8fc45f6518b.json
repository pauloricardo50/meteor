{"metadata":{"usedHelpers":["typeof"],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"packages/vsivsi:job-collection/src/server.coffee","filenameRelative":"packages/vsivsi:job-collection/src/server.coffee","env":{},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],null],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"packages/vsivsi:job-collection/src/server.coffee.map","sourceFileName":"packages/vsivsi:job-collection/src/server.coffee","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"server"},"ignored":false,"code":"var _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nvar eventEmitter,\n    userHelper,\n    bind = function (fn, me) {\n  return function () {\n    return fn.apply(me, arguments);\n  };\n},\n    extend = function (child, parent) {\n  for (var key in meteorBabelHelpers.sanitizeForInObject(parent)) {\n    if (hasProp.call(parent, key)) child[key] = parent[key];\n  }\n\n  function ctor() {\n    this.constructor = child;\n  }\n\n  ctor.prototype = parent.prototype;\n  child.prototype = new ctor();\n  child.__super__ = parent.prototype;\n  return child;\n},\n    hasProp = {}.hasOwnProperty,\n    slice = [].slice,\n    indexOf = [].indexOf || function (item) {\n  for (var i = 0, l = this.length; i < l; i++) {\n    if (i in this && this[i] === item) return i;\n  }\n\n  return -1;\n};\n\nif (Meteor.isServer) {\n  eventEmitter = Npm.require('events').EventEmitter;\n\n  userHelper = function (user, connection) {\n    var ret;\n    ret = user != null ? user : \"[UNAUTHENTICATED]\";\n\n    if (!connection) {\n      ret = \"[SERVER]\";\n    }\n\n    return ret;\n  };\n\n  JobCollection = function (superClass) {\n    extend(JobCollection, superClass);\n\n    function JobCollection(root, options) {\n      var foo, i, len, level, localMethods, methodFunction, methodName, ref;\n\n      if (root == null) {\n        root = 'queue';\n      }\n\n      if (options == null) {\n        options = {};\n      }\n\n      this._emit = bind(this._emit, this);\n      this._toLog = bind(this._toLog, this);\n      this._onCall = bind(this._onCall, this);\n      this._onError = bind(this._onError, this);\n\n      if (!(this instanceof JobCollection)) {\n        return new JobCollection(root, options);\n      }\n\n      JobCollection.__super__.constructor.call(this, root, options);\n\n      this.events = new eventEmitter();\n      this._errorListener = this.events.on('error', this._onError);\n      this._methodErrorDispatch = this.events.on('error', function (_this) {\n        return function (msg) {\n          return _this.events.emit(msg.method, msg);\n        };\n      }(this));\n      this._callListener = this.events.on('call', this._onCall);\n      this._methodEventDispatch = this.events.on('call', function (_this) {\n        return function (msg) {\n          return _this.events.emit(msg.method, msg);\n        };\n      }(this));\n      this.stopped = true;\n\n      share.JobCollectionBase.__super__.deny.bind(this)({\n        update: function (_this) {\n          return function () {\n            return true;\n          };\n        }(this),\n        insert: function (_this) {\n          return function () {\n            return true;\n          };\n        }(this),\n        remove: function (_this) {\n          return function () {\n            return true;\n          };\n        }(this)\n      });\n\n      this.promote();\n      this.logStream = null;\n      this.allows = {};\n      this.denys = {};\n      ref = this.ddpPermissionLevels.concat(this.ddpMethods);\n\n      for (i = 0, len = ref.length; i < len; i++) {\n        level = ref[i];\n        this.allows[level] = [];\n        this.denys[level] = [];\n      }\n\n      if (options.connection == null) {\n        this._ensureIndex({\n          type: 1,\n          status: 1\n        });\n\n        this._ensureIndex({\n          priority: 1,\n          retryUntil: 1,\n          after: 1\n        });\n\n        this.isSimulation = false;\n        localMethods = this._generateMethods();\n\n        if (this._localServerMethods == null) {\n          this._localServerMethods = {};\n        }\n\n        for (methodName in meteorBabelHelpers.sanitizeForInObject(localMethods)) {\n          methodFunction = localMethods[methodName];\n          this._localServerMethods[methodName] = methodFunction;\n        }\n\n        foo = this;\n\n        this._ddp_apply = function (_this) {\n          return function (name, params, cb) {\n            if (cb != null) {\n              return Meteor.setTimeout(function () {\n                var e, err, res;\n                err = null;\n                res = null;\n\n                try {\n                  res = _this._localServerMethods[name].apply(_this, params);\n                } catch (error) {\n                  e = error;\n                  err = e;\n                }\n\n                return cb(err, res);\n              }, 0);\n            } else {\n              return _this._localServerMethods[name].apply(_this, params);\n            }\n          };\n        }(this);\n\n        Job._setDDPApply(this._ddp_apply, root);\n\n        Meteor.methods(localMethods);\n      }\n    }\n\n    JobCollection.prototype._onError = function (msg) {\n      var user;\n      user = userHelper(msg.userId, msg.connection);\n      return this._toLog(user, msg.method, \"\" + msg.error);\n    };\n\n    JobCollection.prototype._onCall = function (msg) {\n      var user;\n      user = userHelper(msg.userId, msg.connection);\n\n      this._toLog(user, msg.method, \"params: \" + JSON.stringify(msg.params));\n\n      return this._toLog(user, msg.method, \"returned: \" + JSON.stringify(msg.returnVal));\n    };\n\n    JobCollection.prototype._toLog = function (userId, method, message) {\n      var ref;\n      return (ref = this.logStream) != null ? ref.write(new Date() + \", \" + userId + \", \" + method + \", \" + message + \"\\n\") : void 0;\n    };\n\n    JobCollection.prototype._emit = function () {\n      var connection, err, method, params, ret, userId;\n      method = arguments[0], connection = arguments[1], userId = arguments[2], err = arguments[3], ret = arguments[4], params = 6 <= arguments.length ? slice.call(arguments, 5) : [];\n\n      if (err) {\n        return this.events.emit('error', {\n          error: err,\n          method: method,\n          connection: connection,\n          userId: userId,\n          params: params,\n          returnVal: null\n        });\n      } else {\n        return this.events.emit('call', {\n          error: null,\n          method: method,\n          connection: connection,\n          userId: userId,\n          params: params,\n          returnVal: ret\n        });\n      }\n    };\n\n    JobCollection.prototype._methodWrapper = function (method, func) {\n      var myTypeof, permitted, self;\n      self = this;\n\n      myTypeof = function (val) {\n        var type;\n        type = typeof val === \"undefined\" ? \"undefined\" : _typeof(val);\n\n        if (type === 'object' && type instanceof Array) {\n          type = 'array';\n        }\n\n        return type;\n      };\n\n      permitted = function (_this) {\n        return function (userId, params) {\n          var performAllTests, performTest;\n\n          performTest = function (tests) {\n            var i, len, result, test;\n            result = false;\n\n            for (i = 0, len = tests.length; i < len; i++) {\n              test = tests[i];\n\n              if (result === false) {\n                result = result || function () {\n                  switch (myTypeof(test)) {\n                    case 'array':\n                      return indexOf.call(test, userId) >= 0;\n\n                    case 'function':\n                      return test(userId, method, params);\n\n                    default:\n                      return false;\n                  }\n                }();\n              }\n            }\n\n            return result;\n          };\n\n          performAllTests = function (allTests) {\n            var i, len, ref, result, t;\n            result = false;\n            ref = _this.ddpMethodPermissions[method];\n\n            for (i = 0, len = ref.length; i < len; i++) {\n              t = ref[i];\n\n              if (result === false) {\n                result = result || performTest(allTests[t]);\n              }\n            }\n\n            return result;\n          };\n\n          return !performAllTests(_this.denys) && performAllTests(_this.allows);\n        };\n      }(this);\n\n      return function () {\n        var err, params, retval;\n        params = 1 <= arguments.length ? slice.call(arguments, 0) : [];\n\n        try {\n          if (!(this.connection && !permitted(this.userId, params))) {\n            retval = func.apply(null, params);\n          } else {\n            err = new Meteor.Error(403, \"Method not authorized\", \"Authenticated user is not permitted to invoke this method.\");\n            throw err;\n          }\n        } catch (error) {\n          err = error;\n\n          self._emit(method, this.connection, this.userId, err);\n\n          throw err;\n        }\n\n        self._emit.apply(self, [method, this.connection, this.userId, null, retval].concat(slice.call(params)));\n\n        return retval;\n      };\n    };\n\n    JobCollection.prototype.setLogStream = function (writeStream) {\n      if (writeStream == null) {\n        writeStream = null;\n      }\n\n      if (this.logStream) {\n        throw new Error(\"logStream may only be set once per job-collection startup/shutdown cycle\");\n      }\n\n      this.logStream = writeStream;\n\n      if (!(this.logStream == null || this.logStream.write != null && typeof this.logStream.write === 'function' && this.logStream.end != null && typeof this.logStream.end === 'function')) {\n        throw new Error(\"logStream must be a valid writable node.js Stream\");\n      }\n    };\n\n    JobCollection.prototype.allow = function (allowOptions) {\n      var func, results, type;\n      results = [];\n\n      for (type in meteorBabelHelpers.sanitizeForInObject(allowOptions)) {\n        func = allowOptions[type];\n\n        if (type in this.allows) {\n          results.push(this.allows[type].push(func));\n        }\n      }\n\n      return results;\n    };\n\n    JobCollection.prototype.deny = function (denyOptions) {\n      var func, results, type;\n      results = [];\n\n      for (type in meteorBabelHelpers.sanitizeForInObject(denyOptions)) {\n        func = denyOptions[type];\n\n        if (type in this.denys) {\n          results.push(this.denys[type].push(func));\n        }\n      }\n\n      return results;\n    };\n\n    JobCollection.prototype.scrub = function (job) {\n      return job;\n    };\n\n    JobCollection.prototype.promote = function (milliseconds) {\n      if (milliseconds == null) {\n        milliseconds = 15 * 1000;\n      }\n\n      if (typeof milliseconds === 'number' && milliseconds > 0) {\n        if (this.interval) {\n          Meteor.clearInterval(this.interval);\n        }\n\n        this._promote_jobs();\n\n        return this.interval = Meteor.setInterval(this._promote_jobs.bind(this), milliseconds);\n      } else {\n        return console.warn(\"jobCollection.promote: invalid timeout: \" + this.root + \", \" + milliseconds);\n      }\n    };\n\n    JobCollection.prototype._promote_jobs = function (ids) {\n      if (ids == null) {\n        ids = [];\n      }\n\n      if (this.stopped) {\n        return;\n      }\n\n      this.find({\n        status: 'running',\n        expiresAfter: {\n          $lt: new Date()\n        }\n      }).forEach(function (_this) {\n        return function (job) {\n          return new Job(_this.root, job).fail(\"Failed for exceeding worker set workTimeout\");\n        };\n      }(this));\n      return this.readyJobs();\n    };\n\n    return JobCollection;\n  }(share.JobCollectionBase);\n}","map":{"version":3,"sources":["packages/vsivsi:job-collection/src/server.coffee"],"names":["eventEmitter","userHelper","bind","fn","me","apply","arguments","extend","child","parent","key","hasProp","call","ctor","constructor","prototype","__super__","hasOwnProperty","slice","indexOf","item","i","l","length","Meteor","isServer","Npm","require","EventEmitter","user","connection","ret","JobCollection","superClass","root","options","foo","len","level","localMethods","methodFunction","methodName","ref","_emit","_toLog","_onCall","_onError","events","_errorListener","on","_methodErrorDispatch","_this","msg","emit","method","_callListener","_methodEventDispatch","stopped","share","JobCollectionBase","deny","update","insert","remove","promote","logStream","allows","denys","ddpPermissionLevels","concat","ddpMethods","_ensureIndex","type","status","priority","retryUntil","after","isSimulation","_generateMethods","_localServerMethods","_ddp_apply","name","params","cb","setTimeout","e","err","res","error","Job","_setDDPApply","methods","userId","JSON","stringify","returnVal","message","write","Date","_methodWrapper","func","myTypeof","permitted","self","val","Array","performAllTests","performTest","tests","result","test","allTests","t","ddpMethodPermissions","retval","Error","setLogStream","writeStream","end","allow","allowOptions","results","push","denyOptions","scrub","job","milliseconds","interval","clearInterval","_promote_jobs","setInterval","console","warn","ids","find","expiresAfter","$lt","forEach","fail","readyJobs"],"mappings":"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","file":"packages/vsivsi:job-collection/src/server.coffee.map","sourcesContent":["var eventEmitter, userHelper,               \n  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },\n  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },\n  hasProp = {}.hasOwnProperty,\n  slice = [].slice,\n  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };\n\nif (Meteor.isServer) {\n  eventEmitter = Npm.require('events').EventEmitter;\n  userHelper = function(user, connection) {\n    var ret;\n    ret = user != null ? user : \"[UNAUTHENTICATED]\";\n    if (!connection) {\n      ret = \"[SERVER]\";\n    }\n    return ret;\n  };\n  JobCollection = (function(superClass) {\n    extend(JobCollection, superClass);\n\n    function JobCollection(root, options) {\n      var foo, i, len, level, localMethods, methodFunction, methodName, ref;\n      if (root == null) {\n        root = 'queue';\n      }\n      if (options == null) {\n        options = {};\n      }\n      this._emit = bind(this._emit, this);\n      this._toLog = bind(this._toLog, this);\n      this._onCall = bind(this._onCall, this);\n      this._onError = bind(this._onError, this);\n      if (!(this instanceof JobCollection)) {\n        return new JobCollection(root, options);\n      }\n      JobCollection.__super__.constructor.call(this, root, options);\n      this.events = new eventEmitter();\n      this._errorListener = this.events.on('error', this._onError);\n      this._methodErrorDispatch = this.events.on('error', (function(_this) {\n        return function(msg) {\n          return _this.events.emit(msg.method, msg);\n        };\n      })(this));\n      this._callListener = this.events.on('call', this._onCall);\n      this._methodEventDispatch = this.events.on('call', (function(_this) {\n        return function(msg) {\n          return _this.events.emit(msg.method, msg);\n        };\n      })(this));\n      this.stopped = true;\n      share.JobCollectionBase.__super__.deny.bind(this)({\n        update: (function(_this) {\n          return function() {\n            return true;\n          };\n        })(this),\n        insert: (function(_this) {\n          return function() {\n            return true;\n          };\n        })(this),\n        remove: (function(_this) {\n          return function() {\n            return true;\n          };\n        })(this)\n      });\n      this.promote();\n      this.logStream = null;\n      this.allows = {};\n      this.denys = {};\n      ref = this.ddpPermissionLevels.concat(this.ddpMethods);\n      for (i = 0, len = ref.length; i < len; i++) {\n        level = ref[i];\n        this.allows[level] = [];\n        this.denys[level] = [];\n      }\n      if (options.connection == null) {\n        this._ensureIndex({\n          type: 1,\n          status: 1\n        });\n        this._ensureIndex({\n          priority: 1,\n          retryUntil: 1,\n          after: 1\n        });\n        this.isSimulation = false;\n        localMethods = this._generateMethods();\n        if (this._localServerMethods == null) {\n          this._localServerMethods = {};\n        }\n        for (methodName in localMethods) {\n          methodFunction = localMethods[methodName];\n          this._localServerMethods[methodName] = methodFunction;\n        }\n        foo = this;\n        this._ddp_apply = (function(_this) {\n          return function(name, params, cb) {\n            if (cb != null) {\n              return Meteor.setTimeout((function() {\n                var e, err, res;\n                err = null;\n                res = null;\n                try {\n                  res = _this._localServerMethods[name].apply(_this, params);\n                } catch (error) {\n                  e = error;\n                  err = e;\n                }\n                return cb(err, res);\n              }), 0);\n            } else {\n              return _this._localServerMethods[name].apply(_this, params);\n            }\n          };\n        })(this);\n        Job._setDDPApply(this._ddp_apply, root);\n        Meteor.methods(localMethods);\n      }\n    }\n\n    JobCollection.prototype._onError = function(msg) {\n      var user;\n      user = userHelper(msg.userId, msg.connection);\n      return this._toLog(user, msg.method, \"\" + msg.error);\n    };\n\n    JobCollection.prototype._onCall = function(msg) {\n      var user;\n      user = userHelper(msg.userId, msg.connection);\n      this._toLog(user, msg.method, \"params: \" + JSON.stringify(msg.params));\n      return this._toLog(user, msg.method, \"returned: \" + JSON.stringify(msg.returnVal));\n    };\n\n    JobCollection.prototype._toLog = function(userId, method, message) {\n      var ref;\n      return (ref = this.logStream) != null ? ref.write((new Date()) + \", \" + userId + \", \" + method + \", \" + message + \"\\n\") : void 0;\n    };\n\n    JobCollection.prototype._emit = function() {\n      var connection, err, method, params, ret, userId;\n      method = arguments[0], connection = arguments[1], userId = arguments[2], err = arguments[3], ret = arguments[4], params = 6 <= arguments.length ? slice.call(arguments, 5) : [];\n      if (err) {\n        return this.events.emit('error', {\n          error: err,\n          method: method,\n          connection: connection,\n          userId: userId,\n          params: params,\n          returnVal: null\n        });\n      } else {\n        return this.events.emit('call', {\n          error: null,\n          method: method,\n          connection: connection,\n          userId: userId,\n          params: params,\n          returnVal: ret\n        });\n      }\n    };\n\n    JobCollection.prototype._methodWrapper = function(method, func) {\n      var myTypeof, permitted, self;\n      self = this;\n      myTypeof = function(val) {\n        var type;\n        type = typeof val;\n        if (type === 'object' && type instanceof Array) {\n          type = 'array';\n        }\n        return type;\n      };\n      permitted = (function(_this) {\n        return function(userId, params) {\n          var performAllTests, performTest;\n          performTest = function(tests) {\n            var i, len, result, test;\n            result = false;\n            for (i = 0, len = tests.length; i < len; i++) {\n              test = tests[i];\n              if (result === false) {\n                result = result || (function() {\n                  switch (myTypeof(test)) {\n                    case 'array':\n                      return indexOf.call(test, userId) >= 0;\n                    case 'function':\n                      return test(userId, method, params);\n                    default:\n                      return false;\n                  }\n                })();\n              }\n            }\n            return result;\n          };\n          performAllTests = function(allTests) {\n            var i, len, ref, result, t;\n            result = false;\n            ref = _this.ddpMethodPermissions[method];\n            for (i = 0, len = ref.length; i < len; i++) {\n              t = ref[i];\n              if (result === false) {\n                result = result || performTest(allTests[t]);\n              }\n            }\n            return result;\n          };\n          return !performAllTests(_this.denys) && performAllTests(_this.allows);\n        };\n      })(this);\n      return function() {\n        var err, params, retval;\n        params = 1 <= arguments.length ? slice.call(arguments, 0) : [];\n        try {\n          if (!(this.connection && !permitted(this.userId, params))) {\n            retval = func.apply(null, params);\n          } else {\n            err = new Meteor.Error(403, \"Method not authorized\", \"Authenticated user is not permitted to invoke this method.\");\n            throw err;\n          }\n        } catch (error) {\n          err = error;\n          self._emit(method, this.connection, this.userId, err);\n          throw err;\n        }\n        self._emit.apply(self, [method, this.connection, this.userId, null, retval].concat(slice.call(params)));\n        return retval;\n      };\n    };\n\n    JobCollection.prototype.setLogStream = function(writeStream) {\n      if (writeStream == null) {\n        writeStream = null;\n      }\n      if (this.logStream) {\n        throw new Error(\"logStream may only be set once per job-collection startup/shutdown cycle\");\n      }\n      this.logStream = writeStream;\n      if (!((this.logStream == null) || (this.logStream.write != null) && typeof this.logStream.write === 'function' && (this.logStream.end != null) && typeof this.logStream.end === 'function')) {\n        throw new Error(\"logStream must be a valid writable node.js Stream\");\n      }\n    };\n\n    JobCollection.prototype.allow = function(allowOptions) {\n      var func, results, type;\n      results = [];\n      for (type in allowOptions) {\n        func = allowOptions[type];\n        if (type in this.allows) {\n          results.push(this.allows[type].push(func));\n        }\n      }\n      return results;\n    };\n\n    JobCollection.prototype.deny = function(denyOptions) {\n      var func, results, type;\n      results = [];\n      for (type in denyOptions) {\n        func = denyOptions[type];\n        if (type in this.denys) {\n          results.push(this.denys[type].push(func));\n        }\n      }\n      return results;\n    };\n\n    JobCollection.prototype.scrub = function(job) {\n      return job;\n    };\n\n    JobCollection.prototype.promote = function(milliseconds) {\n      if (milliseconds == null) {\n        milliseconds = 15 * 1000;\n      }\n      if (typeof milliseconds === 'number' && milliseconds > 0) {\n        if (this.interval) {\n          Meteor.clearInterval(this.interval);\n        }\n        this._promote_jobs();\n        return this.interval = Meteor.setInterval(this._promote_jobs.bind(this), milliseconds);\n      } else {\n        return console.warn(\"jobCollection.promote: invalid timeout: \" + this.root + \", \" + milliseconds);\n      }\n    };\n\n    JobCollection.prototype._promote_jobs = function(ids) {\n      if (ids == null) {\n        ids = [];\n      }\n      if (this.stopped) {\n        return;\n      }\n      this.find({\n        status: 'running',\n        expiresAfter: {\n          $lt: new Date()\n        }\n      }).forEach((function(_this) {\n        return function(job) {\n          return new Job(_this.root, job).fail(\"Failed for exceeding worker set workTimeout\");\n        };\n      })(this));\n      return this.readyJobs();\n    };\n\n    return JobCollection;\n\n  })(share.JobCollectionBase);\n}\n"]},"hash":"9dc65372833079245c075b1ec84af8fc45f6518b"}

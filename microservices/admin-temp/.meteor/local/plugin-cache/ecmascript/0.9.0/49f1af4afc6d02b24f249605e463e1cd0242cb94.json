{"metadata":{"usedHelpers":["classCallCheck","extends","interopRequireDefault"],"marked":[],"modules":{"imports":[{"source":"meteor/meteor","imported":["Meteor"],"specifiers":[{"kind":"named","imported":"Meteor","local":"Meteor"}]},{"source":"moment","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"moment"}]},{"source":"../loans","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Loans"}]},{"source":"../constants","imported":["LOAN_STATUS","AUCTION_STATUS"],"specifiers":[{"kind":"named","imported":"LOAN_STATUS","local":"LOAN_STATUS"},{"kind":"named","imported":"AUCTION_STATUS","local":"AUCTION_STATUS"}]},{"source":"../../utils/loanFunctions","imported":["getAuctionEndTime"],"specifiers":[{"kind":"named","imported":"getAuctionEndTime","local":"getAuctionEndTime"}]}],"exports":{"exported":["LoanServiceModel"],"specifiers":[{"kind":"local","local":"LoanServiceModel","exported":"LoanServiceModel"}]}}},"options":{"filename":"imports/core/api/loans/LoanService.js","filenameRelative":"imports/core/api/loans/LoanService.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"useNativeAsyncAwait":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"imports/core/api/loans/LoanService.js.map","sourceFileName":"imports/core/api/loans/LoanService.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"LoanService"},"ignored":false,"code":"\"use strict\";\n\nvar _extends2 = require(\"babel-runtime/helpers/extends\");\n\nvar _extends3 = _interopRequireDefault(_extends2);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nmodule.export({\n  LoanServiceModel: function LoanServiceModel() {\n    return _LoanServiceModel;\n  }\n});\n\nvar _Meteor = void 0;\n\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function Meteor(v) {\n    _Meteor = v;\n  }\n}, 0);\nvar moment = void 0;\nmodule.watch(require(\"moment\"), {\n  default: function _default(v) {\n    moment = v;\n  }\n}, 1);\nvar Loans = void 0;\nmodule.watch(require(\"../loans\"), {\n  default: function _default(v) {\n    Loans = v;\n  }\n}, 2);\n\nvar _LOAN_STATUS = void 0,\n    _AUCTION_STATUS = void 0;\n\nmodule.watch(require(\"../constants\"), {\n  LOAN_STATUS: function LOAN_STATUS(v) {\n    _LOAN_STATUS = v;\n  },\n  AUCTION_STATUS: function AUCTION_STATUS(v) {\n    _AUCTION_STATUS = v;\n  }\n}, 3);\n\nvar _getAuctionEndTime = void 0;\n\nmodule.watch(require(\"../../utils/loanFunctions\"), {\n  getAuctionEndTime: function getAuctionEndTime(v) {\n    _getAuctionEndTime = v;\n  }\n}, 4);\n\nvar _LoanServiceModel = function _LoanServiceModel() {\n  var _this = this;\n\n  (0, _classCallCheck3.default)(this, _LoanServiceModel);\n\n  this.insert = function (_ref) {\n    var object = _ref.object,\n        userId = _ref.userId;\n    return Loans.insert((0, _extends3.default)({}, object, {\n      // Do this to allow userId to be null\n      userId: userId === undefined ? _Meteor.userId() : userId\n    }));\n  };\n\n  this.update = function (_ref2) {\n    var loanId = _ref2.loanId,\n        object = _ref2.object;\n    return Loans.update(loanId, {\n      $set: object\n    });\n  };\n\n  this.remove = function (_ref3) {\n    var loanId = _ref3.loanId;\n    return Loans.remove(loanId);\n  };\n\n  this.incrementStep = function (_ref4) {\n    var loanId = _ref4.loanId;\n    return Loans.update(loanId, {\n      $inc: {\n        'logic.step': 1\n      }\n    });\n  };\n\n  this.askVerification = function (_ref5) {\n    var loanId = _ref5.loanId;\n    var loan = Loans.findOne(loanId);\n\n    if (loan.logic.verification.requested) {\n      // Don't do anything if this loan is already in requested mode\n      return false;\n    }\n\n    return Loans.update(loanId, {\n      $set: {\n        'logic.verification.requested': true,\n        'logic.verification.requestedTime': new Date()\n      }\n    });\n  };\n\n  this.startAuction = function (_ref6) {\n    var loanId = _ref6.loanId;\n    var loan = Loans.findOne(loanId);\n\n    if (loan.logic.auction.status !== _AUCTION_STATUS.NONE) {\n      // Don't do anything if this auction has already started or ended\n      return false;\n    }\n\n    return Loans.update(loanId, {\n      $set: {\n        'logic.auction.status': _AUCTION_STATUS.STARTED,\n        'logic.auction.startTime': moment().toDate(),\n        'logic.auction.endTime': _getAuctionEndTime(moment())\n      }\n    });\n  };\n\n  this.endAuction = function (_ref7) {\n    var loanId = _ref7.loanId;\n    var loan = Loans.findOne(loanId); // This method is called in the future (through a job),\n    // so only call this if the auction is ongoing\n\n    if (!loan || loan.logic.auction.status !== _AUCTION_STATUS.STARTED) {\n      return false;\n    }\n\n    return Loans.update(id, {\n      $set: {\n        'logic.auction.status': _AUCTION_STATUS.ENDED,\n        'logic.auction.endTime': new Date()\n      }\n    });\n  };\n\n  this.cancelAuction = function (_ref8) {\n    var loanId = _ref8.loanId;\n    return _this.update(loanId, {\n      $set: {\n        'logic.auction.endTime': undefined,\n        'logic.auction.status': '',\n        'logic.auction.startTime': undefined\n      }\n    });\n  };\n\n  this.confirmClosing = function (_ref9) {\n    var loanId = _ref9.loanId,\n        object = _ref9.object;\n    return Loans.update(loanId, {\n      $set: (0, _extends3.default)({\n        status: _LOAN_STATUS.DONE\n      }, object)\n    });\n  };\n} // TODO: make sure step is really done\n;\n\nvar LoanService = new _LoanServiceModel({});\nmodule.exportDefault(LoanService);","map":{"version":3,"sources":["imports/core/api/loans/LoanService.js"],"names":["module","export","LoanServiceModel","Meteor","watch","require","v","moment","default","Loans","LOAN_STATUS","AUCTION_STATUS","getAuctionEndTime","insert","object","userId","undefined","update","loanId","$set","remove","incrementStep","$inc","askVerification","loan","findOne","logic","verification","requested","Date","startAuction","auction","status","NONE","STARTED","toDate","endAuction","id","ENDED","cancelAuction","confirmClosing","DONE","LoanService","exportDefault"],"mappings":"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","file":"imports/core/api/loans/LoanService.js.map","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport moment from 'moment';\nimport Loans from '../loans';\n\nimport { LOAN_STATUS, AUCTION_STATUS } from '../constants';\nimport { getAuctionEndTime } from '../../utils/loanFunctions';\n\nclass LoanServiceModel {\n  insert = ({ object, userId }) =>\n    Loans.insert({\n      ...object,\n      // Do this to allow userId to be null\n      userId: userId === undefined ? Meteor.userId() : userId,\n    });\n\n  update = ({ loanId, object }) => Loans.update(loanId, { $set: object });\n\n  remove = ({ loanId }) => Loans.remove(loanId);\n\n  // TODO: make sure step is really done\n  incrementStep = ({ loanId }) =>\n    Loans.update(loanId, { $inc: { 'logic.step': 1 } });\n\n  askVerification = ({ loanId }) => {\n    const loan = Loans.findOne(loanId);\n\n    if (loan.logic.verification.requested) {\n      // Don't do anything if this loan is already in requested mode\n      return false;\n    }\n\n    return Loans.update(loanId, {\n      $set: {\n        'logic.verification.requested': true,\n        'logic.verification.requestedTime': new Date(),\n      },\n    });\n  };\n\n  startAuction = ({ loanId }) => {\n    const loan = Loans.findOne(loanId);\n\n    if (loan.logic.auction.status !== AUCTION_STATUS.NONE) {\n      // Don't do anything if this auction has already started or ended\n      return false;\n    }\n\n    return Loans.update(loanId, {\n      $set: {\n        'logic.auction.status': AUCTION_STATUS.STARTED,\n        'logic.auction.startTime': moment().toDate(),\n        'logic.auction.endTime': getAuctionEndTime(moment()),\n      },\n    });\n  };\n\n  endAuction = ({ loanId }) => {\n    const loan = Loans.findOne(loanId);\n\n    // This method is called in the future (through a job),\n    // so only call this if the auction is ongoing\n    if (!loan || loan.logic.auction.status !== AUCTION_STATUS.STARTED) {\n      return false;\n    }\n\n    return Loans.update(id, {\n      $set: {\n        'logic.auction.status': AUCTION_STATUS.ENDED,\n        'logic.auction.endTime': new Date(),\n      },\n    });\n  };\n\n  cancelAuction = ({ loanId }) =>\n    this.update(loanId, {\n      $set: {\n        'logic.auction.endTime': undefined,\n        'logic.auction.status': '',\n        'logic.auction.startTime': undefined,\n      },\n    });\n\n  confirmClosing = ({ loanId, object }) =>\n    Loans.update(loanId, {\n      $set: {\n        status: LOAN_STATUS.DONE,\n        ...object,\n      },\n    });\n}\n\nconst LoanService = new LoanServiceModel({});\n\nexport { LoanServiceModel };\nexport default LoanService;\n"]},"hash":"49f1af4afc6d02b24f249605e463e1cd0242cb94"}

{"metadata":{"usedHelpers":["extends","interopRequireDefault"],"marked":[],"modules":{"imports":[{"source":"meteor/meteor","imported":["Meteor"],"specifiers":[{"kind":"named","imported":"Meteor","local":"Meteor"}]},{"source":"meteor/mdg:validated-method","imported":["ValidatedMethod"],"specifiers":[{"kind":"named","imported":"ValidatedMethod","local":"ValidatedMethod"}]},{"source":"meteor/alanning:roles","imported":["Roles"],"specifiers":[{"kind":"named","imported":"Roles","local":"Roles"}]},{"source":"meteor/check","imported":["check","Match"],"specifiers":[{"kind":"named","imported":"check","local":"check"},{"kind":"named","imported":"Match","local":"Match"}]},{"source":"meteor/didericis:callpromise-mixin","imported":["CallPromiseMixin"],"specifiers":[{"kind":"named","imported":"CallPromiseMixin","local":"CallPromiseMixin"}]},{"source":"../../../utils/rate-limit.js","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"rateLimit"}]},{"source":"../../loans","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Loans"}]},{"source":"../offers","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Offers"}]}],"exports":{"exported":["insertOffer","insertAdminOffer","updateOffer","insertFakeOffer","deleteOffer"],"specifiers":[{"kind":"local","local":"insertOffer","exported":"insertOffer"},{"kind":"local","local":"insertAdminOffer","exported":"insertAdminOffer"},{"kind":"local","local":"updateOffer","exported":"updateOffer"},{"kind":"local","local":"insertFakeOffer","exported":"insertFakeOffer"},{"kind":"local","local":"deleteOffer","exported":"deleteOffer"}]}}},"options":{"filename":"imports/core/api/offers/server/methods.js","filenameRelative":"imports/core/api/offers/server/methods.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"useNativeAsyncAwait":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"imports/core/api/offers/server/methods.js.map","sourceFileName":"imports/core/api/offers/server/methods.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"methods"},"ignored":false,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.insertOffer = undefined;\n\nvar _extends2 = require(\"babel-runtime/helpers/extends\");\n\nvar _extends3 = _interopRequireDefault(_extends2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nmodule.export({\n  insertOffer: function insertOffer() {\n    return _insertOffer;\n  },\n  insertAdminOffer: function insertAdminOffer() {\n    return _insertAdminOffer;\n  },\n  updateOffer: function updateOffer() {\n    return _updateOffer;\n  },\n  insertFakeOffer: function insertFakeOffer() {\n    return _insertFakeOffer;\n  },\n  deleteOffer: function deleteOffer() {\n    return _deleteOffer;\n  }\n});\n\nvar _Meteor = void 0;\n\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function Meteor(v) {\n    _Meteor = v;\n  }\n}, 0);\n\nvar _ValidatedMethod = void 0;\n\nmodule.watch(require(\"meteor/mdg:validated-method\"), {\n  ValidatedMethod: function ValidatedMethod(v) {\n    _ValidatedMethod = v;\n  }\n}, 1);\n\nvar _Roles = void 0;\n\nmodule.watch(require(\"meteor/alanning:roles\"), {\n  Roles: function Roles(v) {\n    _Roles = v;\n  }\n}, 2);\n\nvar _check = void 0,\n    _Match = void 0;\n\nmodule.watch(require(\"meteor/check\"), {\n  check: function check(v) {\n    _check = v;\n  },\n  Match: function Match(v) {\n    _Match = v;\n  }\n}, 3);\nexports.insertOffer = _insertOffer;\n\nvar _CallPromiseMixin = void 0;\n\nmodule.watch(require(\"meteor/didericis:callpromise-mixin\"), {\n  CallPromiseMixin: function CallPromiseMixin(v) {\n    _CallPromiseMixin = v;\n  }\n}, 4);\nvar rateLimit = void 0;\nmodule.watch(require(\"../../../utils/rate-limit.js\"), {\n  default: function _default(v) {\n    rateLimit = v;\n  }\n}, 5);\nvar Loans = void 0;\nmodule.watch(require(\"../../loans\"), {\n  default: function _default(v) {\n    Loans = v;\n  }\n}, 6);\nvar Offers = void 0;\nmodule.watch(require(\"../offers\"), {\n  default: function _default(v) {\n    Offers = v;\n  }\n}, 7);\n\n// Insert a new offer\nvar _insertOffer = new _ValidatedMethod({\n  name: 'insertOffer',\n  mixins: [_CallPromiseMixin],\n  validate: function validate(_ref) {\n    var object = _ref.object,\n        userId = _ref.userId;\n\n    _check(object, Object);\n\n    _check(userId, _Match.Optional(String));\n  },\n  run: function run(_ref2) {\n    var object = _ref2.object,\n        userId = _ref2.userId;\n\n    // Make sure there isn't already an offer for this loan\n    var user = _Meteor.user();\n\n    var offer = Offers.findOne({\n      loanId: object.loanId,\n      organization: user.profile.organization\n    });\n\n    if (offer) {\n      throw new _Meteor.Error('noTwoOffers', 'Your organization has already made an offer on this loan');\n    }\n\n    var loan = Loans.findOne(object.loanId);\n    object.userId = userId || _Meteor.userId();\n    object.organization = user.profile.organization;\n    object.canton = user.profile.cantons[0];\n    object.auctionEndTime = loan.logic.auction.endTime;\n    return Offers.insert(object);\n  }\n});\n\nvar _insertAdminOffer = new _ValidatedMethod({\n  name: 'insertAdminOffer',\n  mixins: [_CallPromiseMixin],\n  validate: null,\n  run: function run(_ref3) {\n    var object = _ref3.object;\n\n    if (!(_Roles.userIsInRole(_Meteor.userId(), 'admin') || _Roles.userIsInRole(_Meteor.userId(), 'dev'))) {\n      return false;\n    }\n\n    var loan = Loans.findOne(object.loanId);\n    return Offers.insert((0, _extends3.default)({}, object, {\n      userId: _Meteor.userId(),\n      isAdmin: true,\n      auctionEndTime: loan.logic.auction.endTime,\n      // this doesn't update when the loan is ended prematurely by an admin\n      canton: 'GE'\n    }));\n  }\n});\n\nvar _updateOffer = new _ValidatedMethod({\n  name: 'updateOffer',\n  mixins: [_CallPromiseMixin],\n  validate: function validate(_ref4) {\n    var id = _ref4.id,\n        object = _ref4.object;\n\n    _check(id, String);\n\n    _check(object, Object);\n  },\n  run: function run(_ref5) {\n    var id = _ref5.id,\n        object = _ref5.object;\n    return Offers.update(id, {\n      $set: object\n    });\n  }\n});\n\nvar _insertFakeOffer = new _ValidatedMethod({\n  name: 'insertFakeOffer',\n  mixins: [_CallPromiseMixin],\n  validate: null,\n  run: function run(_ref6) {\n    var object = _ref6.object;\n    return Offers.insert((0, _extends3.default)({}, object, {\n      userId: _Meteor.userId()\n    }));\n  }\n});\n\nvar _deleteOffer = new _ValidatedMethod({\n  name: 'deleteOffer',\n  mixins: [_CallPromiseMixin],\n  validate: function validate() {},\n  run: function run(_ref7) {\n    var id = _ref7.id;\n\n    if (_Roles.userIsInRole(_Meteor.userId(), 'dev') || _Roles.userIsInRole(_Meteor.userId(), 'admin')) {\n      return Offers.remove(id);\n    }\n\n    return false;\n  }\n});\n\nrateLimit({\n  methods: [_insertOffer, _insertAdminOffer, _updateOffer, _insertFakeOffer]\n});","map":{"version":3,"sources":["imports/core/api/offers/server/methods.js"],"names":["module","export","insertOffer","insertAdminOffer","updateOffer","insertFakeOffer","deleteOffer","Meteor","watch","require","v","ValidatedMethod","Roles","check","Match","CallPromiseMixin","rateLimit","default","Loans","Offers","name","mixins","validate","object","userId","Object","Optional","String","run","user","offer","findOne","loanId","organization","profile","Error","loan","canton","cantons","auctionEndTime","logic","auction","endTime","insert","userIsInRole","isAdmin","id","update","$set","remove","methods"],"mappings":"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","file":"imports/core/api/offers/server/methods.js.map","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { ValidatedMethod } from 'meteor/mdg:validated-method';\nimport { Roles } from 'meteor/alanning:roles';\nimport { check, Match } from 'meteor/check';\nimport { CallPromiseMixin } from 'meteor/didericis:callpromise-mixin';\nimport rateLimit from '../../../utils/rate-limit.js';\n\nimport Loans from '../../loans';\nimport Offers from '../offers';\n\n// Insert a new offer\nexport const insertOffer = new ValidatedMethod({\n  name: 'insertOffer',\n  mixins: [CallPromiseMixin],\n  validate({ object, userId }) {\n    check(object, Object);\n    check(userId, Match.Optional(String));\n  },\n  run({ object, userId }) {\n    // Make sure there isn't already an offer for this loan\n    const user = Meteor.user();\n    const offer = Offers.findOne({\n      loanId: object.loanId,\n      organization: user.profile.organization,\n    });\n    if (offer) {\n      throw new Meteor.Error(\n        'noTwoOffers',\n        'Your organization has already made an offer on this loan',\n      );\n    }\n\n    const loan = Loans.findOne(object.loanId);\n\n    object.userId = userId || Meteor.userId();\n    object.organization = user.profile.organization;\n    object.canton = user.profile.cantons[0];\n    object.auctionEndTime = loan.logic.auction.endTime;\n\n    return Offers.insert(object);\n  },\n});\n\nexport const insertAdminOffer = new ValidatedMethod({\n  name: 'insertAdminOffer',\n  mixins: [CallPromiseMixin],\n  validate: null,\n  run({ object }) {\n    if (\n      !(\n        Roles.userIsInRole(Meteor.userId(), 'admin') ||\n        Roles.userIsInRole(Meteor.userId(), 'dev')\n      )\n    ) {\n      return false;\n    }\n\n    const loan = Loans.findOne(object.loanId);\n\n    return Offers.insert({\n      ...object,\n      userId: Meteor.userId(),\n      isAdmin: true,\n      auctionEndTime: loan.logic.auction.endTime, // this doesn't update when the loan is ended prematurely by an admin\n      canton: 'GE',\n    });\n  },\n});\n\nexport const updateOffer = new ValidatedMethod({\n  name: 'updateOffer',\n  mixins: [CallPromiseMixin],\n  validate({ id, object }) {\n    check(id, String);\n    check(object, Object);\n  },\n  run({ id, object }) {\n    return Offers.update(id, { $set: object });\n  },\n});\n\nexport const insertFakeOffer = new ValidatedMethod({\n  name: 'insertFakeOffer',\n  mixins: [CallPromiseMixin],\n  validate: null,\n  run({ object }) {\n    return Offers.insert({ ...object, userId: Meteor.userId() });\n  },\n});\n\nexport const deleteOffer = new ValidatedMethod({\n  name: 'deleteOffer',\n  mixins: [CallPromiseMixin],\n  validate() {},\n  run({ id }) {\n    if (\n      Roles.userIsInRole(Meteor.userId(), 'dev') ||\n      Roles.userIsInRole(Meteor.userId(), 'admin')\n    ) {\n      return Offers.remove(id);\n    }\n\n    return false;\n  },\n});\n\nrateLimit({\n  methods: [\n    insertOffer,\n    insertAdminOffer,\n    updateOffer,\n    insertFakeOffer,\n    // deleteOffer,\n  ],\n});\n"]},"hash":"cafaa5c99cf51c276953bc56703af4f8c7be55e3"}

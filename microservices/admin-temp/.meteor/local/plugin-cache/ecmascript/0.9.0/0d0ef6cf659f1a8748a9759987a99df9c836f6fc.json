{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[{"source":"meteor/meteor","imported":["Meteor"],"specifiers":[{"kind":"named","imported":"Meteor","local":"Meteor"}]},{"source":"meteor/alanning:roles","imported":["Roles"],"specifiers":[{"kind":"named","imported":"Roles","local":"Roles"}]},{"source":"meteor/check","imported":["check"],"specifiers":[{"kind":"named","imported":"check","local":"check"}]},{"source":"meteor/mdg:validated-method","imported":["ValidatedMethod"],"specifiers":[{"kind":"named","imported":"ValidatedMethod","local":"ValidatedMethod"}]},{"source":"../../loans/loans","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Loans"}]},{"source":"../../borrowers/borrowers","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Borrowers"}]},{"source":"../../../utils/generate-pdf","imported":["generateComponentAsPDF"],"specifiers":[{"kind":"named","imported":"generateComponentAsPDF","local":"generateComponentAsPDF"}]},{"source":"../../loans/pdf.js","imported":["LoanPDF","AnonymousLoanPDF"],"specifiers":[{"kind":"named","imported":"LoanPDF","local":"LoanPDF"},{"kind":"named","imported":"AnonymousLoanPDF","local":"AnonymousLoanPDF"}]},{"source":"../../../utils/rate-limit.js","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"rateLimit"}]}],"exports":{"exported":["downloadPDF"],"specifiers":[{"kind":"local","local":"downloadPDF","exported":"downloadPDF"}]}}},"options":{"filename":"imports/core/api/methods/server/miscellaneous.js","filenameRelative":"imports/core/api/methods/server/miscellaneous.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"useNativeAsyncAwait":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"imports/core/api/methods/server/miscellaneous.js.map","sourceFileName":"imports/core/api/methods/server/miscellaneous.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"miscellaneous"},"ignored":false,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nmodule.export({\n  downloadPDF: function downloadPDF() {\n    return _downloadPDF;\n  }\n});\n\nvar _Meteor = void 0;\n\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function Meteor(v) {\n    _Meteor = v;\n  }\n}, 0);\n\nvar _Roles = void 0;\n\nmodule.watch(require(\"meteor/alanning:roles\"), {\n  Roles: function Roles(v) {\n    _Roles = v;\n  }\n}, 1);\n\nvar _check = void 0;\n\nmodule.watch(require(\"meteor/check\"), {\n  check: function check(v) {\n    _check = v;\n  }\n}, 2);\n\nvar _ValidatedMethod = void 0;\n\nmodule.watch(require(\"meteor/mdg:validated-method\"), {\n  ValidatedMethod: function ValidatedMethod(v) {\n    _ValidatedMethod = v;\n  }\n}, 3);\nvar Loans = void 0;\nmodule.watch(require(\"../../loans/loans\"), {\n  default: function _default(v) {\n    Loans = v;\n  }\n}, 4);\nexports.downloadPDF = _downloadPDF;\nvar Borrowers = void 0;\nmodule.watch(require(\"../../borrowers/borrowers\"), {\n  default: function _default(v) {\n    Borrowers = v;\n  }\n}, 5);\n\nvar _generateComponentAsPDF = void 0;\n\nmodule.watch(require(\"../../../utils/generate-pdf\"), {\n  generateComponentAsPDF: function generateComponentAsPDF(v) {\n    _generateComponentAsPDF = v;\n  }\n}, 6);\n\nvar _LoanPDF = void 0,\n    _AnonymousLoanPDF = void 0;\n\nmodule.watch(require(\"../../loans/pdf.js\"), {\n  LoanPDF: function LoanPDF(v) {\n    _LoanPDF = v;\n  },\n  AnonymousLoanPDF: function AnonymousLoanPDF(v) {\n    _AnonymousLoanPDF = v;\n  }\n}, 7);\nvar rateLimit = void 0;\nmodule.watch(require(\"../../../utils/rate-limit.js\"), {\n  default: function _default(v) {\n    rateLimit = v;\n  }\n}, 8);\n\n_Meteor.methods({\n  getServerTime: function getServerTime() {\n    return new Date();\n  },\n  getMixpanelAuthorization: function getMixpanelAuthorization() {\n    if (_Roles.userIsInRole(_Meteor.userId(), 'dev') || _Roles.userIsInRole(_Meteor.userId(), 'admin')) {\n      var btoa = require('btoa');\n\n      var API_KEY = _Meteor.settings.MIXPANEL_API_KEY;\n      var API_SECRET = _Meteor.settings.MIXPANEL_API_SECRET;\n      return \"Basic \" + btoa(API_SECRET + \":\" + API_KEY);\n    }\n\n    throw new _Meteor.Error('Unauthorized access to getMixpanelAuthorization');\n  }\n});\n\nvar _downloadPDF = new _ValidatedMethod({\n  name: 'downloadPDF',\n  validate: function validate(_ref) {\n    var loanId = _ref.loanId,\n        type = _ref.type;\n\n    _check(loanId, String);\n\n    _check(type, String);\n  },\n  run: function run(_ref2) {\n    var loanId = _ref2.loanId,\n        type = _ref2.type;\n    var loan = Loans.findOne(loanId);\n    var borrowers = Borrowers.find({\n      _id: {\n        $in: loan.borrowerIds\n      }\n    });\n    var prefix = type === 'anonymous' ? 'Anonyme' : 'Complet';\n    var fileName = prefix + \" \" + loan.propertyId.address1 + \".pdf\"; // If type is anonymous, loan the anonymous pdf\n\n    var component = type === 'anonymous' ? _AnonymousLoanPDF : _LoanPDF;\n    return _generateComponentAsPDF({\n      component: component,\n      props: {\n        loan: loan,\n        borrowers: borrowers\n      },\n      fileName: fileName\n    }).then(function (result) {\n      return result;\n    }).catch(function (error) {\n      throw new _Meteor.Error('500', error);\n    });\n  }\n});\n\nrateLimit({\n  methods: [_downloadPDF]\n});","map":{"version":3,"sources":["imports/core/api/methods/server/miscellaneous.js"],"names":["module","export","downloadPDF","Meteor","watch","require","v","Roles","check","ValidatedMethod","Loans","default","Borrowers","generateComponentAsPDF","LoanPDF","AnonymousLoanPDF","rateLimit","methods","getServerTime","Date","getMixpanelAuthorization","userIsInRole","userId","btoa","API_KEY","settings","MIXPANEL_API_KEY","API_SECRET","MIXPANEL_API_SECRET","Error","name","validate","loanId","type","String","run","loan","findOne","borrowers","find","_id","$in","borrowerIds","prefix","fileName","propertyId","address1","component","props","then","result","catch","error"],"mappings":"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","file":"imports/core/api/methods/server/miscellaneous.js.map","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport { Roles } from 'meteor/alanning:roles';\nimport { check } from 'meteor/check';\nimport { ValidatedMethod } from 'meteor/mdg:validated-method';\n\nimport Loans from '../../loans/loans';\nimport Borrowers from '../../borrowers/borrowers';\n\nimport { generateComponentAsPDF } from '../../../utils/generate-pdf';\nimport { LoanPDF, AnonymousLoanPDF } from '../../loans/pdf.js';\nimport rateLimit from '../../../utils/rate-limit.js';\n\nMeteor.methods({\n  getServerTime: () => new Date(),\n  getMixpanelAuthorization() {\n    if (\n      Roles.userIsInRole(Meteor.userId(), 'dev') ||\n      Roles.userIsInRole(Meteor.userId(), 'admin')\n    ) {\n      const btoa = require('btoa');\n\n      const API_KEY = Meteor.settings.MIXPANEL_API_KEY;\n      const API_SECRET = Meteor.settings.MIXPANEL_API_SECRET;\n\n      return `Basic ${btoa(`${API_SECRET}:${API_KEY}`)}`;\n    }\n\n    throw new Meteor.Error('Unauthorized access to getMixpanelAuthorization');\n  },\n});\n\nexport const downloadPDF = new ValidatedMethod({\n  name: 'downloadPDF',\n  validate({ loanId, type }) {\n    check(loanId, String);\n    check(type, String);\n  },\n  run({ loanId, type }) {\n    const loan = Loans.findOne(loanId);\n    const borrowers = Borrowers.find({ _id: { $in: loan.borrowerIds } });\n    const prefix = type === 'anonymous' ? 'Anonyme' : 'Complet';\n    const fileName = `${prefix} ${loan.propertyId.address1}.pdf`;\n\n    // If type is anonymous, loan the anonymous pdf\n    const component = type === 'anonymous' ? AnonymousLoanPDF : LoanPDF;\n\n    return generateComponentAsPDF({\n      component,\n      props: { loan, borrowers },\n      fileName,\n    })\n      .then(result => result)\n      .catch((error) => {\n        throw new Meteor.Error('500', error);\n      });\n  },\n});\n\nrateLimit({ methods: [downloadPDF] });\n"]},"hash":"0d0ef6cf659f1a8748a9759987a99df9c836f6fc"}

{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[{"source":"react","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"React"}]},{"source":"lodash/get","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"get"}]},{"source":"lodash/isArray","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"isArray"}]},{"source":"./BorrowerFormArray","imported":["getBorrowerInfoArray"],"specifiers":[{"kind":"named","imported":"getBorrowerInfoArray","local":"getBorrowerInfoArray"}]},{"source":"../api/files/files","imported":["borrowerFiles","loanFiles","propertyFiles"],"specifiers":[{"kind":"named","imported":"borrowerFiles","local":"borrowerFiles"},{"kind":"named","imported":"loanFiles","local":"loanFiles"},{"kind":"named","imported":"propertyFiles","local":"propertyFiles"}]},{"source":"./PropertyFormArray","imported":["getPropertyArray","getPropertyLoanArray"],"specifiers":[{"kind":"named","imported":"getPropertyArray","local":"getPropertyArray"},{"kind":"named","imported":"getPropertyLoanArray","local":"getPropertyLoanArray"}]},{"source":"../utils/loanFunctions","imported":["strategyDone","getPropertyCompletion"],"specifiers":[{"kind":"named","imported":"strategyDone","local":"strategyDone"},{"kind":"named","imported":"getPropertyCompletion","local":"getPropertyCompletion"}]},{"source":"../utils/general","imported":["arrayify"],"specifiers":[{"kind":"named","imported":"arrayify","local":"arrayify"}]},{"source":"../utils/browserFunctions","imported":["isDemo"],"specifiers":[{"kind":"named","imported":"isDemo","local":"isDemo"}]},{"source":"../api/constants","imported":["LOAN_STATUS","AUCTION_STATUS","FILE_STATUS","CLOSING_STEPS_STATUS","CLOSING_STEPS_TYPE"],"specifiers":[{"kind":"named","imported":"LOAN_STATUS","local":"LOAN_STATUS"},{"kind":"named","imported":"AUCTION_STATUS","local":"AUCTION_STATUS"},{"kind":"named","imported":"FILE_STATUS","local":"FILE_STATUS"},{"kind":"named","imported":"CLOSING_STEPS_STATUS","local":"CLOSING_STEPS_STATUS"},{"kind":"named","imported":"CLOSING_STEPS_TYPE","local":"CLOSING_STEPS_TYPE"}]}],"exports":{"exported":["previousDone","getPercent","shouldCountField","getCountedArray","personalInfoPercent","propertyPercent","auctionFilesPercent","filesPercent","getAllFilesPercent","closingPercent"],"specifiers":[{"kind":"local","local":"previousDone","exported":"previousDone"},{"kind":"local","local":"getPercent","exported":"getPercent"},{"kind":"local","local":"shouldCountField","exported":"shouldCountField"},{"kind":"local","local":"getCountedArray","exported":"getCountedArray"},{"kind":"local","local":"personalInfoPercent","exported":"personalInfoPercent"},{"kind":"local","local":"propertyPercent","exported":"propertyPercent"},{"kind":"local","local":"auctionFilesPercent","exported":"auctionFilesPercent"},{"kind":"local","local":"filesPercent","exported":"filesPercent"},{"kind":"local","local":"getAllFilesPercent","exported":"getAllFilesPercent"},{"kind":"local","local":"closingPercent","exported":"closingPercent"}]}}},"options":{"filename":"imports/core/arrays/steps.js","filenameRelative":"imports/core/arrays/steps.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"useNativeAsyncAwait":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"imports/core/arrays/steps.js.map","sourceFileName":"imports/core/arrays/steps.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"steps"},"ignored":false,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nfunction _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } else { return Array.from(arr); } }\n\nmodule.export({\n  previousDone: function previousDone() {\n    return _previousDone;\n  },\n  getPercent: function getPercent() {\n    return _getPercent;\n  },\n  shouldCountField: function shouldCountField() {\n    return _shouldCountField;\n  },\n  getCountedArray: function getCountedArray() {\n    return _getCountedArray;\n  },\n  personalInfoPercent: function personalInfoPercent() {\n    return _personalInfoPercent;\n  },\n  propertyPercent: function propertyPercent() {\n    return _propertyPercent;\n  },\n  auctionFilesPercent: function auctionFilesPercent() {\n    return _auctionFilesPercent;\n  },\n  filesPercent: function filesPercent() {\n    return _filesPercent;\n  },\n  getAllFilesPercent: function getAllFilesPercent() {\n    return _getAllFilesPercent;\n  },\n  closingPercent: function closingPercent() {\n    return _closingPercent;\n  }\n});\nvar React = void 0;\nmodule.watch(require(\"react\"), {\n  default: function _default(v) {\n    React = v;\n  }\n}, 0);\nvar get = void 0;\nmodule.watch(require(\"lodash/get\"), {\n  default: function _default(v) {\n    get = v;\n  }\n}, 1);\nvar isArray = void 0;\nmodule.watch(require(\"lodash/isArray\"), {\n  default: function _default(v) {\n    isArray = v;\n  }\n}, 2);\n\nvar _getBorrowerInfoArray = void 0;\n\nmodule.watch(require(\"./BorrowerFormArray\"), {\n  getBorrowerInfoArray: function getBorrowerInfoArray(v) {\n    _getBorrowerInfoArray = v;\n  }\n}, 3);\n\nvar _borrowerFiles = void 0,\n    _loanFiles = void 0,\n    _propertyFiles = void 0;\n\nmodule.watch(require(\"../api/files/files\"), {\n  borrowerFiles: function borrowerFiles(v) {\n    _borrowerFiles = v;\n  },\n  loanFiles: function loanFiles(v) {\n    _loanFiles = v;\n  },\n  propertyFiles: function propertyFiles(v) {\n    _propertyFiles = v;\n  }\n}, 4);\n\nvar _getPropertyArray = void 0,\n    _getPropertyLoanArray = void 0;\n\nmodule.watch(require(\"./PropertyFormArray\"), {\n  getPropertyArray: function getPropertyArray(v) {\n    _getPropertyArray = v;\n  },\n  getPropertyLoanArray: function getPropertyLoanArray(v) {\n    _getPropertyLoanArray = v;\n  }\n}, 5);\n\nvar _strategyDone = void 0,\n    _getPropertyCompletion = void 0;\n\nexports.previousDone = _previousDone;\nmodule.watch(require(\"../utils/loanFunctions\"), {\n  strategyDone: function strategyDone(v) {\n    _strategyDone = v;\n  },\n  getPropertyCompletion: function getPropertyCompletion(v) {\n    _getPropertyCompletion = v;\n  }\n}, 6);\n\nvar _arrayify = void 0;\n\nmodule.watch(require(\"../utils/general\"), {\n  arrayify: function arrayify(v) {\n    _arrayify = v;\n  }\n}, 7);\n\nvar _isDemo = void 0;\n\nmodule.watch(require(\"../utils/browserFunctions\"), {\n  isDemo: function isDemo(v) {\n    _isDemo = v;\n  }\n}, 8);\n\nvar _LOAN_STATUS = void 0,\n    _AUCTION_STATUS = void 0,\n    _FILE_STATUS = void 0,\n    _CLOSING_STEPS_STATUS = void 0,\n    _CLOSING_STEPS_TYPE = void 0;\n\nmodule.watch(require(\"../api/constants\"), {\n  LOAN_STATUS: function LOAN_STATUS(v) {\n    _LOAN_STATUS = v;\n  },\n  AUCTION_STATUS: function AUCTION_STATUS(v) {\n    _AUCTION_STATUS = v;\n  },\n  FILE_STATUS: function FILE_STATUS(v) {\n    _FILE_STATUS = v;\n  },\n  CLOSING_STEPS_STATUS: function CLOSING_STEPS_STATUS(v) {\n    _CLOSING_STEPS_STATUS = v;\n  },\n  CLOSING_STEPS_TYPE: function CLOSING_STEPS_TYPE(v) {\n    _CLOSING_STEPS_TYPE = v;\n  }\n}, 9);\n\nvar getSteps = function getSteps(props) {\n  var loan = props.loan,\n      borrowers = props.borrowers,\n      property = props.property,\n      serverTime = props.serverTime;\n  var steps = [{\n    nb: 0,\n    items: []\n  }, {\n    nb: 1,\n    items: [{\n      id: 'personal',\n      link: \"/loans/\" + loan._id + \"/borrowers/\" + borrowers[0]._id + \"/personal\",\n      percent: function percent() {\n        return _personalInfoPercent(borrowers);\n      },\n      isDone: function isDone() {\n        return this.percent() >= 1;\n      }\n    }, {\n      id: 'finance',\n      link: \"/loans/\" + loan._id + \"/borrowers/\" + borrowers[0]._id + \"/finance\",\n      isDone: function isDone() {\n        return borrowers.reduce(function (res, b) {\n          return res && b.logic.hasValidatedFinances;\n        }, true);\n      },\n      percent: function percent() {\n        return borrowers.reduce(function (res, b) {\n          return b.logic.hasValidatedFinances ? res + 1 : res;\n        }, 0) / borrowers.length;\n      }\n    }, {\n      id: 'files',\n      link: \"/loans/\" + loan._id + \"/borrowers/\" + borrowers[0]._id + \"/files\",\n      percent: function percent() {\n        return _filesPercent(borrowers, _borrowerFiles, 'auction');\n      },\n      isDone: function isDone() {\n        return this.percent() >= 1;\n      }\n    }, {\n      id: 'property',\n      link: \"/loans/\" + loan._id + \"/property\",\n      percent: function percent() {\n        return _getPropertyCompletion(props);\n      },\n      isDone: function isDone() {\n        return this.percent() >= 1;\n      }\n    }, {\n      id: 'verification',\n      link: \"/loans/\" + loan._id + \"/verification\",\n      waiting: function waiting() {\n        return loan.logic.verification.requested && !loan.logic.verification.validated;\n      },\n      isDone: function isDone() {\n        return loan.logic.verification.validated === true;\n      }\n    }]\n  }, {\n    nb: 2,\n    items: [{\n      id: 'structure',\n      link: \"/loans/\" + loan._id + \"/structure\",\n      isDone: function isDone() {\n        return loan.logic.hasValidatedStructure;\n      },\n      disabled: loan.logic.step < 2\n    }, {\n      id: 'auction',\n      link: \"/loans/\" + loan._id + \"/auction\",\n      waiting: function waiting() {\n        return loan.logic.auction.status === _AUCTION_STATUS.STARTED;\n      },\n      isDone: function isDone() {\n        return loan.logic.auction.status === _AUCTION_STATUS.ENDED;\n      },\n      disabled: loan.logic.step < 2\n    }, {\n      id: 'strategy',\n      link: \"/loans/\" + loan._id + \"/strategy\",\n      isDone: function isDone() {\n        return _strategyDone({\n          loan: loan\n        });\n      }\n    }, {\n      id: 'offerPicker',\n      link: \"/loans/\" + loan._id + \"/offerpicker\",\n      isDone: function isDone() {\n        return !!(loan.logic.lender && loan.logic.lender.offerId);\n      }\n    }]\n  }, {\n    nb: 3,\n    items: [{\n      id: 'contract',\n      link: \"/loans/\" + loan._id + \"/contract\",\n      disabled: loan.logic.step < 3 && !(loan.logic.lender && loan.logic.lender.offerId),\n      percent: function percent() {\n        return _getAllFilesPercent({\n          loan: loan,\n          borrowers: borrowers,\n          property: property\n        }, 'contract');\n      },\n      waiting: function waiting() {\n        return loan.logic.lender.contractRequested && !loan.logic.lender.contract;\n      },\n      isDone: function isDone() {\n        return loan.files.contract && loan.files.contract.length;\n      }\n    }, {\n      id: 'closing',\n      link: \"/loans/\" + loan._id + \"/closing\",\n      // FIXME: true && value used because of weird linting...\n      disabled: (true && _getAllFilesPercent({\n        loan: loan,\n        borrowers: borrowers,\n        property: property\n      }, 'contract')) < 1 || loan.logic.step < 3,\n      percent: function percent() {\n        return _closingPercent(loan);\n      },\n      isDone: function isDone() {\n        return loan.status === _LOAN_STATUS.DONE;\n      }\n    }]\n  }, {\n    nb: 4,\n    title: React.createElement(\"span\", {\n      className: \"fa fa-home fa-2x\",\n      style: {\n        color: '#ADB5BD',\n        paddingLeft: 8\n      }\n    }),\n    disabled: true,\n    // TODO\n    subtitle: null,\n    items: []\n  }]; // Make sure these indices correspond\n  // Verify all 3 items before item 4 are done\n\n  steps[1].items[4].disabled = !_previousDone(steps, 1, 4); // Vérification e-Potek\n  // steps[0].items[6].disabled = !previousDone(steps, 0, 6); // Expertise\n\n  steps[2].items[1].disabled = !_previousDone(steps, 2, 1); // Enchères\n\n  steps[2].items[2].disabled = !_previousDone(steps, 2, 2); // Stratégie\n\n  steps[2].items[3].disabled = !_previousDone(steps, 2, 3); // Choix du prêteur\n\n  return steps;\n};\n\nmodule.exportDefault(getSteps);\n\n// Returns the current value of an autoForm input\nvar getCurrentValue = function getCurrentValue(input, doc) {\n  return get(doc, input.id);\n}; /**\n    * previousDone - Checks if all previous subSteps have been finished upto this\n    * item\n    *\n    * @param {array} steps  An array of subSteps/items\n    * @param {number} stepNb The step Number\n    * @param {number} itemNb The number of the item that is concerned\n    *\n    * @return {boolean} Description\n    */\n\nvar _previousDone = function _previousDone(steps, stepNb, itemNb) {\n  if (stepNb >= steps.length) {\n    throw new Error('invalid stepNb');\n  } else if (itemNb >= steps[stepNb].items.length) {\n    throw new Error('invalid itemNb');\n  }\n\n  return steps[stepNb].items.slice(0, itemNb).reduce(function (res, i) {\n    return res && i.isDone();\n  }, true);\n}; /**\n    * getPercent - Given an array of values, any value that is undefined or null\n    * will be counted as incomplete, make sure we don't divide by 0\n    *\n    * @param {array} array Array of numbers, strings, or dates\n    *\n    * @return {number} a value between 0 and 1\n    */\n\nvar _getPercent = function _getPercent() {\n  var array = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n  var percent = array.reduce(function (tot, val) {\n    if (isArray(val)) {\n      return tot + (val.length ? 1 : 0);\n    } else if (val !== undefined && val !== null) {\n      return tot + 1;\n    }\n\n    return tot;\n  }, 0) / array.length;\n  return isFinite(percent) ? percent : 0;\n};\n\nvar _shouldCountField = function _shouldCountField(f) {\n  return (f.condition === undefined || f.condition === true) && f.required !== false && !f.disabled && f.type !== 'h3';\n};\n\nvar _getCountedArray = function _getCountedArray(formArray, doc) {\n  var arr = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  formArray.forEach(function (i) {\n    if (_shouldCountField(i)) {\n      if (i.type === 'conditionalInput') {\n        if (getCurrentValue(i.inputs[0], doc) === i.conditionalTrueValue) {\n          // If the conditional input is triggering the next input, add all values\n          i.inputs.forEach(function (input) {\n            return arr.push(getCurrentValue(input, doc));\n          });\n        } else {\n          // If conditional value is not triggering\n          arr.push(getCurrentValue(i.inputs[0], doc));\n        }\n      } else {\n        arr.push(getCurrentValue(i, doc));\n      }\n    }\n  });\n  return arr;\n};\n\nvar _personalInfoPercent = function _personalInfoPercent(borrowers) {\n  var a = [];\n\n  _arrayify(borrowers).forEach(function (b) {\n    var formArray = _getBorrowerInfoArray({\n      borrowers: _arrayify(borrowers),\n      borrowerId: b._id\n    });\n\n    _getCountedArray(formArray, b, a);\n  });\n\n  return _getPercent(a);\n};\n\nvar _propertyPercent = function _propertyPercent(loan, borrowers, property) {\n  var formArray1 = _getPropertyArray({\n    loan: loan,\n    borrowers: borrowers,\n    property: property\n  });\n\n  var formArray2 = _getPropertyLoanArray({\n    loan: loan,\n    borrowers: borrowers,\n    property: property\n  });\n\n  var a = _getCountedArray(formArray1, property);\n\n  a = [].concat(_toConsumableArray(a), [_getCountedArray(formArray2, loan)]);\n  return _getPercent(a);\n};\n\nvar _auctionFilesPercent = function _auctionFilesPercent(borrowers) {\n  var a = [];\n\n  _arrayify(borrowers).forEach(function (b) {\n    var fileArray = _borrowerFiles(b).auction;\n\n    if (_isDemo()) {\n      a.push(b.files[fileArray[0].id]);\n    } else {\n      fileArray.forEach(function (f) {\n        return f.condition !== false && a.push(b.files[f.id]);\n      });\n    }\n  });\n\n  return _getPercent(a);\n};\n\nvar _filesPercent = function _filesPercent(doc, fileArrayFunc, step, checkValidity) {\n  var a = [];\n\n  var iterate = function iterate(files, doc2) {\n    if (!doc2 || !doc2.files) {\n      return;\n    }\n\n    if (_isDemo()) {\n      a.push(doc2.files[files[0].id]);\n    } else {\n      files.forEach(function (f) {\n        if (!(f.required === false || f.condition === false)) {\n          if (checkValidity) {\n            a.push(isArray(doc2.files[f.id]) && doc2.files[f.id].every(function (file) {\n              return file.status === _FILE_STATUS.VALID;\n            }) ? true : undefined);\n          } else {\n            a.push(doc2.files[f.id]);\n          }\n        }\n      });\n    }\n  };\n\n  if (isArray(doc)) {\n    doc.forEach(function (item) {\n      var fileArray = fileArrayFunc(item)[step];\n      iterate(fileArray, item);\n    });\n  } else {\n    var fileArray = fileArrayFunc(doc)[step];\n    iterate(fileArray, doc);\n  }\n\n  return _getPercent(a);\n};\n\nvar _getAllFilesPercent = function _getAllFilesPercent(_ref, step) {\n  var loan = _ref.loan,\n      borrowers = _ref.borrowers,\n      property = _ref.property;\n  var array = [];\n\n  if (loan) {\n    array.push(_filesPercent(loan, _loanFiles, step));\n  }\n\n  if (borrowers) {\n    array.push(_filesPercent(borrowers, _borrowerFiles, step));\n  }\n\n  if (property) {\n    array.push(_filesPercent(property, _propertyFiles, step));\n  } // Sum and divide by amount of them\n\n\n  return array.reduce(function (a, b) {\n    return a + b;\n  }, 0) / array.length;\n};\n\nvar _closingPercent = function _closingPercent(loan) {\n  var closingSteps = loan.logic.closingSteps;\n  var arr = [];\n  closingSteps.forEach(function (step) {\n    if (step.type === _CLOSING_STEPS_TYPE.TODO) {\n      arr.push(step.status === _CLOSING_STEPS_STATUS.VALID ? true : undefined);\n    } else {\n      arr.push(isArray(loan.files[step.id]) && loan.files[step.id].every(function (file) {\n        return file.status === _CLOSING_STEPS_STATUS.VALID;\n      }) ? true : undefined);\n    }\n  });\n  return _getPercent(arr);\n};","map":{"version":3,"sources":["imports/core/arrays/steps.js"],"names":["module","export","previousDone","getPercent","shouldCountField","getCountedArray","personalInfoPercent","propertyPercent","auctionFilesPercent","filesPercent","getAllFilesPercent","closingPercent","React","watch","require","default","v","get","isArray","getBorrowerInfoArray","borrowerFiles","loanFiles","propertyFiles","getPropertyArray","getPropertyLoanArray","strategyDone","getPropertyCompletion","arrayify","isDemo","LOAN_STATUS","AUCTION_STATUS","FILE_STATUS","CLOSING_STEPS_STATUS","CLOSING_STEPS_TYPE","getSteps","props","loan","borrowers","property","serverTime","steps","nb","items","id","link","_id","percent","isDone","reduce","res","b","logic","hasValidatedFinances","length","waiting","verification","requested","validated","hasValidatedStructure","disabled","step","auction","status","STARTED","ENDED","lender","offerId","contractRequested","contract","files","DONE","title","color","paddingLeft","subtitle","exportDefault","getCurrentValue","input","doc","stepNb","itemNb","Error","slice","i","array","tot","val","undefined","isFinite","f","condition","required","type","formArray","arr","forEach","inputs","conditionalTrueValue","push","a","borrowerId","formArray1","formArray2","fileArray","fileArrayFunc","checkValidity","iterate","doc2","every","file","VALID","item","closingSteps","TODO"],"mappings":"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","file":"imports/core/arrays/steps.js.map","sourcesContent":["import React from 'react';\nimport get from 'lodash/get';\nimport isArray from 'lodash/isArray';\n\nimport { getBorrowerInfoArray } from './BorrowerFormArray';\nimport { borrowerFiles, loanFiles, propertyFiles } from '../api/files/files';\nimport { getPropertyArray, getPropertyLoanArray } from './PropertyFormArray';\nimport { strategyDone, getPropertyCompletion } from 'core/utils/loanFunctions';\nimport { arrayify } from '../utils/general';\nimport { isDemo } from 'core/utils/browserFunctions';\nimport {\n  LOAN_STATUS,\n  AUCTION_STATUS,\n  FILE_STATUS,\n  CLOSING_STEPS_STATUS,\n  CLOSING_STEPS_TYPE,\n} from '../api/constants';\n\nconst getSteps = (props) => {\n  const { loan, borrowers, property, serverTime } = props;\n\n  const steps = [\n    {\n      nb: 0,\n      items: [],\n    },\n\n    {\n      nb: 1,\n      items: [\n        {\n          id: 'personal',\n          link: `/loans/${loan._id}/borrowers/${borrowers[0]._id}/personal`,\n          percent: () => personalInfoPercent(borrowers),\n          isDone() {\n            return this.percent() >= 1;\n          },\n        },\n        {\n          id: 'finance',\n          link: `/loans/${loan._id}/borrowers/${borrowers[0]._id}/finance`,\n\n          isDone: () =>\n            borrowers.reduce(\n              (res, b) => res && b.logic.hasValidatedFinances,\n              true,\n            ),\n          percent: () =>\n            borrowers.reduce(\n              (res, b) => (b.logic.hasValidatedFinances ? res + 1 : res),\n              0,\n            ) / borrowers.length,\n        },\n        {\n          id: 'files',\n          link: `/loans/${loan._id}/borrowers/${borrowers[0]._id}/files`,\n          percent: () => filesPercent(borrowers, borrowerFiles, 'auction'),\n          isDone() {\n            return this.percent() >= 1;\n          },\n        },\n        {\n          id: 'property',\n          link: `/loans/${loan._id}/property`,\n          percent: () => getPropertyCompletion(props),\n          isDone() {\n            return this.percent() >= 1;\n          },\n        },\n        {\n          id: 'verification',\n          link: `/loans/${loan._id}/verification`,\n          waiting: () =>\n            loan.logic.verification.requested &&\n            !loan.logic.verification.validated,\n          isDone: () => loan.logic.verification.validated === true,\n        },\n      ],\n    },\n\n    {\n      nb: 2,\n      items: [\n        {\n          id: 'structure',\n          link: `/loans/${loan._id}/structure`,\n          isDone: () => loan.logic.hasValidatedStructure,\n          disabled: loan.logic.step < 2,\n        },\n        {\n          id: 'auction',\n          link: `/loans/${loan._id}/auction`,\n          waiting: () => loan.logic.auction.status === AUCTION_STATUS.STARTED,\n          isDone: () => loan.logic.auction.status === AUCTION_STATUS.ENDED,\n          disabled: loan.logic.step < 2,\n        },\n        {\n          id: 'strategy',\n          link: `/loans/${loan._id}/strategy`,\n          isDone: () => strategyDone({ loan }),\n        },\n        {\n          id: 'offerPicker',\n          link: `/loans/${loan._id}/offerpicker`,\n          isDone: () => !!(loan.logic.lender && loan.logic.lender.offerId),\n        },\n      ],\n    },\n\n    {\n      nb: 3,\n      items: [\n        {\n          id: 'contract',\n          link: `/loans/${loan._id}/contract`,\n          disabled:\n            loan.logic.step < 3 &&\n            !(loan.logic.lender && loan.logic.lender.offerId),\n          percent: () =>\n            getAllFilesPercent({ loan, borrowers, property }, 'contract'),\n          waiting: () =>\n            loan.logic.lender.contractRequested && !loan.logic.lender.contract,\n          isDone() {\n            return loan.files.contract && loan.files.contract.length;\n          },\n        },\n        {\n          id: 'closing',\n          link: `/loans/${loan._id}/closing`,\n          // FIXME: true && value used because of weird linting...\n          disabled:\n            (true &&\n              getAllFilesPercent({ loan, borrowers, property }, 'contract')) <\n              1 || loan.logic.step < 3,\n          percent: () => closingPercent(loan),\n          isDone: () => loan.status === LOAN_STATUS.DONE,\n        },\n      ],\n    },\n\n    {\n      nb: 4,\n      title: (\n        <span\n          className=\"fa fa-home fa-2x\"\n          style={{ color: '#ADB5BD', paddingLeft: 8 }}\n        />\n      ),\n      disabled: true, // TODO\n      subtitle: null,\n      items: [],\n    },\n  ];\n\n  // Make sure these indices correspond\n  // Verify all 3 items before item 4 are done\n  steps[1].items[4].disabled = !previousDone(steps, 1, 4); // Vérification e-Potek\n  // steps[0].items[6].disabled = !previousDone(steps, 0, 6); // Expertise\n\n  steps[2].items[1].disabled = !previousDone(steps, 2, 1); // Enchères\n  steps[2].items[2].disabled = !previousDone(steps, 2, 2); // Stratégie\n  steps[2].items[3].disabled = !previousDone(steps, 2, 3); // Choix du prêteur\n\n  return steps;\n};\n\nexport default getSteps;\n\n// Returns the current value of an autoForm input\nconst getCurrentValue = (input, doc) => get(doc, input.id);\n\n/**\n * previousDone - Checks if all previous subSteps have been finished upto this\n * item\n *\n * @param {array} steps  An array of subSteps/items\n * @param {number} stepNb The step Number\n * @param {number} itemNb The number of the item that is concerned\n *\n * @return {boolean} Description\n */\nexport const previousDone = (steps, stepNb, itemNb) => {\n  if (stepNb >= steps.length) {\n    throw new Error('invalid stepNb');\n  } else if (itemNb >= steps[stepNb].items.length) {\n    throw new Error('invalid itemNb');\n  }\n\n  return steps[stepNb].items\n    .slice(0, itemNb)\n    .reduce((res, i) => res && i.isDone(), true);\n};\n\n/**\n * getPercent - Given an array of values, any value that is undefined or null\n * will be counted as incomplete, make sure we don't divide by 0\n *\n * @param {array} array Array of numbers, strings, or dates\n *\n * @return {number} a value between 0 and 1\n */\nexport const getPercent = (array = []) => {\n  const percent =\n    array.reduce((tot, val) => {\n      if (isArray(val)) {\n        return tot + (val.length ? 1 : 0);\n      } else if (val !== undefined && val !== null) {\n        return tot + 1;\n      }\n      return tot;\n    }, 0) / array.length;\n  return isFinite(percent) ? percent : 0;\n};\n\n/**\n * shouldCountField - A boolean to determine if a field in an array\n * should be counted or not\n *\n * @param {object} f A formArray field object\n *\n * @return {boolean} Description\n */\nexport const shouldCountField = f =>\n  (f.condition === undefined || f.condition === true) &&\n  f.required !== false &&\n  !f.disabled &&\n  f.type !== 'h3';\n\n/**\n * getCountedArray - Returns an array of values that are mandatory and should\n * be counted to determine a completion percentage of a form\n *\n * @param {array}  formArray Description\n * @param {object}  doc       Description\n * @param {array} [arr=[]]  Description\n *\n * @return {array} an array with all the currentValues that are mandatory\n */\nexport const getCountedArray = (formArray, doc, arr = []) => {\n  formArray.forEach((i) => {\n    if (shouldCountField(i)) {\n      if (i.type === 'conditionalInput') {\n        if (getCurrentValue(i.inputs[0], doc) === i.conditionalTrueValue) {\n          // If the conditional input is triggering the next input, add all values\n          i.inputs.forEach(input => arr.push(getCurrentValue(input, doc)));\n        } else {\n          // If conditional value is not triggering\n          arr.push(getCurrentValue(i.inputs[0], doc));\n        }\n      } else {\n        arr.push(getCurrentValue(i, doc));\n      }\n    }\n  });\n\n  return arr;\n};\n\n/**\n * personalInfoPercent - Determines the completion rate of the borrower's\n * personal information forms\n *\n * @param {object} borrowers Description\n *\n * @return {number} A value between 0 and 1\n */\nexport const personalInfoPercent = (borrowers) => {\n  const a = [];\n  arrayify(borrowers).forEach((b) => {\n    const formArray = getBorrowerInfoArray({\n      borrowers: arrayify(borrowers),\n      borrowerId: b._id,\n    });\n    getCountedArray(formArray, b, a);\n  });\n\n  return getPercent(a);\n};\n\n/**\n * propertyPercent - Determines the completion rate of the property forms\n *\n * @param {object} loan Description\n * @param {object} borrowers   Description\n *\n * @return {number} A percentage between 0 and 1\n */\nexport const propertyPercent = (loan, borrowers, property) => {\n  const formArray1 = getPropertyArray({ loan, borrowers, property });\n  const formArray2 = getPropertyLoanArray({\n    loan,\n    borrowers,\n    property,\n  });\n\n  let a = getCountedArray(formArray1, property);\n  a = [...a, getCountedArray(formArray2, loan)];\n\n  return getPercent(a);\n};\n\nexport const auctionFilesPercent = (borrowers) => {\n  const a = [];\n  arrayify(borrowers).forEach((b) => {\n    const fileArray = borrowerFiles(b).auction;\n\n    if (isDemo()) {\n      a.push(b.files[fileArray[0].id]);\n    } else {\n      fileArray.forEach(f => f.condition !== false && a.push(b.files[f.id]));\n    }\n  });\n\n  return getPercent(a);\n};\n\n/**\n * filesPercent - Determines the completion rate of file upload for a given\n * step, doc and array of files\n *\n * @param {object} doc           The mongoDB document where files are saved\n * @param {function} fileArrayFunc A function that returns an array of files\n * @param {number} step          The step that determines which files are\n * required at this moment\n *\n * @return {number} a value between 0 and 1 indicating the percentage of\n * completion, 1 is complete, 0 is not started\n */\nexport const filesPercent = (doc, fileArrayFunc, step, checkValidity) => {\n  const a = [];\n  const iterate = (files, doc2) => {\n    if (!doc2 || !doc2.files) {\n      return;\n    }\n\n    if (isDemo()) {\n      a.push(doc2.files[files[0].id]);\n    } else {\n      files.forEach((f) => {\n        if (!(f.required === false || f.condition === false)) {\n          if (checkValidity) {\n            a.push(isArray(doc2.files[f.id]) &&\n              doc2.files[f.id].every(file => file.status === FILE_STATUS.VALID)\n              ? true\n              : undefined);\n          } else {\n            a.push(doc2.files[f.id]);\n          }\n        }\n      });\n    }\n  };\n\n  if (isArray(doc)) {\n    doc.forEach((item) => {\n      const fileArray = fileArrayFunc(item)[step];\n      iterate(fileArray, item);\n    });\n  } else {\n    const fileArray = fileArrayFunc(doc)[step];\n    iterate(fileArray, doc);\n  }\n\n  return getPercent(a);\n};\n\nexport const getAllFilesPercent = ({ loan, borrowers, property }, step) => {\n  const array = [];\n  if (loan) {\n    array.push(filesPercent(loan, loanFiles, step));\n  }\n\n  if (borrowers) {\n    array.push(filesPercent(borrowers, borrowerFiles, step));\n  }\n\n  if (property) {\n    array.push(filesPercent(property, propertyFiles, step));\n  }\n\n  // Sum and divide by amount of them\n  return array.reduce((a, b) => a + b, 0) / array.length;\n};\n\nexport const closingPercent = (loan) => {\n  const { closingSteps } = loan.logic;\n  const arr = [];\n\n  closingSteps.forEach((step) => {\n    if (step.type === CLOSING_STEPS_TYPE.TODO) {\n      arr.push(step.status === CLOSING_STEPS_STATUS.VALID ? true : undefined);\n    } else {\n      arr.push(isArray(loan.files[step.id]) &&\n        loan.files[step.id].every(file => file.status === CLOSING_STEPS_STATUS.VALID)\n        ? true\n        : undefined);\n    }\n  });\n\n  return getPercent(arr);\n};\n"]},"hash":"e6762a8d3a0846e69a14899ddcadad3c2ae3656b"}

{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"packages/dburles:factory/factory.js","filenameRelative":"packages/dburles:factory/factory.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"useNativeAsyncAwait":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"packages/dburles:factory/factory.js.map","sourceFileName":"packages/dburles:factory/factory.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"factory"},"ignored":false,"code":"/* global LocalCollection */ /* global Factory:true */const factories = {};\nFactory = class Factory {\n  constructor(name, collection, attributes) {\n    this.name = name;\n    this.collection = collection;\n    this.attributes = attributes;\n    this.afterHooks = [];\n    this.sequence = 0;\n  }\n\n  after(fn) {\n    this.afterHooks.push(fn);\n    return this;\n  }\n\n};\n\nFactory.define = (name, collection, attributes) => {\n  factories[name] = new Factory(name, collection, attributes);\n  return factories[name];\n};\n\nFactory.get = name => {\n  const factory = factories[name];\n\n  if (!factory) {\n    throw new Error(\"Factory: There is no factory named \" + name);\n  }\n\n  return factory;\n};\n\nFactory._build = (name, attributes = {}, userOptions = {}, options = {}) => {\n  const factory = Factory.get(name);\n  const result = {}; // \"raw\" attributes without functions evaluated, or dotted properties resolved\n\n  const extendedAttributes = _.extend({}, factory.attributes, attributes); // either create a new factory and return its _id\n  // or return a 'fake' _id (since we're not inserting anything)\n\n\n  const makeRelation = relName => {\n    if (options.insert) {\n      return Factory.create(relName, {}, userOptions)._id;\n    }\n\n    if (options.tree) {\n      return Factory._build(relName, {}, userOptions, {\n        tree: true\n      });\n    } // fake an id on build\n\n\n    return Random.id();\n  };\n\n  const getValue = value => {\n    return value instanceof Factory ? makeRelation(value.name) : value;\n  };\n\n  const getValueFromFunction = func => {\n    const api = {\n      sequence: fn => fn(factory.sequence)\n    };\n    const fnRes = func.call(result, api, userOptions);\n    return getValue(fnRes);\n  };\n\n  factory.sequence += 1;\n\n  const walk = (record, object) => {\n    _.each(object, (value, key) => {\n      let newValue = value; // is this a Factory instance?\n\n      if (value instanceof Factory) {\n        newValue = makeRelation(value.name);\n      } else if (_.isArray(value)) {\n        newValue = value.map(element => {\n          if (_.isFunction(element)) {\n            return getValueFromFunction(element);\n          }\n\n          return getValue(element);\n        });\n      } else if (_.isFunction(value)) {\n        newValue = getValueFromFunction(value); // if an object literal is passed in, traverse deeper into it\n      } else if (Object.prototype.toString.call(value) === '[object Object]') {\n        record[key] = record[key] || {};\n        return walk(record[key], value);\n      }\n\n      const modifier = {\n        $set: {}\n      };\n\n      if (key !== '_id') {\n        modifier.$set[key] = newValue;\n      }\n\n      LocalCollection._modify(record, modifier);\n    });\n  };\n\n  walk(result, extendedAttributes);\n\n  if (!options.tree) {\n    result._id = extendedAttributes._id || Random.id();\n  }\n\n  return result;\n};\n\nFactory.build = (name, attributes = {}, userOptions = {}) => {\n  return Factory._build(name, attributes, userOptions);\n};\n\nFactory.tree = (name, attributes, userOptions = {}) => {\n  return Factory._build(name, attributes, userOptions, {\n    tree: true\n  });\n};\n\nFactory._create = (name, doc) => {\n  const collection = Factory.get(name).collection;\n  const insertId = collection.insert(doc);\n  const record = collection.findOne(insertId);\n  return record;\n};\n\nFactory.create = (name, attributes = {}, userOptions = {}) => {\n  const doc = Factory._build(name, attributes, userOptions, {\n    insert: true\n  });\n\n  const record = Factory._create(name, doc);\n\n  Factory.get(name).afterHooks.forEach(cb => cb(record));\n  return record;\n};\n\nFactory.extend = (name, attributes = {}) => {\n  return _.extend(_.clone(Factory.get(name).attributes), attributes);\n};","map":{"version":3,"sources":["packages/dburles:factory/factory.js"],"names":["factories","Factory","constructor","name","collection","attributes","afterHooks","sequence","after","fn","push","define","get","factory","Error","_build","userOptions","options","result","extendedAttributes","_","extend","makeRelation","relName","insert","create","_id","tree","Random","id","getValue","value","getValueFromFunction","func","api","fnRes","call","walk","record","object","each","key","newValue","isArray","map","element","isFunction","Object","prototype","toString","modifier","$set","LocalCollection","_modify","build","_create","doc","insertId","findOne","forEach","cb","clone"],"mappings":"AAAA,4B,CACA,yBAEA,MAAMA,YAAY,EAAlB;AAEAC,UAAU,MAAMA,OAAN,CAAc;AACtBC,cAAYC,IAAZ,EAAkBC,UAAlB,EAA8BC,UAA9B,EAA0C;AACxC,SAAKF,IAAL,GAAYA,IAAZ;AACA,SAAKC,UAAL,GAAkBA,UAAlB;AACA,SAAKC,UAAL,GAAkBA,UAAlB;AACA,SAAKC,UAAL,GAAkB,EAAlB;AACA,SAAKC,QAAL,GAAgB,CAAhB;AACD;;AAEDC,QAAMC,EAAN,EAAU;AACR,SAAKH,UAAL,CAAgBI,IAAhB,CAAqBD,EAArB;AACA,WAAO,IAAP;AACD;;AAZqB,CAAxB;;AAeAR,QAAQU,MAAR,GAAiB,CAACR,IAAD,EAAOC,UAAP,EAAmBC,UAAnB,KAAkC;AACjDL,YAAUG,IAAV,IAAkB,IAAIF,OAAJ,CAAYE,IAAZ,EAAkBC,UAAlB,EAA8BC,UAA9B,CAAlB;AACA,SAAOL,UAAUG,IAAV,CAAP;AACD,CAHD;;AAKAF,QAAQW,GAAR,GAAcT,QAAQ;AACpB,QAAMU,UAAUb,UAAUG,IAAV,CAAhB;;AACA,MAAI,CAAEU,OAAN,EAAe;AACb,UAAM,IAAIC,KAAJ,CAAU,wCAAwCX,IAAlD,CAAN;AACD;;AACD,SAAOU,OAAP;AACD,CAND;;AAQAZ,QAAQc,MAAR,GAAiB,CAACZ,IAAD,EAAOE,aAAa,EAApB,EAAwBW,cAAc,EAAtC,EAA0CC,UAAU,EAApD,KAA2D;AAC1E,QAAMJ,UAAUZ,QAAQW,GAAR,CAAYT,IAAZ,CAAhB;AACA,QAAMe,SAAS,EAAf,CAF0E,CAI1E;;AACA,QAAMC,qBAAqBC,EAAEC,MAAF,CAAS,EAAT,EAAaR,QAAQR,UAArB,EAAiCA,UAAjC,CAA3B,CAL0E,CAO1E;AACA;;;AACA,QAAMiB,eAAeC,WAAW;AAC9B,QAAIN,QAAQO,MAAZ,EAAoB;AAClB,aAAOvB,QAAQwB,MAAR,CAAeF,OAAf,EAAwB,EAAxB,EAA4BP,WAA5B,EAAyCU,GAAhD;AACD;;AACD,QAAIT,QAAQU,IAAZ,EAAkB;AAChB,aAAO1B,QAAQc,MAAR,CAAeQ,OAAf,EAAwB,EAAxB,EAA4BP,WAA5B,EAAyC;AAACW,cAAM;AAAP,OAAzC,CAAP;AACD,KAN6B,CAO9B;;;AACA,WAAOC,OAAOC,EAAP,EAAP;AACD,GATD;;AAWA,QAAMC,WAAWC,SAAS;AACxB,WAAQA,iBAAiB9B,OAAlB,GAA6BqB,aAAaS,MAAM5B,IAAnB,CAA7B,GAAwD4B,KAA/D;AACD,GAFD;;AAIA,QAAMC,uBAAuBC,QAAQ;AACnC,UAAMC,MAAM;AAAE3B,gBAAUE,MAAMA,GAAGI,QAAQN,QAAX;AAAlB,KAAZ;AACA,UAAM4B,QAAQF,KAAKG,IAAL,CAAUlB,MAAV,EAAkBgB,GAAlB,EAAuBlB,WAAvB,CAAd;AACA,WAAOc,SAASK,KAAT,CAAP;AACD,GAJD;;AAMAtB,UAAQN,QAAR,IAAoB,CAApB;;AAEA,QAAM8B,OAAO,CAACC,MAAD,EAASC,MAAT,KAAoB;AAC/BnB,MAAEoB,IAAF,CAAOD,MAAP,EAAe,CAACR,KAAD,EAAQU,GAAR,KAAgB;AAC7B,UAAIC,WAAWX,KAAf,CAD6B,CAE7B;;AACA,UAAIA,iBAAiB9B,OAArB,EAA8B;AAC5ByC,mBAAWpB,aAAaS,MAAM5B,IAAnB,CAAX;AACD,OAFD,MAEO,IAAIiB,EAAEuB,OAAF,CAAUZ,KAAV,CAAJ,EAAsB;AAC3BW,mBAAWX,MAAMa,GAAN,CAAUC,WAAW;AAC9B,cAAIzB,EAAE0B,UAAF,CAAaD,OAAb,CAAJ,EAA2B;AACzB,mBAAOb,qBAAqBa,OAArB,CAAP;AACD;;AACD,iBAAOf,SAASe,OAAT,CAAP;AACD,SALU,CAAX;AAMD,OAPM,MAOA,IAAIzB,EAAE0B,UAAF,CAAaf,KAAb,CAAJ,EAAyB;AAC9BW,mBAAWV,qBAAqBD,KAArB,CAAX,CAD8B,CAEhC;AACC,OAHM,MAGA,IAAIgB,OAAOC,SAAP,CAAiBC,QAAjB,CAA0Bb,IAA1B,CAA+BL,KAA/B,MAA0C,iBAA9C,EAAiE;AACtEO,eAAOG,GAAP,IAAcH,OAAOG,GAAP,KAAe,EAA7B;AACA,eAAOJ,KAAKC,OAAOG,GAAP,CAAL,EAAkBV,KAAlB,CAAP;AACD;;AAED,YAAMmB,WAAW;AAACC,cAAM;AAAP,OAAjB;;AAEA,UAAIV,QAAQ,KAAZ,EAAmB;AACjBS,iBAASC,IAAT,CAAcV,GAAd,IAAqBC,QAArB;AACD;;AAEDU,sBAAgBC,OAAhB,CAAwBf,MAAxB,EAAgCY,QAAhC;AACD,KA3BD;AA4BD,GA7BD;;AA+BAb,OAAKnB,MAAL,EAAaC,kBAAb;;AAEA,MAAI,CAAEF,QAAQU,IAAd,EAAoB;AAClBT,WAAOQ,GAAP,GAAaP,mBAAmBO,GAAnB,IAA0BE,OAAOC,EAAP,EAAvC;AACD;;AACD,SAAOX,MAAP;AACD,CArED;;AAuEAjB,QAAQqD,KAAR,GAAgB,CAACnD,IAAD,EAAOE,aAAa,EAApB,EAAwBW,cAAc,EAAtC,KAA6C;AAC3D,SAAOf,QAAQc,MAAR,CAAeZ,IAAf,EAAqBE,UAArB,EAAiCW,WAAjC,CAAP;AACD,CAFD;;AAIAf,QAAQ0B,IAAR,GAAe,CAACxB,IAAD,EAAOE,UAAP,EAAmBW,cAAc,EAAjC,KAAwC;AACrD,SAAOf,QAAQc,MAAR,CAAeZ,IAAf,EAAqBE,UAArB,EAAiCW,WAAjC,EAA8C;AAACW,UAAM;AAAP,GAA9C,CAAP;AACD,CAFD;;AAIA1B,QAAQsD,OAAR,GAAkB,CAACpD,IAAD,EAAOqD,GAAP,KAAe;AAC/B,QAAMpD,aAAaH,QAAQW,GAAR,CAAYT,IAAZ,EAAkBC,UAArC;AACA,QAAMqD,WAAWrD,WAAWoB,MAAX,CAAkBgC,GAAlB,CAAjB;AACA,QAAMlB,SAASlC,WAAWsD,OAAX,CAAmBD,QAAnB,CAAf;AACA,SAAOnB,MAAP;AACD,CALD;;AAOArC,QAAQwB,MAAR,GAAiB,CAACtB,IAAD,EAAOE,aAAa,EAApB,EAAwBW,cAAc,EAAtC,KAA6C;AAC5D,QAAMwC,MAAMvD,QAAQc,MAAR,CAAeZ,IAAf,EAAqBE,UAArB,EAAiCW,WAAjC,EAA8C;AAACQ,YAAQ;AAAT,GAA9C,CAAZ;;AACA,QAAMc,SAASrC,QAAQsD,OAAR,CAAgBpD,IAAhB,EAAsBqD,GAAtB,CAAf;;AAEAvD,UAAQW,GAAR,CAAYT,IAAZ,EAAkBG,UAAlB,CAA6BqD,OAA7B,CAAqCC,MAAMA,GAAGtB,MAAH,CAA3C;AAEA,SAAOA,MAAP;AACD,CAPD;;AASArC,QAAQoB,MAAR,GAAiB,CAAClB,IAAD,EAAOE,aAAa,EAApB,KAA2B;AAC1C,SAAOe,EAAEC,MAAF,CAASD,EAAEyC,KAAF,CAAQ5D,QAAQW,GAAR,CAAYT,IAAZ,EAAkBE,UAA1B,CAAT,EAAgDA,UAAhD,CAAP;AACD,CAFD","file":"packages/dburles:factory/factory.js.map","sourcesContent":["/* global LocalCollection */\n/* global Factory:true */\n\nconst factories = {};\n\nFactory = class Factory {\n  constructor(name, collection, attributes) {\n    this.name = name;\n    this.collection = collection;\n    this.attributes = attributes;\n    this.afterHooks = [];\n    this.sequence = 0;\n  }\n\n  after(fn) {\n    this.afterHooks.push(fn);\n    return this;\n  }\n};\n\nFactory.define = (name, collection, attributes) => {\n  factories[name] = new Factory(name, collection, attributes);\n  return factories[name];\n};\n\nFactory.get = name => {\n  const factory = factories[name];\n  if (! factory) {\n    throw new Error(\"Factory: There is no factory named \" + name);\n  }\n  return factory;\n};\n\nFactory._build = (name, attributes = {}, userOptions = {}, options = {}) => {\n  const factory = Factory.get(name);\n  const result = {};\n\n  // \"raw\" attributes without functions evaluated, or dotted properties resolved\n  const extendedAttributes = _.extend({}, factory.attributes, attributes);\n\n  // either create a new factory and return its _id\n  // or return a 'fake' _id (since we're not inserting anything)\n  const makeRelation = relName => {\n    if (options.insert) {\n      return Factory.create(relName, {}, userOptions)._id;\n    }\n    if (options.tree) {\n      return Factory._build(relName, {}, userOptions, {tree: true});\n    }\n    // fake an id on build\n    return Random.id();\n  };\n\n  const getValue = value => {\n    return (value instanceof Factory) ? makeRelation(value.name) : value;\n  };\n\n  const getValueFromFunction = func => {\n    const api = { sequence: fn => fn(factory.sequence) };\n    const fnRes = func.call(result, api, userOptions);\n    return getValue(fnRes);\n  };\n\n  factory.sequence += 1;\n\n  const walk = (record, object) => {\n    _.each(object, (value, key) => {\n      let newValue = value;\n      // is this a Factory instance?\n      if (value instanceof Factory) {\n        newValue = makeRelation(value.name);\n      } else if (_.isArray(value)) {\n        newValue = value.map(element => {\n          if (_.isFunction(element)) {\n            return getValueFromFunction(element);\n          }\n          return getValue(element);\n        });\n      } else if (_.isFunction(value)) {\n        newValue = getValueFromFunction(value);\n      // if an object literal is passed in, traverse deeper into it\n      } else if (Object.prototype.toString.call(value) === '[object Object]') {\n        record[key] = record[key] || {};\n        return walk(record[key], value);\n      }\n\n      const modifier = {$set: {}};\n\n      if (key !== '_id') {\n        modifier.$set[key] = newValue;\n      }\n\n      LocalCollection._modify(record, modifier);\n    });\n  };\n\n  walk(result, extendedAttributes);\n\n  if (! options.tree) {\n    result._id = extendedAttributes._id || Random.id();\n  }\n  return result;\n};\n\nFactory.build = (name, attributes = {}, userOptions = {}) => {\n  return Factory._build(name, attributes, userOptions);\n};\n\nFactory.tree = (name, attributes, userOptions = {}) => {\n  return Factory._build(name, attributes, userOptions, {tree: true});\n};\n\nFactory._create = (name, doc) => {\n  const collection = Factory.get(name).collection;\n  const insertId = collection.insert(doc);\n  const record = collection.findOne(insertId);\n  return record;\n};\n\nFactory.create = (name, attributes = {}, userOptions = {}) => {\n  const doc = Factory._build(name, attributes, userOptions, {insert: true});\n  const record = Factory._create(name, doc);\n\n  Factory.get(name).afterHooks.forEach(cb => cb(record));\n\n  return record;\n};\n\nFactory.extend = (name, attributes = {}) => {\n  return _.extend(_.clone(Factory.get(name).attributes), attributes);\n};\n"]},"hash":"8470bba6d10a70503b65f49552e33bfd2fc9d5fd"}

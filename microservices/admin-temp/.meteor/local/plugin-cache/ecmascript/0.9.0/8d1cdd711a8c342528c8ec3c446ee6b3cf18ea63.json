{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[{"source":"../namedQuery.js","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"NamedQuery"}]},{"source":"./schema.js","imported":["ExposeSchema","ExposeDefaults"],"specifiers":[{"kind":"named","imported":"ExposeSchema","local":"ExposeSchema"},{"kind":"named","imported":"ExposeDefaults","local":"ExposeDefaults"}]},{"source":"./lib/mergeDeep.js","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"mergeDeep"}]},{"source":"../../query/lib/createGraph.js","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"createGraph"}]},{"source":"../../query/lib/recursiveCompose.js","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"recursiveCompose"}]},{"source":"../../query/lib/prepareForProcess.js","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"prepareForProcess"}]},{"source":"lodash.clonedeep","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"deepClone"}]},{"source":"../../query/lib/intersectDeep","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"intersectDeep"}]},{"source":"../../query/counts/genEndpoint.server","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"genCountEndpoint"}]},{"source":"meteor/check","imported":["check"],"specifiers":[{"kind":"named","imported":"check","local":"check"}]}],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js","filenameRelative":"packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"useNativeAsyncAwait":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js.map","sourceFileName":"packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"extension"},"ignored":false,"code":"let NamedQuery;\nmodule.watch(require(\"../namedQuery.js\"), {\n    default(v) {\n        NamedQuery = v;\n    }\n\n}, 0);\nlet ExposeSchema, ExposeDefaults;\nmodule.watch(require(\"./schema.js\"), {\n    ExposeSchema(v) {\n        ExposeSchema = v;\n    },\n\n    ExposeDefaults(v) {\n        ExposeDefaults = v;\n    }\n\n}, 1);\nlet mergeDeep;\nmodule.watch(require(\"./lib/mergeDeep.js\"), {\n    default(v) {\n        mergeDeep = v;\n    }\n\n}, 2);\nlet createGraph;\nmodule.watch(require(\"../../query/lib/createGraph.js\"), {\n    default(v) {\n        createGraph = v;\n    }\n\n}, 3);\nlet recursiveCompose;\nmodule.watch(require(\"../../query/lib/recursiveCompose.js\"), {\n    default(v) {\n        recursiveCompose = v;\n    }\n\n}, 4);\nlet prepareForProcess;\nmodule.watch(require(\"../../query/lib/prepareForProcess.js\"), {\n    default(v) {\n        prepareForProcess = v;\n    }\n\n}, 5);\nlet deepClone;\nmodule.watch(require(\"lodash.clonedeep\"), {\n    default(v) {\n        deepClone = v;\n    }\n\n}, 6);\nlet intersectDeep;\nmodule.watch(require(\"../../query/lib/intersectDeep\"), {\n    default(v) {\n        intersectDeep = v;\n    }\n\n}, 7);\nlet genCountEndpoint;\nmodule.watch(require(\"../../query/counts/genEndpoint.server\"), {\n    default(v) {\n        genCountEndpoint = v;\n    }\n\n}, 8);\nlet check;\nmodule.watch(require(\"meteor/check\"), {\n    check(v) {\n        check = v;\n    }\n\n}, 9);\n\n_.extend(NamedQuery.prototype, {\n    /**\n     * @param config\n     */expose(config = {}) {\n        if (!Meteor.isServer) {\n            throw new Meteor.Error('invalid-environment', `You must run this in server-side code`);\n        }\n\n        if (this.isExposed) {\n            throw new Meteor.Error('query-already-exposed', `You have already exposed: \"${this.name}\" named query`);\n        }\n\n        this.exposeConfig = Object.assign({}, ExposeDefaults, config);\n        check(this.exposeConfig, ExposeSchema);\n\n        if (this.exposeConfig.validateParams) {\n            this.options.validateParams = this.exposeConfig.validateParams;\n        }\n\n        if (!this.isResolver) {\n            this._initNormalQuery();\n        } else {\n            this._initMethod();\n        }\n\n        this.isExposed = true;\n    },\n\n    /**\n     * Initializes a normal NamedQuery (normal == not a resolver)\n     * @private\n     */_initNormalQuery() {\n        const config = this.exposeConfig;\n\n        if (config.method) {\n            this._initMethod();\n        }\n\n        if (config.publication) {\n            this._initPublication();\n        }\n\n        if (!config.method && !config.publication) {\n            throw new Meteor.Error('weird', 'If you want to expose your named query you need to specify at least one of [\"method\", \"publication\"] options to true');\n        }\n\n        this._initCountMethod();\n\n        this._initCountPublication();\n    },\n\n    /**\n     * Returns the embodied body of the request\n     * @param {*} _embody \n     * @param {*} body \n     */doEmbodimentIfItApplies(body) {\n        // query is not exposed yet, so it doesn't have embodiment logic\n        if (!this.exposeConfig) {\n            return;\n        }\n\n        const {\n            embody\n        } = this.exposeConfig;\n\n        if (!embody) {\n            return;\n        }\n\n        if (_.isFunction(embody)) {\n            embody.call(this, body, this.params);\n        } else {\n            mergeDeep(body, embody);\n        }\n    },\n\n    /**\n     * @private\n     */_initMethod() {\n        const self = this;\n        Meteor.methods({\n            [this.name](newParams) {\n                self._unblockIfNecessary(this); // security is done in the fetching because we provide a context\n\n\n                return self.clone(newParams).fetch(this);\n            }\n\n        });\n    },\n\n    /**\n     * @returns {void}\n     * @private\n     */_initCountMethod() {\n        const self = this;\n        Meteor.methods({\n            [this.name + '.count'](newParams) {\n                self._unblockIfNecessary(this); // security is done in the fetching because we provide a context\n\n\n                return self.clone(newParams).getCount(this);\n            }\n\n        });\n    },\n\n    /**\n     * @returns {*}\n     * @private\n     */_initCountPublication() {\n        const self = this;\n        genCountEndpoint(self.name, {\n            getCursor(session) {\n                const query = self.clone(session.params);\n                return query.getCursorForCounting();\n            },\n\n            getSession(newParams) {\n                self.doValidateParams(newParams);\n\n                self._callFirewall(this, this.userId, params);\n\n                return {\n                    params: newParams\n                };\n            }\n\n        });\n    },\n\n    /**\n     * @private\n     */_initPublication() {\n        const self = this;\n        Meteor.publishComposite(this.name, function (params = {}) {\n            self._unblockIfNecessary(this);\n\n            self.doValidateParams(params);\n\n            self._callFirewall(this, this.userId, params);\n\n            let body = deepClone(self.body);\n\n            if (params.$body) {\n                body = intersectDeep(body, params.$body);\n            }\n\n            self.doEmbodimentIfItApplies(body);\n            body = prepareForProcess(body, params);\n            const rootNode = createGraph(self.collection, body);\n            return recursiveCompose(rootNode);\n        });\n    },\n\n    /**\n     * @param context\n     * @param userId\n     * @param params\n     * @private\n     */_callFirewall(context, userId, params) {\n        const {\n            firewall\n        } = this.exposeConfig;\n\n        if (!firewall) {\n            return;\n        }\n\n        if (_.isArray(firewall)) {\n            firewall.forEach(fire => {\n                fire.call(context, userId, params);\n            });\n        } else {\n            firewall.call(context, userId, params);\n        }\n    },\n\n    /**\n     * @param context\n     * @private\n     */_unblockIfNecessary(context) {\n        if (this.exposeConfig.unblock) {\n            if (context.unblock) {\n                context.unblock();\n            }\n        }\n    }\n\n});","map":{"version":3,"sources":["packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js"],"names":["NamedQuery","module","watch","require","default","v","ExposeSchema","ExposeDefaults","mergeDeep","createGraph","recursiveCompose","prepareForProcess","deepClone","intersectDeep","genCountEndpoint","check","_","extend","prototype","expose","config","Meteor","isServer","Error","isExposed","name","exposeConfig","Object","assign","validateParams","options","isResolver","_initNormalQuery","_initMethod","method","publication","_initPublication","_initCountMethod","_initCountPublication","doEmbodimentIfItApplies","body","embody","isFunction","call","params","self","methods","newParams","_unblockIfNecessary","clone","fetch","getCount","getCursor","session","query","getCursorForCounting","getSession","doValidateParams","_callFirewall","userId","publishComposite","$body","rootNode","collection","context","firewall","isArray","forEach","fire","unblock"],"mappings":"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","file":"packages/cultofcoders:grapher/lib/namedQuery/expose/extension.js.map","sourcesContent":["import NamedQuery from '../namedQuery.js';\nimport {ExposeSchema, ExposeDefaults} from './schema.js';\nimport mergeDeep from './lib/mergeDeep.js';\nimport createGraph from '../../query/lib/createGraph.js';\nimport recursiveCompose from '../../query/lib/recursiveCompose.js';\nimport prepareForProcess from '../../query/lib/prepareForProcess.js';\nimport deepClone from 'lodash.clonedeep';\nimport intersectDeep from '../../query/lib/intersectDeep';\nimport genCountEndpoint from '../../query/counts/genEndpoint.server';\nimport {check} from 'meteor/check';\n\n_.extend(NamedQuery.prototype, {\n    /**\n     * @param config\n     */\n    expose(config = {}) {\n        if (!Meteor.isServer) {\n            throw new Meteor.Error('invalid-environment', `You must run this in server-side code`);\n        }\n\n        if (this.isExposed) {\n            throw new Meteor.Error('query-already-exposed', `You have already exposed: \"${this.name}\" named query`);\n        }\n\n        this.exposeConfig = Object.assign({}, ExposeDefaults, config);\n        check(this.exposeConfig, ExposeSchema);\n\n        if (this.exposeConfig.validateParams) {\n            this.options.validateParams = this.exposeConfig.validateParams;\n        }\n\n        if (!this.isResolver) {\n            this._initNormalQuery();\n        } else {\n            this._initMethod();\n        }\n\n        this.isExposed = true;\n    },\n\n    /**\n     * Initializes a normal NamedQuery (normal == not a resolver)\n     * @private\n     */\n    _initNormalQuery() {\n        const config = this.exposeConfig;\n        if (config.method) {\n            this._initMethod();\n        }\n\n        if (config.publication) {\n            this._initPublication();\n        }\n\n        if (!config.method && !config.publication) {\n            throw new Meteor.Error('weird', 'If you want to expose your named query you need to specify at least one of [\"method\", \"publication\"] options to true')\n        }\n\n        this._initCountMethod();\n        this._initCountPublication();\n    },\n\n    /**\n     * Returns the embodied body of the request\n     * @param {*} _embody \n     * @param {*} body \n     */\n    doEmbodimentIfItApplies(body) {\n        // query is not exposed yet, so it doesn't have embodiment logic\n        if (!this.exposeConfig) {\n            return;\n        }\n\n        const {embody} = this.exposeConfig;\n\n        if (!embody) {\n            return;\n        }\n\n        if (_.isFunction(embody)) {\n            embody.call(this, body, this.params)\n        } else {\n            mergeDeep(\n                body,\n                embody\n            );\n        }\n    },\n\n    /**\n     * @private\n     */\n    _initMethod() {\n        const self = this;\n        Meteor.methods({\n            [this.name](newParams) {\n                self._unblockIfNecessary(this);\n\n                // security is done in the fetching because we provide a context\n                return self.clone(newParams).fetch(this);\n            }\n        })\n    },\n\n    /**\n     * @returns {void}\n     * @private\n     */\n    _initCountMethod() {\n        const self = this;\n\n        Meteor.methods({\n            [this.name + '.count'](newParams) {\n                self._unblockIfNecessary(this);\n\n                // security is done in the fetching because we provide a context\n                return self.clone(newParams).getCount(this);\n            }\n        });\n    },\n\n    /**\n     * @returns {*}\n     * @private\n     */\n    _initCountPublication() {\n        const self = this;\n\n        genCountEndpoint(self.name, {\n            getCursor(session) {\n                const query = self.clone(session.params);\n                return query.getCursorForCounting();\n            },\n\n            getSession(newParams) {\n                self.doValidateParams(newParams);\n                self._callFirewall(this, this.userId, params);\n\n                return { params: newParams };\n            },\n        });\n    },\n\n    /**\n     * @private\n     */\n    _initPublication() {\n        const self = this;\n\n        Meteor.publishComposite(this.name, function (params = {}) {\n            self._unblockIfNecessary(this);\n            self.doValidateParams(params);\n            self._callFirewall(this, this.userId, params);\n\n            let body = deepClone(self.body);\n            if (params.$body) {\n                body = intersectDeep(body, params.$body);\n            }\n\n            self.doEmbodimentIfItApplies(body);\n            body = prepareForProcess(body, params);\n\n            const rootNode = createGraph(self.collection, body);\n\n            return recursiveCompose(rootNode);\n        });\n    },\n\n    /**\n     * @param context\n     * @param userId\n     * @param params\n     * @private\n     */\n    _callFirewall(context, userId, params) {\n        const {firewall} = this.exposeConfig;\n        if (!firewall) {\n            return;\n        }\n\n        if (_.isArray(firewall)) {\n            firewall.forEach(fire => {\n                fire.call(context, userId, params);\n            })\n        } else {\n            firewall.call(context, userId, params);\n        }\n    },\n\n    /**\n     * @param context\n     * @private\n     */\n    _unblockIfNecessary(context) {\n        if (this.exposeConfig.unblock) {\n            if (context.unblock) {\n                context.unblock();\n            }\n        }\n    },\n});\n"]},"hash":"8d1cdd711a8c342528c8ec3c446ee6b3cf18ea63"}

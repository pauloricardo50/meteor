{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[{"source":"meteor/meteor","imported":["Meteor"],"specifiers":[{"kind":"named","imported":"Meteor","local":"Meteor"}]},{"source":"aws-sdk","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"AWS"}]},{"source":"meteor/check","imported":["check"],"specifiers":[{"kind":"named","imported":"check","local":"check"}]},{"source":"meteor/alanning:roles","imported":["Roles"],"specifiers":[{"kind":"named","imported":"Roles","local":"Roles"}]},{"source":"../../../utils/rate-limit.js","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"rateLimit"}]},{"source":"../../loans/loans","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Loans"}]},{"source":"../../borrowers/borrowers","imported":["default"],"specifiers":[{"kind":"named","imported":"default","local":"Borrowers"}]}],"exports":{"exported":["isAllowed"],"specifiers":[{"kind":"local","local":"isAllowed","exported":"isAllowed"}]}}},"options":{"filename":"imports/core/api/files/server/methods.js","filenameRelative":"imports/core/api/files/server/methods.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],{"spec":false,"loose":false}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"useNativeAsyncAwait":false}],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"imports/core/api/files/server/methods.js.map","sourceFileName":"imports/core/api/files/server/methods.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"methods"},"ignored":false,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nmodule.export({\n  isAllowed: function isAllowed() {\n    return _isAllowed;\n  }\n});\n\nvar _Meteor = void 0;\n\nmodule.watch(require(\"meteor/meteor\"), {\n  Meteor: function Meteor(v) {\n    _Meteor = v;\n  }\n}, 0);\nvar AWS = void 0;\nmodule.watch(require(\"aws-sdk\"), {\n  default: function _default(v) {\n    AWS = v;\n  }\n}, 1);\n\nvar _check = void 0;\n\nmodule.watch(require(\"meteor/check\"), {\n  check: function check(v) {\n    _check = v;\n  }\n}, 2);\n\nvar _Roles = void 0;\n\nexports.isAllowed = _isAllowed;\nmodule.watch(require(\"meteor/alanning:roles\"), {\n  Roles: function Roles(v) {\n    _Roles = v;\n  }\n}, 3);\nvar rateLimit = void 0;\nmodule.watch(require(\"../../../utils/rate-limit.js\"), {\n  default: function _default(v) {\n    rateLimit = v;\n  }\n}, 4);\nvar Loans = void 0;\nmodule.watch(require(\"../../loans/loans\"), {\n  default: function _default(v) {\n    Loans = v;\n  }\n}, 5);\nvar Borrowers = void 0;\nmodule.watch(require(\"../../borrowers/borrowers\"), {\n  default: function _default(v) {\n    Borrowers = v;\n  }\n}, 6);\n\n/* eslint import/prefer-default-export: 0 */var _isAllowed = function _isAllowed(key) {\n  // Check if this user is the owner of the document he's trying to delete a\n  // file from\n  var keyId = key.split('/')[0];\n  var loanFound = !!Loans.findOne({\n    _id: keyId,\n    userId: _Meteor.userId()\n  });\n  var borrowerFound = !!Borrowers.findOne({\n    _id: keyId,\n    userId: _Meteor.userId()\n  });\n\n  if (_Roles.userIsInRole(_Meteor.userId(), 'admin') || _Roles.userIsInRole(_Meteor.userId(), 'dev')) {\n    return true;\n  } else if (!(loanFound || borrowerFound)) {\n    throw new _Meteor.Error('unauthorized email');\n  }\n\n  return true;\n};\n\nvar setupS3 = function setupS3() {\n  AWS.config.update({\n    accessKeyId: _Meteor.settings.AWS.users.accessKeyId,\n    secretAccessKey: _Meteor.settings.AWS.users.secretAccesskey\n  });\n  return new AWS.S3({\n    signatureVersion: 'v4'\n  });\n};\n\n_Meteor.methods({\n  deleteFile: function deleteFile(key) {\n    _check(key, String);\n\n    _isAllowed(key);\n\n    var s3 = setupS3();\n    var params = {\n      Bucket: _Meteor.settings.S3Bucket,\n      Key: key\n    }; // bind s3 to avoid an error of context 'makeLoan is not a function'\n\n    var async = _Meteor.wrapAsync(s3.deleteObject.bind(s3));\n\n    return async(params);\n  },\n  downloadFile: function downloadFile(key) {\n    _check(key, String);\n\n    _isAllowed(key);\n\n    var s3 = setupS3();\n    var params = {\n      Bucket: _Meteor.settings.S3Bucket,\n      Key: key\n    }; // Don't ask me why this works...\n    // https://gist.github.com/rclai/b9331afd2fbabadb0074\n\n    var async = _Meteor.wrapAsync(function (parameters, callback) {\n      return s3.getObject(parameters, function (error, data) {\n        callback(error, data);\n      });\n    });\n\n    return async(params);\n  }\n});\n\nrateLimit({\n  methods: ['deleteFile', 'downloadFile']\n});","map":{"version":3,"sources":["imports/core/api/files/server/methods.js"],"names":["module","export","isAllowed","Meteor","watch","require","v","AWS","default","check","Roles","rateLimit","Loans","Borrowers","key","keyId","split","loanFound","findOne","_id","userId","borrowerFound","userIsInRole","Error","setupS3","config","update","accessKeyId","settings","users","secretAccessKey","secretAccesskey","S3","signatureVersion","methods","deleteFile","String","s3","params","Bucket","S3Bucket","Key","async","wrapAsync","deleteObject","bind","downloadFile","parameters","callback","getObject","error","data"],"mappings":";;;;;AAAAA,OAAOC,MAAP,CAAc;AAACC,aAAU;AAAA,WAAIA,UAAJ;AAAA;AAAX,CAAd;;AAAyC,IAAIC,gBAAJ;;AAAWH,OAAOI,KAAP,CAAaC,QAAQ,eAAR,CAAb,EAAsC;AAACF,QAAD,kBAAQG,CAAR,EAAU;AAACH,cAAOG,CAAP;AAAS;AAApB,CAAtC,EAA4D,CAA5D;AAA+D,IAAIC,YAAJ;AAAQP,OAAOI,KAAP,CAAaC,QAAQ,SAAR,CAAb,EAAgC;AAACG,SAAD,oBAASF,CAAT,EAAW;AAACC,UAAID,CAAJ;AAAM;AAAlB,CAAhC,EAAoD,CAApD;;AAAuD,IAAIG,eAAJ;;AAAUT,OAAOI,KAAP,CAAaC,QAAQ,cAAR,CAAb,EAAqC;AAACI,OAAD,iBAAOH,CAAP,EAAS;AAACG,aAAMH,CAAN;AAAQ;AAAlB,CAArC,EAAyD,CAAzD;;AAA4D,IAAII,eAAJ;;;AAAUV,OAAOI,KAAP,CAAaC,QAAQ,uBAAR,CAAb,EAA8C;AAACK,OAAD,iBAAOJ,CAAP,EAAS;AAACI,aAAMJ,CAAN;AAAQ;AAAlB,CAA9C,EAAkE,CAAlE;AAAqE,IAAIK,kBAAJ;AAAcX,OAAOI,KAAP,CAAaC,QAAQ,8BAAR,CAAb,EAAqD;AAACG,SAAD,oBAASF,CAAT,EAAW;AAACK,gBAAUL,CAAV;AAAY;AAAxB,CAArD,EAA+E,CAA/E;AAAkF,IAAIM,cAAJ;AAAUZ,OAAOI,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACG,SAAD,oBAASF,CAAT,EAAW;AAACM,YAAMN,CAAN;AAAQ;AAApB,CAA1C,EAAgE,CAAhE;AAAmE,IAAIO,kBAAJ;AAAcb,OAAOI,KAAP,CAAaC,QAAQ,2BAAR,CAAb,EAAkD;AAACG,SAAD,oBAASF,CAAT,EAAW;AAACO,gBAAUP,CAAV;AAAY;AAAxB,CAAlD,EAA4E,CAA5E;;AASlgB,4CACO,IAAMJ,aAAY,SAAZA,UAAY,CAACY,GAAD,EAAS;AAChC;AACA;AACA,MAAMC,QAAQD,IAAIE,KAAJ,CAAU,GAAV,EAAe,CAAf,CAAd;AACA,MAAMC,YAAY,CAAC,CAACL,MAAMM,OAAN,CAAc;AAChCC,SAAKJ,KAD2B;AAEhCK,YAAQjB,QAAOiB,MAAP;AAFwB,GAAd,CAApB;AAIA,MAAMC,gBAAgB,CAAC,CAACR,UAAUK,OAAV,CAAkB;AACxCC,SAAKJ,KADmC;AAExCK,YAAQjB,QAAOiB,MAAP;AAFgC,GAAlB,CAAxB;;AAKA,MACEV,OAAMY,YAAN,CAAmBnB,QAAOiB,MAAP,EAAnB,EAAoC,OAApC,KACAV,OAAMY,YAAN,CAAmBnB,QAAOiB,MAAP,EAAnB,EAAoC,KAApC,CAFF,EAGE;AACA,WAAO,IAAP;AACD,GALD,MAKO,IAAI,EAAEH,aAAaI,aAAf,CAAJ,EAAmC;AACxC,UAAM,IAAIlB,QAAOoB,KAAX,CAAiB,oBAAjB,CAAN;AACD;;AAED,SAAO,IAAP;AACD,CAvBM;;AAyBP,IAAMC,UAAU,SAAVA,OAAU,GAAM;AACpBjB,MAAIkB,MAAJ,CAAWC,MAAX,CAAkB;AAChBC,iBAAaxB,QAAOyB,QAAP,CAAgBrB,GAAhB,CAAoBsB,KAApB,CAA0BF,WADvB;AAEhBG,qBAAiB3B,QAAOyB,QAAP,CAAgBrB,GAAhB,CAAoBsB,KAApB,CAA0BE;AAF3B,GAAlB;AAKA,SAAO,IAAIxB,IAAIyB,EAAR,CAAW;AAAEC,sBAAkB;AAApB,GAAX,CAAP;AACD,CAPD;;AASA9B,QAAO+B,OAAP,CAAe;AACbC,YADa,sBACFrB,GADE,EACG;AACdL,WAAMK,GAAN,EAAWsB,MAAX;;AACAlC,eAAUY,GAAV;;AAEA,QAAMuB,KAAKb,SAAX;AACA,QAAMc,SAAS;AAAEC,cAAQpC,QAAOyB,QAAP,CAAgBY,QAA1B;AAAoCC,WAAK3B;AAAzC,KAAf,CALc,CAOd;;AACA,QAAM4B,QAAQvC,QAAOwC,SAAP,CAAiBN,GAAGO,YAAH,CAAgBC,IAAhB,CAAqBR,EAArB,CAAjB,CAAd;;AACA,WAAOK,MAAMJ,MAAN,CAAP;AACD,GAXY;AAYbQ,cAZa,wBAYAhC,GAZA,EAYK;AAChBL,WAAMK,GAAN,EAAWsB,MAAX;;AACAlC,eAAUY,GAAV;;AAEA,QAAMuB,KAAKb,SAAX;AACA,QAAMc,SAAS;AAAEC,cAAQpC,QAAOyB,QAAP,CAAgBY,QAA1B;AAAoCC,WAAK3B;AAAzC,KAAf,CALgB,CAOhB;AACA;;AACA,QAAM4B,QAAQvC,QAAOwC,SAAP,CAAiB,UAACI,UAAD,EAAaC,QAAb;AAAA,aAC7BX,GAAGY,SAAH,CAAaF,UAAb,EAAyB,UAACG,KAAD,EAAQC,IAAR,EAAiB;AACxCH,iBAASE,KAAT,EAAgBC,IAAhB;AACD,OAFD,CAD6B;AAAA,KAAjB,CAAd;;AAKA,WAAOT,MAAMJ,MAAN,CAAP;AACD;AA3BY,CAAf;;AA8BA3B,UAAU;AAAEuB,WAAS,CAAC,YAAD,EAAe,cAAf;AAAX,CAAV","file":"imports/core/api/files/server/methods.js.map","sourcesContent":["import { Meteor } from 'meteor/meteor';\nimport AWS from 'aws-sdk';\nimport { check } from 'meteor/check';\nimport { Roles } from 'meteor/alanning:roles';\nimport rateLimit from '../../../utils/rate-limit.js';\n\nimport Loans from 'core/api/loans/loans';\nimport Borrowers from 'core/api/borrowers/borrowers';\n\n/* eslint import/prefer-default-export: 0 */\nexport const isAllowed = (key) => {\n  // Check if this user is the owner of the document he's trying to delete a\n  // file from\n  const keyId = key.split('/')[0];\n  const loanFound = !!Loans.findOne({\n    _id: keyId,\n    userId: Meteor.userId(),\n  });\n  const borrowerFound = !!Borrowers.findOne({\n    _id: keyId,\n    userId: Meteor.userId(),\n  });\n\n  if (\n    Roles.userIsInRole(Meteor.userId(), 'admin') ||\n    Roles.userIsInRole(Meteor.userId(), 'dev')\n  ) {\n    return true;\n  } else if (!(loanFound || borrowerFound)) {\n    throw new Meteor.Error('unauthorized email');\n  }\n\n  return true;\n};\n\nconst setupS3 = () => {\n  AWS.config.update({\n    accessKeyId: Meteor.settings.AWS.users.accessKeyId,\n    secretAccessKey: Meteor.settings.AWS.users.secretAccesskey,\n  });\n\n  return new AWS.S3({ signatureVersion: 'v4' });\n};\n\nMeteor.methods({\n  deleteFile(key) {\n    check(key, String);\n    isAllowed(key);\n\n    const s3 = setupS3();\n    const params = { Bucket: Meteor.settings.S3Bucket, Key: key };\n\n    // bind s3 to avoid an error of context 'makeLoan is not a function'\n    const async = Meteor.wrapAsync(s3.deleteObject.bind(s3));\n    return async(params);\n  },\n  downloadFile(key) {\n    check(key, String);\n    isAllowed(key);\n\n    const s3 = setupS3();\n    const params = { Bucket: Meteor.settings.S3Bucket, Key: key };\n\n    // Don't ask me why this works...\n    // https://gist.github.com/rclai/b9331afd2fbabadb0074\n    const async = Meteor.wrapAsync((parameters, callback) =>\n      s3.getObject(parameters, (error, data) => {\n        callback(error, data);\n      }));\n\n    return async(params);\n  },\n});\n\nrateLimit({ methods: ['deleteFile', 'downloadFile'] });\n"]},"hash":"5433e9e1df6cddbd72b5310f9c69c485811b85ad"}

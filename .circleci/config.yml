version: 2
jobs:
  Prepare:
    working_directory: ~/app
    docker: &ref_0
      - image: 'circleci/openjdk:10-jdk-node-browsers'
        environment:
          LANG: C.UTF-8
          LANGUAGE: C.UTF-8
          LC_ALL: C.UTF-8
          LC_NUMERIC: en_US.UTF-8
          METEOR_VERSION: 1.10.1
          NODE_ENV: development
          TOOL_NODE_FLAGS: >-
            --max_old_space_size=8192 --optimize_for_size --gc_interval=100
            --min_semi_space_size=8 --max_semi_space_size=256
          CIRCLE_CI: 1
          DEBUG: false
          METEOR_DISABLE_OPTIMISTIC_CACHING: 1
    resource_class: large
    steps:
      - run:
          name: Install expect
          command: sudo apt-get install expect
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - checkout
      - run:
          name: Init submodules
          command: git submodule sync && git submodule update --init --recursive
      - save_cache:
          name: Cache source
          key: 'source_master_8-{{ .Branch }}-{{ .Revision }}'
          paths:
            - .
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - run:
          name: Install project node_modules
          command: npm ci
      - save_cache:
          name: Cache globals
          key: 'global_master_8-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ~/.cache
      - save_cache:
          name: Cache node_modules
          key: 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
          paths:
            - ./node_modules
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_backend_{{ checksum
              "./microservices/backend/.meteor/release" }}_{{ checksum
              "./microservices/backend/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Install node_modules
          command: meteor npm --prefix microservices/backend ci
      - run:
          name: Build backend
          command: ./scripts/circleci/build_backend.sh
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor backend
          key: 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/backend/.meteor/local/bundler-cache
            - ./microservices/backend/.meteor/local/isopacks
            - ./microservices/backend/.meteor/local/plugin-cache
  Www - unit tests:
    working_directory: ~/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_www_{{ checksum
              "./microservices/www/.meteor/release" }}_{{ checksum
              "./microservices/www/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_8_www-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_www-{{ .Branch }}-'
            - meteor_microservice_master_8_www-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  meteor npm --prefix microservices/www ci
                  meteor npm --prefix microservices/backend ci
                  
      - run:
          name: Generate language files
          command: npm run lang www
      - run:
          name: Run unit tests
          command: cd ./microservices/www && meteor npm run test-ci
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_8_www_{{ checksum
            "./microservices/www/.meteor/release" }}_{{ checksum
            "./microservices/www/.meteor/versions" }}
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_8_www-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/www/.meteor/local/bundler-cache
            - ./microservices/www/.meteor/local/isopacks
            - ./microservices/www/.meteor/local/plugin-cache
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  App - unit tests:
    working_directory: ~/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_app_{{ checksum
              "./microservices/app/.meteor/release" }}_{{ checksum
              "./microservices/app/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_8_app-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_app-{{ .Branch }}-'
            - meteor_microservice_master_8_app-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  meteor npm --prefix microservices/app ci
                  meteor npm --prefix microservices/backend ci
                  
      - run:
          name: Generate language files
          command: npm run lang app
      - run:
          name: Run unit tests
          command: cd ./microservices/app && meteor npm run test-ci
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_8_app_{{ checksum
            "./microservices/app/.meteor/release" }}_{{ checksum
            "./microservices/app/.meteor/versions" }}
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_8_app-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/app/.meteor/local/bundler-cache
            - ./microservices/app/.meteor/local/isopacks
            - ./microservices/app/.meteor/local/plugin-cache
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  Admin - unit tests:
    working_directory: ~/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_admin_{{ checksum
              "./microservices/admin/.meteor/release" }}_{{ checksum
              "./microservices/admin/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_8_admin-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_admin-{{ .Branch }}-'
            - meteor_microservice_master_8_admin-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  meteor npm --prefix microservices/admin ci
                  meteor npm --prefix microservices/backend ci
                  
      - run:
          name: Generate language files
          command: npm run lang admin
      - run:
          name: Run unit tests
          command: cd ./microservices/admin && meteor npm run test-ci
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_8_admin_{{ checksum
            "./microservices/admin/.meteor/release" }}_{{ checksum
            "./microservices/admin/.meteor/versions" }}
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_8_admin-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/admin/.meteor/local/bundler-cache
            - ./microservices/admin/.meteor/local/isopacks
            - ./microservices/admin/.meteor/local/plugin-cache
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  Pro - unit tests:
    working_directory: ~/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_pro_{{ checksum
              "./microservices/pro/.meteor/release" }}_{{ checksum
              "./microservices/pro/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_8_pro-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_pro-{{ .Branch }}-'
            - meteor_microservice_master_8_pro-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  meteor npm --prefix microservices/pro ci
                  meteor npm --prefix microservices/backend ci
                  
      - run:
          name: Generate language files
          command: npm run lang pro
      - run:
          name: Run unit tests
          command: cd ./microservices/pro && meteor npm run test-ci
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_8_pro_{{ checksum
            "./microservices/pro/.meteor/release" }}_{{ checksum
            "./microservices/pro/.meteor/versions" }}
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_8_pro-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/pro/.meteor/local/bundler-cache
            - ./microservices/pro/.meteor/local/isopacks
            - ./microservices/pro/.meteor/local/plugin-cache
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  Www - e2e tests:
    working_directory: ~/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_www_{{ checksum
              "./microservices/www/.meteor/release" }}_{{ checksum
              "./microservices/www/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_8_www-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_www-{{ .Branch }}-'
            - meteor_microservice_master_8_www-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  meteor npm --prefix microservices/www ci
                  meteor npm --prefix microservices/backend ci
                  
      - run:
          name: Generate language files
          command: npm run lang www
      - run:
          name: Run e2e tests
          command: |2-

                    cd ./microservices/www && meteor npm run test-e2e-ci
                    
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_8_www_{{ checksum
            "./microservices/www/.meteor/release" }}_{{ checksum
            "./microservices/www/.meteor/versions" }}
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_8_www-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/www/.meteor/local/bundler-cache
            - ./microservices/www/.meteor/local/isopacks
            - ./microservices/www/.meteor/local/plugin-cache
      - store_test_results:
          path: ./e2e-results
      - store_artifacts:
          path: ./e2e-results
  App - e2e tests:
    working_directory: ~/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_app_{{ checksum
              "./microservices/app/.meteor/release" }}_{{ checksum
              "./microservices/app/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_8_app-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_app-{{ .Branch }}-'
            - meteor_microservice_master_8_app-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  meteor npm --prefix microservices/app ci
                  meteor npm --prefix microservices/backend ci
                  
      - run:
          name: Generate language files
          command: npm run lang app
      - run:
          name: Run e2e tests
          command: |2-

                    cd ./microservices/app && meteor npm run test-e2e-ci
                    
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_8_app_{{ checksum
            "./microservices/app/.meteor/release" }}_{{ checksum
            "./microservices/app/.meteor/versions" }}
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_8_app-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/app/.meteor/local/bundler-cache
            - ./microservices/app/.meteor/local/isopacks
            - ./microservices/app/.meteor/local/plugin-cache
      - store_test_results:
          path: ./e2e-results
      - store_artifacts:
          path: ./e2e-results
  Admin - e2e tests:
    working_directory: ~/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_admin_{{ checksum
              "./microservices/admin/.meteor/release" }}_{{ checksum
              "./microservices/admin/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_8_admin-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_admin-{{ .Branch }}-'
            - meteor_microservice_master_8_admin-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  meteor npm --prefix microservices/admin ci
                  meteor npm --prefix microservices/backend ci
                  
      - run:
          name: Generate language files
          command: npm run lang admin
      - run:
          name: Run e2e tests
          command: |2-

                    cd ./microservices/admin && meteor npm run test-e2e-ci
                    
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_8_admin_{{ checksum
            "./microservices/admin/.meteor/release" }}_{{ checksum
            "./microservices/admin/.meteor/versions" }}
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_8_admin-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/admin/.meteor/local/bundler-cache
            - ./microservices/admin/.meteor/local/isopacks
            - ./microservices/admin/.meteor/local/plugin-cache
      - store_test_results:
          path: ./e2e-results
      - store_artifacts:
          path: ./e2e-results
  Pro - e2e tests:
    working_directory: ~/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_8-{{ .Branch }}-'
            - source_master_8-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_8-{{ .Branch }}-{{ .Revision }}'
            - 'global_master_8-{{ .Branch }}-'
            - global_master_8-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_8_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_8_pro_{{ checksum
              "./microservices/pro/.meteor/release" }}_{{ checksum
              "./microservices/pro/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_8_pro-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_pro-{{ .Branch }}-'
            - meteor_microservice_master_8_pro-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_8_backend-{{ .Branch }}-'
            - meteor_microservice_master_8_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  meteor npm --prefix microservices/pro ci
                  meteor npm --prefix microservices/backend ci
                  
      - run:
          name: Generate language files
          command: npm run lang pro
      - run:
          name: Run e2e tests
          command: |2-

                    cd ./microservices/pro && meteor npm run test-e2e-ci
                    
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_8_pro_{{ checksum
            "./microservices/pro/.meteor/release" }}_{{ checksum
            "./microservices/pro/.meteor/versions" }}
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_8_pro-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/pro/.meteor/local/bundler-cache
            - ./microservices/pro/.meteor/local/isopacks
            - ./microservices/pro/.meteor/local/plugin-cache
      - store_test_results:
          path: ./e2e-results
      - store_artifacts:
          path: ./e2e-results
workflows:
  version: 2
  Build and test:
    jobs:
      - Prepare
      - Www - unit tests:
          requires:
            - Prepare
      - App - unit tests:
          requires:
            - Prepare
      - Admin - unit tests:
          requires:
            - Prepare
      - Pro - unit tests:
          requires:
            - Prepare
      - Www - e2e tests:
          requires:
            - Prepare
      - App - e2e tests:
          requires:
            - Prepare
      - Admin - e2e tests:
          requires:
            - Prepare
      - Pro - e2e tests:
          requires:
            - Prepare

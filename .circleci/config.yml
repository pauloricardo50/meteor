version: 2
jobs:
  test-www:
    working_directory: ~/app
    machine: true
    environment: &ref_0
      LANG: C.UTF-8
      LANGUAGE: C.UTF-8
      LC_ALL: C.UTF-8
      LC_NUMERIC: en_US.UTF-8
      METEOR_VERSION: '1.7'
      NODE_ENV: development
      TOOL_NODE_FLAGS: >-
        --max_old_space_size=8192 --optimize_for_size --gc_interval=100
        --min_semi_space_size=8 --max_semi_space_size=256
      METEOR_PROFILE: 1000
      CIRCLE_CI: 1
      DEBUG: true
      DOCKER_DRIVER: overlay2
    steps:
      - checkout
      - restore_cache:
          name: Restore meteor system
          keys:
            - 'meteor-system-www-2-{{ checksum "./.circleci/config.yml" }}'
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - >-
              meteor-microservice-www-2-{{ checksum
              "./microservices/www/.meteor/release" }}-{{ checksum
              "./microservices/www/.meteor/packages" }}-{{ checksum
              "./microservices/www/.meteor/versions" }}
      - restore_cache:
          name: Restore node_modules
          keys:
            - >-
              node_modules-www-2-{{ checksum "./microservices/www/package.json"
              }}
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Copy meteor bin to build cache
          command: >-
            mkdir -p ~/build-temp && cp /usr/local/bin/meteor
            ~/build-temp/meteor-bin
      - run:
          name: Install node_modules
          command: cd microservices/www && meteor npm i
      - save_cache:
          name: Cache node_modules
          key: 'node_modules-www-2-{{ checksum "./microservices/www/package.json" }}'
          paths:
            - .microservices/www/node_modules
      - run:
          name: Run tests
          command: cd microservices/www && meteor npm run test-CI
      - save_cache:
          name: Cache meteor system
          key: 'meteor-system-www-2-{{ checksum "./.circleci/config.yml" }}'
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: >-
            meteor-microservice-www-2-{{ checksum
            "./microservices/www/.meteor/release" }}-{{ checksum
            "./microservices/www/.meteor/packages" }}-{{ checksum
            "./microservices/www/.meteor/versions" }}
          paths:
            - ./microservices/www/.meteor/local
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  test-app:
    working_directory: ~/app
    machine: true
    environment: *ref_0
    steps:
      - checkout
      - restore_cache:
          name: Restore meteor system
          keys:
            - 'meteor-system-app-2-{{ checksum "./.circleci/config.yml" }}'
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - >-
              meteor-microservice-app-2-{{ checksum
              "./microservices/app/.meteor/release" }}-{{ checksum
              "./microservices/app/.meteor/packages" }}-{{ checksum
              "./microservices/app/.meteor/versions" }}
      - restore_cache:
          name: Restore node_modules
          keys:
            - >-
              node_modules-app-2-{{ checksum "./microservices/app/package.json"
              }}
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Copy meteor bin to build cache
          command: >-
            mkdir -p ~/build-temp && cp /usr/local/bin/meteor
            ~/build-temp/meteor-bin
      - run:
          name: Install node_modules
          command: cd microservices/app && meteor npm i
      - save_cache:
          name: Cache node_modules
          key: 'node_modules-app-2-{{ checksum "./microservices/app/package.json" }}'
          paths:
            - .microservices/app/node_modules
      - run:
          name: Run tests
          command: cd microservices/app && meteor npm run test-CI
      - save_cache:
          name: Cache meteor system
          key: 'meteor-system-app-2-{{ checksum "./.circleci/config.yml" }}'
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: >-
            meteor-microservice-app-2-{{ checksum
            "./microservices/app/.meteor/release" }}-{{ checksum
            "./microservices/app/.meteor/packages" }}-{{ checksum
            "./microservices/app/.meteor/versions" }}
          paths:
            - ./microservices/app/.meteor/local
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  test-admin:
    working_directory: ~/app
    machine: true
    environment: *ref_0
    steps:
      - checkout
      - restore_cache:
          name: Restore meteor system
          keys:
            - 'meteor-system-admin-2-{{ checksum "./.circleci/config.yml" }}'
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - >-
              meteor-microservice-admin-2-{{ checksum
              "./microservices/admin/.meteor/release" }}-{{ checksum
              "./microservices/admin/.meteor/packages" }}-{{ checksum
              "./microservices/admin/.meteor/versions" }}
      - restore_cache:
          name: Restore node_modules
          keys:
            - >-
              node_modules-admin-2-{{ checksum
              "./microservices/admin/package.json" }}
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Copy meteor bin to build cache
          command: >-
            mkdir -p ~/build-temp && cp /usr/local/bin/meteor
            ~/build-temp/meteor-bin
      - run:
          name: Install node_modules
          command: cd microservices/admin && meteor npm i
      - save_cache:
          name: Cache node_modules
          key: >-
            node_modules-admin-2-{{ checksum
            "./microservices/admin/package.json" }}
          paths:
            - .microservices/admin/node_modules
      - run:
          name: Run tests
          command: cd microservices/admin && meteor npm run test-CI
      - save_cache:
          name: Cache meteor system
          key: 'meteor-system-admin-2-{{ checksum "./.circleci/config.yml" }}'
          paths:
            - ~/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: >-
            meteor-microservice-admin-2-{{ checksum
            "./microservices/admin/.meteor/release" }}-{{ checksum
            "./microservices/admin/.meteor/packages" }}-{{ checksum
            "./microservices/admin/.meteor/versions" }}
          paths:
            - ./microservices/admin/.meteor/local
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
workflows:
  version: 2
  Build and test:
    jobs:
      - test-www
      - test-app
      - test-admin

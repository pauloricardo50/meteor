version: 2
jobs:
  Prepare:
    working_directory: /home/circleci/app
    docker: &ref_0
      - image: 'cypress/base:12'
        environment:
          LANG: C.UTF-8
          LANGUAGE: C.UTF-8
          LC_ALL: C.UTF-8
          LC_NUMERIC: en_US.UTF-8
          METEOR_VERSION: 1.10.2
          NODE_ENV: development
          TOOL_NODE_FLAGS: >-
            --max_old_space_size=8192 --optimize_for_size --gc_interval=100
            --min_semi_space_size=8 --max_semi_space_size=256
          CIRCLE_CI: 1
          DEBUG: false
          METEOR_ALLOW_SUPERUSER: true
          METEOR_DISABLE_OPTIMISTIC_CACHING: 1
          RTL_SKIP_AUTO_CLEANUP: 1
          HOME: /home/circleci
    resource_class: medium
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - checkout
      - run:
          name: Init submodules
          command: git submodule sync && git submodule update --init --recursive
      - save_cache:
          name: Cache source
          key: 'source_master_16-{{ .Branch }}-{{ .Revision }}'
          paths:
            - .
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_16_2-{{ checksum "./package-lock.json" }}'
            - global_master_16_2-
      - run:
          name: Install project node_modules
          command: npm ci
      - save_cache:
          name: Cache globals
          key: 'global_master_16_2-{{ checksum "./package-lock.json" }}'
          paths:
            - /home/circleci/.cache
      - save_cache:
          name: Cache node_modules
          key: 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
          paths:
            - ./node_modules
  Www2 - unit tests:
    working_directory: /home/circleci/app
    docker: *ref_0
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - run:
          name: Install node_modules
          command: npm --prefix microservices/www2 ci
      - run:
          name: Run tests
          command: npm run test-ci --prefix microservices/www2
  App - unit tests:
    working_directory: /home/circleci/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_16_app_2_{{ checksum
              "./microservices/app/.meteor/release" }}_{{ checksum
              "./microservices/app/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_app-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_app-{{ .Branch }}-'
            - meteor_microservice_master_16_app-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - >-
              meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'meteor_microservice_master_16_backend-{{ .Branch }}-'
            - meteor_microservice_master_16_backend-
      - run:
          name: Setup display
          command: |2-

                    echo "export DISPLAY=':99.0'" >> $BASH_ENV
                    apt-get update && apt-get install xvfb -y
                    Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1
                  
          background: true
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  function installBackend {
                    meteor npm --prefix microservices/app ci
                    touch $HOME/.npm-backend-done
                  }

                  installBackend &

                  meteor npm --prefix microservices/backend ci

                  until [ -f $HOME/.npm-backend-done ]; do
                    echo "$HOME/.npm-backend-done does not exist. Waiting 1s"
                    sleep 1
                  done
                  
      - run:
          name: Generate language files
          command: npm run lang app
      - run:
          name: Run unit tests
          command: cd ./microservices/app && meteor npm run test-ci
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_16_app_2_{{ checksum
            "./microservices/app/.meteor/release" }}_{{ checksum
            "./microservices/app/.meteor/versions" }}
          paths:
            - /home/circleci/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_16_app-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/app/.meteor/local/bundler-cache/scanner
            - ./microservices/app/.meteor/local/isopacks
            - ./microservices/app/.meteor/local/plugin-cache
            - ./microservices/app/.meteor/local/resolver-result-cache.json
      - save_cache:
          name: Cache meteor backend
          key: 'meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/backend/.meteor/local/bundler-cache/scanner
            - ./microservices/backend/.meteor/local/isopacks
            - ./microservices/backend/.meteor/local/plugin-cache
            - ./microservices/backend/.meteor/local/resolver-result-cache.json
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  Core - unit tests:
    working_directory: /home/circleci/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_16_backend_2_{{ checksum
              "./microservices/backend/.meteor/release" }}_{{ checksum
              "./microservices/backend/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - >-
              meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'meteor_microservice_master_16_backend-{{ .Branch }}-'
            - meteor_microservice_master_16_backend-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - >-
              meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'meteor_microservice_master_16_backend-{{ .Branch }}-'
            - meteor_microservice_master_16_backend-
      - run:
          name: Setup display
          command: |2-

                    echo "export DISPLAY=':99.0'" >> $BASH_ENV
                    apt-get update && apt-get install xvfb -y
                    Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1
                  
          background: true
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  function installBackend {
                    meteor npm --prefix microservices/backend ci
                    touch $HOME/.npm-backend-done
                  }

                  installBackend &

                  

                  until [ -f $HOME/.npm-backend-done ]; do
                    echo "$HOME/.npm-backend-done does not exist. Waiting 1s"
                    sleep 1
                  done
                  
      - run:
          name: Run unit tests
          command: cd ./microservices/backend && meteor npm run test-ci
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_16_backend_2_{{ checksum
            "./microservices/backend/.meteor/release" }}_{{ checksum
            "./microservices/backend/.meteor/versions" }}
          paths:
            - /home/circleci/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/backend/.meteor/local/bundler-cache/scanner
            - ./microservices/backend/.meteor/local/isopacks
            - ./microservices/backend/.meteor/local/plugin-cache
            - ./microservices/backend/.meteor/local/resolver-result-cache.json
      - save_cache:
          name: Cache meteor backend
          key: 'meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/backend/.meteor/local/bundler-cache/scanner
            - ./microservices/backend/.meteor/local/isopacks
            - ./microservices/backend/.meteor/local/plugin-cache
            - ./microservices/backend/.meteor/local/resolver-result-cache.json
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  Admin - unit tests:
    working_directory: /home/circleci/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_16_admin_2_{{ checksum
              "./microservices/admin/.meteor/release" }}_{{ checksum
              "./microservices/admin/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_admin-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_admin-{{ .Branch }}-'
            - meteor_microservice_master_16_admin-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - >-
              meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'meteor_microservice_master_16_backend-{{ .Branch }}-'
            - meteor_microservice_master_16_backend-
      - run:
          name: Setup display
          command: |2-

                    echo "export DISPLAY=':99.0'" >> $BASH_ENV
                    apt-get update && apt-get install xvfb -y
                    Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1
                  
          background: true
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  function installBackend {
                    meteor npm --prefix microservices/admin ci
                    touch $HOME/.npm-backend-done
                  }

                  installBackend &

                  meteor npm --prefix microservices/backend ci

                  until [ -f $HOME/.npm-backend-done ]; do
                    echo "$HOME/.npm-backend-done does not exist. Waiting 1s"
                    sleep 1
                  done
                  
      - run:
          name: Generate language files
          command: npm run lang admin
      - run:
          name: Run unit tests
          command: cd ./microservices/admin && meteor npm run test-ci
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_16_admin_2_{{ checksum
            "./microservices/admin/.meteor/release" }}_{{ checksum
            "./microservices/admin/.meteor/versions" }}
          paths:
            - /home/circleci/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_16_admin-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/admin/.meteor/local/bundler-cache/scanner
            - ./microservices/admin/.meteor/local/isopacks
            - ./microservices/admin/.meteor/local/plugin-cache
            - ./microservices/admin/.meteor/local/resolver-result-cache.json
      - save_cache:
          name: Cache meteor backend
          key: 'meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/backend/.meteor/local/bundler-cache/scanner
            - ./microservices/backend/.meteor/local/isopacks
            - ./microservices/backend/.meteor/local/plugin-cache
            - ./microservices/backend/.meteor/local/resolver-result-cache.json
      - store_test_results:
          path: ./results
      - store_artifacts:
          path: ./results
  App - e2e tests:
    working_directory: /home/circleci/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_16_2-{{ checksum "./package-lock.json" }}'
            - global_master_16_2-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_16_app_2_{{ checksum
              "./microservices/app/.meteor/release" }}_{{ checksum
              "./microservices/app/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_app-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_app-{{ .Branch }}-'
            - meteor_microservice_master_16_app-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - >-
              meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'meteor_microservice_master_16_backend-{{ .Branch }}-'
            - meteor_microservice_master_16_backend-
      - run:
          name: Install netcat
          command: apt-get update && apt-get install -y netcat
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  function installBackend {
                    meteor npm --prefix microservices/app ci
                    touch $HOME/.npm-backend-done
                  }

                  installBackend &

                  meteor npm --prefix microservices/backend ci

                  until [ -f $HOME/.npm-backend-done ]; do
                    echo "$HOME/.npm-backend-done does not exist. Waiting 1s"
                    sleep 1
                  done
                  
      - run:
          name: Generate language files
          command: npm run lang app
      - run:
          name: Run e2e tests
          command: |2-

                    cd ./microservices/app && meteor npm run test-e2e-ci
                    
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_16_app_2_{{ checksum
            "./microservices/app/.meteor/release" }}_{{ checksum
            "./microservices/app/.meteor/versions" }}
          paths:
            - /home/circleci/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_16_app-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/app/.meteor/local/bundler-cache/scanner
            - ./microservices/app/.meteor/local/isopacks
            - ./microservices/app/.meteor/local/plugin-cache
            - ./microservices/app/.meteor/local/resolver-result-cache.json
      - save_cache:
          name: Cache meteor backend
          key: 'meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/backend/.meteor/local/bundler-cache/scanner
            - ./microservices/backend/.meteor/local/isopacks
            - ./microservices/backend/.meteor/local/plugin-cache
            - ./microservices/backend/.meteor/local/resolver-result-cache.json
      - store_test_results:
          path: ./e2e-results
      - store_artifacts:
          path: ./e2e-results
  Admin - e2e tests:
    working_directory: /home/circleci/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_16_2-{{ checksum "./package-lock.json" }}'
            - global_master_16_2-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_16_admin_2_{{ checksum
              "./microservices/admin/.meteor/release" }}_{{ checksum
              "./microservices/admin/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_admin-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_admin-{{ .Branch }}-'
            - meteor_microservice_master_16_admin-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - >-
              meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'meteor_microservice_master_16_backend-{{ .Branch }}-'
            - meteor_microservice_master_16_backend-
      - run:
          name: Install netcat
          command: apt-get update && apt-get install -y netcat
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  function installBackend {
                    meteor npm --prefix microservices/admin ci
                    touch $HOME/.npm-backend-done
                  }

                  installBackend &

                  meteor npm --prefix microservices/backend ci

                  until [ -f $HOME/.npm-backend-done ]; do
                    echo "$HOME/.npm-backend-done does not exist. Waiting 1s"
                    sleep 1
                  done
                  
      - run:
          name: Generate language files
          command: npm run lang admin
      - run:
          name: Run e2e tests
          command: |2-

                    cd ./microservices/admin && meteor npm run test-e2e-ci
                    
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_16_admin_2_{{ checksum
            "./microservices/admin/.meteor/release" }}_{{ checksum
            "./microservices/admin/.meteor/versions" }}
          paths:
            - /home/circleci/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_16_admin-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/admin/.meteor/local/bundler-cache/scanner
            - ./microservices/admin/.meteor/local/isopacks
            - ./microservices/admin/.meteor/local/plugin-cache
            - ./microservices/admin/.meteor/local/resolver-result-cache.json
      - save_cache:
          name: Cache meteor backend
          key: 'meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/backend/.meteor/local/bundler-cache/scanner
            - ./microservices/backend/.meteor/local/isopacks
            - ./microservices/backend/.meteor/local/plugin-cache
            - ./microservices/backend/.meteor/local/resolver-result-cache.json
      - store_test_results:
          path: ./e2e-results
      - store_artifacts:
          path: ./e2e-results
  Pro - e2e tests:
    working_directory: /home/circleci/app
    docker: *ref_0
    resource_class: medium+
    steps:
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore global cache
          keys:
            - 'global_master_16_2-{{ checksum "./package-lock.json" }}'
            - global_master_16_2-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor system
          keys:
            - >-
              meteor_system_master_16_pro_2_{{ checksum
              "./microservices/pro/.meteor/release" }}_{{ checksum
              "./microservices/pro/.meteor/versions" }}
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_pro-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_pro-{{ .Branch }}-'
            - meteor_microservice_master_16_pro-
      - restore_cache:
          name: Restore meteor backend
          keys:
            - >-
              meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'meteor_microservice_master_16_backend-{{ .Branch }}-'
            - meteor_microservice_master_16_backend-
      - run:
          name: Install netcat
          command: apt-get update && apt-get install -y netcat
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Create results directory
          command: mkdir ./results
      - run:
          name: Install node_modules
          command: |2-

                  function installBackend {
                    meteor npm --prefix microservices/pro ci
                    touch $HOME/.npm-backend-done
                  }

                  installBackend &

                  meteor npm --prefix microservices/backend ci

                  until [ -f $HOME/.npm-backend-done ]; do
                    echo "$HOME/.npm-backend-done does not exist. Waiting 1s"
                    sleep 1
                  done
                  
      - run:
          name: Generate language files
          command: npm run lang pro
      - run:
          name: Run e2e tests
          command: |2-

                    cd ./microservices/pro && meteor npm run test-e2e-ci
                    
          no_output_timeout: 30m
      - save_cache:
          name: Cache meteor system
          key: >-
            meteor_system_master_16_pro_2_{{ checksum
            "./microservices/pro/.meteor/release" }}_{{ checksum
            "./microservices/pro/.meteor/versions" }}
          paths:
            - /home/circleci/.meteor
      - save_cache:
          name: Cache meteor microservice
          key: 'meteor_microservice_master_16_pro-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/pro/.meteor/local/bundler-cache/scanner
            - ./microservices/pro/.meteor/local/isopacks
            - ./microservices/pro/.meteor/local/plugin-cache
            - ./microservices/pro/.meteor/local/resolver-result-cache.json
      - save_cache:
          name: Cache meteor backend
          key: 'meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision }}'
          paths:
            - ./microservices/backend/.meteor/local/bundler-cache/scanner
            - ./microservices/backend/.meteor/local/isopacks
            - ./microservices/backend/.meteor/local/plugin-cache
            - ./microservices/backend/.meteor/local/resolver-result-cache.json
      - store_test_results:
          path: ./e2e-results
      - store_artifacts:
          path: ./e2e-results
  Www - deploy:
    working_directory: /home/circleci/app
    docker: *ref_0
    steps:
      - add_ssh_keys
      - setup_remote_docker:
          version: 19.03.12
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_www-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_www-{{ .Branch }}-'
            - meteor_microservice_master_16_www-
      - restore_cache:
          name: Restore minifier cache
          keys:
            - 'minifier_microservice_master_16_www-{{ .Branch }}-{{ .Revision }}'
            - 'minifier_microservice_master_16_www-{{ .Branch }}-'
            - minifier_microservice_master_16_www-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Install GCloud
          command: |2-

                  cd ~
                  echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
                  apt-get install apt-transport-https ca-certificates gnupg
                  curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
                  apt-get update && apt-get install -y google-cloud-sdk

                  echo "$GCLOUD_SDK_KEY" > ./gcloud-key.json
                  gcloud auth activate-service-account  --key-file=./gcloud-key.json
                  rm ./gcloud-key.json
                
      - run:
          name: Install Docker
          command: 'wget -qO- https://get.docker.com/ | sh'
      - run:
          name: Deploy
          command: |2-

                    cd deploy
                    ENVIRONMENT="staging"

                    if [ "$CIRCLE_BRANCH" = "staging" ]; then
                      ENVIRONMENT="staging"
                    else
                      echo "Deployments not configured for this branch"
                      exit 1
                    fi

                    # Uses the fingerprint as the name
                    mv ~/.ssh/id_rsa_02c8ca4cac313d6026c95416de40b8b8 ~/.ssh/epotek
                    node run-all -e $ENVIRONMENT --apps www validate
                    node run-all -e $ENVIRONMENT --apps www deploy
                  
          no_output_timeout: 30m
      - save_cache:
          name: Save minifier cache
          key: 'minifier_microservice_master_16_www-{{ .Branch }}-{{ .Revision }}'
          paths:
            - >-
              ./microservices/www/.meteor/local/plugin-cache/zodern_standard-minifier-js
  App - deploy:
    working_directory: /home/circleci/app
    docker: *ref_0
    steps:
      - add_ssh_keys
      - setup_remote_docker:
          version: 19.03.12
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_app-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_app-{{ .Branch }}-'
            - meteor_microservice_master_16_app-
      - restore_cache:
          name: Restore minifier cache
          keys:
            - 'minifier_microservice_master_16_app-{{ .Branch }}-{{ .Revision }}'
            - 'minifier_microservice_master_16_app-{{ .Branch }}-'
            - minifier_microservice_master_16_app-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Install GCloud
          command: |2-

                  cd ~
                  echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
                  apt-get install apt-transport-https ca-certificates gnupg
                  curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
                  apt-get update && apt-get install -y google-cloud-sdk

                  echo "$GCLOUD_SDK_KEY" > ./gcloud-key.json
                  gcloud auth activate-service-account  --key-file=./gcloud-key.json
                  rm ./gcloud-key.json
                
      - run:
          name: Install Docker
          command: 'wget -qO- https://get.docker.com/ | sh'
      - run:
          name: Deploy
          command: |2-

                    cd deploy
                    ENVIRONMENT="staging"

                    if [ "$CIRCLE_BRANCH" = "staging" ]; then
                      ENVIRONMENT="staging"
                    else
                      echo "Deployments not configured for this branch"
                      exit 1
                    fi

                    # Uses the fingerprint as the name
                    mv ~/.ssh/id_rsa_02c8ca4cac313d6026c95416de40b8b8 ~/.ssh/epotek
                    node run-all -e $ENVIRONMENT --apps app validate
                    node run-all -e $ENVIRONMENT --apps app deploy
                  
          no_output_timeout: 30m
      - save_cache:
          name: Save minifier cache
          key: 'minifier_microservice_master_16_app-{{ .Branch }}-{{ .Revision }}'
          paths:
            - >-
              ./microservices/app/.meteor/local/plugin-cache/zodern_standard-minifier-js
  Admin - deploy:
    working_directory: /home/circleci/app
    docker: *ref_0
    steps:
      - add_ssh_keys
      - setup_remote_docker:
          version: 19.03.12
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_admin-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_admin-{{ .Branch }}-'
            - meteor_microservice_master_16_admin-
      - restore_cache:
          name: Restore minifier cache
          keys:
            - >-
              minifier_microservice_master_16_admin-{{ .Branch }}-{{ .Revision
              }}
            - 'minifier_microservice_master_16_admin-{{ .Branch }}-'
            - minifier_microservice_master_16_admin-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Install GCloud
          command: |2-

                  cd ~
                  echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
                  apt-get install apt-transport-https ca-certificates gnupg
                  curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
                  apt-get update && apt-get install -y google-cloud-sdk

                  echo "$GCLOUD_SDK_KEY" > ./gcloud-key.json
                  gcloud auth activate-service-account  --key-file=./gcloud-key.json
                  rm ./gcloud-key.json
                
      - run:
          name: Install Docker
          command: 'wget -qO- https://get.docker.com/ | sh'
      - run:
          name: Deploy
          command: |2-

                    cd deploy
                    ENVIRONMENT="staging"

                    if [ "$CIRCLE_BRANCH" = "staging" ]; then
                      ENVIRONMENT="staging"
                    else
                      echo "Deployments not configured for this branch"
                      exit 1
                    fi

                    # Uses the fingerprint as the name
                    mv ~/.ssh/id_rsa_02c8ca4cac313d6026c95416de40b8b8 ~/.ssh/epotek
                    node run-all -e $ENVIRONMENT --apps admin validate
                    node run-all -e $ENVIRONMENT --apps admin deploy
                  
          no_output_timeout: 30m
      - save_cache:
          name: Save minifier cache
          key: 'minifier_microservice_master_16_admin-{{ .Branch }}-{{ .Revision }}'
          paths:
            - >-
              ./microservices/admin/.meteor/local/plugin-cache/zodern_standard-minifier-js
  Pro - deploy:
    working_directory: /home/circleci/app
    docker: *ref_0
    steps:
      - add_ssh_keys
      - setup_remote_docker:
          version: 19.03.12
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - 'meteor_microservice_master_16_pro-{{ .Branch }}-{{ .Revision }}'
            - 'meteor_microservice_master_16_pro-{{ .Branch }}-'
            - meteor_microservice_master_16_pro-
      - restore_cache:
          name: Restore minifier cache
          keys:
            - 'minifier_microservice_master_16_pro-{{ .Branch }}-{{ .Revision }}'
            - 'minifier_microservice_master_16_pro-{{ .Branch }}-'
            - minifier_microservice_master_16_pro-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Install GCloud
          command: |2-

                  cd ~
                  echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
                  apt-get install apt-transport-https ca-certificates gnupg
                  curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
                  apt-get update && apt-get install -y google-cloud-sdk

                  echo "$GCLOUD_SDK_KEY" > ./gcloud-key.json
                  gcloud auth activate-service-account  --key-file=./gcloud-key.json
                  rm ./gcloud-key.json
                
      - run:
          name: Install Docker
          command: 'wget -qO- https://get.docker.com/ | sh'
      - run:
          name: Deploy
          command: |2-

                    cd deploy
                    ENVIRONMENT="staging"

                    if [ "$CIRCLE_BRANCH" = "staging" ]; then
                      ENVIRONMENT="staging"
                    else
                      echo "Deployments not configured for this branch"
                      exit 1
                    fi

                    # Uses the fingerprint as the name
                    mv ~/.ssh/id_rsa_02c8ca4cac313d6026c95416de40b8b8 ~/.ssh/epotek
                    node run-all -e $ENVIRONMENT --apps pro validate
                    node run-all -e $ENVIRONMENT --apps pro deploy
                  
          no_output_timeout: 30m
      - save_cache:
          name: Save minifier cache
          key: 'minifier_microservice_master_16_pro-{{ .Branch }}-{{ .Revision }}'
          paths:
            - >-
              ./microservices/pro/.meteor/local/plugin-cache/zodern_standard-minifier-js
  Backend - deploy:
    working_directory: /home/circleci/app
    docker: *ref_0
    steps:
      - add_ssh_keys
      - setup_remote_docker:
          version: 19.03.12
      - restore_cache:
          name: Restore source
          keys:
            - 'source_master_16-{{ .Branch }}-{{ .Revision }}'
            - 'source_master_16-{{ .Branch }}-'
            - source_master_16-
      - restore_cache:
          name: Restore node_modules
          keys:
            - 'node_modules_master_16_{{ checksum "./package-lock.json" }}'
      - restore_cache:
          name: Restore meteor microservice
          keys:
            - >-
              meteor_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'meteor_microservice_master_16_backend-{{ .Branch }}-'
            - meteor_microservice_master_16_backend-
      - restore_cache:
          name: Restore minifier cache
          keys:
            - >-
              minifier_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
              }}
            - 'minifier_microservice_master_16_backend-{{ .Branch }}-'
            - minifier_microservice_master_16_backend-
      - run:
          name: Install meteor
          command: ./scripts/circleci/install_meteor.sh
      - run:
          name: Install GCloud
          command: |2-

                  cd ~
                  echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
                  apt-get install apt-transport-https ca-certificates gnupg
                  curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
                  apt-get update && apt-get install -y google-cloud-sdk

                  echo "$GCLOUD_SDK_KEY" > ./gcloud-key.json
                  gcloud auth activate-service-account  --key-file=./gcloud-key.json
                  rm ./gcloud-key.json
                
      - run:
          name: Install Docker
          command: 'wget -qO- https://get.docker.com/ | sh'
      - run:
          name: Deploy
          command: |2-

                    cd deploy
                    ENVIRONMENT="staging"

                    if [ "$CIRCLE_BRANCH" = "staging" ]; then
                      ENVIRONMENT="staging"
                    else
                      echo "Deployments not configured for this branch"
                      exit 1
                    fi

                    # Uses the fingerprint as the name
                    mv ~/.ssh/id_rsa_02c8ca4cac313d6026c95416de40b8b8 ~/.ssh/epotek
                    node run-all -e $ENVIRONMENT --apps backend validate
                    node run-all -e $ENVIRONMENT --apps backend deploy
                  
          no_output_timeout: 30m
      - save_cache:
          name: Save minifier cache
          key: >-
            minifier_microservice_master_16_backend-{{ .Branch }}-{{ .Revision
            }}
          paths:
            - >-
              ./microservices/backend/.meteor/local/plugin-cache/zodern_standard-minifier-js
workflows:
  version: 2
  Test and deploy:
    jobs:
      - Prepare
      - Www2 - unit tests:
          requires:
            - Prepare
      - App - unit tests:
          requires:
            - Prepare
      - Core - unit tests:
          requires:
            - Prepare
      - Admin - unit tests:
          requires:
            - Prepare
      - App - e2e tests:
          requires:
            - Prepare
      - Admin - e2e tests:
          requires:
            - Prepare
      - Pro - e2e tests:
          requires:
            - Prepare
      - App - deploy:
          requires: &ref_1
            - App - unit tests
            - Admin - unit tests
            - Core - unit tests
            - App - e2e tests
            - Admin - e2e tests
            - Pro - e2e tests
          filters: &ref_2
            branches:
              only:
                - staging
      - Admin - deploy:
          requires: *ref_1
          filters: *ref_2
      - Pro - deploy:
          requires: *ref_1
          filters: *ref_2
      - Backend - deploy:
          requires: *ref_1
          filters: *ref_2

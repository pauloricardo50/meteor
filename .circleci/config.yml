version: 2
jobs:
  build:
    working_directory: ~/app
    docker:
      - image: circleci/node:8.9-browsers
        environment:
          # lang settings required for Meteor's Mongo
          LANG: C.UTF-8
          LANGUAGE: C.UTF-8
          LC_ALL: C.UTF-8
          LC_NUMERIC: en_US.UTF-8
          METEOR_VERSION: 1.7
          NODE_ENV: test
          TOOL_NODE_FLAGS: '--max_old_space_size=8192 --optimize_for_size --gc-interval=100' #Â if builds run out of memory
          METEOR_PROFILE: 1000 # If you need to debug meteor, turn this on
          # Used to to know in our scripts if we're on CircleCI environment or not
          CIRCLE_CI: 1
          DEBUG: true
    steps:
      - checkout
      - run:
          name: install meteor
          command: |
            curl https://install.meteor.com?release=$METEOR_VERSION | /bin/sh
            meteor update --release 1.7.1-beta.19
      - run:
          name: run tests for App
          command: |
            cd microservices/app
            # Using 3.6.0 because of this: https://github.com/meteortesting/meteor-mocha/issues/54
            # Using chromedriver 2.37 because 2.38 is incompatible with selenium >3.6.0
            # meteor npm i selenium-webdriver@3.6.0 chromedriver@2.37.0 --no-save
            # meteor npm i nightmare --no-save
            meteor npm i
            meteor npm run test-CI

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build